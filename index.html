<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maestro Mario - HVAC Training App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--accent:#ff6b2b;--electric:#00d4ff;--gold:#f1c40f;--dark:#0a1628;--card:#111d33;--card2:#162440;--txt:#e8f0ff;--muted:#7a93b8;--r:16px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Nunito',sans-serif;background:var(--dark);color:var(--txt);min-height:100vh;min-height:100dvh;overflow-x:hidden}
        .bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
        .bg .o{position:absolute;border-radius:50%;filter:blur(90px);opacity:.12;animation:d 22s ease-in-out infinite}
        .bg .o:nth-child(1){width:420px;height:420px;background:var(--accent);top:-120px;left:-120px}
        .bg .o:nth-child(2){width:360px;height:360px;background:var(--electric);bottom:-100px;right:-100px;animation-delay:-8s}
        .bg .o:nth-child(3){width:280px;height:280px;background:#6366f1;top:40%;left:40%;animation-delay:-15s}
        @keyframes d{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-30px) scale(1.08)}66%{transform:translate(-20px,20px) scale(.92)}}
        .gr{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);background-size:44px 44px}
        .app{position:relative;z-index:1;max-width:460px;margin:0 auto;min-height:100vh;min-height:100dvh;padding:16px 18px;display:flex;flex-direction:column}
        .s{display:none;flex-direction:column;align-items:center;flex:1;animation:si .55s cubic-bezier(.16,1,.3,1)}
        .s.on{display:flex}
        @keyframes si{from{opacity:0;transform:translateY(36px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
        
        /* VIDEO FLOTANTE DESDE LA DERECHA */
        .video-float{position:fixed;bottom:100px;right:-320px;z-index:900;width:300px;transition:right 0.6s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
        .video-float.active{right:20px;pointer-events:auto}
        .video-float.hiding{right:-320px}
        .video-float-inner{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 15px 50px rgba(255,107,43,0.6),0 0 0 3px var(--accent);background:#000}
        .video-float video{width:100%;display:block;border-radius:17px}
        .video-float-label{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;padding:6px 14px;border-radius:20px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .video-float-label::before{content:'';width:10px;height:10px;border-radius:50%;background:#00ff00;animation:blink 1s infinite;box-shadow:0 0 10px #00ff00}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .video-float-close{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,0.7);border:2px solid rgba(255,255,255,0.3);color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
        .video-float-close:hover{background:var(--accent);border-color:var(--accent);transform:scale(1.1)}
        .video-float-glow{position:absolute;inset:-4px;border-radius:24px;background:conic-gradient(var(--accent),var(--electric),var(--gold),var(--accent));z-index:-1;animation:sp 3s linear infinite}
        
        /* MODAL AI CHAT */
        .ai-modal{position:fixed;inset:0;z-index:600;background:rgba(10,22,40,0.95);display:flex;align-items:flex-end;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s}
        .ai-modal.active{opacity:1;visibility:visible}
        .ai-chat{width:100%;max-width:460px;height:75vh;background:var(--card);border-radius:24px 24px 0 0;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.4s cubic-bezier(.16,1,.3,1)}
        .ai-modal.active .ai-chat{transform:translateY(0)}
        .ai-chat-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:12px}
        .ai-chat-avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid var(--accent)}
        .ai-chat-avatar img{width:100%;height:100%;object-fit:cover}
        .ai-chat-title{flex:1}
        .ai-chat-title h3{font-family:'Fredoka',sans-serif;font-size:17px;color:var(--txt)}
        .ai-chat-title span{font-size:12px;color:var(--electric)}
        .ai-chat-close{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:var(--txt);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .ai-chat-close:hover{background:var(--accent)}
        .ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
        .ai-msg{max-width:85%;padding:14px 18px;border-radius:18px;font-size:15px;line-height:1.5}
        .ai-msg.mario{background:linear-gradient(135deg,rgba(255,107,43,0.2),rgba(0,212,255,0.1));border:1px solid rgba(255,107,43,0.3);align-self:flex-start;border-bottom-left-radius:4px}
        .ai-msg.user{background:var(--card2);align-self:flex-end;border-bottom-right-radius:4px}
        .ai-chat-input{padding:16px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px}
        .ai-chat-input input{flex:1;padding:14px 18px;border-radius:25px;border:2px solid rgba(255,255,255,0.1);background:var(--dark);color:var(--txt);font-size:15px;outline:none}
        .ai-chat-input input:focus{border-color:var(--accent)}
        .ai-chat-input button{width:50px;height:50px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:22px;cursor:pointer}
        .ai-chat-input button:disabled{opacity:0.5;cursor:not-allowed}
        
        /* SPEAKING INDICATOR */
        .speaking-indicator{display:none;align-items:center;gap:8px;padding:10px 16px;background:rgba(255,107,43,0.2);border-radius:12px;margin-top:8px}
        .speaking-indicator.active{display:flex}
        .speaking-indicator .waves{display:flex;gap:3px;align-items:center}
        .speaking-indicator .wave{width:4px;height:16px;background:var(--accent);border-radius:2px;animation:wave 0.8s ease-in-out infinite}
        .speaking-indicator .wave:nth-child(2){animation-delay:0.1s}
        .speaking-indicator .wave:nth-child(3){animation-delay:0.2s}
        .speaking-indicator .wave:nth-child(4){animation-delay:0.3s}
        @keyframes wave{0%,100%{height:8px}50%{height:20px}}
        .speaking-indicator span{font-size:13px;color:var(--accent);font-weight:600}
        
        /* CONFETTI */
        .cw{position:fixed;inset:0;pointer-events:none;z-index:100}.cf{position:absolute;top:-16px;animation:cff 2.8s ease-out forwards}
        @keyframes cff{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
        
        /* AVATAR - CLICKEABLE PARA ABRIR AI */
        .aw{position:relative;margin:16px auto 12px;cursor:pointer;transition:transform 0.3s}
        .aw:hover{transform:scale(1.05)}
        .aw.lg{width:190px;height:190px}.aw.md{width:140px;height:140px}.aw.sm{width:120px;height:120px}
        .ar{position:absolute;inset:-6px;border-radius:50%;background:conic-gradient(var(--accent),var(--electric),var(--accent));animation:sp 4s linear infinite}
        @keyframes sp{to{transform:rotate(360deg)}}
        .ag{position:absolute;inset:-20px;border-radius:50%;background:radial-gradient(circle,var(--accent) 0%,transparent 70%);opacity:.25;animation:pu 3s ease-in-out infinite}
        @keyframes pu{0%,100%{transform:scale(1);opacity:.25}50%{transform:scale(1.12);opacity:.4}}
        .ai{position:relative;width:100%;height:100%;border-radius:50%;overflow:hidden;border:4px solid var(--dark);animation:fl 4.5s ease-in-out infinite}
        .ai img{width:100%;height:100%;object-fit:cover}
        @keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        
        /* BADGE DE AI EN AVATAR */
        .aw .ai-badge{position:absolute;bottom:5px;right:5px;background:var(--accent);color:white;font-family:'Fredoka',sans-serif;font-size:10px;font-weight:700;padding:4px 8px;border-radius:10px;border:2px solid var(--dark)}
        
        /* BURBUJA */
        .bb{background:var(--card);border:1.5px solid rgba(0,212,255,.15);border-radius:var(--r);padding:18px 22px;margin:0 6px 20px;position:relative;box-shadow:0 6px 28px rgba(0,0,0,.25);text-align:center;font-size:16.5px;line-height:1.55;font-weight:600;min-height:60px}
        .bb::before{content:'';position:absolute;top:-10px;left:50%;transform:translateX(-50%);border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid rgba(0,212,255,.15)}
        .bb::after{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid var(--card)}
        
        /* OTROS ESTILOS */
        .lo{text-align:center;padding:4px 0}.lo-t{font-family:'Fredoka',sans-serif;font-size:26px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.lo-s{font-size:12px;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:2px}
        .pb{width:100%;height:5px;background:rgba(255,255,255,.06);border-radius:3px;margin:12px 0 6px;overflow:hidden}.pbf{height:100%;background:linear-gradient(90deg,var(--accent),var(--electric));border-radius:3px;transition:width .6s}
        .ps{font-size:12px;color:var(--muted);margin-bottom:12px;text-align:center}.ps b{color:var(--accent)}
        .os{width:100%;display:flex;flex-direction:column;gap:10px}
        .oc{background:var(--card);border:2px solid rgba(255,255,255,.06);border-radius:var(--r);padding:16px 18px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:14px}
        .oc:hover{border-color:rgba(255,107,43,.4);background:var(--card2);transform:translateY(-1px)}
        .oc.sel{border-color:var(--accent);background:linear-gradient(135deg,rgba(255,107,43,.12),rgba(0,212,255,.06))}
        .oi{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;transition:all .25s}
        .oc.sel .oi{background:var(--accent);transform:scale(1.08)}
        .ot{font-family:'Fredoka',sans-serif;font-size:15px;font-weight:600}.od{font-size:12.5px;color:var(--muted);margin-top:1px}
        .ck{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.12);margin-left:auto;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:white}
        .oc.sel .ck{background:var(--accent);border-color:var(--accent)}.oc.sel .ck::after{content:'‚úì'}
        .mh{font-size:12.5px;color:var(--muted);text-align:center;margin-bottom:8px}
        .fl{display:flex;gap:18px;justify-content:center;margin-top:16px}
        .fc{width:135px;height:155px;background:var(--card);border:2.5px solid rgba(255,255,255,.06);border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer;transition:all .3s}
        .fc:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 10px 28px rgba(255,107,43,.18)}
        .fe{font-size:42px;line-height:1}.fn{font-family:'Fredoka',sans-serif;font-size:17px;font-weight:600}
        .bt{width:100%;padding:16px;border:none;border-radius:var(--r);background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:17px;font-weight:700;cursor:pointer;margin-top:20px;transition:all .25s;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .bt:hover{transform:translateY(-2px);box-shadow:0 7px 24px rgba(255,107,43,.35)}.bt:disabled{opacity:.35;cursor:not-allowed;transform:none}
        .ip{width:100%;padding:16px 18px;border:2px solid rgba(255,255,255,.06);border-radius:var(--r);background:var(--card);color:var(--txt);font-size:16px;font-weight:600;outline:none}.ip:focus{border-color:var(--accent)}.ip::placeholder{color:var(--muted)}
        .sp{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;text-align:center}
        .sp-t{font-family:'Fredoka',sans-serif;font-size:40px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.15}
        .sp-s{font-size:17px;color:var(--muted);max-width:280px}
        .badge{display:inline-flex;align-items:center;gap:7px;background:rgba(255,107,43,.1);border:1px solid rgba(255,107,43,.25);border-radius:28px;padding:5px 14px;font-family:'Fredoka',sans-serif;font-size:13px;color:var(--accent)}
        .rt{background:var(--card);border:1.5px solid rgba(0,212,255,.12);border-radius:var(--r);padding:16px 18px;margin-bottom:10px;display:flex;align-items:center;gap:14px;animation:ri .5s ease-out backwards}
        @keyframes ri{from{opacity:0;transform:translateX(-24px)}to{opacity:1;transform:translateX(0)}}
        .rn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--electric));display:flex;align-items:center;justify-content:center;font-family:'Fredoka',sans-serif;font-weight:700;font-size:16px;flex-shrink:0}
        .rtt{font-family:'Fredoka',sans-serif;font-size:14.5px;font-weight:600}.rd{font-size:12px;color:var(--muted)}
        .rl{width:2px;height:16px;background:linear-gradient(var(--accent),var(--electric));margin-left:35px;border-radius:2px}
        .typing{display:inline-flex;gap:4px;align-items:center;padding:4px 0}
        .typing .dot{width:8px;height:8px;border-radius:50%;background:var(--electric);animation:tblink 1.4s infinite both}
        .typing .dot:nth-child(2){animation-delay:.2s}.typing .dot:nth-child(3){animation-delay:.4s}
        @keyframes tblink{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
        
        /* MUSIC BUTTON */
        .music-btn{position:fixed;bottom:20px;left:20px;z-index:800;width:48px;height:48px;border-radius:50%;background:var(--card);border:2px solid rgba(0,212,255,0.3);color:var(--electric);font-size:22px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .music-btn:hover{background:var(--card2);border-color:var(--electric);transform:scale(1.1)}
        .music-btn.active{display:flex}
        .music-btn.muted{color:var(--muted);border-color:rgba(255,255,255,0.1)}
        
        /* QUIZ STYLES */
        .quiz-header{width:100%;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .quiz-cat{font-size:11px;color:var(--electric);text-transform:uppercase;letter-spacing:1.5px;font-weight:700}
        .quiz-score{display:flex;align-items:center;gap:8px;font-family:'Fredoka',sans-serif;font-size:14px}
        .quiz-score .correct{color:#2ecc71}.quiz-score .wrong{color:#e74c3c}
        .quiz-num{font-family:'Fredoka',sans-serif;font-size:15px;color:var(--txt);text-align:center;margin:4px 0}
        .quiz-q{background:var(--card);border:1.5px solid rgba(0,212,255,.15);border-radius:var(--r);padding:20px;margin:12px 0;text-align:center;font-size:17px;font-weight:700;line-height:1.5}
        .quiz-opts{width:100%;display:flex;flex-direction:column;gap:10px}
        .quiz-opt{background:var(--card);border:2px solid rgba(255,255,255,.08);border-radius:var(--r);padding:16px 18px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:14px;font-size:15px;font-weight:600}
        .quiz-opt:hover{border-color:rgba(255,107,43,.4);background:var(--card2);transform:translateY(-1px)}
        .quiz-opt.correct{border-color:#2ecc71;background:rgba(46,204,113,0.15)}
        .quiz-opt.correct .quiz-letter{background:#2ecc71}
        .quiz-opt.wrong{border-color:#e74c3c;background:rgba(231,76,60,0.15)}
        .quiz-opt.wrong .quiz-letter{background:#e74c3c}
        .quiz-opt.disabled{pointer-events:none;opacity:0.6}
        .quiz-opt.disabled.correct{opacity:1}
        .quiz-letter{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;flex-shrink:0;transition:all .3s}
        .quiz-explain{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:var(--r);padding:14px 18px;margin-top:12px;font-size:14px;line-height:1.5;display:none}
        .quiz-explain.show{display:block}
        .quiz-explain b{color:var(--electric)}
        .quiz-next{width:100%;padding:14px;border:none;border-radius:var(--r);background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;cursor:pointer;margin-top:14px;display:none;transition:all .25s;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .quiz-next:hover{transform:translateY(-2px)}
        .quiz-next.show{display:block}
        .quiz-nav{display:flex;gap:10px;width:100%;margin-top:14px}
        .quiz-nav button{flex:1;padding:14px;border:none;border-radius:var(--r);font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all .25s;display:none}
        .quiz-nav button.show{display:block}
        .quiz-prev{background:var(--card);border:2px solid rgba(0,212,255,0.3) !important;color:var(--electric)}
        .quiz-prev:hover{border-color:var(--electric) !important;transform:translateY(-2px)}
        .quiz-fwd{background:linear-gradient(135deg,var(--accent),#e84500);color:white;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .quiz-fwd:hover{transform:translateY(-2px)}
        .quiz-result{text-align:center;width:100%}
        .quiz-result-score{font-family:'Fredoka',sans-serif;font-size:64px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .quiz-result-label{font-size:18px;color:var(--muted);margin-top:4px}
        .quiz-result-msg{font-size:16px;margin-top:16px;line-height:1.5}
        .quiz-medal{font-size:80px;margin:16px 0}
        .quiz-stars{display:flex;justify-content:center;gap:6px;margin:12px 0}
        .quiz-stars span{font-size:32px;opacity:0.2;transition:all 0.5s}
        .quiz-stars span.lit{opacity:1;animation:starPop 0.5s ease-out}
        @keyframes starPop{0%{transform:scale(0)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
        
        /* CELEBRATION EFFECTS */
        @keyframes screenShake{0%,100%{transform:translateX(0)}10%,50%,90%{transform:translateX(-4px)}30%,70%{transform:translateX(4px)}}
        @keyframes bigShake{0%,100%{transform:translateX(0)}10%,50%,90%{transform:translateX(-8px) rotate(-1deg)}30%,70%{transform:translateX(8px) rotate(1deg)}}
        @keyframes lightning{0%{opacity:0}5%{opacity:0.8}10%{opacity:0}15%{opacity:1}20%{opacity:0}100%{opacity:0}}
        @keyframes streakPulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
        @keyframes fireFloat{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-120px) scale(0.3);opacity:0}}
        .shake{animation:screenShake 0.4s ease}
        .big-shake{animation:bigShake 0.6s ease}
        .streak-badge{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:900;font-size:48px;font-family:'Fredoka',sans-serif;font-weight:700;color:white;text-shadow:0 0 30px rgba(255,107,43,0.8),0 0 60px rgba(255,107,43,0.4);animation:streakPulse 0.6s ease;pointer-events:none;white-space:nowrap}
        .lightning-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:850;pointer-events:none;animation:lightning 0.4s ease}
        .fire-emoji{position:fixed;z-index:850;font-size:36px;pointer-events:none;animation:fireFloat 1.2s ease-out forwards}
        
        /* PROFILE SYSTEM */
        .profile-btn{position:fixed;top:20px;right:20px;z-index:800;width:48px;height:48px;border-radius:50%;background:var(--card);border:2px solid rgba(255,215,0,0.4);color:var(--gold);font-size:22px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .profile-btn:hover{transform:scale(1.1);border-color:var(--gold)}
        .profile-btn.active{display:flex}
        .prof-card{background:var(--card);border:2px solid rgba(255,215,0,0.2);border-radius:16px;padding:20px;text-align:center;width:100%}
        .prof-name{font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;margin-top:8px}
        .prof-title{color:var(--electric);font-size:13px;text-transform:uppercase;letter-spacing:1.5px;margin-top:4px}
        .prof-level{display:flex;align-items:center;justify-content:center;gap:12px;margin:16px 0}
        .prof-lvl-num{font-family:'Fredoka',sans-serif;font-size:48px;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .prof-xp{width:100%;margin-top:8px}
        .prof-xp-bar{width:100%;height:12px;background:rgba(255,255,255,0.08);border-radius:6px;overflow:hidden}
        .prof-xp-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--accent));border-radius:6px;transition:width 0.5s}
        .prof-xp-txt{font-size:12px;color:var(--muted);margin-top:4px}
        .prof-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:16px}
        .prof-stat{background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 8px;text-align:center}
        .prof-stat-num{font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;color:var(--electric)}
        .prof-stat-label{font-size:11px;color:var(--muted);margin-top:2px}
        .medals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;width:100%}
        .medal-slot{background:var(--card);border:2px solid rgba(255,255,255,0.06);border-radius:14px;padding:16px 10px;text-align:center;transition:all 0.3s}
        .medal-slot.earned{border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.05)}
        .medal-slot .medal-icon{font-size:36px;opacity:0.2}
        .medal-slot.earned .medal-icon{opacity:1}
        .medal-slot .medal-name{font-size:11px;margin-top:6px;color:var(--muted);font-weight:600}
        .medal-slot.earned .medal-name{color:var(--gold)}
        
        /* AVATAR PICKER */
        .prof-avatar{font-size:64px;cursor:pointer;transition:transform 0.3s;position:relative}
        .prof-avatar:hover{transform:scale(1.1)}
        .prof-avatar-edit{position:absolute;bottom:-4px;right:-4px;background:var(--accent);color:white;border-radius:50%;width:24px;height:24px;font-size:12px;display:flex;align-items:center;justify-content:center}
        .avatar-picker{display:none;background:var(--card);border:2px solid rgba(0,212,255,0.2);border-radius:16px;padding:16px;margin-top:12px;width:100%}
        .avatar-picker.open{display:block}
        .avatar-picker-title{font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;color:var(--electric);margin-bottom:12px;text-align:center}
        .avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
        .avatar-option{font-size:36px;padding:10px;text-align:center;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent;background:rgba(255,255,255,0.03)}
        .avatar-option:hover{background:rgba(0,212,255,0.1);transform:scale(1.15)}
        .avatar-option.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
        
        /* MUSIC PICKER */
        .music-panel{position:fixed;bottom:70px;left:12px;z-index:810;background:var(--card);border:2px solid rgba(0,212,255,0.2);border-radius:16px;padding:16px;width:280px;display:none;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
        .music-panel.open{display:block;animation:fadeIn 0.3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .music-panel-title{font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;color:var(--electric);margin-bottom:12px;text-align:center}
        .music-option{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s;border:2px solid transparent;margin-bottom:6px;background:rgba(255,255,255,0.03)}
        .music-option:hover{background:rgba(0,212,255,0.08)}
        .music-option.selected{border-color:var(--electric);background:rgba(0,212,255,0.1)}
        .music-option-icon{font-size:24px;width:36px;text-align:center}
        .music-option-info{flex:1}
        .music-option-name{font-family:'Fredoka',sans-serif;font-size:14px;font-weight:600}
        .music-option-desc{font-size:11px;color:var(--muted)}
        .music-upload{margin-top:8px;padding:10px;border:2px dashed rgba(255,255,255,0.15);border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s}
        .music-upload:hover{border-color:var(--electric);background:rgba(0,212,255,0.05)}
        .music-upload-label{font-size:12px;color:var(--muted)}
        .music-upload-name{font-size:12px;color:var(--electric);margin-top:4px;font-weight:600;display:none}
    </style>
</head>
<body>
<div class="bg"><div class="o"></div><div class="o"></div><div class="o"></div></div>
<div class="gr"></div>

<!-- VIDEO FLOTANTE DESDE LA DERECHA -->
<div class="video-float" id="videoFloat">
    <div class="video-float-glow"></div>
    <div class="video-float-inner">
        <div class="video-float-label">üî¥ EN VIVO</div>
        <button class="video-float-close" onclick="closeVideo()">‚úï</button>
        <video id="marioVideo" playsinline webkit-playsinline></video>
    </div>
</div>

<!-- MODAL AI CHAT -->
<div class="ai-modal" id="aiModal">
    <div class="ai-chat">
        <div class="ai-chat-header">
            <div class="ai-chat-avatar"><img src="mario.jpg" alt="Mario"></div>
            <div class="ai-chat-title"><h3>Maestro Mario AI</h3><span>üü¢ Disponible para ayudarte</span></div>
            <button class="ai-chat-close" onclick="closeAIChat()">‚úï</button>
        </div>
        <div class="ai-chat-messages" id="aiMessages">
            <div class="ai-msg mario">¬°√ìrale t√©cnico! Soy el Maestro Mario con inteligencia artificial. ¬øEn qu√© te puedo ayudar? Preg√∫ntame lo que quieras sobre HVAC, refrigeraci√≥n, o electricidad. üîß</div>
        </div>
        <div class="speaking-indicator" id="speakingIndicator">
            <div class="waves"><div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>
            <span>Maestro Mario est√° hablando...</span>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiInput" placeholder="Escribe tu pregunta..." onkeydown="if(event.key==='Enter'&&!event.shiftKey)sendAIMessage()">
            <button id="sendBtn" onclick="sendAIMessage()">‚û§</button>
        </div>
    </div>
</div>

<!-- AUDIO PLAYER PARA VOZ DE AI -->
<audio id="aiAudio" style="display:none"></audio>

<div class="app">
<!-- PANTALLA INICIO -->
<div class="s on" id="s0"><div class="sp">
    <div class="aw lg" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="Maestro Mario"></div><span class="ai-badge">AI</span></div>
    <div><div class="sp-t">MAESTRO<br>MARIO</div><div class="badge">‚ö° NIVEL 33</div></div>
    <div class="sp-s">Si no mides, est√°s adivinando</div>
    <button class="bt" onclick="startWithVideo()" style="max-width:260px">Comenzar / Start</button>
</div></div>

<!-- IDIOMA -->
<div class="s" id="s1">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div><div class="lo-s">HVAC ‚Ä¢ ELECTRICAL ‚Ä¢ TRAINING</div></div>
    <div class="aw md" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb">¬°Hola! Choose your language<br>Elige tu idioma</div>
    <div class="fl"><div class="fc" onclick="setLang('es')"><span class="fe">üá≤üáΩ</span><span class="fn">Espa√±ol</span></div><div class="fc" onclick="setLang('en')"><span class="fe">üá∫üá∏</span><span class="fn">English</span></div></div>
</div>

<!-- NOMBRE -->
<div class="s" id="s2">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:20%"></div></div><div class="ps"><b data-t="step_1"></b></div>
    <div class="aw md" id="a2" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb2"><span data-t="welcome_speech"></span></div>
    <div style="width:100%"><input class="ip" id="nm" data-tp="name_ph" oninput="document.getElementById('b2').disabled=this.value.trim().length<2"><button class="bt" id="b2" disabled onclick="sName()" data-t="continue"></button></div>
</div>

<!-- NIVEL -->
<div class="s" id="s3">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:40%"></div></div><div class="ps"><b data-t="step_2"></b></div>
    <div class="aw sm" id="a3" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb3"><span data-t="level_speech"></span></div>
    <div class="os" id="lo"></div>
    <button class="bt" id="b3" disabled onclick="sLvl()" data-t="continue"></button>
</div>

<!-- ESPECIALIDADES -->
<div class="s" id="s4">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:60%"></div></div><div class="ps"><b data-t="step_3"></b></div>
    <div class="aw sm" id="a4" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb4"><span data-t="spec_speech"></span></div>
    <p class="mh" data-t="multi_hint"></p>
    <div class="os" id="so"></div>
    <button class="bt" id="b4" disabled onclick="sSpc()" data-t="continue"></button>
</div>

<!-- ESCUELA -->
<div class="s" id="s5">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:80%"></div></div><div class="ps"><b data-t="step_4"></b></div>
    <div class="aw sm" id="a5" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb5"><span data-t="school_speech"></span></div>
    <div class="os" id="sco"></div>
    <button class="bt" id="b5" disabled onclick="sSch()" data-t="continue"></button>
</div>

<!-- METAS -->
<div class="s" id="s6">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:90%"></div></div><div class="ps"><b data-t="step_5"></b></div>
    <div class="aw sm" id="a6" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb6"><span data-t="goals_speech"></span></div>
    <p class="mh" data-t="multi_hint"></p>
    <div class="os" id="go2"></div>
    <button class="bt" id="b6" disabled onclick="sGol()" data-t="continue"></button>
</div>

<!-- RUTA FINAL -->
<div class="s" id="s7">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:100%"></div></div>
    <div class="aw md" id="a7" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--gold) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb7"><span data-t="route_speech"></span></div>
    <div id="rl" style="width:100%"></div>
    <button class="bt" onclick="startApp()" data-t="start_btn"></button>
</div>

<!-- QUIZ -->
<div class="s" id="s8">
    <div class="quiz-header">
        <div class="quiz-cat" id="qCat"></div>
        <div class="quiz-score">‚úÖ <span class="correct" id="qRight">0</span> | ‚ùå <span class="wrong" id="qWrong">0</span></div>
    </div>
    <div class="pb"><div class="pbf" id="qBar" style="width:0%"></div></div>
    <div class="quiz-num" id="qNum"></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="qBubble"></div>
    <div class="quiz-q" id="qText"></div>
    <div class="quiz-opts" id="qOpts"></div>
    <div class="quiz-explain" id="qExplain"></div>
    <div class="quiz-nav">
        <button class="quiz-prev" id="qPrev" onclick="prevQuestion()">‚Üê Anterior</button>
        <button class="quiz-fwd" id="qNext" onclick="nextQuestion()">Siguiente ‚Üí</button>
    </div>
</div>

<!-- QUIZ RESULT -->
<div class="s" id="s9">
    <div class="aw md" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--gold) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="quiz-result">
        <div class="quiz-medal" id="rMedal"></div>
        <div class="quiz-result-score" id="rScore"></div>
        <div class="quiz-result-label" id="rLabel"></div>
        <div class="quiz-stars" id="rStars"><span>‚≠ê</span><span>‚≠ê</span><span>‚≠ê</span><span>‚≠ê</span><span>‚≠ê</span></div>
        <div class="bb quiz-result-msg" id="rMsg"></div>
        <div id="rMedalEarned" style="display:none;margin-top:16px;padding:16px;background:rgba(255,215,0,0.1);border:2px solid var(--gold);border-radius:14px;text-align:center">
            <div style="font-size:48px" id="rNewMedal"></div>
            <div style="font-family:'Fredoka',sans-serif;font-size:18px;font-weight:700;color:var(--gold);margin-top:8px" id="rMedalName"></div>
        </div>
    </div>
    <button class="bt" onclick="retryQuiz()">üîÑ Intentar de Nuevo</button>
    <button class="bt" onclick="go('s10')" style="background:var(--card);border:2px solid var(--gold);margin-top:10px">üë§ Ver Mi Perfil</button>
    <button class="bt" onclick="go('s7')" style="background:var(--card);border:2px solid var(--accent);margin-top:10px">‚Üê Volver a Mi Ruta</button>
</div>

<!-- PROFILE -->
<div class="s" id="s10">
    <div class="prof-card">
        <div class="prof-avatar" id="profAvatar" onclick="toggleAvatarPicker()">üë§<div class="prof-avatar-edit">‚úèÔ∏è</div></div>
        <div class="avatar-picker" id="avatarPicker">
            <div class="avatar-picker-title">Elige tu avatar</div>
            <div class="avatar-grid" id="avatarGrid"></div>
        </div>
        <div class="prof-name" id="profName"></div>
        <div class="prof-title" id="profTitle"></div>
        <div class="prof-level">
            <div>
                <div style="font-size:12px;color:var(--muted)">NIVEL</div>
                <div class="prof-lvl-num" id="profLevel">1</div>
            </div>
        </div>
        <div class="prof-xp">
            <div class="prof-xp-bar"><div class="prof-xp-fill" id="profXpBar" style="width:0%"></div></div>
            <div class="prof-xp-txt" id="profXpTxt">0 / 100 XP</div>
        </div>
    </div>
    <div class="prof-stats">
        <div class="prof-stat"><div class="prof-stat-num" id="profPts">0</div><div class="prof-stat-label">Puntos</div></div>
        <div class="prof-stat"><div class="prof-stat-num" id="profAcc">0%</div><div class="prof-stat-label">Precisi√≥n</div></div>
        <div class="prof-stat"><div class="prof-stat-num" id="profStrk">0</div><div class="prof-stat-label">Mejor Racha</div></div>
    </div>
    <div style="width:100%;margin-top:20px;font-family:'Fredoka',sans-serif;font-size:18px;font-weight:700;text-align:center">üèÖ Medallas</div>
    <div class="medals-grid" id="medalsGrid"></div>
    <button class="bt" onclick="go('s8');showQuestion()" style="margin-top:20px">üìù Seguir con el Quiz</button>
    <button class="bt" onclick="go('s7')" style="background:var(--card);border:2px solid var(--accent);margin-top:10px">‚Üê Volver a Mi Ruta</button>
</div>
</div>
<div class="cw" id="conf"></div>
<button class="music-btn" id="musicBtn" onclick="toggleMusic()" ondblclick="toggleMusicPanel(event)">üéµ</button>
<div class="music-panel" id="musicPanel">
    <div class="music-panel-title">üé∂ Elige tu m√∫sica</div>
    <div id="musicOptions"></div>
    <div class="music-upload" onclick="document.getElementById('musicFile').click()">
        <div>üìÅ <b>Mi M√∫sica</b></div>
        <div class="music-upload-label">Sube tu MP3, WAV o audio favorito</div>
        <div class="music-upload-name" id="musicFileName"></div>
    </div>
    <input type="file" id="musicFile" accept="audio/*" style="display:none" onchange="loadCustomMusic(this)">
</div>
<button class="profile-btn" id="profileBtn" onclick="go('s10');renderProfile()">üë§</button>

<script>
const D={lang:'es',name:'',level:null,specs:[],school:null,goals:[]};
let videoPlaying=false;
let currentVideoCallback=null;
let isSpeaking=false;
let audioUnlocked=false;

function unlockAudio(){
    if(audioUnlocked)return;
    const audio=document.getElementById('aiAudio');
    audio.src='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRwAAAAAAAAAAAAAAAAAAAAAAAA==';
    audio.play().then(()=>{audio.pause();audioUnlocked=true;}).catch(()=>{});
}

// ========== CHIPTUNE MUSIC ENGINE ==========
let musicCtx=null;
let musicPlaying=false;
let musicMuted=false;
let musicGain=null;
let musicTimers=[];
let musicVolume=0.5;
let musicMode='onboarding';
let currentMusicStyle='pokemon';
let customAudio=null;
let musicPanelOpen=false;

const MUSIC_STYLES=[
    {id:'pokemon',icon:'üéÆ',name:'Pok√©mon Adventure',desc:'8-bit cl√°sico'},
    {id:'lofi',icon:'üéß',name:'Lo-Fi Chill',desc:'Relajado para estudiar'},
    {id:'battle',icon:'‚öîÔ∏è',name:'Boss Battle',desc:'√âpico e intenso'},
    {id:'reggaeton',icon:'üé∫',name:'Reggaet√≥n Study',desc:'Ritmo latino'},
    {id:'silent',icon:'üîá',name:'Sin M√∫sica',desc:'Solo silencio'}
];

function noteFreq(note,octave){
    const notes={C:261.63,D:293.66,E:329.63,F:349.23,G:392.00,A:440.00,B:493.88};
    const base=notes[note]||261.63;
    return base*Math.pow(2,octave-4);
}

function playNote(type,freq,start,dur,vol){
    if(!musicCtx)return;
    const osc=musicCtx.createOscillator();
    const gain=musicCtx.createGain();
    osc.type=type;
    osc.frequency.setValueAtTime(freq,start);
    gain.gain.setValueAtTime(vol,start);
    gain.gain.setValueAtTime(vol,start+dur*0.8);
    gain.gain.linearRampToValueAtTime(0,start+dur);
    osc.connect(gain);
    gain.connect(musicGain);
    osc.start(start);
    osc.stop(start+dur);
}

function playMusicLoop(){
    if(!musicCtx||!musicPlaying||currentMusicStyle==='custom'||currentMusicStyle==='silent')return;
    const style=currentMusicStyle;
    const bpm=style==='battle'?160:style==='reggaeton'?95:style==='lofi'?75:130;
    const beat=60/bpm;
    const half=beat/2;
    const now=musicCtx.currentTime+0.05;
    
    if(style==='pokemon'){
        const melody=[['E',5],['G',5],['A',5],['B',5],['A',5],['G',5],['E',5],['D',5],['C',5],['D',5],['E',5],['G',5],['A',5],['G',5],['E',5],['G',5],['A',5],['B',5],['C',6],['B',5],['A',5],['G',5],['A',5],['B',5],['G',5],['E',5],['D',5],['E',5],['C',5],['D',5],['E',5],['E',5]];
        const bass=[['C',3],['C',3],['G',3],['G',3],['A',3],['A',3],['E',3],['E',3],['F',3],['F',3],['C',3],['C',3],['G',3],['G',3],['G',3],['G',3],['A',3],['A',3],['F',3],['F',3],['C',3],['C',3],['G',3],['G',3],['F',3],['F',3],['G',3],['G',3],['C',3],['C',3],['C',3],['C',3]];
        const arp=[['C',4],['E',4],['G',4],['E',4],['A',4],['C',5],['E',5],['C',5],['F',4],['A',4],['C',5],['A',4],['G',4],['B',4],['D',5],['B',4],['A',4],['C',5],['E',5],['C',5],['F',4],['A',4],['C',5],['A',4],['G',4],['B',4],['D',5],['B',4],['C',4],['E',4],['G',4],['E',4]];
        for(let i=0;i<melody.length;i++){playNote('square',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.85,0.08);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.12);}
        for(let i=0;i<arp.length;i++){playNote('square',noteFreq(arp[i][0],arp[i][1]),now+i*half,half*0.4,0.03);}
        const loopDur=melody.length*half;
        musicTimers.push(setTimeout(()=>playMusicLoop(),loopDur*1000-100));
    }
    else if(style==='lofi'){
        // Lo-fi chill beats - sine waves, slow, jazzy
        const melody=[['E',4],['G',4],['A',4],['G',4],['E',4],['D',4],['C',4],['D',4],['E',4],['A',4],['G',4],['E',4],['D',4],['E',4],['G',4],['A',4]];
        const bass=[['C',3],['C',3],['A',2],['A',2],['F',2],['F',2],['G',2],['G',2],['C',3],['C',3],['A',2],['A',2],['F',2],['F',2],['G',2],['G',2]];
        const pad=[['E',4],['E',4],['C',4],['C',4],['A',3],['A',3],['B',3],['B',3],['E',4],['E',4],['C',4],['C',4],['A',3],['A',3],['B',3],['B',3]];
        for(let i=0;i<melody.length;i++){playNote('sine',noteFreq(melody[i][0],melody[i][1]),now+i*beat,beat*0.7,0.1);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*beat,beat*0.9,0.1);}
        for(let i=0;i<pad.length;i++){playNote('sine',noteFreq(pad[i][0],pad[i][1]),now+i*beat,beat*1.2,0.04);}
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*beat*1000-100));
    }
    else if(style==='battle'){
        // Epic boss battle - fast, intense, sawtooth
        const melody=[['E',5],['E',5],['F',5],['G',5],['G',5],['F',5],['E',5],['D',5],['C',5],['C',5],['D',5],['E',5],['E',5],['D',5],['D',5],['D',5],['E',5],['E',5],['F',5],['G',5],['G',5],['F',5],['E',5],['D',5],['C',5],['C',5],['D',5],['E',5],['D',5],['C',5],['C',5],['C',5]];
        const bass=[['C',2],['C',2],['C',2],['C',2],['A',2],['A',2],['A',2],['A',2],['F',2],['F',2],['F',2],['F',2],['G',2],['G',2],['G',2],['G',2],['C',2],['C',2],['C',2],['C',2],['A',2],['A',2],['A',2],['A',2],['F',2],['F',2],['F',2],['F',2],['G',2],['G',2],['G',2],['G',2]];
        for(let i=0;i<melody.length;i++){playNote('sawtooth',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.8,0.06);}
        for(let i=0;i<bass.length;i++){playNote('square',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.1);}
        // Drum-like percussion with noise
        for(let i=0;i<32;i+=2){playNote('square',noteFreq('C',1),now+i*half,half*0.15,0.15);}
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*half*1000-100));
    }
    else if(style==='reggaeton'){
        // Reggaet√≥n dembow rhythm
        const melody=[['A',4],['C',5],['D',5],['E',5],['D',5],['C',5],['A',4],['G',4],['A',4],['C',5],['D',5],['E',5],['G',5],['E',5],['D',5],['C',5]];
        const bass=[['A',2],['A',2],['A',2],['A',2],['D',3],['D',3],['D',3],['D',3],['F',2],['F',2],['G',2],['G',2],['A',2],['A',2],['A',2],['A',2]];
        for(let i=0;i<melody.length;i++){playNote('triangle',noteFreq(melody[i][0],melody[i][1]),now+i*beat,beat*0.6,0.09);}
        for(let i=0;i<bass.length;i++){playNote('sine',noteFreq(bass[i][0],bass[i][1]),now+i*beat,beat*0.8,0.14);}
        // Dembow kick pattern
        for(let i=0;i<16;i++){
            const isKick=(i%4===0||i%4===3);
            if(isKick)playNote('sine',noteFreq('C',2),now+i*beat,beat*0.2,0.18);
            else playNote('square',noteFreq('C',1),now+i*beat,beat*0.08,0.06);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*beat*1000-100));
    }
}

function toggleMusicPanel(e){
    if(e)e.preventDefault();
    musicPanelOpen=!musicPanelOpen;
    const panel=document.getElementById('musicPanel');
    panel.classList.toggle('open',musicPanelOpen);
    if(musicPanelOpen)renderMusicOptions();
}

function renderMusicOptions(){
    document.getElementById('musicOptions').innerHTML=MUSIC_STYLES.map(s=>
        '<div class="music-option'+(currentMusicStyle===s.id?' selected':'')+'" onclick="switchMusic(\''+s.id+'\')">'+
        '<div class="music-option-icon">'+s.icon+'</div>'+
        '<div class="music-option-info"><div class="music-option-name">'+s.name+'</div><div class="music-option-desc">'+s.desc+'</div></div>'+
        '</div>'
    ).join('');
    // Show custom music option if loaded
    if(customAudio){
        const el=document.querySelector('.music-upload');
        if(el)el.querySelector('.music-option')?.classList.toggle('selected',currentMusicStyle==='custom');
    }
}

function switchMusic(styleId){
    // Stop current
    if(customAudio){customAudio.pause();customAudio.currentTime=0;}
    stopMusicOsc();
    
    currentMusicStyle=styleId;
    
    if(styleId==='silent'){
        musicPlaying=false;
        document.getElementById('musicBtn').textContent='üîá';
    }else if(styleId==='custom'&&customAudio){
        musicPlaying=true;
        customAudio.volume=musicMuted?0:Math.min(musicVolume*2,1);
        customAudio.loop=true;
        customAudio.play().catch(()=>{});
        document.getElementById('musicBtn').textContent='üéµ';
    }else{
        if(!musicCtx||musicCtx.state==='closed'){
            musicCtx=new(window.AudioContext||window.webkitAudioContext)();
            musicGain=musicCtx.createGain();
            musicGain.gain.setValueAtTime(musicMuted?0:musicVolume,musicCtx.currentTime);
            musicGain.connect(musicCtx.destination);
        }
        musicPlaying=true;
        document.getElementById('musicBtn').textContent='üéµ';
        playMusicLoop();
    }
    
    renderMusicOptions();
    try{localStorage.setItem('maestro_music_style',styleId);}catch(e){}
}

function stopMusicOsc(){
    musicTimers.forEach(t=>clearTimeout(t));
    musicTimers=[];
    if(musicCtx&&musicCtx.state!=='closed'){musicCtx.close();musicCtx=null;}
}

function loadCustomMusic(input){
    if(!input.files||!input.files[0])return;
    const file=input.files[0];
    const url=URL.createObjectURL(file);
    customAudio=new Audio(url);
    customAudio.loop=true;
    document.getElementById('musicFileName').textContent='‚ô´ '+file.name;
    document.getElementById('musicFileName').style.display='block';
    switchMusic('custom');
    toggleMusicPanel();
}

function startMusic(){
    if(musicPlaying)return;
    // Load saved style
    try{const saved=localStorage.getItem('maestro_music_style');if(saved)currentMusicStyle=saved;}catch(e){}
    
    if(currentMusicStyle==='silent')return;
    if(currentMusicStyle==='custom'&&customAudio){
        musicPlaying=true;
        customAudio.volume=0.5;
        customAudio.loop=true;
        customAudio.play().catch(()=>{});
        document.getElementById('musicBtn').classList.add('active');
        document.getElementById('musicBtn').textContent='üéµ';
        return;
    }
    musicCtx=new(window.AudioContext||window.webkitAudioContext)();
    musicGain=musicCtx.createGain();
    musicGain.gain.setValueAtTime(0.5,musicCtx.currentTime);
    musicGain.connect(musicCtx.destination);
    musicPlaying=true;
    musicMuted=false;
    document.getElementById('musicBtn').classList.add('active');
    document.getElementById('musicBtn').textContent='üéµ';
    playMusicLoop();
}

function stopMusic(){
    musicPlaying=false;
    if(customAudio){customAudio.pause();}
    stopMusicOsc();
}

function toggleMusic(){
    const btn=document.getElementById('musicBtn');
    if(musicMuted){
        musicMuted=false;
        musicVolume=musicMode==='studying'?0.25:0.5;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(musicVolume,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=Math.min(musicVolume*2,1);
        btn.textContent='üéµ';
        btn.classList.remove('muted');
    }else if(musicVolume>=0.4){
        musicVolume=musicMode==='studying'?0.15:0.25;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(musicVolume,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=Math.min(musicVolume*2,1);
        btn.textContent='üîâ';
    }else if(musicVolume>=0.15){
        musicVolume=musicMode==='studying'?0.06:0.1;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(musicVolume,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=Math.min(musicVolume*2,1);
        btn.textContent='üîà';
    }else{
        musicMuted=true;
        musicVolume=0;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(0,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=0;
        btn.textContent='üîá';
        btn.classList.add('muted');
    }
}

function setMusicVolume(vol){
    musicVolume=vol;
    if(musicGain&&musicCtx&&!musicMuted)musicGain.gain.linearRampToValueAtTime(vol,musicCtx.currentTime+0.3);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(vol*2,1);
}

function lowerMusicForSpeech(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(Math.min(musicVolume*0.2,0.05),musicCtx.currentTime+0.3);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*0.4,0.15);
}

function restoreMusicAfterSpeech(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(musicVolume,musicCtx.currentTime+0.3);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*2,1);
}

function lowerMusicForVideo(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(Math.min(musicVolume*0.3,0.08),musicCtx.currentTime+0.5);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*0.5,0.2);
}

function restoreMusicAfterVideo(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(musicVolume,musicCtx.currentTime+0.5);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*2,1);
}

function enterStudyMode(){
    musicMode='studying';
    setMusicVolume(0.25);
    document.getElementById('musicBtn').textContent='üîâ';
}

const SUPABASE_URL='https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1';

const VIDEOS={
    bienvenida:'bienvenida.mp4.mp4',
    correcto:'correcto.mp4.mp4',
    incorrecto:'incorrecto.mp4.mp4',
    medalla:'medalla.mp4.mp4'
};

// ========== VIDEO FUNCTIONS ==========
let videoClosing=false;

function showVideo(type,cb){
    if(videoPlaying||videoClosing)return;
    videoPlaying=true;
    videoClosing=false;
    lowerMusicForVideo();
    currentVideoCallback=cb;
    const vf=document.getElementById('videoFloat');
    const v=document.getElementById('marioVideo');
    const videoSrc=VIDEOS[type]||VIDEOS.bienvenida;
    console.log('Loading video:',videoSrc);
    
    // Limpiar handlers anteriores
    v.onended=null;
    v.onerror=null;
    
    v.src=videoSrc;
    v.load();
    vf.classList.remove('hiding');
    vf.classList.add('active');
    v.play().then(()=>{
        console.log('Video playing');
    }).catch(e=>{
        console.log('Video play error:',e);
        closeVideo();
    });
    v.onended=function(){
        console.log('Video ended');
        closeVideo();
    };
    v.onerror=function(e){
        console.log('Video error:',e);
        if(videoPlaying&&!videoClosing)closeVideo();
    };
}

function closeVideo(){
    if(videoClosing)return;
    videoClosing=true;
    const vf=document.getElementById('videoFloat');
    const v=document.getElementById('marioVideo');
    
    // Limpiar handlers ANTES de tocar el src
    v.onended=null;
    v.onerror=null;
    
    vf.classList.add('hiding');
    vf.classList.remove('active');
    restoreMusicAfterVideo();
    setTimeout(()=>{
        v.pause();
        v.removeAttribute('src');
        v.load();
        videoPlaying=false;
        videoClosing=false;
        if(currentVideoCallback){
            const cb=currentVideoCallback;
            currentVideoCallback=null;
            cb();
        }
    },600);
}

function startWithVideo(){
    startMusic();
    showVideo('bienvenida',()=>{
        go('s1');
    });
}

// ========== AI CHAT FUNCTIONS ==========
const MARIO_SYSTEM="Eres el Maestro Mario Flores Corona, instructor de HVAC/Refrigeracion/Electricidad con 25+ a√±os de experiencia. Tu escuela es ACVOLT Tech School en San Bernardino, California. Tu frase: Si no mides, est√°s adivinando. Responde en 2-3 oraciones MAX. S√© personal y motivador. Usa frases como √≥rale, vamos con todo, as√≠ se hace. NO uses markdown ni emojis.";

async function getAIResponse(msg){
    try{
        const r=await fetch(SUPABASE_URL+'/tutor-ia-chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                messages:[{role:'user',content:msg}],
                system:MARIO_SYSTEM,
                max_tokens:150
            })
        });
        if(!r.ok)throw new Error('Chat API error');
        const d=await r.json();
        return d.content&&d.content[0]?d.content[0].text:'¬°√ìrale t√©cnico! Hubo un problema, intenta de nuevo.';
    }catch(e){
        console.error('AI Chat Error:',e);
        return '¬°√ìrale! Problema de conexi√≥n. Intenta de nuevo.';
    }
}

let speechAbort=null;

async function speakText(text){
    // Cancel any ongoing speech
    if(speechAbort)speechAbort.cancelled=true;
    const thisAbort={cancelled:false};
    speechAbort=thisAbort;
    
    try{
        isSpeaking=true;
        lowerMusicForSpeech();
        document.getElementById('speakingIndicator').classList.add('active');
        
        // Split into chunks at sentence boundaries
        const chunks=splitTextChunks(text,500);
        
        // Pre-fetch first chunk
        let nextBlob=await fetchVoiceChunk(chunks[0]);
        if(thisAbort.cancelled)return cleanupSpeech();
        
        for(let i=0;i<chunks.length;i++){
            if(thisAbort.cancelled)return cleanupSpeech();
            
            const currentBlob=nextBlob;
            if(!currentBlob)continue;
            
            // Start pre-fetching NEXT chunk while current plays
            const fetchNext=(i+1<chunks.length)?fetchVoiceChunk(chunks[i+1]):Promise.resolve(null);
            
            // Play current chunk
            const audioUrl=URL.createObjectURL(currentBlob);
            const audio=document.getElementById('aiAudio');
            audio.src=audioUrl;
            
            await new Promise(resolve=>{
                audio.onended=()=>{URL.revokeObjectURL(audioUrl);resolve();};
                audio.onerror=()=>{URL.revokeObjectURL(audioUrl);resolve();};
                audio.play().catch(()=>resolve());
            });
            
            if(thisAbort.cancelled)return cleanupSpeech();
            
            // Next chunk should already be fetched
            nextBlob=await fetchNext;
        }
        
        cleanupSpeech();
    }catch(e){
        console.error('Voice Error:',e);
        cleanupSpeech();
    }
}

async function fetchVoiceChunk(text){
    try{
        const r=await fetch(SUPABASE_URL+'/tutor-ia-voice',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({text:text.trim()})
        });
        if(!r.ok)return null;
        return await r.blob();
    }catch(e){return null;}
}

function cleanupSpeech(){
    isSpeaking=false;
    document.getElementById('speakingIndicator').classList.remove('active');
    restoreMusicAfterSpeech();
}

function stopSpeech(){
    if(speechAbort)speechAbort.cancelled=true;
    const audio=document.getElementById('aiAudio');
    audio.pause();
    audio.removeAttribute('src');
    cleanupSpeech();
}

function splitTextChunks(text,maxLen){
    if(text.length<=maxLen)return[text];
    const chunks=[];
    let remaining=text;
    while(remaining.length>0){
        if(remaining.length<=maxLen){chunks.push(remaining);break;}
        let splitAt=-1;
        for(let i=Math.min(maxLen,remaining.length)-1;i>=maxLen*0.4;i--){
            if('.!?'.includes(remaining[i])){splitAt=i+1;break;}
        }
        if(splitAt===-1){
            for(let i=Math.min(maxLen,remaining.length)-1;i>=maxLen*0.4;i--){
                if(',;:'.includes(remaining[i])){splitAt=i+1;break;}
            }
        }
        if(splitAt===-1){
            for(let i=Math.min(maxLen,remaining.length)-1;i>=maxLen*0.4;i--){
                if(remaining[i]===' '){splitAt=i+1;break;}
            }
        }
        if(splitAt===-1)splitAt=maxLen;
        chunks.push(remaining.substring(0,splitAt));
        remaining=remaining.substring(splitAt);
    }
    return chunks;
}

function openAIChat(){
    document.getElementById('aiModal').classList.add('active');
}

function closeAIChat(){
    document.getElementById('aiModal').classList.remove('active');
    const audio=document.getElementById('aiAudio');
    audio.pause();
    isSpeaking=false;
    document.getElementById('speakingIndicator').classList.remove('active');
}

async function sendAIMessage(){
    const input=document.getElementById('aiInput');
    const msgs=document.getElementById('aiMessages');
    const sendBtn=document.getElementById('sendBtn');
    const txt=input.value.trim();
    if(!txt||isSpeaking)return;
    
    // Desbloquear audio en el click
    unlockAudio();
    
    // Disable input while processing
    input.disabled=true;
    sendBtn.disabled=true;
    
    // Show user message
    msgs.innerHTML+='<div class="ai-msg user">'+txt+'</div>';
    input.value='';
    
    // Show typing indicator
    msgs.innerHTML+='<div class="ai-msg mario" id="typing"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
    msgs.scrollTop=msgs.scrollHeight;
    
    // Get AI text response
    const response=await getAIResponse(txt);
    
    // Remove typing indicator and show response
    const typing=document.getElementById('typing');
    if(typing)typing.remove();
    msgs.innerHTML+='<div class="ai-msg mario">'+response+'</div>';
    msgs.scrollTop=msgs.scrollHeight;
    
    // Re-enable input
    input.disabled=false;
    sendBtn.disabled=false;
    input.focus();
    
    // Speak the response
    await speakText(response);
}

// ========== CONFETTI ==========
function cft(){
    const c=document.getElementById('conf');
    c.innerHTML='';
    const cols=['#ff6b2b','#00d4ff','#f1c40f','#2ecc71','#e74c3c','#9b59b6'];
    for(let i=0;i<25;i++){
        const p=document.createElement('div');
        p.className='cf';
        p.style.left=Math.random()*100+'%';
        p.style.background=cols[Math.floor(Math.random()*cols.length)];
        p.style.animationDelay=Math.random()*1.5+'s';
        p.style.animationDuration=(2+Math.random()*1.5)+'s';
        p.style.width=(6+Math.random()*6)+'px';
        p.style.height=p.style.width;
        p.style.borderRadius=Math.random()>.5?'50%':'2px';
        c.appendChild(p);
    }
    setTimeout(()=>c.innerHTML='',3500);
}

// ========== TRANSLATIONS ==========
const T={
es:{step_1:'Paso 1 de 5',step_2:'Paso 2 de 5',step_3:'Paso 3 de 5',step_4:'Paso 4 de 5',step_5:'Paso 5 de 5',welcome_speech:'¬°Bienvenido t√©cnico! Soy el Maestro Mario y voy a ser tu gu√≠a. ¬øC√≥mo te llamas?',name_ph:'Escribe tu nombre aqu√≠...',continue:'Continuar ‚Üí',level_speech:'¬°Mucho gusto, {name}! ¬øEn qu√© nivel t√©cnico te encuentras?',spec_speech:'¬°Excelente, {name}! ¬øEn qu√© √°reas te sientes m√°s fuerte?',multi_hint:'Selecciona una o m√°s opciones',school_speech:'¬°Vas muy bien, {name}! ¬øD√≥nde est√°s estudiando?',goals_speech:'¬°√öltima pregunta, {name}! ¬øQu√© quieres lograr?',route_speech:'¬°Perfecto, {name}! He creado tu ruta personalizada. ¬°Vamos con todo!',start_btn:'üöÄ ¬°Empezar a Aprender!',lv1:'Estudiante',lv1d:'Estoy aprendiendo lo b√°sico',lv2:'Ayudante',lv2d:'Ya ando en el campo con un t√©cnico',lv3:'T√©cnico',lv3d:'Ya trabajo solo pero quiero mejorar',lv4:'Avanzado',lv4d:'Quiero dominar el oficio',lv5:'Maestro',lv5d:'Quiero ser l√≠der / abrir mi empresa',sp_e:'Electricidad',sp_ed:'Circuitos, controles, cableado',sp_a:'Aire Acondicionado',sp_ad:'Splits, centrales, mini splits',sp_r:'Refrigeraci√≥n',sp_rd:'C√°maras fr√≠as, refrigeradores comerciales',sp_h:'Calefacci√≥n',sp_hd:'Furnaces, bombas de calor',sp_x:'Estoy empezando en todo',sp_xd:'Quiero aprender de todo',sc_ac:'ACVOLT Tech School',sc_acd:'Estudiante actual de ACVOLT',sc_ot:'Otra escuela',sc_otd:'Estoy en otra instituci√≥n',sc_sf:'Aprendo por mi cuenta',sc_sfd:'YouTube, libros, campo',sc_dn:'Ya termin√© mis estudios',sc_dnd:'Tengo certificaci√≥n/diploma',gl_c:'Pasar mis certificaciones',gl_cd:'EPA, NATE, OSHA, NCCER',gl_d:'Mejorar mis diagn√≥sticos',gl_dd:'Ser m√°s preciso en el campo',gl_b:'Abrir mi propio negocio',gl_bd:'De t√©cnico a empresario',gl_m:'Ganar m√°s dinero',gl_md:'Subir mi valor como t√©cnico',r_elec:'Fundamentos El√©ctricos',r_elecd:'Circuitos, Ley de Ohm, diagramas',r_ac:'Aire Acondicionado',r_acd:'Presiones, carga de refrigerante',r_ref:'Refrigeraci√≥n Comercial',r_refd:'C√°maras fr√≠as, controles, defrost',r_heat:'Calefacci√≥n',r_heatd:'Furnaces, bombas de calor, gas',r_cert:'Preparaci√≥n para Certificaciones',r_certd:'EPA 608 ‚Ä¢ NATE ‚Ä¢ OSHA ‚Ä¢ NCCER',r_biz:'De T√©cnico a Empresario',r_bizd:'Licencias, estimados, clientes'},
en:{step_1:'Step 1 of 5',step_2:'Step 2 of 5',step_3:'Step 3 of 5',step_4:'Step 4 of 5',step_5:'Step 5 of 5',welcome_speech:"Welcome technician! I'm Maestro Mario and I'll be your guide. What's your name?",name_ph:'Type your name here...',continue:'Continue ‚Üí',level_speech:"Nice to meet you, {name}! What's your technical level?",spec_speech:'Excellent, {name}! What areas are you strongest in?',multi_hint:'Select one or more options',school_speech:'Great progress, {name}! Where are you studying?',goals_speech:'Last question, {name}! What do you want to achieve?',route_speech:"Perfect, {name}! I've created your personalized path. Let's go!",start_btn:'üöÄ Start Learning!',lv1:'Student',lv1d:"I'm learning the basics",lv2:'Helper',lv2d:"I'm in the field with a technician",lv3:'Technician',lv3d:'I work solo but want to improve',lv4:'Advanced',lv4d:'I want to master the trade',lv5:'Master',lv5d:'I want to lead / start my business',sp_e:'Electrical',sp_ed:'Circuits, controls, wiring',sp_a:'Air Conditioning',sp_ad:'Splits, central, mini splits',sp_r:'Refrigeration',sp_rd:'Walk-in coolers, commercial',sp_h:'Heating',sp_hd:'Furnaces, heat pumps',sp_x:'Starting in everything',sp_xd:'I want to learn it all',sc_ac:'ACVOLT Tech School',sc_acd:'Current ACVOLT student',sc_ot:'Another school',sc_otd:"I'm at another institution",sc_sf:'Self-taught',sc_sfd:'YouTube, books, field',sc_dn:'Completed studies',sc_dnd:'I have certification/diploma',gl_c:'Pass certifications',gl_cd:'EPA, NATE, OSHA, NCCER',gl_d:'Improve diagnostics',gl_dd:'Be more precise in the field',gl_b:'Start my business',gl_bd:'From tech to owner',gl_m:'Earn more money',gl_md:'Increase my value',r_elec:'Electrical Fundamentals',r_elecd:"Circuits, Ohm's law, diagrams",r_ac:'Air Conditioning',r_acd:'Pressure diagnostics, charging',r_ref:'Commercial Refrigeration',r_refd:'Walk-in coolers, controls, defrost',r_heat:'Heating Systems',r_heatd:'Furnaces, heat pumps, gas',r_cert:'Certification Prep',r_certd:'EPA 608 ‚Ä¢ NATE ‚Ä¢ OSHA ‚Ä¢ NCCER',r_biz:'Tech to Business Owner',r_bizd:'Licensing, estimates, clients'}
};

const t=k=>(T[D.lang][k]||k).replace('{name}',D.name);
const u=()=>{document.querySelectorAll('[data-t]').forEach(e=>e.textContent=t(e.getAttribute('data-t')));document.querySelectorAll('[data-tp]').forEach(e=>e.placeholder=t(e.getAttribute('data-tp')));};
const go=id=>{document.querySelectorAll('.s').forEach(s=>s.classList.remove('on'));document.getElementById(id).classList.add('on');window.scrollTo(0,0);};
const rx=(id,c)=>{const e=document.getElementById(id);if(e){e.classList.add(c);setTimeout(()=>e.classList.remove(c),1500);}};

function setLang(l){D.lang=l;unlockAudio();u();go('s2');document.getElementById('nm').placeholder=t('name_ph');speakText(t('welcome_speech'));}
function sName(){D.name=document.getElementById('nm').value.trim();u();bLvl();go('s3');rx('a3','nod');speakText(t('level_speech'));}
function pLvl(e,v){document.querySelectorAll('#lo .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.level=v;document.getElementById('b3').disabled=false;rx('a3','nod');}
function sLvl(){u();bSpc();go('s4');speakText(t('spec_speech'));}
function tSpc(e,k){if(k==='all'){document.querySelectorAll('#so .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.specs=['all'];}else{document.querySelector('#so .oc:last-child').classList.remove('sel');D.specs=D.specs.filter(s=>s!=='all');e.classList.toggle('sel');if(e.classList.contains('sel'))D.specs.push(k);else D.specs=D.specs.filter(s=>s!==k);}document.getElementById('b4').disabled=D.specs.length===0;rx('a4','nod');}
function sSpc(){u();bSch();go('s5');speakText(t('school_speech'));}
function pSch(e,v){document.querySelectorAll('#sco .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.school=v;document.getElementById('b5').disabled=false;rx('a5','nod');}
function sSch(){u();bGol();go('s6');speakText(t('goals_speech'));}
function tGol(e,k){e.classList.toggle('sel');if(e.classList.contains('sel'))D.goals.push(k);else D.goals=D.goals.filter(g=>g!==k);document.getElementById('b6').disabled=D.goals.length===0;rx('a6','nod');}
function sGol(){u();bRt();go('s7');cft();rx('a7','cel');speakText(t('route_speech'));}

function bLvl(){document.getElementById('lo').innerHTML=[{k:1,i:'üìö',t:'lv1',d:'lv1d'},{k:2,i:'üîß',t:'lv2',d:'lv2d'},{k:3,i:'‚öôÔ∏è',t:'lv3',d:'lv3d'},{k:4,i:'üéØ',t:'lv4',d:'lv4d'},{k:5,i:'üëë',t:'lv5',d:'lv5d'}].map(x=>'<div class="oc" onclick="pLvl(this,'+x.k+')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div></div>').join('');}
function bSpc(){document.getElementById('so').innerHTML=[{k:'electrical',i:'‚ö°',t:'sp_e',d:'sp_ed'},{k:'ac',i:'‚ùÑÔ∏è',t:'sp_a',d:'sp_ad'},{k:'refrigeration',i:'üßä',t:'sp_r',d:'sp_rd'},{k:'heating',i:'üî•',t:'sp_h',d:'sp_hd'},{k:'all',i:'üåü',t:'sp_x',d:'sp_xd'}].map(x=>'<div class="oc" onclick="tSpc(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div><div class="ck"></div></div>').join('');}
function bSch(){document.getElementById('sco').innerHTML=[{k:'acvolt',i:'üéì',t:'sc_ac',d:'sc_acd'},{k:'other',i:'üè´',t:'sc_ot',d:'sc_otd'},{k:'self',i:'üí™',t:'sc_sf',d:'sc_sfd'},{k:'done',i:'‚úÖ',t:'sc_dn',d:'sc_dnd'}].map(x=>'<div class="oc" onclick="pSch(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div></div>').join('');}
function bGol(){document.getElementById('go2').innerHTML=[{k:'certs',i:'üìã',t:'gl_c',d:'gl_cd'},{k:'diag',i:'üîç',t:'gl_d',d:'gl_dd'},{k:'biz',i:'üè¢',t:'gl_b',d:'gl_bd'},{k:'money',i:'üí∞',t:'gl_m',d:'gl_md'}].map(x=>'<div class="oc" onclick="tGol(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div><div class="ck"></div></div>').join('');}
function bRt(){var r=[];if(D.specs.includes('all')||D.specs.includes('electrical'))r.push({i:'‚ö°',t:'r_elec',d:'r_elecd'});if(D.specs.includes('all')||D.specs.includes('ac'))r.push({i:'‚ùÑÔ∏è',t:'r_ac',d:'r_acd'});if(D.specs.includes('all')||D.specs.includes('refrigeration'))r.push({i:'üßä',t:'r_ref',d:'r_refd'});if(D.specs.includes('all')||D.specs.includes('heating'))r.push({i:'üî•',t:'r_heat',d:'r_heatd'});if(D.goals.includes('certs'))r.push({i:'üìã',t:'r_cert',d:'r_certd'});if(D.goals.includes('biz'))r.push({i:'üè¢',t:'r_biz',d:'r_bizd'});document.getElementById('rl').innerHTML=r.map((x,i)=>'<div class="rt"><div class="rn">'+(i+1)+'</div><div><div class="rtt">'+x.i+' '+t(x.t)+'</div><div class="rd">'+t(x.d)+'</div></div></div>'+(i<r.length-1?'<div class="rl"></div>':'')).join('');}

function startApp(){enterStudyMode();startQuiz();console.log('Profile:',JSON.stringify(D,null,2));}

// ========== QUIZ SYSTEM ==========
const QUIZ_PRINCIPIANTE=[
// ELECTRICIDAD B√ÅSICA (13)
{cat:'‚ö° Electricidad B√°sica',q:'El voltaje en un circuito se puede comparar mejor con:',o:['La cantidad de agua en un tanque','La presi√≥n que empuja el agua por la tuber√≠a','El di√°metro de la tuber√≠a','La velocidad del agua al salir'],c:1,e:'El voltaje es la diferencia de potencial que empuja los electrones, similar a la presi√≥n del agua.',a:'Imagina una manguera de jard√≠n: el voltaje es como la presi√≥n del agua. Sin presi√≥n no sale nada. Los voltios son esa fuerza que empuja la electricidad por los cables.'},
{cat:'‚ö° Electricidad B√°sica',q:'Si un circuito tiene 240V y 20A de corriente, ¬øcu√°l es la resistencia seg√∫n Ohm?',o:['4,800 ohms','260 ohms','12 ohms','220 ohms'],c:2,e:'V = I √ó R, entonces R = V/I = 240/20 = 12 ohms.',a:'Es como dividir galletas entre ni√±os. 240 galletas (voltios) entre 20 ni√±os (amperios) = 12 galletas cada uno (ohms). R = V √∑ I.'},
{cat:'‚ö° Electricidad B√°sica',q:'Est√°s midiendo voltaje en un tomacorriente y el mult√≠metro marca 0V. ¬øCu√°l es la causa M√ÅS probable?',o:['El tomacorriente est√° da√±ado','El breaker est√° apagado o disparado','El mult√≠metro est√° en la escala de amperios','Las tres podr√≠an causar la lectura de 0V'],c:3,e:'Las tres situaciones pueden dar lectura de 0V. Un buen t√©cnico verifica cada posibilidad.',a:'Es como cuando no sale agua de la llave: puede ser que cerraron la v√°lvula, que no hay agua en la calle, o que la llave est√° rota. No asumas, verifica cada cosa.'},
{cat:'‚ö° Electricidad B√°sica',q:'En un circuito en paralelo, si se quema una carga, las dem√°s:',o:['Se apagan todas inmediatamente','Siguen funcionando pero con m√°s voltaje','Siguen funcionando normalmente','Funcionan pero m√°s lento'],c:2,e:'En paralelo cada carga tiene su propio camino. Si una falla, las dem√°s no se afectan.',a:'Piensa en las casas de tu cuadra: si tu vecino apaga sus luces, las tuyas siguen prendidas. Cada casa tiene su propia conexi√≥n. Eso es paralelo.'},
{cat:'‚ö° Electricidad B√°sica',q:'Un fusible de 15A se quema repetidamente. La acci√≥n correcta es:',o:['Poner uno de 20A para que aguante m√°s','Poner uno de 30A y resolver despu√©s','Buscar la causa del exceso de corriente','Puentear el fusible temporalmente'],c:2,e:'NUNCA pongas un fusible m√°s grande. Hay que encontrar por qu√© est√° jalando m√°s corriente de lo normal.',a:'El fusible es como la alarma de incendios. Si se activa, no le quitas las pilas ‚Äî buscas el fuego. Poner uno m√°s grande es como quitar la alarma: la casa se va a quemar.'},
{cat:'‚ö° Electricidad B√°sica',q:'Un equipo residencial de AC necesita 240V. Al medir entre las dos l√≠neas (hot) obtienes 208V. Esto indica:',o:['El equipo est√° da√±ado','Es alimentaci√≥n trif√°sica, no monof√°sica','El mult√≠metro necesita calibraci√≥n','El voltaje est√° bajo y hay que llamar a la compa√±√≠a el√©ctrica'],c:1,e:'208V entre fases indica alimentaci√≥n trif√°sica (com√∫n en comercial). Residencial monof√°sico da 240V.',a:'Es como pedir una pizza familiar y te traen una mediana. No est√° mal, pero no es lo que pediste. 208V funciona diferente que 240V y puede afectar el rendimiento del equipo.'},
{cat:'‚ö° Electricidad B√°sica',q:'El cable verde con franja amarilla en un circuito SIEMPRE debe ir a:',o:['La l√≠nea caliente (hot)','El neutro','El ground (tierra)','Depende del circuito'],c:2,e:'Verde o verde/amarillo es SIEMPRE tierra. Nunca se usa para otra cosa, es una regla de seguridad absoluta.',a:'Verde = pasto = tierra. As√≠ como el pasto siempre est√° abajo, el cable verde siempre va a tierra. Si alguien lo us√≥ para otra cosa, ese electricista hizo una chambonada peligrosa.'},
{cat:'‚ö° Electricidad B√°sica',q:'Un motor monof√°sico no arranca pero zumba. El componente M√ÅS probable que fall√≥ es:',o:['El contactor','El capacitor de arranque','El termostato','El breaker'],c:1,e:'Un motor que zumba pero no gira casi siempre indica capacitor de arranque da√±ado.',a:'El capacitor es como el empuj√≥n que le das a un columpio. El motor necesita ese empuj√≥n inicial. Si el capacitor falla, el motor quiere girar pero no puede, por eso zumba.'},
{cat:'‚ö° Electricidad B√°sica',q:'Un cortocircuito se diferencia de una sobrecarga porque:',o:['La sobrecarga es m√°s peligrosa','El cortocircuito genera corriente muy alta instant√°neamente','La sobrecarga dispara el breaker m√°s r√°pido','No hay diferencia real entre ambos'],c:1,e:'El cortocircuito genera corriente masiva instant√°nea. La sobrecarga es un exceso gradual.',a:'Un cortocircuito es como una presa que se revienta: el agua sale toda de golpe. La sobrecarga es como dejar todas las llaves abiertas poco a poco. Ambos son problemas, pero el cortocircuito es m√°s violento.'},
{cat:'‚ö° Electricidad B√°sica',q:'La corriente AC a 60Hz en USA cambia de direcci√≥n:',o:['60 veces por segundo','120 veces por segundo','60 veces por minuto','Una vez cada 60 segundos'],c:1,e:'60Hz = 60 ciclos, pero cada ciclo tiene dos cambios de direcci√≥n, entonces son 120 cambios por segundo.',a:'Un ciclo es como un columpio: va y viene, eso son DOS movimientos. Entonces 60 ciclos = 120 cambios de direcci√≥n. Esta es una pregunta capciosa que muchos t√©cnicos fallan.'},
{cat:'‚ö° Electricidad B√°sica',q:'Un equipo etiquetado como 1500W a 120V, ¬øcu√°ntos amperios consume?',o:['12.5A','180,000A','15A','1,380A'],c:0,e:'I = W/V = 1500/120 = 12.5A.',a:'Watts √∑ Voltios = Amperios. Es como repartir: 1500 entre 120 = 12.5. Este c√°lculo lo vas a hacer TODOS los d√≠as en el campo.'},
{cat:'‚ö° Electricidad B√°sica',q:'El contactor del compresor se cierra pero el compresor no arranca. ¬øQu√© revisas PRIMERO?',o:['El termostato','El voltaje que llega al compresor','El nivel de refrigerante','La presi√≥n del sistema'],c:1,e:'Si el contactor cierra, la se√±al de control est√° bien. Hay que verificar que el voltaje llega al compresor.',a:'Es como cuando enciendes el switch de la luz pero el foco no prende. El switch funciona, entonces el problema est√° del switch al foco. Mide voltaje en los terminales del compresor.'},
{cat:'‚ö° Electricidad B√°sica',q:'¬øCu√°l es la diferencia principal entre un capacitor de arranque (start) y uno de marcha (run)?',o:['El de arranque tiene m√°s microfaradios y se desconecta al arrancar','El de marcha tiene m√°s microfaradios','Son intercambiables','El de arranque es m√°s peque√±o f√≠sicamente'],c:0,e:'El start cap tiene m√°s MFD, da el empuj√≥n inicial y se desconecta. El run cap queda conectado siempre.',a:'El capacitor de arranque es como el turbo de un carro: te da un empuj√≥n fuerte al inicio y luego se apaga. El de marcha es como el motor regular que trabaja todo el tiempo.'},

// REFRIGERACI√ìN B√ÅSICA (13)
{cat:'üßä Refrigeraci√≥n B√°sica',q:'En el ciclo de refrigeraci√≥n, el componente que ABSORBE calor del espacio es:',o:['El condensador, porque ah√≠ se condensa el gas','El evaporador, porque ah√≠ se evapora el refrigerante','El compresor, porque genera presi√≥n','La v√°lvula TXV, porque reduce la temperatura'],c:1,e:'El evaporador absorbe calor al evaporar el refrigerante. El nombre lo dice: evapora.',a:'El evaporador es como un vaso con hielo: cuando pones el vaso en la mesa, el hielo absorbe el calor del ambiente y se derrite. El refrigerante hace lo mismo, absorbe calor y se evapora.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'El compresor de un sistema de AC est√° caliente al tacto y hace ruido. ¬øEs normal?',o:['No, un compresor siempre debe estar fr√≠o','S√≠, comprimir gas genera calor y vibraci√≥n','Solo si es un compresor scroll','Depende de la marca'],c:1,e:'Comprimir gas siempre genera calor. Un compresor caliente que funciona bien es completamente normal.',a:'Infla un globo y siente la boquilla: est√° caliente. Comprimir aire genera calor. El compresor hace lo mismo pero con refrigerante. Caliente = trabajando. Pero OJO: demasiado caliente = problema.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'Un sistema con R-410A tiene presi√≥n de succi√≥n de 118 PSI. Esto corresponde a una temperatura de evaporaci√≥n de aproximadamente:',o:['32¬∞F','40¬∞F','50¬∞F','25¬∞F'],c:1,e:'R-410A a 118 PSI en succi√≥n = aproximadamente 40¬∞F de temperatura de evaporaci√≥n.',a:'Cada refrigerante tiene su tabla de presi√≥n-temperatura. Es como un diccionario: 118 PSI en R-410A siempre = 40¬∞F. Memoriza los valores comunes o lleva tu tabla siempre.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'¬øQu√© pasa si cargas refrigerante l√≠quido por el lado de succi√≥n (baja)?',o:['Enfr√≠a m√°s r√°pido el sistema','Puede da√±ar el compresor por golpe de l√≠quido','No pasa nada diferente','El refrigerante se evapora autom√°ticamente'],c:1,e:'L√≠quido en succi√≥n puede causar slugging y da√±ar las v√°lvulas del compresor.',a:'Es como tragar un cubo de hielo entero: te puedes ahogar. El compresor est√° dise√±ado para gas, no l√≠quido. El l√≠quido no se comprime y rompe las v√°lvulas. Siempre carga en vapor por el lado de baja.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'El superheat se mide restando:',o:['Temperatura de succi√≥n menos temperatura ambiente','Temperatura de l√≠nea de succi√≥n menos temperatura de saturaci√≥n a la presi√≥n de succi√≥n','Temperatura del evaporador menos temperatura del condensador','Temperatura del aire de retorno menos la del supply'],c:1,e:'Superheat = Temp real de la l√≠nea de succi√≥n - Temp de saturaci√≥n seg√∫n la presi√≥n de succi√≥n.',a:'Es como medir fiebre: la temperatura normal es 98.6¬∞F (saturaci√≥n). Si tienes 101¬∞F, tu superheat es 2.4¬∞F. Mides cu√°nto m√°s caliente est√° el gas comparado con lo que deber√≠a estar.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'Los manifold gauges muestran azul 65 PSI y rojo 250 PSI en un sistema R-22. Esto sugiere:',o:['Presiones normales de operaci√≥n','Sistema sobrecargado','Posible restricci√≥n o bajo flujo de aire','Fuga de refrigerante'],c:0,e:'Para R-22, succi√≥n ~65 PSI y descarga ~250 PSI son presiones normales en d√≠a caluroso.',a:'Es como cuando el doctor te toma la presi√≥n: 120/80 es normal. En R-22, 65/250 es saludable. Aprende a leer los gauges como el doctor lee tu presi√≥n.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'Si el superheat es demasiado alto, ¬øqu√© indica generalmente?',o:['Hay mucho refrigerante en el sistema','Hay poco refrigerante o flujo de aire excesivo','El compresor est√° fallando','La v√°lvula TXV est√° abierta de m√°s'],c:1,e:'Superheat alto = poco refrigerante llegando al evaporador, o demasiado aire pasando por el evaporador.',a:'Superheat alto es como una olla con poca agua en la estufa: se seca r√°pido y se sobrecalienta. El evaporador necesita suficiente refrigerante para absorber calor.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'La manguera AMARILLA del manifold se conecta normalmente a:',o:['El lado de baja presi√≥n','El lado de alta presi√≥n','El tanque de refrigerante o bomba de vac√≠o','El compresor directamente'],c:2,e:'Azul = baja (succi√≥n), Roja = alta (descarga), Amarilla = centro (tanque, vac√≠o, o recuperaci√≥n).',a:'Piensa en un sem√°foro: azul fr√≠o (baja), rojo caliente (alta), y amarillo en medio. La manguera amarilla es tu puente al tanque.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'La v√°lvula TXV regula el flujo de refrigerante bas√°ndose en:',o:['La presi√≥n de descarga del compresor','La temperatura y presi√≥n del evaporador (superheat)','La temperatura ambiente exterior','El voltaje del sistema'],c:1,e:'La TXV sensa el superheat para modular cu√°nto refrigerante entra al evaporador.',a:'La TXV es como la llave del agua: si el evaporador necesita m√°s refrigerante (superheat alto), abre m√°s. Si tiene mucho (superheat bajo), cierra. Es autom√°tica e inteligente.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'Un filter drier saturado puede causar:',o:['Mayor eficiencia del sistema','Una restricci√≥n que se ve como un evaporador parcialmente congelado','Mejor lubricaci√≥n del compresor','Aumento de refrigerante'],c:1,e:'Un filter drier tapado restringe el flujo, causando ca√≠da de presi√≥n y congelamiento parcial.',a:'Es como un filtro de caf√© tapado: si est√° sucio, el caf√© pasa poquito. Si el drier est√° saturado, el refrigerante no pasa bien y el evaporador se congela de un solo lado.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'Para comprar y manejar refrigerantes en USA necesitas certificaci√≥n:',o:['NATE tipo I','OSHA 30 horas','EPA 608','HVAC Excellence'],c:2,e:'La certificaci√≥n EPA 608 es OBLIGATORIA por ley federal. Sin ella, no puedes comprar refrigerante.',a:'EPA 608 es tu licencia de manejar del HVAC. Sin ella no compras refrigerante, no trabajas legalmente. Es como manejar sin licencia: te pueden multar miles de d√≥lares.'},
{cat:'üßä Refrigeraci√≥n B√°sica',q:'El subcooling se mide en:',o:['La l√≠nea de succi√≥n, restando temperaturas','La l√≠nea de l√≠quido, restando la temp real de la temp de saturaci√≥n a presi√≥n de descarga','El evaporador, midiendo la temperatura del aire','El compresor, midiendo su amperaje'],c:1,e:'Subcooling = Temp de saturaci√≥n a presi√≥n de alta - Temp real de la l√≠nea de l√≠quido.',a:'Si el superheat es la fiebre del gas, el subcooling es lo fr√≠o del l√≠quido. Mides cu√°nto m√°s fr√≠o est√° el l√≠quido comparado con su punto de condensaci√≥n. Normal es 10-15¬∞F.'},

{cat:'üßä Refrigeraci√≥n B√°sica',q:'El subcooling se mide en:',o:['La l√≠nea de succi√≥n, restando temperaturas','La l√≠nea de l√≠quido, restando la temp real de la temp de saturaci√≥n a presi√≥n de descarga','El evaporador, midiendo la temperatura del aire','El compresor, midiendo su amperaje'],c:1,e:'Subcooling = Temp de saturaci√≥n a presi√≥n de alta - Temp real de la l√≠nea de l√≠quido.',a:'Si el superheat es la fiebre del gas, el subcooling es lo fr√≠o del l√≠quido. Mides cu√°nto m√°s fr√≠o est√° el l√≠quido comparado con su punto de condensaci√≥n. Normal es 10-15¬∞F.'},

// HERRAMIENTAS Y SEGURIDAD (12)
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'PPE en HVAC incluye lentes de seguridad, guantes y zapatos. ¬øCu√°ndo es aceptable NO usar PPE?',o:['Cuando el trabajo es r√°pido y sencillo','Cuando hace mucho calor','Nunca ‚Äî PPE es obligatorio en TODO momento','Cuando el supervisor no est√° viendo'],c:2,e:'PPE es obligatorio SIEMPRE. No hay excusa. Un accidente toma solo un segundo.',a:'Los accidentes no avisan. No dicen: oye, ponte los lentes que te va a saltar algo. Pasan en un parpadeo. PPE siempre, sin excepci√≥n, aunque sea un trabajo de 5 minutos.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Hiciste Lockout/Tagout en el panel. Antes de tocar los cables, debes:',o:['Empezar a trabajar, ya desconectaste','Verificar ausencia de voltaje con tu mult√≠metro','Preguntarle al cliente si ya apag√≥ todo','Revisar visualmente que no hay chispas'],c:1,e:'SIEMPRE verifica con tu mult√≠metro despu√©s de LOTO. Puede haber fuentes de energ√≠a m√∫ltiples.',a:'Lockout es como ponerle seguro a una pistola. Pero un profesional SIEMPRE verifica que la c√°mara est√° vac√≠a. Desconectar y NO verificar es como jugar ruleta rusa.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Tu detector de fugas electr√≥nico no encuentra la fuga pero sospechas que existe. ¬øQu√© otro m√©todo usas?',o:['Agregar m√°s refrigerante y ver si se mantiene','Presurizar con nitr√≥geno y usar agua jabonosa','Presurizar con ox√≠geno para mejor detecci√≥n','Usar una vela para ver si la llama se mueve'],c:1,e:'Nitr√≥geno + agua jabonosa es el m√©todo secundario m√°s confiable para encontrar fugas.',a:'Las burbujas no mienten. Presuriza con nitr√≥geno y ponte agua jabonosa en las conexiones. Donde haga burbujas, ah√≠ est√° la fuga. Nunca uses ox√≠geno: puede explotar con aceite.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Despu√©s de hacer vac√≠o, tu micron gauge marca 500 micrones. Cierras la v√°lvula y esperas 10 minutos. Sube a 1500. Esto indica:',o:['Vac√≠o exitoso, puedes cargar','Hay humedad en el sistema que se evapora','Hay una fuga en el sistema','Puede ser fuga O humedad, necesitas m√°s pruebas'],c:3,e:'Un rise de 500 a 1500 puede ser humedad o fuga. Necesitas m√°s tiempo o pruebas adicionales.',a:'Es como inflar una llanta y ver si baja: si baja r√°pido = fuga. Si baja poquito = puede ser la temperatura. A 1500 micrones despu√©s de 10 min, no sabes seguro. Haz m√°s vac√≠o y espera m√°s.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Al soldar tuber√≠a de cobre con un tanque de refrigerante conectado, debes:',o:['No hay problema, el refrigerante no es inflamable','Fluir nitr√≥geno por la tuber√≠a mientras sueldas','Solo alejar el tanque un poco','Usar el tanque como soporte ya que es pesado'],c:1,e:'SIEMPRE fluye nitr√≥geno al soldar. Previene oxidaci√≥n interna y es un requisito de seguridad.',a:'Al soldar sin nitr√≥geno, el interior del cobre se oxida y esos pedacitos sueltos van a tapar la TXV o el drier. El nitr√≥geno es como poner un escudo invisible dentro del tubo.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'¬øQu√© haces si hueles refrigerante fuerte en un cuarto mec√°nico cerrado?',o:['Es normal, los cuartos mec√°nicos huelen as√≠','Abrir ventilaci√≥n y salir si es necesario, puede desplazar ox√≠geno','Ignorarlo si no te mareas','Prender un ventilador el√©ctrico dentro del cuarto'],c:1,e:'Los refrigerantes desplazan ox√≠geno en espacios cerrados. La asfixia puede ocurrir sin que te des cuenta.',a:'Los refrigerantes son invisibles y sin olor fuerte. Si ya hueles algo, hay MUCHO gas. Es como el mon√≥xido de carbono: no lo ves pero te mata. Ventila y sal primero, investiga despu√©s.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Aprietas una conexi√≥n flare con torque wrench. ¬øPor qu√© no debes apretarla m√°s de lo especificado?',o:['Gasta m√°s tiempo','Puedes rajar el flare y crear una fuga','No pasa nada, m√°s apretado es mejor','Solo importa con tuber√≠a de aluminio'],c:1,e:'Apretar de m√°s raja el cobre y crea fugas que no ver√°s hasta que el sistema est√© cargado.',a:'Es como apretar la tapa de un frasco de vidrio: si le pasas, la quiebras. El cobre es suave, si aprietas de m√°s se raja y boom, tienes una fuga que te va a dar dolores de cabeza.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Tu mult√≠metro marca voltaje inconsistente que sube y baja. ¬øQu√© puede estar pasando?',o:['Voltaje normal de AC','Conexi√≥n suelta o puntas de prueba da√±adas','El equipo est√° modulando normalmente','El mult√≠metro es demasiado preciso'],c:1,e:'Lecturas inestables casi siempre indican una conexi√≥n suelta, ya sea en el circuito o en tus puntas.',a:'Si el radio suena entrecortado, lo m√°s probable es que la antena est√° floja. Igual con el mult√≠metro: lecturas locas = conexi√≥n floja. Revisa tus puntas primero.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'OSHA puede multar a un t√©cnico individual que no use PPE hasta:',o:['No pueden multar al trabajador, solo a la empresa','$1,000 por la primera vez','Hasta $15,625 por violaci√≥n seria','Solo dan advertencia verbal'],c:2,e:'OSHA puede multar tanto a la empresa como al individuo. Las multas serias llegan hasta $15,625.',a:'No es juego. OSHA tiene poder de ley. Una multa de $15,000 es m√°s que tu sueldo de un mes. Y si alguien se lastima, pueden ser cargos criminales. PPE siempre.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Necesitas presurizar un sistema para buscar fugas. ¬øQu√© gas usas?',o:['Refrigerante R-22 porque es barato','Ox√≠geno porque es f√°cil de conseguir','Nitr√≥geno seco','Aire comprimido de la van'],c:2,e:'Nitr√≥geno seco es el √öNICO gas aceptable para presurizar. Ox√≠geno explota con aceite.',a:'Ox√≠geno + aceite = bomba. Aire comprimido tiene humedad. Refrigerante contamina. Nitr√≥geno es inerte, seco y seguro. Es el √öNICO que debes usar.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Un capacitor que mediste se ve hinchado en la parte superior. Tu acci√≥n:',o:['Medir microfaradios para ver si est√° bien','Reemplazarlo inmediatamente, un cap hinchado es defectuoso','Dejarlo si a√∫n funciona','Descargarlo y volver a instalarlo'],c:1,e:'Un capacitor hinchado es defectuoso aunque todav√≠a mida bien. Reemplaza siempre.',a:'Un capacitor hinchado es como una llanta ponchada: aunque todav√≠a ruede, est√° a punto de reventar. C√°mbialo ahora antes de que da√±e el motor o el compresor.'},
{cat:'üõ°Ô∏è Herramientas y Seguridad',q:'Tu bomba de vac√≠o logra 200 micrones pero al cerrar la v√°lvula sube a 800 en 5 minutos y se detiene. Esto indica:',o:['Fuga grande en el sistema','Humedad residual que se est√° evaporando','La bomba est√° da√±ada','El sistema est√° listo para cargar'],c:1,e:'Si sube y se detiene (no sigue subiendo), generalmente es humedad evapor√°ndose, no una fuga.',a:'Una fuga es como un globo con hueco: la presi√≥n sube y sube sin parar. La humedad es como un charquito que se seca: sube un poco y se estabiliza. Si se detiene, es humedad. Si sigue subiendo, es fuga.'},

// AIRE ACONDICIONADO B√ÅSICO (12)
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'Un mini split es diferente de un split convencional porque:',o:['Usa menos refrigerante','No necesita ductos','Enfr√≠a m√°s eficientemente','Trabaja solo con 110V'],c:1,e:'La principal diferencia del mini split es que no requiere ductos. Cada unidad interior enfr√≠a su zona.',a:'Un split convencional es como un sistema de riego con mangueras (ductos) que van a cada cuarto. El mini split es como tener una regadera individual en cada cuarto, sin mangueras. M√°s f√°cil de instalar.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'Un equipo con SEER de 20 comparado con uno de SEER 14:',o:['Enfr√≠a m√°s r√°pido','Enfr√≠a a menor temperatura','Usa menos electricidad para dar el mismo enfriamiento','Necesita menos refrigerante'],c:2,e:'SEER m√°s alto = misma capacidad pero menos consumo el√©ctrico. No enfr√≠a m√°s ni menos.',a:'Es como comparar un carro que da 30 millas por gal√≥n con uno de 20. Los dos te llevan al mismo lugar, pero el de 30 gasta menos gasolina. SEER alto = menos factura de luz.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'Tu cliente tiene una casa de 2,000 sq ft. Seg√∫n regla general, ¬øcu√°ntas toneladas de AC necesita?',o:['2 toneladas','3 a 4 toneladas dependiendo de factores','Siempre 5 toneladas para que sobre','1 tonelada es suficiente'],c:1,e:'Regla general: 400-500 sq ft por tonelada, pero aislamiento, ventanas y clima afectan el c√°lculo.',a:'La regla del pulgar es 1 tonelada por cada 400-500 pies cuadrados. Pero es como la ropa: no es solo la talla, importa si hace calor, si la casa tiene buen aislamiento, cu√°ntas ventanas. Siempre haz Manual J.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'El filtro de aire debe cambiarse cada:',o:['6 meses a 1 a√±o','1-3 meses dependiendo del tipo y uso','Solo cuando el equipo no enfr√≠a','Cada 5 a√±os con el mantenimiento'],c:1,e:'Filtros est√°ndar de 1 pulgada: cada 1-3 meses. Filtros de 4 pulgadas: cada 6-12 meses.',a:'El filtro es como el cubrebocas del sistema. Si no lo cambias, se tapa y el equipo no puede respirar. Un filtro sucio es la causa #1 de llamadas de servicio innecesarias.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'El evaporador est√° congelado. Tu PRIMER paso es:',o:['Agregar m√°s refrigerante inmediatamente','Apagar el equipo y dejar que se descongele antes de diagnosticar','Raspar el hielo con un destornillador','Subir el termostato a calefacci√≥n'],c:1,e:'Primero deja que se descongele completamente. No puedes diagnosticar con hielo encima.',a:'Es como cuando se te empa√±a el parabrisas: primero limpia para poder ver, luego maneja. No diagnostiques con hielo ‚Äî no puedes ver presiones reales ni medir flujo de aire correcto.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'El condensador est√° en el sol directo y obstruido con plantas. Las presiones de alta van a estar:',o:['M√°s bajas de lo normal','M√°s altas de lo normal','Igual que siempre','Intermitentes'],c:1,e:'Condensador obstruido = no puede liberar calor = presi√≥n de alta se eleva.',a:'Es como taparte la boca mientras exhalas: la presi√≥n sube porque el aire no puede salir. El condensador necesita exhalar el calor. Si est√° tapado con plantas o basura, la presi√≥n sube.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'El mantenimiento preventivo de AC se recomienda:',o:['Solo cuando algo falla','Una vez al a√±o en primavera','Dos veces al a√±o: primavera para AC y oto√±o para calefacci√≥n','Cada mes sin excepci√≥n'],c:2,e:'Dos visitas anuales: antes del verano para AC y antes del invierno para calefacci√≥n.',a:'Es como el dentista: vas dos veces al a√±o aunque no te duela nada. Si esperas a que duela, el tratamiento es caro. Mantenimiento preventivo ahorra dinero y extiende la vida del equipo.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'El return air en una casa est√° ubicado t√≠picamente:',o:['En el techo cerca del AC','En una pared interior, generalmente bajo o central','Afuera de la casa','En el ba√±o siempre'],c:1,e:'Los returns est√°n en paredes interiores, centrales, para recircular el aire de la casa.',a:'El return es la boca del sistema que traga el aire de la casa para reciclarlo. Generalmente est√° abajo en la pared de un pasillo. Si lo tapas con un mueble, el sistema se ahoga.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'El termostato llama por cooling pero el equipo no enciende. Mides 24V entre R y Y en el termostato. Esto indica:',o:['El termostato est√° malo','La se√±al sale bien del termostato, el problema est√° despu√©s','No hay voltaje suficiente','El compresor est√° en delay'],c:1,e:'24V entre R y Y = el termostato est√° mandando la se√±al correctamente. El problema est√° en otro lado.',a:'Es como cuando mandas un mensaje de texto y te dice enviado: tu tel√©fono hizo su trabajo. Si la otra persona no responde, el problema no es tu tel√©fono. 24V en el termostato = √©l est√° haciendo su trabajo.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'Un condensador sucio puede causar TODO lo siguiente EXCEPTO:',o:['Presiones de descarga altas','Mayor consumo de energ√≠a','Menor superheat en el evaporador','Posible da√±o al compresor'],c:2,e:'Condensador sucio causa presiones altas, m√°s consumo y posible da√±o. El superheat tiende a SUBIR, no bajar.',a:'Condensador sucio es como una persona acalorada que no puede sudar: la temperatura sube, gasta m√°s energ√≠a, y eventualmente colapsa. Pero el superheat no baja, sube porque el sistema pierde eficiencia.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'BTU significa British Thermal Unit. Un BTU es la energ√≠a necesaria para:',o:['Enfriar 1 libra de aire en 1¬∞F','Subir 1 libra de agua en 1¬∞F','Derretir 1 libra de hielo','Evaporar 1 libra de refrigerante'],c:1,e:'1 BTU = energ√≠a para subir 1¬∞F a 1 libra de agua. Es la unidad base de calor en HVAC.',a:'Imagina una libra de agua (como una botellita). Un BTU es lo que necesitas para calentarla UN gradito. 12,000 BTU (1 tonelada) = calentar 12,000 botellitas un grado cada hora.'},
{cat:'‚ùÑÔ∏è Aire Acondicionado B√°sico',q:'Mides la temperatura del supply a 58¬∞F y el return a 75¬∞F. El delta T es:',o:['133¬∞F','58¬∞F','17¬∞F ‚Äî est√° en rango normal','75¬∞F'],c:2,e:'Delta T = Return - Supply = 75 - 58 = 17¬∞F. Normal es 15-20¬∞F.',a:'Delta T es la diferencia entre lo que entra y lo que sale. Como medir cu√°nto baj√≥ la temperatura del agua despu√©s de ponerle hielo. 17¬∞F de diferencia = tu equipo est√° trabajando bien.'}
];

let quizData=[];
let quizIdx=0;
let quizRight=0;
let quizWrong=0;
let quizAnswered=false;
let quizAnswers=[];

function shuffleArray(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
    return a;
}

function startQuiz(){
    quizData=shuffleArray(QUIZ_PRINCIPIANTE);
    quizIdx=0;quizRight=0;quizWrong=0;quizStreak=0;
    quizAnswers=new Array(quizData.length).fill(-1);
    document.getElementById('qRight').textContent='0';
    document.getElementById('qWrong').textContent='0';
    go('s8');
    showQuestion();
    const intro=D.lang==='es'?'¬°Vamos con el quiz, '+D.name+'! Demuestra lo que sabes.':'Let\'s go '+D.name+'! Show what you know.';
    speakText(intro);
}

function retryQuiz(){
    startQuiz();
}

function showQuestion(){
    if(quizIdx>=quizData.length){showResult();return;}
    const q=quizData[quizIdx];
    const alreadyAnswered=quizAnswers[quizIdx]>=0;
    quizAnswered=alreadyAnswered;
    const pct=Math.round((quizIdx/quizData.length)*100);
    document.getElementById('qBar').style.width=pct+'%';
    document.getElementById('qNum').textContent=(D.lang==='es'?'Pregunta ':'Question ')+(quizIdx+1)+' / '+quizData.length;
    document.getElementById('qCat').textContent=q.cat;
    
    // Back button
    const prevBtn=document.getElementById('qPrev');
    if(quizIdx>0){prevBtn.classList.add('show');}else{prevBtn.classList.remove('show');}
    
    if(alreadyAnswered){
        // Revisiting a question already answered
        const userAnswer=quizAnswers[quizIdx];
        const correct=userAnswer===q.c;
        document.getElementById('qBubble').textContent=correct?(D.lang==='es'?'‚úÖ Ya contestaste bien esta pregunta.':'‚úÖ You already got this right.'):(D.lang==='es'?'‚ùå Aqu√≠ fallaste. La correcta es la '+['A','B','C','D'][q.c]+'.':'‚ùå You missed this one. Correct: '+['A','B','C','D'][q.c]+'.');
        document.getElementById('qText').textContent=q.q;
        const letters=['A','B','C','D'];
        document.getElementById('qOpts').innerHTML=q.o.map((o,i)=>{
            let cls='quiz-opt disabled';
            if(i===q.c)cls+=' correct';
            if(i===userAnswer&&!correct)cls+=' wrong';
            return '<div class="'+cls+'"><div class="quiz-letter">'+letters[i]+'</div><div>'+o+'</div></div>';
        }).join('');
        document.getElementById('qExplain').innerHTML=correct?('<b>'+(D.lang==='es'?'Explicaci√≥n:':'Explanation:')+'</b> '+q.e):('<b style="color:#ff6b2b">'+(D.lang==='es'?'üìñ Con peras y manzanas:':'üìñ Simply put:')+'</b><br>'+q.a+'<br><br><b>'+(D.lang==='es'?'T√©cnico:':'Technical:')+'</b> '+q.e);
        document.getElementById('qExplain').classList.add('show');
        const nextBtn=document.getElementById('qNext');
        nextBtn.textContent=(quizIdx<quizData.length-1)?(D.lang==='es'?'Siguiente ‚Üí':'Next ‚Üí'):(D.lang==='es'?'Ver Resultado üèÜ':'See Result üèÜ');
        nextBtn.classList.add('show');
    }else{
        // New unanswered question
        document.getElementById('qBubble').textContent=quizIdx===0?(D.lang==='es'?'¬°Dale, t√∫ puedes!':'You got this!'):(D.lang==='es'?'¬øQu√© piensas, '+D.name+'?':'What do you think, '+D.name+'?');
        document.getElementById('qText').textContent=q.q;
        document.getElementById('qExplain').classList.remove('show');
        document.getElementById('qNext').classList.remove('show');
        const letters=['A','B','C','D'];
        document.getElementById('qOpts').innerHTML=q.o.map((o,i)=>'<div class="quiz-opt" onclick="answerQuiz('+i+',this)"><div class="quiz-letter">'+letters[i]+'</div><div>'+o+'</div></div>').join('');
    }
    window.scrollTo(0,0);
}

let quizStreak=0;

const CHEERS_ES=[
    ['¬°Correcto!','¬°Bien hecho!','¬°As√≠ se hace!','¬°Muy bien, '+'{name}'+'!','¬°Buena elecci√≥n!'],
    ['¬°Divino!','¬°Perfecto!','¬°Excelente!','¬°Maravilloso!','¬°√ìrale, '+'{name}'+'!'],
    ['¬°Espectacular!','¬°Eres crack!','¬°Incre√≠ble, '+'{name}'+'!','¬°Qu√© m√°quina!'],
    ['üî• ¬°IMPARABLE! üî•','‚ö° ¬°NO TE PARA NADIE! ‚ö°','üí™ ¬°ERES UNA BESTIA! üí™','üèÜ ¬°VAS CON TODO! üèÜ']
];
const CHEERS_EN=[
    ['Correct!','Well done!','Nice job!','Good pick, '+'{name}'+'!','That\'s right!'],
    ['Perfect!','Excellent!','Brilliant!','Amazing!','Great work, '+'{name}'+'!'],
    ['Spectacular!','You\'re on fire!','Incredible, '+'{name}'+'!','Crushing it!'],
    ['üî• UNSTOPPABLE! üî•','‚ö° NOBODY STOPS YOU! ‚ö°','üí™ YOU\'RE A BEAST! üí™','üèÜ ALL THE WAY! üèÜ']
];
const MISS_ES=[
    '¬°No te preocupes, {name}! Todos fallamos al principio. As√≠ se aprende, ech√°ndole ganas.',
    '¬°Ey {name}, tranquilo! Los mejores t√©cnicos tambi√©n empezaron equivoc√°ndose. ¬°T√∫ puedes!',
    '¬°{name}, ya eres ganador solo por intentarlo! No te desanimes, vamos campe√≥n.',
    '¬°√ìrale {name}, casi le atinas! Eres una estrella en entrenamiento. Mira la explicaci√≥n.',
    '¬°{name}, no pasa nada! Hasta Mario se equivocaba al principio. Lo importante es aprender.',
    '¬°√Ånimo {name}! Cada error te acerca m√°s a ser un crack del HVAC. ¬°T√∫ puedes con esto!',
    '¬°Hey {name}! Esta estaba dif√≠cil. Pero t√∫ eres ching√≥n, vas a dominar este tema.',
    '¬°{name}, respira! Los grandes se hacen a base de pr√°ctica. Mira la explicaci√≥n y vas a ver qu√© f√°cil es.'
];
const MISS_EN=[
    'Don\'t worry {name}! Everyone struggles at first. That\'s how you learn!',
    'Hey {name}, take it easy! The best techs started by making mistakes too. You got this!',
    '{name}, you\'re already a winner just for trying! Don\'t give up, champ.',
    'Almost {name}! You\'re a star in training. Check out the explanation.',
    '{name}, no big deal! Even Mario made mistakes starting out. What matters is learning.',
    'Keep going {name}! Every mistake brings you closer to being an HVAC pro!',
    'Hey {name}! That was a tough one. But you\'re awesome, you\'ll master this.',
    '{name}, take a breath! Greatness comes from practice. Check the explanation and you\'ll get it.'
];

function pickCheer(streak){
    const cheers=D.lang==='es'?CHEERS_ES:CHEERS_EN;
    let tier=0;
    if(streak>=8)tier=3;
    else if(streak>=5)tier=2;
    else if(streak>=3)tier=1;
    const list=cheers[tier];
    return list[Math.floor(Math.random()*list.length)].replace('{name}',D.name);
}

function pickMiss(){
    const list=D.lang==='es'?MISS_ES:MISS_EN;
    const msg=list[Math.floor(Math.random()*list.length)].replace(/\{name\}/g,D.name);
    const letter=' '+(D.lang==='es'?'La correcta es la ':'Correct answer is ')+['A','B','C','D'][quizData[quizIdx].c]+'.';
    return msg+letter;
}

function celebrate(streak){
    const el=document.getElementById('s8');
    // Vibrate phone
    if(navigator.vibrate){
        if(streak>=5)navigator.vibrate([100,50,100,50,200]);
        else navigator.vibrate(80);
    }
    // Screen shake
    if(streak>=5){
        el.classList.add('big-shake');
        setTimeout(()=>el.classList.remove('big-shake'),600);
    }else if(streak>=2){
        el.classList.add('shake');
        setTimeout(()=>el.classList.remove('shake'),400);
    }
    // Lightning flash at 5+ streak
    if(streak>=5){
        const flash=document.createElement('div');
        flash.className='lightning-flash';
        document.body.appendChild(flash);
        setTimeout(()=>flash.remove(),400);
    }
    // Fire emojis at 3+ streak (reduced for performance)
    if(streak>=3){
        const emojis=streak>=8?['üî•','‚ö°','üí•','üåü']:streak>=5?['üî•','‚ö°','üí•']:['üî•','‚ú®'];
        const count=streak>=8?6:streak>=5?4:2;
        for(let i=0;i<count;i++){
            setTimeout(()=>{
                const fire=document.createElement('div');
                fire.className='fire-emoji';
                fire.textContent=emojis[Math.floor(Math.random()*emojis.length)];
                fire.style.left=Math.random()*80+10+'%';
                fire.style.bottom='10%';
                document.body.appendChild(fire);
                setTimeout(()=>fire.remove(),1200);
            },i*150);
        }
    }
    // Streak badge at 5+ 
    if(streak>=5){
        const badge=document.createElement('div');
        badge.className='streak-badge';
        badge.textContent=streak>=10?'üèÜ '+streak+'x COMBO! üèÜ':streak>=8?'‚ö° '+streak+'x RACHA! ‚ö°':'üî• '+streak+'x STREAK! üî•';
        document.body.appendChild(badge);
        setTimeout(()=>badge.remove(),1500);
    }
    // Confetti at 5+
    if(streak>=5)cft();
}

function answerQuiz(idx,el){
    if(quizAnswered)return;
    quizAnswered=true;
    quizAnswers[quizIdx]=idx;
    const q=quizData[quizIdx];
    const correct=idx===q.c;
    const opts=document.querySelectorAll('.quiz-opt');
    
    opts.forEach((o,i)=>{
        if(i===q.c)o.classList.add('correct');
        if(i===idx&&!correct)o.classList.add('wrong');
        if(i!==q.c&&i!==idx)o.classList.add('disabled');
    });
    
    if(correct){
        quizRight++;
        quizStreak++;
        if(quizStreak>bestStreak)bestStreak=quizStreak;
        document.getElementById('qRight').textContent=quizRight;
        const cheer=pickCheer(quizStreak);
        document.getElementById('qBubble').textContent=cheer;
        celebrate(quizStreak);
        document.getElementById('qExplain').innerHTML='<b>'+(D.lang==='es'?'Explicaci√≥n:':'Explanation:')+'</b> '+q.e;
        speakText(cheer+' '+q.e);
    }else{
        quizWrong++;
        quizStreak=0;
        document.getElementById('qWrong').textContent=quizWrong;
        const motivation=pickMiss();
        const bubble=document.getElementById('qBubble');
        bubble.textContent=motivation;
        // After 4 seconds, update bubble with the simple analogy
        setTimeout(()=>{
            bubble.innerHTML='<span style="color:#ff6b2b">üìñ</span> '+q.a;
        },4000);
        // Show deep explanation with analogy
        let explain='<b style="color:#ff6b2b">'+(D.lang==='es'?'üìñ Te lo explico con peras y manzanas:':'üìñ Let me break it down simply:')+'</b><br>'+q.a+'<br><br><b>'+(D.lang==='es'?'Explicaci√≥n t√©cnica:':'Technical explanation:')+'</b> '+q.e;
        document.getElementById('qExplain').innerHTML=explain;
        // Mario speaks EVERYTHING: motivation + analogy + technical explanation
        speakText(motivation+' '+(D.lang==='es'?'Te lo explico f√°cil: ':'Let me explain simply: ')+q.a+' '+(D.lang==='es'?'En t√©rminos t√©cnicos: ':'Technically speaking: ')+q.e);
    }
    
    document.getElementById('qExplain').classList.add('show');
    document.getElementById('qNext').textContent=(quizIdx<quizData.length-1)?(D.lang==='es'?'Siguiente ‚Üí':'Next ‚Üí'):(D.lang==='es'?'Ver Resultado üèÜ':'See Result üèÜ');
    document.getElementById('qNext').classList.add('show');
}

function nextQuestion(){
    stopSpeech();
    quizIdx++;
    showQuestion();
}

function prevQuestion(){
    stopSpeech();
    if(quizIdx>0){quizIdx--;showQuestion();}
}

function showResult(){
    go('s9');
    const pct=Math.round((quizRight/quizData.length)*100);
    document.getElementById('rScore').textContent=pct+'%';
    document.getElementById('rLabel').textContent=quizRight+' / '+quizData.length+(D.lang==='es'?' correctas':' correct');
    
    // Award XP: 10 per correct, bonus for streaks
    const xpEarned=quizRight*10+(bestStreak>=10?50:bestStreak>=5?25:0);
    profile.xp+=xpEarned;
    profile.totalCorrect+=quizRight;
    profile.totalAnswered+=quizData.length;
    profile.quizzesTaken++;
    if(bestStreak>profile.bestStreak)profile.bestStreak=bestStreak;
    
    // Level up check
    while(profile.xp>=profile.xpNeeded){
        profile.xp-=profile.xpNeeded;
        profile.level++;
        profile.xpNeeded=Math.floor(profile.xpNeeded*1.4);
    }
    
    let medal,msg,stars;
    const medalEarned=document.getElementById('rMedalEarned');
    medalEarned.style.display='none';
    
    if(pct===100){
        medal='üèÜ';stars=5;
        msg=D.lang==='es'?'¬°¬°PERFECTO, '+D.name+'!! 100% sin fallar. ¬°Eres leyenda! Te ganaste tu medalla de Bronce ü•â':'PERFECT, '+D.name+'!! 100% flawless. You earned your Bronze Medal ü•â';
        if(!profile.medals.includes('bronze_principiante')){
            profile.medals.push('bronze_principiante');
            medalEarned.style.display='block';
            document.getElementById('rNewMedal').textContent='ü•â';
            document.getElementById('rMedalName').textContent=D.lang==='es'?'¬°MEDALLA DE BRONCE DESBLOQUEADA!\nPrincipiante Perfecto':'BRONZE MEDAL UNLOCKED!\nPerfect Beginner';
        }
    }else if(pct>=90){
        medal='üèÜ';stars=5;
        msg=D.lang==='es'?'¬°Incre√≠ble, '+D.name+'! Casi perfecto. El Maestro Mario est√° orgulloso. ¬°Intenta el 100% para tu medalla!':'Incredible, '+D.name+'! Almost perfect. Try for 100% to earn your medal!';
    }else if(pct>=80){
        medal='ü•á';stars=4;
        msg=D.lang==='es'?'¬°Excelente, '+D.name+'! Tienes muy buena base. Repasa lo que fallaste y ve por el 100%.':'Excellent, '+D.name+'! Great foundation. Review mistakes and go for 100%!';
    }else if(pct>=70){
        medal='ü•à';stars=3;
        msg=D.lang==='es'?'¬°Bien, '+D.name+'! Vas por buen camino. No te rindas, cada error es una lecci√≥n.':'Good job, '+D.name+'! On the right track. Every mistake is a lesson.';
    }else if(pct>=60){
        medal='ü•â';stars=2;
        msg=D.lang==='es'?'¬°No te desanimes, '+D.name+'! Ya eres ganador por intentarlo. Repasa y vuelve m√°s fuerte.':'Don\'t get discouraged, '+D.name+'! You\'re a winner for trying. Review and come back stronger.';
    }else{
        medal='üí™';stars=1;
        msg=D.lang==='es'?'¬°'+D.name+', vamos campe√≥n! Todos fallamos al principio. T√∫ puedes, eres una estrella. ¬°Estudia y regresa con todo!':D.name+', let\'s go champ! Everyone struggles at first. You\'re a star. Study and come back strong!';
    }
    
    document.getElementById('rMedal').textContent=medal;
    document.getElementById('rMsg').textContent=msg;
    
    const starEls=document.querySelectorAll('#rStars span');
    starEls.forEach((s,i)=>{s.classList.remove('lit');});
    starEls.forEach((s,i)=>{
        setTimeout(()=>{if(i<stars)s.classList.add('lit');},i*300);
    });
    
    saveProfile();
    document.getElementById('profileBtn').classList.add('active');
    cft();
    speakText(msg);
}

// ========== PROFILE & MEDAL SYSTEM ==========
const MEDALS_DEF=[
    {id:'bronze_principiante',icon:'ü•â',name:'Bronce Principiante',desc:'100% en quiz principiante'},
    {id:'silver_principiante',icon:'ü•à',name:'Plata Principiante',desc:'100% dos veces seguidas'},
    {id:'gold_principiante',icon:'ü•á',name:'Oro Principiante',desc:'100% tres veces seguidas'},
    {id:'streak_5',icon:'üî•',name:'En Llamas',desc:'Racha de 5 correctas'},
    {id:'streak_10',icon:'‚ö°',name:'Imparable',desc:'Racha de 10 correctas'},
    {id:'streak_20',icon:'üí•',name:'Leyenda',desc:'Racha de 20 correctas'},
    {id:'quiz_5',icon:'üìù',name:'Estudiante',desc:'Completar 5 quizzes'},
    {id:'quiz_15',icon:'üìö',name:'Estudioso',desc:'Completar 15 quizzes'},
    {id:'correct_100',icon:'üíØ',name:'Centuri√≥n',desc:'100 respuestas correctas'},
    {id:'correct_500',icon:'üåü',name:'Maestro en Entrenamiento',desc:'500 respuestas correctas'},
    {id:'level_5',icon:'‚≠ê',name:'Nivel 5',desc:'Alcanzar nivel 5'},
    {id:'level_10',icon:'üëë',name:'Nivel 10',desc:'Alcanzar nivel 10'}
];

const LEVEL_TITLES={
    1:'Aprendiz Novato',2:'Aprendiz',3:'Ayudante',4:'T√©cnico Jr.',5:'T√©cnico',
    6:'T√©cnico Senior',7:'Especialista',8:'Experto',9:'Maestro',10:'Gran Maestro',
    11:'Leyenda HVAC',12:'Maestro Supremo',15:'Dios del HVAC'
};

let profile={level:1,xp:0,xpNeeded:100,totalCorrect:0,totalAnswered:0,quizzesTaken:0,bestStreak:0,medals:[],perfectStreakCount:0,avatar:'üë§'};
let bestStreak=0;

const AVATARS=[
    'üë§','üßë‚Äçüîß','üë∑','ü¶∏‚Äç‚ôÇÔ∏è','ü¶∏‚Äç‚ôÄÔ∏è','üßë‚Äçüè´',
    'üê∫','ü¶Ö','üêÜ','ü¶Å','üêª','ü¶ä',
    'üî•','‚ö°','‚ùÑÔ∏è','üåü','üíé','üèÜ',
    'ü§ñ','üëæ','üéÆ','üïπÔ∏è','üõ°Ô∏è','‚öîÔ∏è',
    'üßä','üîß','‚öôÔ∏è','üåÄ','üí™','üëë'
];

function toggleAvatarPicker(){
    const picker=document.getElementById('avatarPicker');
    picker.classList.toggle('open');
    if(picker.classList.contains('open')){
        document.getElementById('avatarGrid').innerHTML=AVATARS.map(a=>'<div class="avatar-option'+(a===profile.avatar?' selected':'')+'" onclick="selectAvatar(\''+a+'\')">'+a+'</div>').join('');
    }
}

function selectAvatar(emoji){
    profile.avatar=emoji;
    saveProfile();
    document.getElementById('profAvatar').innerHTML=emoji+'<div class="prof-avatar-edit">‚úèÔ∏è</div>';
    document.getElementById('profileBtn').textContent=emoji;
    document.getElementById('avatarPicker').classList.remove('open');
    // Update selected state
    document.querySelectorAll('.avatar-option').forEach(el=>{
        el.classList.toggle('selected',el.textContent===emoji);
    });
}

function getTitle(lvl){
    let title='Aprendiz';
    for(let l of Object.keys(LEVEL_TITLES).map(Number).sort((a,b)=>b-a)){
        if(lvl>=l){title=LEVEL_TITLES[l];break;}
    }
    return title;
}

function checkAutoMedals(){
    if(bestStreak>=5&&!profile.medals.includes('streak_5'))profile.medals.push('streak_5');
    if(bestStreak>=10&&!profile.medals.includes('streak_10'))profile.medals.push('streak_10');
    if(bestStreak>=20&&!profile.medals.includes('streak_20'))profile.medals.push('streak_20');
    if(profile.quizzesTaken>=5&&!profile.medals.includes('quiz_5'))profile.medals.push('quiz_5');
    if(profile.quizzesTaken>=15&&!profile.medals.includes('quiz_15'))profile.medals.push('quiz_15');
    if(profile.totalCorrect>=100&&!profile.medals.includes('correct_100'))profile.medals.push('correct_100');
    if(profile.totalCorrect>=500&&!profile.medals.includes('correct_500'))profile.medals.push('correct_500');
    if(profile.level>=5&&!profile.medals.includes('level_5'))profile.medals.push('level_5');
    if(profile.level>=10&&!profile.medals.includes('level_10'))profile.medals.push('level_10');
}

function saveProfile(){
    checkAutoMedals();
    try{localStorage.setItem('maestro_profile',JSON.stringify(profile));}catch(e){}
}

function loadProfile(){
    try{
        const saved=localStorage.getItem('maestro_profile');
        if(saved){
            const p=JSON.parse(saved);
            Object.assign(profile,p);
            document.getElementById('profileBtn').classList.add('active');
            document.getElementById('profileBtn').textContent=profile.avatar||'üë§';
        }
    }catch(e){}
}

function renderProfile(){
    document.getElementById('profAvatar').innerHTML=profile.avatar+'<div class="prof-avatar-edit">‚úèÔ∏è</div>';
    document.getElementById('profileBtn').textContent=profile.avatar;
    document.getElementById('profName').textContent=D.name||'T√©cnico';
    document.getElementById('profTitle').textContent=getTitle(profile.level);
    document.getElementById('profLevel').textContent=profile.level;
    const xpPct=Math.round((profile.xp/profile.xpNeeded)*100);
    document.getElementById('profXpBar').style.width=xpPct+'%';
    document.getElementById('profXpTxt').textContent=profile.xp+' / '+profile.xpNeeded+' XP';
    document.getElementById('profPts').textContent=profile.totalCorrect*10;
    const acc=profile.totalAnswered>0?Math.round((profile.totalCorrect/profile.totalAnswered)*100):0;
    document.getElementById('profAcc').textContent=acc+'%';
    document.getElementById('profStrk').textContent=profile.bestStreak;
    
    // Medals grid
    document.getElementById('medalsGrid').innerHTML=MEDALS_DEF.map(m=>{
        const earned=profile.medals.includes(m.id);
        return '<div class="medal-slot'+(earned?' earned':'')+'"><div class="medal-icon">'+(earned?m.icon:'üîí')+'</div><div class="medal-name">'+m.name+'</div><div style="font-size:10px;color:var(--muted);margin-top:2px">'+m.desc+'</div></div>';
    }).join('');
}

// Load profile on start
loadProfile();

// Close music panel on outside click
document.addEventListener('click',e=>{
    const panel=document.getElementById('musicPanel');
    const btn=document.getElementById('musicBtn');
    if(musicPanelOpen&&!panel.contains(e.target)&&e.target!==btn){
        musicPanelOpen=false;
        panel.classList.remove('open');
    }
});

document.getElementById('nm').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim().length>=2)sName();});
</script>
</body>
</html>
