h<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maestro Mario - HVAC Training App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--accent:#ff6b2b;--electric:#00d4ff;--gold:#f1c40f;--dark:#0a1628;--card:#111d33;--card2:#162440;--txt:#e8f0ff;--muted:#7a93b8;--r:16px}

        /* FLOATING HOME BUTTON */
        .home-fab{position:fixed;bottom:20px;left:20px;z-index:800;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--dark),var(--card));border:2px solid rgba(0,212,255,0.4);color:var(--electric);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:all 0.3s}
        .home-fab:hover{transform:scale(1.1);border-color:var(--electric);box-shadow:0 4px 20px rgba(0,212,255,0.3)}

        /* AI PAYWALL MODAL */
        .paywall-overlay{position:fixed;inset:0;z-index:10000;background:rgba(10,22,40,0.95);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .paywall-overlay.active{display:flex}
        .paywall-card{background:var(--card);border:1px solid rgba(0,212,255,0.2);border-radius:20px;max-width:400px;width:100%;padding:20px 18px;text-align:center;position:relative;overflow:hidden;animation:pwSlide 0.4s ease;margin:auto 0;flex-shrink:0}
        @keyframes pwSlide{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .paywall-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--accent),var(--electric),var(--gold))}
        .pw-icon{font-size:50px;margin-bottom:8px}
        .pw-title{font-size:18px;font-weight:800;color:var(--txt);margin-bottom:4px;font-family:'Fredoka',sans-serif}
        .pw-subtitle{font-size:13px;color:var(--muted);margin-bottom:12px}
        .pw-features{text-align:left;margin-bottom:16px}
        .pw-feature{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:13px;color:var(--txt)}
        .pw-feature span{color:#2ecc71;font-size:15px}
        .pw-price{font-size:28px;font-weight:800;color:var(--accent);margin-bottom:2px;font-family:'Fredoka',sans-serif}
        .pw-period{font-size:12px;color:var(--muted);margin-bottom:12px}
        .pw-btn{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),#e84500);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:'Fredoka',sans-serif}
        .pw-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,107,43,0.3)}
        .pw-close{margin-top:14px;background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;padding:8px}
        .pw-close:hover{color:var(--txt)}

        /* AI CHARACTER COUNTER */
        .ai-chars-banner{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:799;background:rgba(17,29,51,0.95);border:1px solid rgba(0,212,255,0.3);border-radius:50px;padding:6px 16px;font-size:12px;color:var(--electric);font-weight:600;display:none;align-items:center;gap:6px;box-shadow:0 4px 15px rgba(0,0,0,0.3);white-space:nowrap}
        .ai-chars-banner.show{display:inline-flex}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Nunito',sans-serif;background:var(--dark);color:var(--txt);min-height:100vh;min-height:100dvh;overflow-x:hidden}
        .bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
        .bg .o{position:absolute;border-radius:50%;filter:blur(90px);opacity:.12;animation:d 22s ease-in-out infinite}
        .bg .o:nth-child(1){width:420px;height:420px;background:var(--accent);top:-120px;left:-120px}
        .bg .o:nth-child(2){width:360px;height:360px;background:var(--electric);bottom:-100px;right:-100px;animation-delay:-8s}
        .bg .o:nth-child(3){width:280px;height:280px;background:#6366f1;top:40%;left:40%;animation-delay:-15s}
        @keyframes d{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-30px) scale(1.08)}66%{transform:translate(-20px,20px) scale(.92)}}
        .gr{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);background-size:44px 44px}
        .app{position:relative;z-index:1;max-width:460px;margin:0 auto;min-height:100vh;min-height:100dvh;padding:16px 18px;display:flex;flex-direction:column}
        .s{display:none;flex-direction:column;align-items:center;flex:1;animation:si .55s cubic-bezier(.16,1,.3,1)}
        .s.on{display:flex}
        @keyframes si{from{opacity:0;transform:translateY(36px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
        
        /* VIDEO FLOTANTE DESDE LA DERECHA */
        .video-float{position:fixed;bottom:100px;right:-320px;z-index:900;width:300px;transition:right 0.6s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
        .video-float.active{right:20px;pointer-events:auto}
        .video-float.hiding{right:-320px}
        .video-float-inner{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 15px 50px rgba(255,107,43,0.6),0 0 0 3px var(--accent);background:#000}
        .video-float video{width:100%;display:block;border-radius:17px}
        .video-float-label{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;padding:6px 14px;border-radius:20px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .video-float-label::before{content:'';width:10px;height:10px;border-radius:50%;background:#00ff00;animation:blink 1s infinite;box-shadow:0 0 10px #00ff00}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .video-float-close{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,0.7);border:2px solid rgba(255,255,255,0.3);color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
        .video-float-close:hover{background:var(--accent);border-color:var(--accent);transform:scale(1.1)}
        .video-float-glow{position:absolute;inset:-4px;border-radius:24px;background:conic-gradient(var(--accent),var(--electric),var(--gold),var(--accent));z-index:-1;animation:sp 3s linear infinite}
        
        /* MODAL AI CHAT */
        .ai-modal{position:fixed;inset:0;z-index:600;background:rgba(10,22,40,0.95);display:flex;align-items:flex-end;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s}
        .ai-modal.active{opacity:1;visibility:visible}
        .ai-chat{width:100%;max-width:460px;height:75vh;background:var(--card);border-radius:24px 24px 0 0;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.4s cubic-bezier(.16,1,.3,1)}
        .ai-modal.active .ai-chat{transform:translateY(0)}
        .ai-chat-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:12px}
        .ai-chat-avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid var(--accent)}
        .ai-chat-avatar img{width:100%;height:100%;object-fit:cover}
        .ai-chat-title{flex:1}
        .ai-chat-title h3{font-family:'Fredoka',sans-serif;font-size:17px;color:var(--txt)}
        .ai-chat-title span{font-size:12px;color:var(--electric)}
        .ai-chat-close{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:var(--txt);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .ai-chat-close:hover{background:var(--accent)}
        .ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
        .ai-msg{max-width:85%;padding:14px 18px;border-radius:18px;font-size:15px;line-height:1.5}
        .ai-msg.mario{background:linear-gradient(135deg,rgba(255,107,43,0.2),rgba(0,212,255,0.1));border:1px solid rgba(255,107,43,0.3);align-self:flex-start;border-bottom-left-radius:4px}
        .ai-msg.user{background:var(--card2);align-self:flex-end;border-bottom-right-radius:4px}
        .ai-chat-input{padding:16px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px}
        .ai-chat-input input{flex:1;padding:14px 18px;border-radius:25px;border:2px solid rgba(255,255,255,0.1);background:var(--dark);color:var(--txt);font-size:15px;outline:none}
        .ai-chat-input input:focus{border-color:var(--accent)}
        .ai-chat-input button{width:50px;height:50px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:22px;cursor:pointer}
        .ai-chat-input button:disabled{opacity:0.5;cursor:not-allowed}
        
        /* SPEAKING INDICATOR */
        .speaking-indicator{display:none;align-items:center;gap:8px;padding:10px 16px;background:rgba(255,107,43,0.2);border-radius:12px;margin-top:8px}
        .speaking-indicator.active{display:flex}
        .speaking-indicator .waves{display:flex;gap:3px;align-items:center}
        .speaking-indicator .wave{width:4px;height:16px;background:var(--accent);border-radius:2px;animation:wave 0.8s ease-in-out infinite}
        .speaking-indicator .wave:nth-child(2){animation-delay:0.1s}
        .speaking-indicator .wave:nth-child(3){animation-delay:0.2s}
        .speaking-indicator .wave:nth-child(4){animation-delay:0.3s}
        @keyframes wave{0%,100%{height:8px}50%{height:20px}}
        .speaking-indicator span{font-size:13px;color:var(--accent);font-weight:600}
        
        /* CONFETTI */
        .cw{position:fixed;inset:0;pointer-events:none;z-index:100}.cf{position:absolute;top:-16px;animation:cff 2.8s ease-out forwards}
        @keyframes cff{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
        
        /* AVATAR - CLICKEABLE PARA ABRIR AI */
        .aw{position:relative;margin:16px auto 12px;cursor:pointer;transition:transform 0.3s}
        .aw:hover{transform:scale(1.05)}
        .aw.lg{width:190px;height:190px}.aw.md{width:140px;height:140px}.aw.sm{width:120px;height:120px}
        .ar{position:absolute;inset:-6px;border-radius:50%;background:conic-gradient(var(--accent),var(--electric),var(--accent));animation:sp 4s linear infinite}
        @keyframes sp{to{transform:rotate(360deg)}}
        .ag{position:absolute;inset:-20px;border-radius:50%;background:radial-gradient(circle,var(--accent) 0%,transparent 70%);opacity:.25;animation:pu 3s ease-in-out infinite}
        @keyframes pu{0%,100%{transform:scale(1);opacity:.25}50%{transform:scale(1.12);opacity:.4}}
        .ai{position:relative;width:100%;height:100%;border-radius:50%;overflow:hidden;border:4px solid var(--dark);animation:fl 4.5s ease-in-out infinite}
        .ai img{width:100%;height:100%;object-fit:cover}
        @keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        
        /* BADGE DE AI EN AVATAR */
        .aw .ai-badge{position:absolute;bottom:5px;right:5px;background:var(--accent);color:white;font-family:'Fredoka',sans-serif;font-size:10px;font-weight:700;padding:4px 8px;border-radius:10px;border:2px solid var(--dark)}
        
        /* BURBUJA */
        .bb{background:var(--card);border:1.5px solid rgba(0,212,255,.15);border-radius:var(--r);padding:18px 22px;margin:0 6px 20px;position:relative;box-shadow:0 6px 28px rgba(0,0,0,.25);text-align:center;font-size:16.5px;line-height:1.55;font-weight:600;min-height:60px}
        .bb::before{content:'';position:absolute;top:-10px;left:50%;transform:translateX(-50%);border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid rgba(0,212,255,.15)}
        .bb::after{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid var(--card)}
        
        /* OTROS ESTILOS */
        .lo{text-align:center;padding:4px 60px}.lo-t{font-family:'Fredoka',sans-serif;font-size:26px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.lo-s{font-size:12px;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:2px}
        .pb{width:100%;height:5px;background:rgba(255,255,255,.06);border-radius:3px;margin:12px 0 6px;overflow:hidden}.pbf{height:100%;background:linear-gradient(90deg,var(--accent),var(--electric));border-radius:3px;transition:width .6s}
        .ps{font-size:12px;color:var(--muted);margin-bottom:12px;text-align:center}.ps b{color:var(--accent)}
        .os{width:100%;display:flex;flex-direction:column;gap:10px}
        .oc{background:var(--card);border:2px solid rgba(255,255,255,.06);border-radius:var(--r);padding:16px 18px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:14px}
        .oc:hover{border-color:rgba(255,107,43,.4);background:var(--card2);transform:translateY(-1px)}
        .oc.sel{border-color:var(--accent);background:linear-gradient(135deg,rgba(255,107,43,.12),rgba(0,212,255,.06))}
        .oi{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;transition:all .25s}
        .oc.sel .oi{background:var(--accent);transform:scale(1.08)}
        .ot{font-family:'Fredoka',sans-serif;font-size:15px;font-weight:600}.od{font-size:12.5px;color:var(--muted);margin-top:1px}
        .ck{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.12);margin-left:auto;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:white}
        .oc.sel .ck{background:var(--accent);border-color:var(--accent)}.oc.sel .ck::after{content:'âœ“'}
        .mh{font-size:12.5px;color:var(--muted);text-align:center;margin-bottom:8px}
        .fl{display:flex;gap:18px;justify-content:center;margin-top:16px}
        .fc{width:135px;height:155px;background:var(--card);border:2.5px solid rgba(255,255,255,.06);border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer;transition:all .3s}
        .fc:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 10px 28px rgba(255,107,43,.18)}
        .fe{font-size:42px;line-height:1}.fn{font-family:'Fredoka',sans-serif;font-size:17px;font-weight:600}
        .bt{width:100%;padding:16px;border:none;border-radius:var(--r);background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:17px;font-weight:700;cursor:pointer;margin-top:20px;transition:all .25s;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .bt:hover{transform:translateY(-2px);box-shadow:0 7px 24px rgba(255,107,43,.35)}.bt:disabled{opacity:.35;cursor:not-allowed;transform:none}
        .ip{width:100%;padding:16px 18px;border:2px solid rgba(255,255,255,.06);border-radius:var(--r);background:var(--card);color:var(--txt);font-size:16px;font-weight:600;outline:none}.ip:focus{border-color:var(--accent)}.ip::placeholder{color:var(--muted)}
        .sp{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;text-align:center}
        .sp-t{font-family:'Fredoka',sans-serif;font-size:40px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.15}
        .sp-s{font-size:17px;color:var(--muted);max-width:280px}
        .badge{display:inline-flex;align-items:center;gap:7px;background:rgba(255,107,43,.1);border:1px solid rgba(255,107,43,.25);border-radius:28px;padding:5px 14px;font-family:'Fredoka',sans-serif;font-size:13px;color:var(--accent)}
        .rt{background:var(--card);border:1.5px solid rgba(0,212,255,.12);border-radius:var(--r);padding:16px 18px;margin-bottom:10px;display:flex;align-items:center;gap:14px;animation:ri .5s ease-out backwards}
        @keyframes ri{from{opacity:0;transform:translateX(-24px)}to{opacity:1;transform:translateX(0)}}
        .rn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--electric));display:flex;align-items:center;justify-content:center;font-family:'Fredoka',sans-serif;font-weight:700;font-size:16px;flex-shrink:0}
        .rtt{font-family:'Fredoka',sans-serif;font-size:14.5px;font-weight:600}.rd{font-size:12px;color:var(--muted)}
        .rl{width:2px;height:16px;background:linear-gradient(var(--accent),var(--electric));margin-left:35px;border-radius:2px}
        .typing{display:inline-flex;gap:4px;align-items:center;padding:4px 0}
        .typing .dot{width:8px;height:8px;border-radius:50%;background:var(--electric);animation:tblink 1.4s infinite both}
        .typing .dot:nth-child(2){animation-delay:.2s}.typing .dot:nth-child(3){animation-delay:.4s}
        @keyframes tblink{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
        
        /* MUSIC BUTTON */
        .music-btn{position:fixed;top:60px;right:76px;z-index:800;width:44px;height:44px;border-radius:50%;background:var(--card);border:2px solid rgba(0,212,255,0.3);color:var(--electric);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .music-btn:hover{background:var(--card2);border-color:var(--electric);transform:scale(1.1)}
        .music-btn.muted{color:var(--muted);border-color:rgba(255,255,255,0.1)}
        .music-settings{position:fixed;top:60px;right:128px;z-index:800;width:44px;height:44px;border-radius:50%;background:var(--card);border:2px solid rgba(0,212,255,0.15);color:var(--electric);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .music-settings:hover{transform:scale(1.15);border-color:var(--electric)}
        
        /* QUIZ SELECTOR - SECTIONS */
        .qs-section{background:var(--card);border:2px solid rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;transition:all 0.3s}
        .qs-section.locked{opacity:0.5}
        .qs-section-head{padding:16px;cursor:pointer;display:flex;align-items:center;gap:14px;transition:background 0.2s}
        .qs-section-head:hover{background:rgba(255,255,255,0.03)}
        .qs-section-icon{font-size:36px;width:52px;height:52px;display:flex;align-items:center;justify-content:center;border-radius:14px;flex-shrink:0}
        .qs-section-info{flex:1}
        .qs-section-title{font-family:'Fredoka',sans-serif;font-size:17px;font-weight:700}
        .qs-section-meta{font-size:11px;color:var(--muted);margin-top:2px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .qs-section-progress{font-size:11px;font-weight:700;padding:2px 8px;border-radius:8px}
        .qs-section-arrow{font-size:18px;color:var(--muted);transition:transform 0.3s;flex-shrink:0}
        .qs-section.open .qs-section-arrow{transform:rotate(180deg)}
        .qs-section-body{max-height:0;overflow:hidden;transition:max-height 0.4s ease}
        .qs-section.open .qs-section-body{max-height:800px}
        .qs-section-levels{padding:0 12px 14px 12px;display:flex;flex-direction:column;gap:8px}
        .qs-level{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s}
        .qs-level:hover{border-color:var(--electric);background:rgba(0,212,255,0.05)}
        .qs-level-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
        .qs-level-info{flex:1}
        .qs-level-name{font-size:14px;font-weight:600}
        .qs-level-count{font-size:11px;color:var(--muted)}
        .qs-level-badge{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:700}
        .qs-level-badge.new{background:var(--electric);color:var(--bg)}
        .qs-level-badge.done{background:rgba(76,175,80,0.2);color:#4caf50}
        .qs-level-stars{font-size:11px;margin-left:4px}
        .qs-lock-badge{font-size:10px;padding:3px 10px;border-radius:8px;background:rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
        /* Legacy compat */
        .quiz-sel-card{background:var(--card);border:2px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px 16px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden}
        .quiz-sel-card:hover{border-color:var(--electric);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,212,255,0.15)}
        .quiz-sel-card .qs-icon{font-size:40px;width:56px;height:56px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);border-radius:14px;flex-shrink:0}
        .quiz-sel-card .qs-info{flex:1}
        .quiz-sel-card .qs-title{font-family:'Fredoka',sans-serif;font-size:17px;font-weight:700;margin-bottom:2px}
        .quiz-sel-card .qs-desc{font-size:12px;color:var(--muted);line-height:1.3}

        /* QUIZ STYLES */
        .quiz-header{width:100%;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .quiz-cat{font-size:11px;color:var(--electric);text-transform:uppercase;letter-spacing:1.5px;font-weight:700}
        .quiz-score{display:flex;align-items:center;gap:8px;font-family:'Fredoka',sans-serif;font-size:14px}
        .quiz-score .correct{color:#2ecc71}.quiz-score .wrong{color:#e74c3c}
        .quiz-num{font-family:'Fredoka',sans-serif;font-size:15px;color:var(--txt);text-align:center;margin:4px 0}
        .quiz-q{background:var(--card);border:1.5px solid rgba(0,212,255,.15);border-radius:var(--r);padding:20px;margin:12px 0;text-align:center;font-size:17px;font-weight:700;line-height:1.5}
        .quiz-opts{width:100%;display:flex;flex-direction:column;gap:10px}
        .quiz-opt{background:var(--card);border:2px solid rgba(255,255,255,.08);border-radius:var(--r);padding:16px 18px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:14px;font-size:15px;font-weight:600}
        .quiz-opt:hover{border-color:rgba(255,107,43,.4);background:var(--card2);transform:translateY(-1px)}
        .quiz-opt.correct{border-color:#2ecc71;background:rgba(46,204,113,0.15)}
        .quiz-opt.correct .quiz-letter{background:#2ecc71}
        .quiz-opt.wrong{border-color:#e74c3c;background:rgba(231,76,60,0.15)}
        .quiz-opt.wrong .quiz-letter{background:#e74c3c}
        .quiz-opt.disabled{pointer-events:none;opacity:0.6}
        .quiz-opt.disabled.correct{opacity:1}
        .quiz-letter{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;flex-shrink:0;transition:all .3s}
        .quiz-explain{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:var(--r);padding:14px 18px;margin-top:12px;font-size:14px;line-height:1.5;display:none}
        .quiz-explain.show{display:block}
        .quiz-explain b{color:var(--electric)}
        .quiz-next{width:100%;padding:14px;border:none;border-radius:var(--r);background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;cursor:pointer;margin-top:14px;display:none;transition:all .25s;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .quiz-next:hover{transform:translateY(-2px)}
        .quiz-next.show{display:block}
        .quiz-nav{display:flex;gap:10px;width:100%;margin-top:14px}
        .quiz-nav button{flex:1;padding:14px;border:none;border-radius:var(--r);font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all .25s;display:none}
        .quiz-nav button.show{display:block}
        .quiz-prev{background:var(--card);border:2px solid rgba(0,212,255,0.3) !important;color:var(--electric)}
        .quiz-prev:hover{border-color:var(--electric) !important;transform:translateY(-2px)}
        .quiz-fwd{background:linear-gradient(135deg,var(--accent),#e84500);color:white;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .quiz-fwd:hover{transform:translateY(-2px)}
        .quiz-result{text-align:center;width:100%}
        .quiz-result-score{font-family:'Fredoka',sans-serif;font-size:64px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .quiz-result-label{font-size:18px;color:var(--muted);margin-top:4px}
        .quiz-result-msg{font-size:16px;margin-top:16px;line-height:1.5}
        .quiz-medal{font-size:80px;margin:16px 0}
        .quiz-stars{display:flex;justify-content:center;gap:6px;margin:12px 0}
        .quiz-stars span{font-size:32px;opacity:0.2;transition:all 0.5s}
        .quiz-stars span.lit{opacity:1;animation:starPop 0.5s ease-out}
        @keyframes starPop{0%{transform:scale(0)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
        
        /* CELEBRATION EFFECTS */
        @keyframes screenShake{0%,100%{transform:translateX(0)}10%,50%,90%{transform:translateX(-4px)}30%,70%{transform:translateX(4px)}}
        @keyframes bigShake{0%,100%{transform:translateX(0)}10%,50%,90%{transform:translateX(-8px) rotate(-1deg)}30%,70%{transform:translateX(8px) rotate(1deg)}}
        @keyframes lightning{0%{opacity:0}5%{opacity:0.8}10%{opacity:0}15%{opacity:1}20%{opacity:0}100%{opacity:0}}
        @keyframes streakPulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
        @keyframes fireFloat{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-120px) scale(0.3);opacity:0}}
        .shake{animation:screenShake 0.4s ease}
        .big-shake{animation:bigShake 0.6s ease}
        .streak-badge{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:900;font-size:48px;font-family:'Fredoka',sans-serif;font-weight:700;color:white;text-shadow:0 0 30px rgba(255,107,43,0.8),0 0 60px rgba(255,107,43,0.4);animation:streakPulse 0.6s ease;pointer-events:none;white-space:nowrap}
        .lightning-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:850;pointer-events:none;animation:lightning 0.4s ease}
        .fire-emoji{position:fixed;z-index:850;font-size:36px;pointer-events:none;animation:fireFloat 1.2s ease-out forwards}
        
        /* PROFILE SYSTEM */
        .profile-btn{position:fixed;top:60px;right:20px;z-index:800;width:48px;height:48px;border-radius:50%;background:var(--card);border:2px solid rgba(255,215,0,0.4);color:var(--gold);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
        .profile-btn:hover{transform:scale(1.1);border-color:var(--gold)}
        .prof-card{background:var(--card);border:2px solid rgba(255,215,0,0.2);border-radius:16px;padding:20px;text-align:center;width:100%}
        .prof-name{font-family:'Fredoka',sans-serif;font-size:24px;font-weight:700;margin-top:8px}
        .prof-title{color:var(--electric);font-size:13px;text-transform:uppercase;letter-spacing:1.5px;margin-top:4px}
        .prof-level{display:flex;align-items:center;justify-content:center;gap:12px;margin:16px 0}
        .prof-lvl-num{font-family:'Fredoka',sans-serif;font-size:48px;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .prof-xp{width:100%;margin-top:8px}
        .prof-xp-bar{width:100%;height:12px;background:rgba(255,255,255,0.08);border-radius:6px;overflow:hidden}
        .prof-xp-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--accent));border-radius:6px;transition:width 0.5s}
        .prof-xp-txt{font-size:12px;color:var(--muted);margin-top:4px}
        .prof-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:16px}
        .prof-stat{background:rgba(255,255,255,0.04);border-radius:12px;padding:12px 8px;text-align:center}
        .prof-stat-num{font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;color:var(--electric)}
        .prof-stat-label{font-size:11px;color:var(--muted);margin-top:2px}
        .medals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;width:100%}
        .medal-slot{background:var(--card);border:2px solid rgba(255,255,255,0.06);border-radius:14px;padding:16px 10px;text-align:center;transition:all 0.3s}
        .medal-slot.earned{border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.05)}
        .medal-slot .medal-icon{font-size:36px;opacity:0.2}
        .medal-slot.earned .medal-icon{opacity:1}
        .medal-slot .medal-name{font-size:11px;margin-top:6px;color:var(--muted);font-weight:600}
        .medal-slot.earned .medal-name{color:var(--gold)}
        
        /* AVATAR PICKER - INDUSTRY THEMED */
        .prof-avatar{font-size:64px;cursor:pointer;transition:transform 0.3s;position:relative;display:flex;align-items:center;justify-content:center}
        .prof-avatar:hover{transform:scale(1.1)}
        .prof-avatar-edit{position:absolute;bottom:-4px;right:-4px;background:var(--accent);color:white;border-radius:50%;width:24px;height:24px;font-size:12px;display:flex;align-items:center;justify-content:center}
        .avatar-picker{display:none;background:var(--card);border:2px solid rgba(0,212,255,0.2);border-radius:16px;padding:16px;margin:12px auto 0;width:100%;max-width:400px}
        .avatar-picker.open{display:block}
        .avatar-picker-title{font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700;color:var(--electric);margin-bottom:6px;text-align:center}
        .avatar-picker-sub{font-size:11px;color:var(--muted);text-align:center;margin-bottom:12px}
        .avatar-section{margin-bottom:14px}
        .avatar-section-title{font-family:'Fredoka',sans-serif;font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;padding-left:4px;display:flex;align-items:center;gap:6px}
        .avatar-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .avatar-option{padding:8px 4px;text-align:center;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent;background:rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;gap:4px}
        .avatar-option:hover{background:rgba(0,212,255,0.1);transform:scale(1.05)}
        .avatar-option.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
        .avatar-option .av-icon{font-size:32px;line-height:1.2}
        .avatar-option .av-name{font-size:9px;color:var(--muted);font-weight:600;line-height:1.2;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .avatar-option.selected .av-name{color:var(--gold)}
        .avatar-option.locked{opacity:0.35;cursor:not-allowed;position:relative}
        .avatar-option.locked:hover{transform:none;background:rgba(255,255,255,0.03)}
        .avatar-option.locked .av-icon{filter:grayscale(1)}
        .avatar-option .av-lock{font-size:10px;color:var(--accent);font-weight:700;line-height:1}
        
        /* MUSIC PICKER */
        .music-panel{position:fixed;top:72px;right:12px;z-index:810;background:var(--card);border:2px solid rgba(0,212,255,0.2);border-radius:16px;padding:16px;width:290px;display:none;box-shadow:0 8px 32px rgba(0,0,0,0.5);max-height:80vh;overflow-y:auto}
        .music-panel.open{display:block;animation:fadeIn 0.3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .music-panel-title{font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;color:var(--electric);margin-bottom:12px;text-align:center}
        .music-option{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s;border:2px solid transparent;margin-bottom:6px;background:rgba(255,255,255,0.03)}
        .music-option:hover{background:rgba(0,212,255,0.08)}
        .music-option.selected{border-color:var(--electric);background:rgba(0,212,255,0.1)}
        .music-option-icon{font-size:24px;width:36px;text-align:center}
        .music-option-info{flex:1}
        .music-option-name{font-family:'Fredoka',sans-serif;font-size:14px;font-weight:600}
        .music-option-desc{font-size:11px;color:var(--muted)}
        .music-upload{margin-top:8px;padding:10px;border:2px dashed rgba(255,255,255,0.15);border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s}
        .music-upload:hover{border-color:var(--electric);background:rgba(0,212,255,0.05)}
        .music-upload-label{font-size:12px;color:var(--muted)}
        .music-upload-name{font-size:12px;color:var(--electric);margin-top:4px;font-weight:600;display:none}
        
        /* ========== 3-ZONE HUB ========== */
        .hub-title{font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;text-align:center;margin:8px 0 4px;color:var(--txt)}
        .hub-sub{font-size:13px;color:var(--muted);text-align:center;margin-bottom:16px}
        .zone-cards{width:100%;display:flex;flex-direction:column;gap:14px}
        .zone-card{background:var(--card);border:2.5px solid rgba(255,255,255,0.06);border-radius:20px;padding:20px 18px;cursor:pointer;transition:all 0.35s;display:flex;align-items:center;gap:16px;position:relative;overflow:hidden}
        .zone-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--zone-color,transparent) 0%,transparent 60%);opacity:0.06;transition:opacity 0.3s}
        .zone-card:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,0.3)}
        .zone-card:hover::before{opacity:0.12}
        .zone-card:active{transform:scale(0.98)}
        .zone-icon{width:64px;height:64px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0;transition:all 0.3s}
        .zone-card:hover .zone-icon{transform:scale(1.08)}
        .zone-info{flex:1}
        .zone-name{font-family:'Fredoka',sans-serif;font-size:18px;font-weight:700;margin-bottom:2px}
        .zone-desc{font-size:12.5px;color:var(--muted);line-height:1.4}
        .zone-badge{position:absolute;top:12px;right:12px;font-size:10px;padding:3px 10px;border-radius:10px;font-weight:700;text-transform:uppercase;font-family:'Fredoka',sans-serif}
        .zone-stat{display:flex;gap:8px;margin-top:6px}
        .zone-stat-item{font-size:11px;color:var(--electric);font-weight:600;display:flex;align-items:center;gap:4px}
        .zone-card.quiz-zone{border-color:rgba(0,212,255,0.2);--zone-color:#00d4ff}
        .zone-card.quiz-zone .zone-icon{background:rgba(0,212,255,0.12);color:#00d4ff}
        .zone-card.quiz-zone .zone-name{color:#00d4ff}
        .zone-card.quiz-zone:hover{border-color:rgba(0,212,255,0.5)}
        .zone-card.study-zone{border-color:rgba(255,107,43,0.2);--zone-color:#ff6b2b}
        .zone-card.study-zone .zone-icon{background:rgba(255,107,43,0.12);color:#ff6b2b}
        .zone-card.study-zone .zone-name{color:#ff6b2b}
        .zone-card.study-zone:hover{border-color:rgba(255,107,43,0.5)}
        .zone-card.video-zone{border-color:rgba(155,89,182,0.2);--zone-color:#9b59b6}
        .zone-card.video-zone .zone-icon{background:rgba(155,89,182,0.12);color:#9b59b6}
        .zone-card.video-zone .zone-name{color:#9b59b6}
        .zone-card.video-zone:hover{border-color:rgba(155,89,182,0.5)}
        .zone-card.newbie-zone{border-color:rgba(52,152,219,0.2);--zone-color:#3498db}
        .zone-card.newbie-zone .zone-icon{background:rgba(52,152,219,0.12);color:#3498db}
        .zone-card.newbie-zone .zone-name{color:#3498db}
        .zone-card.newbie-zone:hover{border-color:rgba(52,152,219,0.5)}
        .zone-count{background:rgba(255,255,255,0.06);border-radius:8px;padding:2px 8px;font-size:11px;color:var(--muted);font-weight:600}
        
        /* STUDY ZONE */
        .study-empty{text-align:center;padding:40px 20px}
        .study-empty-icon{font-size:72px;margin-bottom:16px}
        .study-empty-title{font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:var(--electric);margin-bottom:8px}
        .study-empty-desc{font-size:14px;color:var(--muted);line-height:1.5;max-width:300px;margin:0 auto}
        .study-topic{background:var(--card);border:2px solid rgba(255,107,43,0.15);border-radius:14px;padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;gap:12px}
        .study-topic:hover{border-color:var(--accent);transform:translateY(-2px)}
        .study-topic-icon{font-size:28px;width:44px;text-align:center}
        .study-topic-info{flex:1}
        .study-topic-name{font-family:'Fredoka',sans-serif;font-size:15px;font-weight:700}
        .study-topic-count{font-size:12px;color:var(--accent);font-weight:600;margin-top:2px}
        .study-alert{background:linear-gradient(135deg,rgba(255,107,43,0.12),rgba(231,76,60,0.08));border:1.5px solid rgba(255,107,43,0.25);border-radius:14px;padding:14px 16px;margin-bottom:16px;text-align:center;font-size:13px;color:var(--accent);line-height:1.5}
        .study-alert b{color:var(--txt)}
        
        /* VIDEO ZONE */
        .video-card{background:var(--card);border:2px solid rgba(155,89,182,0.15);border-radius:16px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;gap:14px}
        .video-card:hover{border-color:rgba(155,89,182,0.4);transform:translateY(-2px)}
        .video-card-thumb{width:72px;height:50px;border-radius:10px;background:rgba(155,89,182,0.15);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0}
        .video-card-info{flex:1}
        .video-card-title{font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700}
        .video-card-desc{font-size:11px;color:var(--muted);margin-top:2px}
        .video-card-dur{font-size:11px;color:#9b59b6;font-weight:600;margin-top:4px}
        .video-section-title{font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;color:var(--txt);margin:16px 0 10px;display:flex;align-items:center;gap:8px}
        
        /* FLOATING NAV FOR LIBRARY */
        .lib-float-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:460px;display:flex;gap:8px;padding:12px 18px;background:linear-gradient(to top,var(--dark) 70%,transparent);z-index:50;pointer-events:none}
        .lib-float-nav .bt{pointer-events:auto;box-shadow:0 -4px 20px rgba(0,0,0,0.5)}
        
        /* STUDY LIBRARY STYLES */
        .zone-card.library-zone{border-color:rgba(46,204,113,0.2);--zone-color:#2ecc71}
        .zone-card.library-zone .zone-icon{background:rgba(46,204,113,0.12);color:#2ecc71}
        .zone-card.library-zone .zone-name{color:#2ecc71}
        
        /* STUDY REDIRECT BANNER */
        .study-redirect{background:linear-gradient(135deg,rgba(255,107,43,0.15),rgba(231,76,60,0.1));border:2px solid rgba(255,107,43,0.3);border-radius:16px;padding:18px;margin-top:14px;text-align:center;animation:pulse-border 2s infinite}
        @keyframes pulse-border{0%,100%{border-color:rgba(255,107,43,0.3)}50%{border-color:rgba(255,107,43,0.7)}}
        .study-redirect-icon{font-size:40px;margin-bottom:8px}
        .study-redirect-title{font-family:'Fredoka',sans-serif;font-size:16px;font-weight:700;color:var(--accent)}
        .study-redirect-desc{font-size:13px;color:var(--muted);margin:6px 0 12px;line-height:1.4}
        
        /* ========== FORMULA HELPER ========== */
        .formula-helper{display:none;width:100%;margin:8px 0;animation:si .4s ease}
        .formula-helper.show{display:block}
        .formula-hint{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(99,102,241,0.06));border:1.5px solid rgba(0,212,255,0.2);border-radius:14px;padding:12px 16px;margin-bottom:8px}
        .formula-hint-title{font-family:'Fredoka',sans-serif;font-size:13px;font-weight:700;color:var(--electric);display:flex;align-items:center;gap:8px;margin-bottom:6px}
        .formula-hint-text{font-size:14px;color:var(--txt);line-height:1.4}
        .formula-hint-text .formula-big{font-family:'Fredoka',sans-serif;font-size:22px;font-weight:700;color:var(--gold);display:block;text-align:center;margin:8px 0;letter-spacing:1px}
        .formula-hint-text .formula-vars{font-size:12px;color:var(--muted);text-align:center;display:block;margin-top:2px}
        .formula-toggle{background:var(--card);border:2px solid rgba(0,212,255,0.2);border-radius:12px;padding:10px 16px;cursor:pointer;transition:all 0.25s;display:flex;align-items:center;justify-content:center;gap:8px;font-family:'Fredoka',sans-serif;font-size:14px;font-weight:600;color:var(--electric);margin-bottom:8px}
        .formula-toggle:hover{border-color:var(--electric);background:rgba(0,212,255,0.05)}
        .formula-toggle.open{border-color:var(--electric);background:rgba(0,212,255,0.08)}
        
        /* POWER WHEEL */
        .power-wheel{display:none;margin:10px auto;text-align:center}
        .power-wheel.show{display:block}
        .pw-container{position:relative;width:220px;height:220px;margin:0 auto}
        .pw-svg{width:100%;height:100%}
        .pw-label{font-size:11px;color:var(--muted);text-align:center;margin-top:6px}
        
        /* MOTIVATIONAL QUOTE */
        .motive-bar{display:none;width:100%;background:linear-gradient(135deg,rgba(255,107,43,0.06),rgba(241,196,15,0.04));border:1px solid rgba(241,196,15,0.15);border-radius:12px;padding:10px 14px;margin:6px 0;text-align:center}
        .motive-bar.show{display:block}
        .motive-text{font-size:12.5px;color:var(--gold);font-style:italic;line-height:1.4}
        .motive-author{font-size:10px;color:var(--muted);margin-top:3px;font-weight:600}
    </style>
</head>
<body>
<div class="bg"><div class="o"></div><div class="o"></div><div class="o"></div></div>
<div class="gr"></div>

<!-- VIDEO FLOTANTE DESDE LA DERECHA -->
<div class="video-float" id="videoFloat">
    <div class="video-float-glow"></div>
    <div class="video-float-inner">
        <div class="video-float-label" id="videoLabel">ðŸ”´ EN VIVO</div>
        <button class="video-float-close" onclick="closeVideo()">âœ•</button>
        <video id="marioVideo" playsinline webkit-playsinline></video>
        <div id="videoSubtitle" style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.85));padding:16px 12px 10px;text-align:center;font-family:'Fredoka',sans-serif;pointer-events:none">
            <div style="color:#ffd700;font-size:11px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.8)">âš¡ Si no mides, estÃ¡s adivinando</div>
            <div style="color:rgba(255,255,255,0.7);font-size:9px;font-style:italic;margin-top:2px;text-shadow:0 1px 3px rgba(0,0,0,0.8)">If you don't measure, you're guessing</div>
        </div>
    </div>
</div>

<!-- MODAL AI CHAT -->
<div class="ai-modal" id="aiModal">
    <div class="ai-chat">
        <div class="ai-chat-header">
            <div class="ai-chat-avatar"><img src="mario.jpg" alt="Mario"></div>
            <div class="ai-chat-title"><h3>Maestro Mario AI</h3><span id="aiChatStatus">ðŸŸ¢ Disponible para ayudarte</span></div>
            <button class="ai-chat-close" onclick="closeAIChat()">âœ•</button>
        </div>
        <div class="ai-chat-messages" id="aiMessages">
            <div class="ai-msg mario" id="aiChatWelcome">Â¡Ã“rale! Soy el Maestro Mario con inteligencia artificial. Â¿En quÃ© te puedo ayudar? PregÃºntame lo que quieras sobre HVAC, refrigeraciÃ³n, o electricidad. ðŸ”§</div>
        </div>
        <div class="speaking-indicator" id="speakingIndicator">
            <div class="waves"><div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>
            <span id="aiChatTyping">Maestro Mario estÃ¡ hablando...</span>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiInput" placeholder="Escribe tu pregunta..." onkeydown="if(event.key==='Enter'&&!event.shiftKey)sendAIMessage()">
            <button id="sendBtn" onclick="sendAIMessage()">âž¤</button>
        </div>
    </div>
</div>

<!-- AUDIO PLAYER PARA VOZ DE AI -->
<audio id="aiAudio" style="display:none"></audio>

<div class="app">
<!-- PANTALLA INICIO -->
<div class="s on" id="s0"><div class="sp">
    <div class="aw lg" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="Maestro Mario"></div><span class="ai-badge">AI</span></div>
    <div><div class="sp-t">MAESTRO<br>MARIO</div><div class="badge">âš¡ NIVEL 33</div></div>
    <div class="sp-s">Si no mides, estÃ¡s adivinando<br><span style="font-size:12px;opacity:0.7;font-style:italic">If you don't measure, you're guessing</span></div>
    <button class="bt" onclick="startWithVideo()" style="max-width:260px">Comenzar / Start</button>
    <div style="margin-top:24px;text-align:center">
      <div style="font-family:'Fredoka',sans-serif;font-size:14px;font-weight:700;color:#ffffff;letter-spacing:3px;text-transform:uppercase;text-shadow:0 0 15px rgba(37,99,235,0.4)">A.C. VOLT TECHNICAL SCHOOLâ„¢</div>
      <div style="font-size:9px;color:rgba(255,255,255,0.5);margin-top:6px;letter-spacing:1px">Â© 2026 A.C. VOLT TECH SCHOOL, INC. All Rights Reserved.</div>
    </div>
</div></div>

<!-- IDIOMA -->
<div class="s" id="s1">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div><div class="lo-s">HVAC â€¢ ELECTRICAL â€¢ TRAINING</div></div>
    <div class="aw md" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb">Â¡Hola! Choose your language<br>Elige tu idioma</div>
    <div class="fl"><div class="fc" onclick="setLang('es')"><span class="fe" style="font-size:28px;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Fredoka',sans-serif;font-weight:700">ES</span><span class="fn">EspaÃ±ol</span></div><div class="fc" onclick="setLang('en')"><span class="fe" style="font-size:28px;background:linear-gradient(135deg,var(--electric),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Fredoka',sans-serif;font-weight:700">EN</span><span class="fn">English</span></div></div>
</div>

<!-- NOMBRE -->
<div class="s" id="s2">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:20%"></div></div><div class="ps"><b data-t="step_1"></b></div>
    <div class="aw md" id="a2" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb2"><span data-t="welcome_speech"></span></div>
    <div style="width:100%"><input class="ip" id="nm" data-tp="name_ph" oninput="document.getElementById('b2').disabled=this.value.trim().length<2"><button class="bt" id="b2" disabled onclick="sName()" data-t="continue"></button></div>
</div>

<!-- NIVEL -->
<div class="s" id="s3">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:40%"></div></div><div class="ps"><b data-t="step_2"></b></div>
    <div class="aw sm" id="a3" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb3"><span data-t="level_speech"></span></div>
    <div class="os" id="lo"></div>
    <button class="bt" id="b3" disabled onclick="sLvl()" data-t="continue"></button>
</div>

<!-- ESPECIALIDADES -->
<div class="s" id="s4">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:60%"></div></div><div class="ps"><b data-t="step_3"></b></div>
    <div class="aw sm" id="a4" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb4"><span data-t="spec_speech"></span></div>
    <p class="mh" data-t="multi_hint"></p>
    <div class="os" id="so"></div>
    <button class="bt" id="b4" disabled onclick="sSpc()" data-t="continue"></button>
</div>

<!-- ESCUELA -->
<div class="s" id="s5">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:80%"></div></div><div class="ps"><b data-t="step_4"></b></div>
    <div class="aw sm" id="a5" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb5"><span data-t="school_speech"></span></div>
    <div class="os" id="sco"></div>
    <button class="bt" id="b5" disabled onclick="sSch()" data-t="continue"></button>
</div>

<!-- METAS -->
<div class="s" id="s6">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:90%"></div></div><div class="ps"><b data-t="step_5"></b></div>
    <div class="aw sm" id="a6" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb6"><span data-t="goals_speech"></span></div>
    <p class="mh" data-t="multi_hint"></p>
    <div class="os" id="go2"></div>
    <button class="bt" id="b6" disabled onclick="sGol()" data-t="continue"></button>
</div>

<!-- RUTA FINAL -->
<div class="s" id="s7">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:100%"></div></div>
    <div class="aw md" id="a7" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--gold) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="bb7"><span data-t="route_speech"></span></div>
    <div id="rl" style="width:100%"></div>
    <button class="bt" onclick="startApp()" data-t="start_btn"></button>
</div>

<!-- ========== 3-ZONE HUB ========== -->
<div class="s" id="s-hub">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--electric) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="hubBubble">Â¿QuÃ© quieres hacer hoy?</div>
    
    <div class="zone-cards">
        <!-- I'M NEW TO HVAC ZONE (FIRST - for beginners) -->
        <div class="zone-card newbie-zone" onclick="goNewbieZone()">
            <div class="zone-icon">ðŸ†•</div>
            <div class="zone-info">
                <div class="zone-name" style="color:#3498db" id="hubNewbieName">Soy Nuevo en HVAC</div>
                <div class="zone-desc" id="hubNewbieDesc">IntroducciÃ³n a HVACR: la industria, herramientas, terminologÃ­a, salarios y cÃ³mo empezar tu carrera</div>
                <div class="zone-stat">
                    <span class="zone-stat-item" id="hubNewbieStat">ðŸŽ“ 8 temas + 50 preguntas</span>
                </div>
            </div>
            <div class="zone-badge" style="background:rgba(52,152,219,0.15);color:#3498db" id="hubNewbieBadge">Nivel 1</div>
        </div>
        
        <!-- QUIZ ZONE -->
        <div class="zone-card quiz-zone" onclick="goQuizZone()">
            <div class="zone-icon">ðŸ“</div>
            <div class="zone-info">
                <div class="zone-name" id="hubQuizName">Quiz Zone</div>
                <div class="zone-desc" id="hubQuizDesc">Toma quizzes y demuestra lo que sabes</div>
                <div class="zone-stat">
                    <span class="zone-stat-item" id="hubQuizCount">ðŸ“‹ 0 quizzes</span>
                    <span class="zone-stat-item" id="hubQuizTotal">ðŸ“Š 0 preguntas</span>
                </div>
            </div>
            <div class="zone-badge" style="background:rgba(0,212,255,0.15);color:#00d4ff" id="hubQuizBadge">Â¡Vamos!</div>
        </div>
        
        <!-- ZONA DE REPASO (failed questions) -->
        <div class="zone-card study-zone" onclick="goStudyZone()">
            <div class="zone-icon">ðŸ”„</div>
            <div class="zone-info">
                <div class="zone-name" id="hubRepasoName">Zona de Repaso</div>
                <div class="zone-desc" id="hubRepasoDesc">Repasa solo las preguntas que fallaste en los quizzes</div>
                <div class="zone-stat">
                    <span class="zone-stat-item" id="hubStudyCount">ðŸ”„ 0 por repasar</span>
                </div>
            </div>
            <div class="zone-badge" style="background:rgba(255,107,43,0.15);color:#ff6b2b;display:none" id="hubStudyBadge">âš ï¸ Repasa</div>
        </div>
        
        <!-- ZONA DE ESTUDIO (all questions with explanations) -->
        <div class="zone-card" style="border-color:rgba(46,204,113,0.2)" onclick="goStudyLibrary()">
            <div class="zone-icon" style="background:rgba(46,204,113,0.12);color:#2ecc71">ðŸ“–</div>
            <div class="zone-info">
                <div class="zone-name" style="color:#2ecc71" id="hubEstudioName">Zona de Estudio</div>
                <div class="zone-desc" id="hubEstudioDesc">Todas las preguntas con explicaciones detalladas, fÃ³rmulas y ejemplos de campo</div>
                <div class="zone-stat">
                    <span class="zone-stat-item" id="hubLibraryCount">ðŸ“– 0 temas disponibles</span>
                </div>
            </div>
            <div class="zone-badge" style="background:rgba(46,204,113,0.15);color:#2ecc71">ðŸ“– Estudia</div>
        </div>
        
        <!-- VIDEO ZONE -->
        <div class="zone-card video-zone" onclick="goVideoZone()">
            <div class="zone-icon">ðŸŽ¥</div>
            <div class="zone-info">
                <div class="zone-name" id="hubVideoName">Video Zone</div>
                <div class="zone-desc" id="hubVideoDesc">Videos de Maestro Mario para aprender visualmente</div>
                <div class="zone-stat">
                    <span class="zone-stat-item">ðŸŽ¬ Videos de entrenamiento</span>
                </div>
            </div>
            <div class="zone-badge" style="background:rgba(155,89,182,0.15);color:#9b59b6">Pronto</div>
        </div>
    </div>
    
    <button class="bt" onclick="go('s10');renderProfile()" style="background:var(--card);border:2px solid var(--gold);margin-top:16px" id="hubProfileBtn">ðŸ‘¤ Mi Perfil</button>
    <button class="bt" onclick="go('s7')" style="background:var(--card);border:2px solid var(--accent);margin-top:8px" id="hubRutaBtn">â† Mi Ruta</button>
</div>

<!-- I'M NEW TO HVAC ZONE -->
<div class="s" id="s-newbie">
    <div class="lo"><div class="lo-t" id="newbieTitle">ðŸ†• SOY NUEVO EN HVAC</div></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,#3498db 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="newbieBubble">Â¡Bienvenido al mundo HVAC! AquÃ­ te explico todo lo que necesitas saber para empezar.</div>
    
    <!-- QUIZ BUTTON -->
    <button class="bt" onclick="startIntroQuiz()" style="background:linear-gradient(135deg,#3498db,#2980b9);margin-bottom:16px;font-size:16px;padding:16px" id="newbieQuizBtn">ðŸ“ Tomar Quiz Intro HVACR (50 preguntas)</button>
    
    <div id="newbieContent" style="width:100%;display:flex;flex-direction:column;gap:14px;margin-top:8px"></div>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid #3498db;margin-top:16px" data-lang="volver-hub">â† Volver al Hub</button>
</div>

<!-- QUIZ ZONE SELECTOR -->
<div class="s" id="s7b">
    <div class="lo"><div class="lo-t">ðŸ“ QUIZ ZONE</div></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--electric) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="quizSelBubble">Â¿QuÃ© quiz quieres tomar hoy?</div>
    <div id="quizSelList" style="width:100%;display:flex;flex-direction:column;gap:12px;margin-top:16px"></div>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--electric);margin-top:16px" data-lang="volver-hub">â† Volver al Hub</button>
</div>

<!-- STUDY ZONE -->
<div class="s" id="s-study">
    <div class="lo"><div class="lo-t" id="repasoTitle">ðŸ”„ ZONA DE REPASO</div></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--accent) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="studyBubble"></div>
    <div id="studyContent" style="width:100%;margin-top:16px"></div>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--accent);margin-top:16px" data-lang="volver-hub">â† Volver al Hub</button>
</div>

<!-- STUDY QUIZ (reuses quiz UI but in study mode) -->
<div class="s" id="s-study-quiz">
    <div class="quiz-header">
        <div class="quiz-cat" id="sqCat">ðŸ“š REPASO</div>
        <div class="quiz-score">âœ… <span class="correct" id="sqRight">0</span> | âŒ <span class="wrong" id="sqWrong">0</span></div>
    </div>
    <div class="pb"><div class="pbf" id="sqBar" style="width:0%"></div></div>
    <div class="quiz-num" id="sqNum"></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="sqBubble"></div>
    <div class="quiz-q" id="sqText"></div>
    <div class="quiz-opts" id="sqOpts"></div>
    <div class="quiz-explain" id="sqExplain"></div>
    <div class="quiz-nav">
        <button class="quiz-prev" id="sqPrev" onclick="studyPrev()"></button>
        <button class="quiz-fwd" id="sqNext" onclick="studyNext()"></button>
    </div>
</div>

<!-- STUDY RESULT -->
<div class="s" id="s-study-result">
    <div class="aw md" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--accent) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="quiz-result">
        <div class="quiz-medal" id="srMedal"></div>
        <div class="quiz-result-score" id="srScore"></div>
        <div class="quiz-result-label" id="srLabel"></div>
        <div class="bb quiz-result-msg" id="srMsg"></div>
    </div>
    <button class="bt" onclick="startStudyQuiz(lastStudyCat)" id="studyRetryBtn">ðŸ”„ Repasar de Nuevo</button>
    <button class="bt" onclick="go('s-study');renderStudyZone()" style="background:var(--card);border:2px solid var(--accent);margin-top:10px" id="studyZoneRepasoBtn">ðŸ”„ Zona de Repaso</button>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--electric);margin-top:10px" data-lang="volver-hub">â† Volver al Hub</button>
</div>

<!-- ZONA DE ESTUDIO - ALL QUESTIONS WITH EXPLANATIONS -->
<div class="s" id="s-library">
    <div class="lo"><div class="lo-t" id="estudioTitle">ðŸ“– ZONA DE ESTUDIO</div></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,#2ecc71 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="libraryBubble"></div>
    <div id="libraryContent" style="width:100%;margin-top:16px;padding-bottom:80px"></div>
    <!-- FLOATING NAV -->
    <div class="lib-float-nav">
        <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--accent);flex:1;margin:0;font-size:14px;padding:12px" data-lang="volver-hub">â† Volver al Hub</button>
    </div>
</div>

<!-- STUDY LIBRARY DETAIL VIEW -->
<div class="s" id="s-library-detail">
    <div class="lo"><div class="lo-t" id="libDetailTitle">ðŸ“– TEMA</div></div>
    <div id="libDetailContent" style="width:100%;margin-top:12px;padding-bottom:120px"></div>
    <!-- FLOATING NAV BUTTONS -->
    <div class="lib-float-nav">
        <button class="bt" onclick="go('s-library');renderStudyLibrary()" style="background:linear-gradient(135deg,#2ecc71,#1a9955);flex:1;margin:0;font-size:13px;padding:12px 8px"><span id="floatLibBtn">ðŸ“– Zona de Estudio</span></button>
        <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--accent);flex:1;margin:0;font-size:13px;padding:12px 8px">â† Hub</button>
    </div>
</div>

<!-- VIDEO ZONE -->
<div class="s" id="s-videos">
    <div class="lo"><div class="lo-t">ðŸŽ¥ VIDEO ZONE</div></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,#9b59b6 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="videoBubble">Videos del Maestro Mario para que aprendas viendo.</div>
    <div id="videoContent" style="width:100%;margin-top:16px"></div>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid rgba(155,89,182,0.3);margin-top:16px" data-lang="volver-hub">â† Volver al Hub</button>
</div>

<!-- QUIZ -->
<div class="s" id="s8">
    <div class="quiz-header">
        <div class="quiz-cat" id="qCat"></div>
        <div class="quiz-score">âœ… <span class="correct" id="qRight">0</span> | âŒ <span class="wrong" id="qWrong">0</span></div>
    </div>
    <div class="pb"><div class="pbf" id="qBar" style="width:0%"></div></div>
    <div class="quiz-num" id="qNum"></div>
    <div class="aw sm" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="bb" id="qBubble"></div>
    <div class="motive-bar" id="qMotive"><div class="motive-text" id="qMotiveText"></div><div class="motive-author" id="qMotiveAuthor"></div></div>
    <div class="formula-helper" id="qFormula">
        <div class="formula-toggle" id="qFormToggle" onclick="toggleFormulaDetail()">ðŸ“ <span id="qFormToggleText"></span></div>
        <div class="formula-hint" id="qFormDetail" style="display:none">
            <div class="formula-hint-title" id="qFormTitle">ðŸ“ FÃ³rmula Necesaria</div>
            <div class="formula-hint-text" id="qFormText"></div>
        </div>
        <div class="power-wheel" id="qPowerWheel">
            <div class="pw-container">
                <svg class="pw-svg" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                    <!-- Outer circle -->
                    <circle cx="150" cy="150" r="145" fill="none" stroke="rgba(0,212,255,0.25)" stroke-width="2"/>
                    <!-- Inner circle (center) -->
                    <circle cx="150" cy="150" r="42" fill="rgba(255,255,255,0.04)" stroke="rgba(255,255,255,0.15)" stroke-width="1.5"/>
                    <!-- Cross dividers -->
                    <line x1="150" y1="5" x2="150" y2="295" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                    <line x1="5" y1="150" x2="295" y2="150" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                    
                    <!-- TOP QUADRANT: POWER (P/W) â€” yellow -->
                    <text x="150" y="32" text-anchor="middle" fill="#f1c40f" font-family="Fredoka" font-size="20" font-weight="700">P (Watts)</text>
                    <text x="150" y="58" text-anchor="middle" fill="#f1c40f" font-size="11" font-weight="600">V Ã— I</text>
                    <text x="150" y="74" text-anchor="middle" fill="#daa520" font-size="10">IÂ² Ã— R</text>
                    <text x="150" y="89" text-anchor="middle" fill="#daa520" font-size="10">VÂ² Ã· R</text>
                    
                    <!-- LEFT QUADRANT: VOLTAGE (V/E) â€” cyan -->
                    <text x="54" y="140" text-anchor="middle" fill="#00d4ff" font-family="Fredoka" font-size="20" font-weight="700">V (Volts)</text>
                    <text x="54" y="162" text-anchor="middle" fill="#00d4ff" font-size="11" font-weight="600">I Ã— R</text>
                    <text x="54" y="178" text-anchor="middle" fill="#0099bb" font-size="10">P Ã· I</text>
                    <text x="54" y="193" text-anchor="middle" fill="#0099bb" font-size="10">âˆš(P Ã— R)</text>
                    
                    <!-- RIGHT QUADRANT: CURRENT (I/A) â€” orange -->
                    <text x="246" y="140" text-anchor="middle" fill="#ff6b2b" font-family="Fredoka" font-size="20" font-weight="700">I (Amps)</text>
                    <text x="246" y="162" text-anchor="middle" fill="#ff6b2b" font-size="11" font-weight="600">V Ã· R</text>
                    <text x="246" y="178" text-anchor="middle" fill="#cc4400" font-size="10">P Ã· V</text>
                    <text x="246" y="193" text-anchor="middle" fill="#cc4400" font-size="10">âˆš(P Ã· R)</text>
                    
                    <!-- BOTTOM QUADRANT: RESISTANCE (R/Î©) â€” green -->
                    <text x="150" y="222" text-anchor="middle" fill="#2ecc71" font-family="Fredoka" font-size="20" font-weight="700">R (Ohms)</text>
                    <text x="150" y="244" text-anchor="middle" fill="#2ecc71" font-size="11" font-weight="600">V Ã· I</text>
                    <text x="150" y="260" text-anchor="middle" fill="#1a9955" font-size="10">VÂ² Ã· P</text>
                    <text x="150" y="275" text-anchor="middle" fill="#1a9955" font-size="10">P Ã· IÂ²</text>
                    
                    <!-- Center labels -->
                    <text x="150" y="145" text-anchor="middle" fill="white" font-family="Fredoka" font-size="13" font-weight="700">OHM</text>
                    <text x="150" y="161" text-anchor="middle" fill="var(--muted)" font-size="10">+ WATT</text>
                </svg>
            </div>
            <div class="pw-label">âš¡ Power Wheel â€” 12 FÃ³rmulas: Ley de Ohm + Ley de Watt</div>
        </div>
    </div>
    <div class="quiz-q" id="qText"></div>
    <div class="quiz-opts" id="qOpts"></div>
    <div class="quiz-explain" id="qExplain"></div>
    <div class="quiz-nav">
        <button class="quiz-prev" id="qPrev" onclick="prevQuestion()"></button>
        <button class="quiz-fwd" id="qNext" onclick="nextQuestion()"></button>
    </div>
</div>

<!-- QUIZ RESULT -->
<div class="s" id="s9">
    <div class="aw md" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--gold) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div><span class="ai-badge">AI</span></div>
    <div class="quiz-result">
        <div class="quiz-medal" id="rMedal"></div>
        <div class="quiz-result-score" id="rScore"></div>
        <div class="quiz-result-label" id="rLabel"></div>
        <div class="quiz-stars" id="rStars"><span>â­</span><span>â­</span><span>â­</span><span>â­</span><span>â­</span></div>
        <div class="bb quiz-result-msg" id="rMsg"></div>
        <div id="rMedalEarned" style="display:none;margin-top:16px;padding:16px;background:rgba(255,215,0,0.1);border:2px solid var(--gold);border-radius:14px;text-align:center">
            <div style="font-size:48px" id="rNewMedal"></div>
            <div style="font-family:'Fredoka',sans-serif;font-size:18px;font-weight:700;color:var(--gold);margin-top:8px" id="rMedalName"></div>
        </div>
        <!-- STUDY ZONE REDIRECT (shown when score < 70%) -->
        <div class="study-redirect" id="rStudyRedirect" style="display:none">
            <div class="study-redirect-icon">ðŸ“š</div>
            <div class="study-redirect-title" id="studyRedirectTitle">Â¡El Maestro Mario te recomienda repasar!</div>
            <div class="study-redirect-desc" id="rStudyDesc">Tienes preguntas que necesitas reforzar. Ve a la Study Zone para dominarlas.</div>
            <button class="bt" onclick="go('s-study');renderStudyZone()" style="background:var(--accent);margin-top:8px;padding:12px"><span class='lang-repaso-btn'>ðŸ”„ Ir a Zona de Repaso â†’</span></button>
        </div>
    </div>
    <button class="bt" onclick="retryQuiz()" id="retryBtn">ðŸ”„ Intentar de Nuevo</button>
    <button class="bt" onclick="renderQuizSelector();go('s7b')" style="background:var(--card);border:2px solid var(--electric);margin-top:10px" id="otherQuizBtn">ðŸ“ Otro Quiz</button>
    <button class="bt" onclick="go('s10');renderProfile()" style="background:var(--card);border:2px solid var(--gold);margin-top:10px" id="viewProfileBtn">ðŸ‘¤ Ver Mi Perfil</button>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--accent);margin-top:10px" data-lang="volver-hub">â† Volver al Hub</button>
</div>

<!-- PROFILE -->
<div class="s" id="s10">
    <div class="prof-card">
        <div class="prof-avatar" id="profAvatar" onclick="toggleAvatarPicker()">ðŸ‘¤<div class="prof-avatar-edit">âœï¸</div></div>
        <div class="avatar-picker" id="avatarPicker">
            <div class="avatar-picker-title" id="avatarPickerTitle">ðŸ”§ Elige tu Avatar</div>
            <div class="avatar-picker-sub" id="avatarPickerSub">Desbloquea avatares dominando quizzes y subiendo de nivel</div>
            <div id="avatarGrid"></div>
        </div>
        <div class="prof-name" id="profName"></div>
        <div class="prof-title" id="profTitle"></div>
        <div class="prof-level">
            <div>
                <div style="font-size:12px;color:var(--muted)" id="profLevelLabel">NIVEL</div>
                <div class="prof-lvl-num" id="profLevel">1</div>
            </div>
        </div>
        <div class="prof-xp">
            <div class="prof-xp-bar"><div class="prof-xp-fill" id="profXpBar" style="width:0%"></div></div>
            <div class="prof-xp-txt" id="profXpTxt">0 / 100 XP</div>
        </div>
    </div>
    <div class="prof-stats">
        <div class="prof-stat"><div class="prof-stat-num" id="profPts">0</div><div class="prof-stat-label" id="profPtsLabel">Puntos</div></div>
        <div class="prof-stat"><div class="prof-stat-num" id="profAcc">0%</div><div class="prof-stat-label" id="profAccLabel">PrecisiÃ³n</div></div>
        <div class="prof-stat"><div class="prof-stat-num" id="profStrk">0</div><div class="prof-stat-label" id="profStrkLabel">Mejor Racha</div></div>
    </div>
    <div style="width:100%;margin-top:20px;font-family:'Fredoka',sans-serif;font-size:18px;font-weight:700;text-align:center" id="profMedalsTitle">ðŸ… Medallas</div>
    <div class="medals-grid" id="medalsGrid"></div>
    <div id="crossAppSection" style="display:none;width:100%;margin-top:20px">
      <div style="font-family:'Fredoka',sans-serif;font-size:18px;font-weight:700;text-align:center;margin-bottom:12px">ðŸ“Š <span id="crossAppTitle">Progreso Total</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="background:var(--card2);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(0,212,255,0.15)">
          <div style="font-size:11px;color:var(--muted)">Maestro Mario AI</div>
          <div style="font-size:24px;font-weight:700;color:var(--electric)" id="crossV2Quizzes">0</div>
          <div style="font-size:11px;color:var(--muted)">quizzes</div>
        </div>
        <div style="background:var(--card2);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(255,107,43,0.15)">
          <div style="font-size:11px;color:var(--muted)">Maestro ACVOLT</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent)" id="crossV1Quizzes">0</div>
          <div style="font-size:11px;color:var(--muted)">quizzes</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px">
        <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center">
          <div style="font-size:20px;font-weight:700;color:var(--gold)" id="crossTotalQuizzes">0</div>
          <div style="font-size:10px;color:var(--muted)" id="crossTotalLabel">Total Quizzes</div>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center">
          <div style="font-size:20px;font-weight:700;color:#2ecc71" id="crossAvgScore">0%</div>
          <div style="font-size:10px;color:var(--muted)" id="crossAvgLabel">Promedio</div>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center">
          <div style="font-size:20px;font-weight:700;color:#9b59b6" id="crossCerts">0</div>
          <div style="font-size:10px;color:var(--muted)" id="crossCertsLabel">Certificados</div>
        </div>
      </div>
    </div>
    <button class="bt" onclick="renderQuizSelector();go('s7b')" style="margin-top:20px" id="profQuizBtn">ðŸ“ Tomar un Quiz</button>
    <button class="bt" onclick="toggleMusicPanel()" style="background:var(--card);border:2px solid rgba(0,212,255,0.3);margin-top:10px" id="profMusicBtn">ðŸŽ¶ Cambiar MÃºsica</button>
    <button class="bt" onclick="go('s-hub');updateHub()" style="background:var(--card);border:2px solid var(--accent);margin-top:10px" data-lang="volver-hub">â† Volver al Hub</button>
    <button class="bt" onclick="exitApp()" style="background:rgba(255,60,60,0.15);border:2px solid rgba(255,60,60,0.4);color:#ff4444;margin-top:20px" id="exitAppBtn">ðŸšª Salir del App</button>
</div>
</div>
<div class="cw" id="conf"></div>
<button class="music-btn" id="musicBtn" onclick="toggleMusic()">ðŸŽµ</button>
<button class="music-settings" onclick="toggleMusicPanel()">ðŸŽ¶</button>
<div class="music-panel" id="musicPanel">
    <div class="music-panel-title" id="musicPanelTitle">ðŸŽ¶ Elige tu mÃºsica</div>
    <div id="musicOptions"></div>
    <div class="music-upload" onclick="document.getElementById('musicFile').click()">
        <div>ðŸ“ <b>Mi MÃºsica</b></div>
        <div class="music-upload-label">Sube tu MP3, WAV o audio favorito</div>
        <div class="music-upload-name" id="musicFileName"></div>
    </div>
    <input type="file" id="musicFile" accept="audio/*" style="display:none" onchange="loadCustomMusic(this)">
</div>
<button class="profile-btn" id="profileBtn" onclick="go('s10');renderProfile()">ðŸ‘¤</button>

<script src="quiz-refrigeracion-200.js"></script>
<script src="quiz-principiante-50.js"></script>
<script src="quiz-electricidad-117.js"></script>
<script src="quiz-intro.js"></script>
<script src="quiz-intro-electricidad.js"></script>
<script src="quiz-intro-refrigeracion.js"></script>
<script src="quiz-study-electricidad.js"></script>
<script src="quiz-study-refrigeracion.js"></script>
<script src="QUIZ_ELECTRICIDAD_COMERCIAL_278.js"></script>
<script src="quiz-ac-principiante-200.js"></script>
<script src="quiz-heating-intro-100-FINAL.js"></script>
<script src="quiz-ventas-intro-120-FINAL.js"></script>
<script src="quiz-wh-intro-100-FINAL.js"></script>
<script src="quiz-acca-intro-100-FINAL.js"></script>
<script src="quiz-escuela-intro-105-FINAL.js"></script>

<script>
const D={lang:'es',name:'',level:null,specs:[],school:null,goals:[],gender:'m'};

// Female name detection for inclusive language
const FEMALE_NAMES=new Set(['maria','maria','ana','andrea','adriana','alejandra','alicia','amanda','amelia','angela','angelica','angie','anna','beatriz','belen','bianca','blanca','brenda','camila','carla','carmen','carolina','catalina','cecilia','celia','claudia','cristina','daniela','danna','diana','elena','elisa','elizabeth','erika','esmeralda','esperanza','estela','esther','eva','fatima','fernanda','flora','francisca','gabriela','genesis','giselle','gladys','gloria','grace','graciela','guadalupe','heidi','ingrid','irene','iris','isabel','isabella','ivana','ivonne','jacqueline','janet','jasmin','jazmin','jennifer','jessica','jimena','joana','josefina','juana','julia','juliana','julieta','karen','karla','karina','katherine','katia','keyla','laura','leonor','leticia','lilia','liliana','linda','lisa','lorena','lucia','luciana','luisa','lupita','luz','magaly','magda','magdalena','maira','manuela','marcela','margarita','mariana','maribel','marisol','marlene','marta','martha','mayra','melanie','melissa','mercedes','michelle','miriam','monica','nadia','nancy','natalia','natasha','nicole','nidia','noemi','nora','norma','olga','paola','patricia','paula','perla','pilar','priscila','raquel','rebeca','regina','renata','rocio','rosa','rosalba','rosario','roxana','ruth','sabrina','samantha','sandra','sara','selena','silvia','sofia','soledad','sonia','stefania','stephanie','susana','tamara','tatiana','teresa','valentina','valeria','vanessa','veronica','victoria','violeta','virginia','viviana','wendy','ximena','yesenia','yolanda','yuri','zoe','zoila']);

function detectGender(name){
    const first=name.trim().split(/\s+/)[0].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    return FEMALE_NAMES.has(first)?'f':'m';
}

// Gender-aware helper: returns male or female form
function gn(m,f){return D.gender==='f'?f:m;}
let videoPlaying=false;
let currentVideoCallback=null;
let isSpeaking=false;
let audioUnlocked=false;

function unlockAudio(){
    if(audioUnlocked)return;
    const audio=document.getElementById('aiAudio');
    audio.src='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRwAAAAAAAAAAAAAAAAAAAAAAAA==';
    audio.play().then(()=>{audio.pause();audioUnlocked=true;}).catch(()=>{});
}

// ========== CHIPTUNE MUSIC ENGINE ==========
let musicCtx=null;
let musicPlaying=false;
let musicMuted=false;
let musicGain=null;
let musicTimers=[];
let musicVolume=0.5;
let musicMode='onboarding';
let currentMusicStyle='pokemon';
let customAudio=null;
let musicPanelOpen=false;

const MUSIC_STYLES=[
    {id:'pokemon',icon:'ðŸŽ®',name:'PokÃ©mon Adventure',desc:'8-bit clÃ¡sico',desc_en:'8-bit classic'},
    {id:'lofi',icon:'ðŸŽ§',name:'Lo-Fi Chill',desc:'Relajado para estudiar',desc_en:'Relaxed for studying'},
    {id:'battle',icon:'âš”ï¸',name:'Boss Battle',desc:'Ã‰pico e intenso',desc_en:'Epic and intense'},
    {id:'reggaeton',icon:'ðŸŽº',name:'ReggaetÃ³n Study',desc:'Ritmo latino',desc_en:'Latin rhythm'},
    {id:'jazz',icon:'ðŸŽ·',name:'Jazz Smooth',desc:'Suave y elegante',desc_en:'Smooth and elegant'},
    {id:'tropical',icon:'ðŸŒ´',name:'Tropical Vibes',desc:'Cumbia y playa',desc_en:'Cumbia and beach'},
    {id:'rock8bit',icon:'ðŸŽ¸',name:'Rock 8-Bit',desc:'Rock clÃ¡sico pixelado',desc_en:'Classic pixel rock'},
    {id:'ambient',icon:'ðŸŒ™',name:'Ambient Night',desc:'Calmado nocturno',desc_en:'Calm nighttime'},
    {id:'mariachi',icon:'ðŸª—',name:'Mariachi Digital',desc:'Trompetas y guitarrÃ³n',desc_en:'Trumpets and guitarrÃ³n'},
    {id:'hiphop',icon:'ðŸŽ¤',name:'Hip-Hop Study',desc:'Boom bap para enfocarte',desc_en:'Boom bap to focus'},
    {id:'edm',icon:'ðŸ”Š',name:'EDM Energy',desc:'ElectrÃ³nica motivadora',desc_en:'Motivating electronic'},
    {id:'corrido',icon:'ðŸ¤ ',name:'Corrido Tumbado',desc:'Estilo norteÃ±o digital',desc_en:'Digital norteÃ±o style'},
    {id:'classical',icon:'ðŸŽ»',name:'ClÃ¡sica Ã‰pica',desc:'Orquesta inspiradora',desc_en:'Inspiring orchestra'},
    {id:'synthwave',icon:'ðŸŒ†',name:'Synthwave 80s',desc:'Retro futurista',desc_en:'Retro futuristic'},
    {id:'salsa',icon:'ðŸ’ƒ',name:'Salsa Digital',desc:'Sabor caribeÃ±o',desc_en:'Caribbean flavor'},
    {id:'silent',icon:'ðŸ”‡',name:'Sin MÃºsica',desc:'Solo silencio',desc_en:'Just silence'}
];

function noteFreq(note,octave){
    const notes={C:261.63,D:293.66,E:329.63,F:349.23,G:392.00,A:440.00,B:493.88};
    const base=notes[note]||261.63;
    return base*Math.pow(2,octave-4);
}

function playNote(type,freq,start,dur,vol){
    if(!musicCtx)return;
    const osc=musicCtx.createOscillator();
    const gain=musicCtx.createGain();
    osc.type=type;
    osc.frequency.setValueAtTime(freq,start);
    gain.gain.setValueAtTime(vol,start);
    gain.gain.setValueAtTime(vol,start+dur*0.8);
    gain.gain.linearRampToValueAtTime(0,start+dur);
    osc.connect(gain);
    gain.connect(musicGain);
    osc.start(start);
    osc.stop(start+dur);
}

function playMusicLoop(){
    if(!musicCtx||!musicPlaying||currentMusicStyle==='custom'||currentMusicStyle==='silent')return;
    const style=currentMusicStyle;
    const bpm=style==='battle'?160:style==='reggaeton'?95:style==='lofi'?75:130;
    const beat=60/bpm;
    const half=beat/2;
    const now=musicCtx.currentTime+0.05;
    
    if(style==='pokemon'){
        const melody=[['E',5],['G',5],['A',5],['B',5],['A',5],['G',5],['E',5],['D',5],['C',5],['D',5],['E',5],['G',5],['A',5],['G',5],['E',5],['G',5],['A',5],['B',5],['C',6],['B',5],['A',5],['G',5],['A',5],['B',5],['G',5],['E',5],['D',5],['E',5],['C',5],['D',5],['E',5],['E',5]];
        const bass=[['C',3],['C',3],['G',3],['G',3],['A',3],['A',3],['E',3],['E',3],['F',3],['F',3],['C',3],['C',3],['G',3],['G',3],['G',3],['G',3],['A',3],['A',3],['F',3],['F',3],['C',3],['C',3],['G',3],['G',3],['F',3],['F',3],['G',3],['G',3],['C',3],['C',3],['C',3],['C',3]];
        const arp=[['C',4],['E',4],['G',4],['E',4],['A',4],['C',5],['E',5],['C',5],['F',4],['A',4],['C',5],['A',4],['G',4],['B',4],['D',5],['B',4],['A',4],['C',5],['E',5],['C',5],['F',4],['A',4],['C',5],['A',4],['G',4],['B',4],['D',5],['B',4],['C',4],['E',4],['G',4],['E',4]];
        for(let i=0;i<melody.length;i++){playNote('square',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.85,0.08);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.12);}
        for(let i=0;i<arp.length;i++){playNote('square',noteFreq(arp[i][0],arp[i][1]),now+i*half,half*0.4,0.03);}
        const loopDur=melody.length*half;
        musicTimers.push(setTimeout(()=>playMusicLoop(),loopDur*1000-100));
    }
    else if(style==='lofi'){
        // Lo-fi chill beats - sine waves, slow, jazzy
        const melody=[['E',4],['G',4],['A',4],['G',4],['E',4],['D',4],['C',4],['D',4],['E',4],['A',4],['G',4],['E',4],['D',4],['E',4],['G',4],['A',4]];
        const bass=[['C',3],['C',3],['A',2],['A',2],['F',2],['F',2],['G',2],['G',2],['C',3],['C',3],['A',2],['A',2],['F',2],['F',2],['G',2],['G',2]];
        const pad=[['E',4],['E',4],['C',4],['C',4],['A',3],['A',3],['B',3],['B',3],['E',4],['E',4],['C',4],['C',4],['A',3],['A',3],['B',3],['B',3]];
        for(let i=0;i<melody.length;i++){playNote('sine',noteFreq(melody[i][0],melody[i][1]),now+i*beat,beat*0.7,0.1);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*beat,beat*0.9,0.1);}
        for(let i=0;i<pad.length;i++){playNote('sine',noteFreq(pad[i][0],pad[i][1]),now+i*beat,beat*1.2,0.04);}
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*beat*1000-100));
    }
    else if(style==='battle'){
        // Epic boss battle - fast, intense, sawtooth
        const melody=[['E',5],['E',5],['F',5],['G',5],['G',5],['F',5],['E',5],['D',5],['C',5],['C',5],['D',5],['E',5],['E',5],['D',5],['D',5],['D',5],['E',5],['E',5],['F',5],['G',5],['G',5],['F',5],['E',5],['D',5],['C',5],['C',5],['D',5],['E',5],['D',5],['C',5],['C',5],['C',5]];
        const bass=[['C',2],['C',2],['C',2],['C',2],['A',2],['A',2],['A',2],['A',2],['F',2],['F',2],['F',2],['F',2],['G',2],['G',2],['G',2],['G',2],['C',2],['C',2],['C',2],['C',2],['A',2],['A',2],['A',2],['A',2],['F',2],['F',2],['F',2],['F',2],['G',2],['G',2],['G',2],['G',2]];
        for(let i=0;i<melody.length;i++){playNote('sawtooth',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.8,0.06);}
        for(let i=0;i<bass.length;i++){playNote('square',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.1);}
        // Drum-like percussion with noise
        for(let i=0;i<32;i+=2){playNote('square',noteFreq('C',1),now+i*half,half*0.15,0.15);}
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*half*1000-100));
    }
    else if(style==='reggaeton'){
        // ReggaetÃ³n dembow rhythm
        const melody=[['A',4],['C',5],['D',5],['E',5],['D',5],['C',5],['A',4],['G',4],['A',4],['C',5],['D',5],['E',5],['G',5],['E',5],['D',5],['C',5]];
        const bass=[['A',2],['A',2],['A',2],['A',2],['D',3],['D',3],['D',3],['D',3],['F',2],['F',2],['G',2],['G',2],['A',2],['A',2],['A',2],['A',2]];
        for(let i=0;i<melody.length;i++){playNote('triangle',noteFreq(melody[i][0],melody[i][1]),now+i*beat,beat*0.6,0.09);}
        for(let i=0;i<bass.length;i++){playNote('sine',noteFreq(bass[i][0],bass[i][1]),now+i*beat,beat*0.8,0.14);}
        // Dembow kick pattern
        for(let i=0;i<16;i++){
            const isKick=(i%4===0||i%4===3);
            if(isKick)playNote('sine',noteFreq('C',2),now+i*beat,beat*0.2,0.18);
            else playNote('square',noteFreq('C',1),now+i*beat,beat*0.08,0.06);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*beat*1000-100));
    }
    else if(style==='jazz'){
        // Smooth jazz - walking bass, cool chords
        const melody=[['G',4],['A',4],['B',4],['D',5],['E',5],['D',5],['B',4],['A',4],['G',4],['F',4],['E',4],['D',4],['E',4],['G',4],['A',4],['B',4]];
        const bass=[['G',2],['B',2],['D',3],['G',2],['C',3],['E',3],['G',3],['C',3],['A',2],['C',3],['E',3],['A',2],['D',3],['F',3],['A',3],['D',3]];
        const pad=[['B',3],['D',4],['G',3],['B',3],['E',4],['G',4],['C',4],['E',4],['C',4],['E',4],['A',3],['C',4],['F',3],['A',3],['D',4],['F',3]];
        for(let i=0;i<melody.length;i++){playNote('sine',noteFreq(melody[i][0],melody[i][1]),now+i*beat,beat*0.75,0.08);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*beat,beat*0.85,0.1);}
        for(let i=0;i<pad.length;i++){playNote('sine',noteFreq(pad[i][0],pad[i][1]),now+i*beat,beat*1.5,0.03);}
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*beat*1000-100));
    }
    else if(style==='tropical'){
        // Tropical cumbia - bright, rhythmic
        const melody=[['C',5],['E',5],['G',5],['E',5],['C',5],['D',5],['F',5],['A',5],['G',5],['F',5],['E',5],['D',5],['C',5],['E',5],['G',5],['C',6]];
        const bass=[['C',3],['C',3],['G',2],['G',2],['F',2],['F',2],['G',2],['G',2],['C',3],['C',3],['A',2],['A',2],['F',2],['F',2],['G',2],['G',2]];
        for(let i=0;i<melody.length;i++){playNote('triangle',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.7,0.09);}
        for(let i=0;i<bass.length;i++){playNote('sine',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.85,0.12);}
        // Guiro/shaker pattern
        for(let i=0;i<16;i++){
            if(i%2===0)playNote('square',noteFreq('C',7),now+i*half,half*0.05,0.04);
            if(i%4===0)playNote('sine',noteFreq('G',2),now+i*half,half*0.15,0.15);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*half*1000-100));
    }
    else if(style==='rock8bit'){
        // 8-bit rock - power chords, driving rhythm
        const melody=[['E',5],['E',5],['G',5],['A',5],['B',5],['A',5],['G',5],['E',5],['D',5],['D',5],['E',5],['G',5],['A',5],['B',5],['A',5],['G',5],['E',5],['E',5],['G',5],['A',5],['C',6],['B',5],['A',5],['G',5],['E',5],['D',5],['E',5],['G',5],['A',5],['G',5],['E',5],['E',5]];
        const bass=[['E',2],['E',2],['E',2],['E',2],['G',2],['G',2],['G',2],['G',2],['A',2],['A',2],['A',2],['A',2],['B',2],['B',2],['B',2],['B',2],['E',2],['E',2],['E',2],['E',2],['C',3],['C',3],['C',3],['C',3],['A',2],['A',2],['A',2],['A',2],['B',2],['B',2],['B',2],['B',2]];
        for(let i=0;i<melody.length;i++){playNote('square',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.8,0.07);}
        for(let i=0;i<bass.length;i++){playNote('sawtooth',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.09);}
        // Power drum beat
        for(let i=0;i<32;i++){
            if(i%4===0)playNote('square',noteFreq('C',1),now+i*half,half*0.12,0.16);
            if(i%4===2)playNote('square',noteFreq('G',6),now+i*half,half*0.06,0.05);
            if(i%2===1)playNote('square',noteFreq('D',7),now+i*half,half*0.04,0.03);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*half*1000-100));
    }
    else if(style==='ambient'){
        // Ambient night - slow pads, ethereal
        const pad1=[['C',4],['E',4],['G',4],['E',4],['A',3],['C',4],['E',4],['C',4]];
        const pad2=[['G',3],['B',3],['D',4],['B',3],['F',3],['A',3],['C',4],['A',3]];
        const bell=[['G',5],['E',5],['C',5],['G',5],['A',5],['F',5],['D',5],['A',5]];
        const longBeat=beat*2;
        for(let i=0;i<pad1.length;i++){playNote('sine',noteFreq(pad1[i][0],pad1[i][1]),now+i*longBeat,longBeat*1.2,0.07);}
        for(let i=0;i<pad2.length;i++){playNote('sine',noteFreq(pad2[i][0],pad2[i][1]),now+i*longBeat,longBeat*1.2,0.05);}
        for(let i=0;i<bell.length;i++){playNote('sine',noteFreq(bell[i][0],bell[i][1]),now+i*longBeat,longBeat*0.4,0.04);}
        // Deep bass drone
        playNote('sine',noteFreq('C',2),now,pad1.length*longBeat,0.06);
        musicTimers.push(setTimeout(()=>playMusicLoop(),pad1.length*longBeat*1000-100));
    }
    else if(style==='mariachi'){
        // Mariachi digital - trumpets and strumming
        const trumpet=[['G',5],['A',5],['B',5],['D',6],['B',5],['A',5],['G',5],['G',5],['A',5],['B',5],['G',5],['E',5],['D',5],['E',5],['G',5],['A',5],['B',5],['D',6],['E',6],['D',6],['B',5],['A',5],['G',5],['A',5],['B',5],['A',5],['G',5],['E',5],['D',5],['G',5],['G',5],['G',5]];
        const bass=[['G',2],['G',2],['D',3],['D',3],['G',2],['G',2],['D',3],['D',3],['E',2],['E',2],['B',2],['B',2],['C',3],['C',3],['D',3],['D',3],['G',2],['G',2],['D',3],['D',3],['E',2],['E',2],['B',2],['B',2],['C',3],['C',3],['D',3],['D',3],['G',2],['G',2],['G',2],['G',2]];
        for(let i=0;i<trumpet.length;i++){playNote('sawtooth',noteFreq(trumpet[i][0],trumpet[i][1]),now+i*half,half*0.75,0.06);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.85,0.1);}
        // GuitarrÃ³n rhythm
        for(let i=0;i<32;i++){
            if(i%4===0||i%4===3)playNote('triangle',noteFreq('G',3),now+i*half,half*0.3,0.08);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),trumpet.length*half*1000-100));
    }
    else if(style==='hiphop'){
        // Hip-Hop boom bap - punchy drums, deep bass, Rhodes keys
        const melody=[['C',4],['E',4],['G',4],['A',4],['G',4],['E',4],['C',4],['D',4],['F',4],['A',4],['G',4],['F',4],['E',4],['D',4],['C',4],['C',4]];
        const bass=[['C',2],['C',2],['C',2],['E',2],['F',2],['F',2],['G',2],['G',2],['A',2],['A',2],['G',2],['G',2],['F',2],['E',2],['C',2],['C',2]];
        for(let i=0;i<melody.length;i++){playNote('sine',noteFreq(melody[i][0],melody[i][1]),now+i*beat,beat*0.5,0.09);}
        for(let i=0;i<bass.length;i++){playNote('triangle',noteFreq(bass[i][0],bass[i][1]),now+i*beat,beat*0.8,0.14);}
        // Boom bap drums
        for(let i=0;i<16;i++){
            if(i%4===0)playNote('sine',noteFreq('C',2),now+i*beat,beat*0.2,0.2);
            if(i%4===2)playNote('square',noteFreq('C',7),now+i*beat,beat*0.06,0.05);
            if(i%2===1)playNote('square',noteFreq('D',6),now+i*beat,beat*0.04,0.04);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*beat*1000-100));
    }
    else if(style==='edm'){
        // EDM Energy - building synth, four on the floor
        const melody=[['E',5],['E',5],['G',5],['A',5],['B',5],['B',5],['A',5],['G',5],['E',5],['G',5],['B',5],['E',6],['D',6],['B',5],['A',5],['G',5],['A',5],['A',5],['B',5],['D',6],['E',6],['E',6],['D',6],['B',5],['A',5],['B',5],['D',6],['E',6],['B',5],['G',5],['E',5],['E',5]];
        const bass=[['E',2],['E',2],['E',2],['E',2],['A',2],['A',2],['A',2],['A',2],['C',3],['C',3],['C',3],['C',3],['B',2],['B',2],['B',2],['B',2],['A',2],['A',2],['A',2],['A',2],['C',3],['C',3],['C',3],['C',3],['D',3],['D',3],['D',3],['D',3],['B',2],['B',2],['B',2],['B',2]];
        for(let i=0;i<melody.length;i++){playNote('sawtooth',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.7,0.05);}
        for(let i=0;i<bass.length;i++){playNote('sine',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.13);}
        // Four on the floor kick + hi-hat
        for(let i=0;i<32;i++){
            if(i%4===0)playNote('sine',noteFreq('C',1),now+i*half,half*0.2,0.18);
            playNote('square',noteFreq('C',8),now+i*half,half*0.03,0.025);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*half*1000-100));
    }
    else if(style==='corrido'){
        // Corrido tumbado - tuba bass, guitarrÃ³n, accordion feel
        const melody=[['D',5],['F',5],['A',5],['D',6],['A',5],['F',5],['D',5],['E',5],['G',5],['B',5],['A',5],['G',5],['F',5],['E',5],['D',5],['D',5],['F',5],['A',5],['D',6],['C',6],['A',5],['F',5],['E',5],['D',5],['E',5],['F',5],['A',5],['G',5],['F',5],['E',5],['D',5],['D',5]];
        const tuba=[['D',2],['D',2],['A',2],['A',2],['D',2],['D',2],['A',2],['A',2],['G',2],['G',2],['D',3],['D',3],['A',2],['A',2],['D',2],['D',2],['D',2],['D',2],['F',2],['F',2],['A',2],['A',2],['G',2],['G',2],['F',2],['F',2],['E',2],['E',2],['D',2],['D',2],['A',2],['A',2]];
        for(let i=0;i<melody.length;i++){playNote('sawtooth',noteFreq(melody[i][0],melody[i][1]),now+i*half,half*0.65,0.06);}
        for(let i=0;i<tuba.length;i++){playNote('triangle',noteFreq(tuba[i][0],tuba[i][1]),now+i*half,half*0.8,0.12);}
        // Tumbado rhythm
        for(let i=0;i<32;i++){
            if(i%4===0||i%4===3)playNote('sine',noteFreq('D',2),now+i*half,half*0.15,0.16);
            if(i%2===1)playNote('square',noteFreq('A',6),now+i*half,half*0.04,0.04);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),melody.length*half*1000-100));
    }
    else if(style==='classical'){
        // Classical epic - strings, French horns feel
        const strings=[['C',5],['E',5],['G',5],['C',6],['B',5],['G',5],['E',5],['C',5],['D',5],['F',5],['A',5],['D',6],['C',6],['A',5],['F',5],['D',5],['E',5],['G',5],['B',5],['E',6],['D',6],['B',5],['G',5],['E',5],['C',5],['E',5],['G',5],['C',6],['G',5],['E',5],['C',5],['C',5]];
        const cello=[['C',3],['C',3],['G',2],['G',2],['C',3],['C',3],['E',3],['E',3],['D',3],['D',3],['A',2],['A',2],['D',3],['D',3],['F',3],['F',3],['E',3],['E',3],['B',2],['B',2],['E',3],['E',3],['G',3],['G',3],['C',3],['C',3],['G',2],['G',2],['C',3],['C',3],['C',3],['C',3]];
        const horn=[['E',4],['G',4],['C',5],['G',4],['F',4],['A',4],['D',5],['A',4],['G',4],['B',4],['E',5],['B',4],['E',4],['G',4],['C',5],['C',5]];
        for(let i=0;i<strings.length;i++){playNote('sine',noteFreq(strings[i][0],strings[i][1]),now+i*half,half*0.9,0.07);}
        for(let i=0;i<cello.length;i++){playNote('triangle',noteFreq(cello[i][0],cello[i][1]),now+i*half,half*1.0,0.09);}
        for(let i=0;i<horn.length;i++){playNote('sawtooth',noteFreq(horn[i][0],horn[i][1]),now+i*beat,beat*0.8,0.035);}
        musicTimers.push(setTimeout(()=>playMusicLoop(),strings.length*half*1000-100));
    }
    else if(style==='synthwave'){
        // Synthwave 80s - arpeggiated synths, driving bass
        const arp=[['E',5],['G',5],['B',5],['E',6],['B',5],['G',5],['E',5],['D',5],['F',5],['A',5],['D',6],['A',5],['F',5],['D',5],['E',5],['G',5],['B',5],['E',6],['G',6],['E',6],['B',5],['G',5],['A',5],['C',6],['E',6],['C',6],['A',5],['E',5],['G',5],['B',5],['E',5],['E',5]];
        const bass=[['E',2],['E',2],['E',2],['E',2],['D',2],['D',2],['D',2],['D',2],['E',2],['E',2],['E',2],['E',2],['A',2],['A',2],['A',2],['A',2],['E',2],['E',2],['E',2],['E',2],['D',2],['D',2],['D',2],['D',2],['A',2],['A',2],['A',2],['A',2],['B',2],['B',2],['B',2],['B',2]];
        for(let i=0;i<arp.length;i++){playNote('square',noteFreq(arp[i][0],arp[i][1]),now+i*half,half*0.5,0.05);}
        for(let i=0;i<bass.length;i++){playNote('sawtooth',noteFreq(bass[i][0],bass[i][1]),now+i*half,half*0.9,0.1);}
        // Snare on 2 and 4, kick on 1 and 3
        for(let i=0;i<32;i++){
            if(i%8===0||i%8===4)playNote('sine',noteFreq('C',2),now+i*half,half*0.15,0.15);
            if(i%8===2||i%8===6)playNote('square',noteFreq('C',7),now+i*half,half*0.05,0.06);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),arp.length*half*1000-100));
    }
    else if(style==='salsa'){
        // Salsa digital - piano montuno, conga feel, bright brass
        const piano=[['C',5],['E',5],['G',5],['C',5],['E',5],['G',5],['A',4],['C',5],['F',5],['A',4],['C',5],['F',5],['G',4],['B',4],['D',5],['G',4],['B',4],['D',5],['C',5],['E',5],['G',5],['C',5],['E',5],['G',5]];
        const bass=[['C',3],['C',3],['G',2],['C',3],['F',2],['F',2],['C',3],['F',2],['G',2],['G',2],['D',3],['G',2],['C',3],['C',3],['G',2],['C',3],['F',2],['F',2],['C',3],['F',2],['G',2],['G',2],['D',3],['G',2]];
        const bpm2=180;const sbeat=60/bpm2;const shalf=sbeat/2;
        for(let i=0;i<piano.length;i++){playNote('triangle',noteFreq(piano[i][0],piano[i][1]),now+i*shalf,shalf*0.6,0.08);}
        for(let i=0;i<bass.length;i++){playNote('sine',noteFreq(bass[i][0],bass[i][1]),now+i*shalf,shalf*0.8,0.12);}
        // Conga/timbale pattern
        for(let i=0;i<24;i++){
            if(i%3===0)playNote('square',noteFreq('A',6),now+i*shalf,shalf*0.08,0.06);
            if(i%6===2)playNote('sine',noteFreq('E',2),now+i*shalf,shalf*0.12,0.14);
        }
        musicTimers.push(setTimeout(()=>playMusicLoop(),piano.length*shalf*1000-100));
    }
}

function exitApp(){
    const msg=D.lang==='es'?'Â¿Seguro que quieres salir? Tu progreso estÃ¡ guardado.':'Are you sure you want to exit? Your progress is saved.';
    if(confirm(msg)){
        stopMusic();
        if(window.speechSynthesis)window.speechSynthesis.cancel();
        document.body.innerHTML='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#0a0e1a;color:white;font-family:Fredoka,sans-serif;text-align:center;padding:20px"><div style="font-size:80px;margin-bottom:20px">ðŸ‘‹</div><div style="font-size:28px;font-weight:700;margin-bottom:10px">'+(D.lang==='es'?'Â¡Hasta luego, '+D.name+'!':'See you later, '+D.name+'!')+'</div><div style="font-size:16px;color:#8899aa;margin-bottom:30px">'+(D.lang==='es'?'Tu progreso estÃ¡ guardado. Â¡Regresa pronto, '+gn('campeÃ³n','campeona')+'!':'Your progress is saved. Come back soon, champ!')+'</div><button onclick="location.reload()" style="padding:14px 32px;border-radius:12px;border:2px solid #00d4ff;background:rgba(0,212,255,0.1);color:#00d4ff;font-size:16px;font-family:Fredoka,sans-serif;font-weight:600;cursor:pointer">'+(D.lang==='es'?'ðŸ”„ Volver a Entrar':'ðŸ”„ Re-enter App')+'</button></div>';
    }
}

function toggleMusicPanel(e){
    if(e)e.preventDefault();
    musicPanelOpen=!musicPanelOpen;
    const panel=document.getElementById('musicPanel');
    panel.classList.toggle('open',musicPanelOpen);
    if(musicPanelOpen)renderMusicOptions();
}

function renderMusicOptions(){
    document.getElementById('musicOptions').innerHTML=MUSIC_STYLES.map(s=>
        '<div class="music-option'+(currentMusicStyle===s.id?' selected':'')+'" onclick="switchMusic(\''+s.id+'\')">'+
        '<div class="music-option-icon">'+s.icon+'</div>'+
        '<div class="music-option-info"><div class="music-option-name">'+s.name+'</div><div class="music-option-desc">'+(D.lang==="es"?s.desc:(s.desc_en||s.desc))+'</div></div>'+
        '</div>'
    ).join('');
    // Show custom music option if loaded
    if(customAudio){
        const el=document.querySelector('.music-upload');
        if(el)el.querySelector('.music-option')?.classList.toggle('selected',currentMusicStyle==='custom');
    }
}

function switchMusic(styleId){
    // Stop current
    if(customAudio){customAudio.pause();customAudio.currentTime=0;}
    stopMusicOsc();
    
    currentMusicStyle=styleId;
    
    if(styleId==='silent'){
        musicPlaying=false;
        document.getElementById('musicBtn').textContent='ðŸ”‡';
    }else if(styleId==='custom'&&customAudio){
        musicPlaying=true;
        customAudio.volume=musicMuted?0:Math.min(musicVolume*2,1);
        customAudio.loop=true;
        customAudio.play().catch(()=>{});
        document.getElementById('musicBtn').textContent='ðŸŽµ';
    }else{
        if(!musicCtx||musicCtx.state==='closed'){
            musicCtx=new(window.AudioContext||window.webkitAudioContext)();
            musicGain=musicCtx.createGain();
            musicGain.gain.setValueAtTime(musicMuted?0:musicVolume,musicCtx.currentTime);
            musicGain.connect(musicCtx.destination);
        }
        musicPlaying=true;
        document.getElementById('musicBtn').textContent='ðŸŽµ';
        playMusicLoop();
    }
    
    renderMusicOptions();
    try{localStorage.setItem('maestro_music_style',styleId);}catch(e){}
}

function stopMusicOsc(){
    musicTimers.forEach(t=>clearTimeout(t));
    musicTimers=[];
    if(musicCtx&&musicCtx.state!=='closed'){musicCtx.close();musicCtx=null;}
}

function loadCustomMusic(input){
    if(!input.files||!input.files[0])return;
    const file=input.files[0];
    const url=URL.createObjectURL(file);
    customAudio=new Audio(url);
    customAudio.loop=true;
    document.getElementById('musicFileName').textContent='â™« '+file.name;
    document.getElementById('musicFileName').style.display='block';
    switchMusic('custom');
    toggleMusicPanel();
}

function startMusic(){
    if(musicPlaying)return;
    // Load saved style
    try{const saved=localStorage.getItem('maestro_music_style');if(saved)currentMusicStyle=saved;}catch(e){}
    
    if(currentMusicStyle==='silent')return;
    if(currentMusicStyle==='custom'&&customAudio){
        musicPlaying=true;
        customAudio.volume=0.5;
        customAudio.loop=true;
        customAudio.play().catch(()=>{});
        document.getElementById('musicBtn').classList.add('active');
        document.getElementById('musicBtn').textContent='ðŸŽµ';
        return;
    }
    musicCtx=new(window.AudioContext||window.webkitAudioContext)();
    musicGain=musicCtx.createGain();
    musicGain.gain.setValueAtTime(0.5,musicCtx.currentTime);
    musicGain.connect(musicCtx.destination);
    musicPlaying=true;
    musicMuted=false;
    document.getElementById('musicBtn').classList.add('active');
    document.getElementById('musicBtn').textContent='ðŸŽµ';
    playMusicLoop();
}

function stopMusic(){
    musicPlaying=false;
    if(customAudio){customAudio.pause();}
    stopMusicOsc();
}

function toggleMusic(){
    const btn=document.getElementById('musicBtn');
    if(musicMuted){
        musicMuted=false;
        musicVolume=musicMode==='studying'?0.25:0.5;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(musicVolume,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=Math.min(musicVolume*2,1);
        btn.textContent='ðŸŽµ';
        btn.classList.remove('muted');
    }else if(musicVolume>=0.4){
        musicVolume=musicMode==='studying'?0.15:0.25;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(musicVolume,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=Math.min(musicVolume*2,1);
        btn.textContent='ðŸ”‰';
    }else if(musicVolume>=0.15){
        musicVolume=musicMode==='studying'?0.06:0.1;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(musicVolume,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=Math.min(musicVolume*2,1);
        btn.textContent='ðŸ”ˆ';
    }else{
        musicMuted=true;
        musicVolume=0;
        if(musicGain&&musicCtx)musicGain.gain.setValueAtTime(0,musicCtx.currentTime);
        if(customAudio&&currentMusicStyle==='custom')customAudio.volume=0;
        btn.textContent='ðŸ”‡';
        btn.classList.add('muted');
    }
}

function setMusicVolume(vol){
    musicVolume=vol;
    if(musicGain&&musicCtx&&!musicMuted)musicGain.gain.linearRampToValueAtTime(vol,musicCtx.currentTime+0.3);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(vol*2,1);
}

function lowerMusicForSpeech(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(Math.min(musicVolume*0.2,0.05),musicCtx.currentTime+0.3);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*0.4,0.15);
}

function restoreMusicAfterSpeech(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(musicVolume,musicCtx.currentTime+0.3);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*2,1);
}

function lowerMusicForVideo(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(Math.min(musicVolume*0.3,0.08),musicCtx.currentTime+0.5);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*0.5,0.2);
}

function restoreMusicAfterVideo(){
    if(musicGain&&!musicMuted&&musicCtx)musicGain.gain.linearRampToValueAtTime(musicVolume,musicCtx.currentTime+0.5);
    if(customAudio&&currentMusicStyle==='custom'&&!musicMuted)customAudio.volume=Math.min(musicVolume*2,1);
}

function enterStudyMode(){
    musicMode='studying';
    setMusicVolume(0.25);
    document.getElementById('musicBtn').textContent='ðŸ”‰';
}

const SUPABASE_URL='https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1';
const SUPABASE_REST='https://htklsowiyjwsjnacnvnr.supabase.co/rest/v1';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a2xzb3dpeWp3c2puYWNudm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjIwMjQsImV4cCI6MjA4NjAzODAyNH0.6A3F7MI4YJEMo98b4Zfzao9p_hMh2T0ha0dRJ4SUhv0';

// === SUPABASE PROGRESS SYNC (V2 â†’ Supabase) ===
function syncV2Profile(){
  try {
    var email = null;
    try { email = D.email || null; } catch(e){}
    if(!email) try { email = JSON.parse(localStorage.getItem('tecnico_user')||'{}').email; } catch(e){}
    if(!email) return;

    var nombre = 'TÃ©cnico';
    try { nombre = D.name || 'TÃ©cnico'; } catch(e){}

    fetch(SUPABASE_REST+'/rpc/sync_v2_profile', {
      method:'POST',
      headers:{'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY},
      body:JSON.stringify({
        p_email: email,
        p_name: nombre,
        p_level: profile.level,
        p_xp: profile.xp,
        p_xp_needed: profile.xpNeeded,
        p_total_correct: profile.totalCorrect,
        p_total_answered: profile.totalAnswered,
        p_quizzes_taken: profile.quizzesTaken,
        p_best_streak: profile.bestStreak,
        p_perfect_streak: profile.perfectStreakCount||0,
        p_medals: profile.medals||[],
        p_avatar: profile.avatar||'novato'
      })
    }).catch(function(e){ console.log('V2 profile sync error:', e); });
  } catch(e){ console.log('syncV2Profile error:', e); }
}

function syncV2QuizAttempt(quizId, totalQ, correct, wrong, pct, tiempoSeg){
  try {
    var email = null;
    try { email = D.email || null; } catch(e){}
    if(!email) try { email = JSON.parse(localStorage.getItem('tecnico_user')||'{}').email; } catch(e){}
    if(!email) return;

    fetch(SUPABASE_REST+'/rpc/save_v2_quiz_attempt', {
      method:'POST',
      headers:{'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY},
      body:JSON.stringify({
        p_email: email,
        p_quiz_id: quizId,
        p_total_questions: totalQ,
        p_correct_answers: correct,
        p_wrong_answers: wrong,
        p_porcentaje: pct,
        p_tiempo_segundos: tiempoSeg||null
      })
    }).catch(function(e){ console.log('V2 quiz sync error:', e); });
  } catch(e){ console.log('syncV2QuizAttempt error:', e); }
}

// === LOAD OTHER APP'S PROGRESS ===
async function loadCrossAppProgress(){
  try {
    var email = null;
    try { email = D.email || null; } catch(e){}
    if(!email) try { email = JSON.parse(localStorage.getItem('tecnico_user')||'{}').email; } catch(e){}
    if(!email) return null;

    // Get V1 stats from admin_combined_progress view
    var res = await fetch(SUPABASE_REST+'/admin_combined_progress?email=eq.'+encodeURIComponent(email)+'&select=*', {
      headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY}
    });
    var data = await res.json();
    return data && data.length > 0 ? data[0] : null;
  } catch(e){ console.log('loadCrossApp error:', e); return null; }
}

const VIDEOS={
    bienvenida:'bienvenida.mp4.mp4',
    bienvenida_en:'bienvenida_en.mp4.mp4.mp4',
    correcto:'correcto.mp4.mp4',
    incorrecto:'incorrecto.mp4.mp4',
    medalla:'medalla.mp4.mp4',
    medalla_en:'medalla_en.mp4.mp4.mp4'
};

// ========== VIDEO FUNCTIONS ==========
let videoClosing=false;

function showVideo(type,cb){
    if(videoPlaying||videoClosing)return;
    videoPlaying=true;
    videoClosing=false;
    lowerMusicForVideo();
    currentVideoCallback=cb;
    const vf=document.getElementById('videoFloat');
    const v=document.getElementById('marioVideo');
    const videoSrc=VIDEOS[type]||VIDEOS.bienvenida;
    // Use English version of video if available and language is English
    let finalVideoSrc=videoSrc;
    if(D.lang==='en'&&VIDEOS[type+'_en']){
        finalVideoSrc=VIDEOS[type+'_en'];
    }
    console.log('Loading video:',finalVideoSrc);
    
    // Update video label and subtitle based on language
    const label=document.getElementById('videoLabel');
    const sub=document.getElementById('videoSubtitle');
    if(label)label.textContent=D.lang==='en'?'ðŸ”´ LIVE':'ðŸ”´ EN VIVO';
    if(sub){
        // Video subtitles based on type and language
        const subtitles={
            bienvenida:{
                both:'<div style="color:#ffd700;font-size:11px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.8)">âš¡ Si no mides, estÃ¡s adivinando</div><div style="color:rgba(255,255,255,0.7);font-size:9px;font-style:italic;margin-top:2px;text-shadow:0 1px 3px rgba(0,0,0,0.8)">If you don\'t measure, you\'re guessing</div>',
                es:'<div style="color:#ffd700;font-size:12px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.8)">âš¡ Si no mides, estÃ¡s adivinando</div><div style="color:#ffffff;font-size:10px;margin-top:3px;font-weight:600;letter-spacing:1px">A.C. VOLT TECHNICAL SCHOOLâ„¢</div>',
                en:'<div style="color:#ffd700;font-size:12px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.8)">âš¡ If you don\'t measure, you\'re guessing</div><div style="color:#ffffff;font-size:10px;margin-top:3px;font-weight:600;letter-spacing:1px">A.C. VOLT TECHNICAL SCHOOLâ„¢</div>'
            },
            correcto:{es:'<div style="color:#2ecc71;font-size:12px;font-weight:700">âœ… Â¡Correcto!</div>',en:'<div style="color:#2ecc71;font-size:12px;font-weight:700">âœ… Correct!</div>'},
            incorrecto:{es:'<div style="color:#ff6b2b;font-size:12px;font-weight:700">âŒ Â¡IntÃ©ntalo de nuevo!</div>',en:'<div style="color:#ff6b2b;font-size:12px;font-weight:700">âŒ Try again!</div>'},
            medalla:{es:'<div style="color:#ffd700;font-size:12px;font-weight:700">ðŸ… Â¡Nueva medalla!</div>',en:'<div style="color:#ffd700;font-size:12px;font-weight:700">ðŸ… New medal!</div>'}
        };
        const st=subtitles[type]||subtitles.bienvenida;
        if(type==='bienvenida'&&!D.lang){
            sub.innerHTML=st.both;
        }else{
            sub.innerHTML=D.lang==='en'?(st.en||st.es):st.es;
        }
        sub.style.display='block';
    }
    
    // Limpiar handlers anteriores
    v.onended=null;
    v.onerror=null;
    
    v.src=finalVideoSrc;
    v.load();
    vf.classList.remove('hiding');
    vf.classList.add('active');
    v.play().then(()=>{
        console.log('Video playing');
    }).catch(e=>{
        console.log('Video play error:',e);
        closeVideo();
    });
    v.onended=function(){
        console.log('Video ended');
        closeVideo();
    };
    v.onerror=function(e){
        console.log('Video error:',e);
        if(videoPlaying&&!videoClosing)closeVideo();
    };
}

function closeVideo(){
    if(videoClosing)return;
    videoClosing=true;
    const vf=document.getElementById('videoFloat');
    const v=document.getElementById('marioVideo');
    
    // Limpiar handlers ANTES de tocar el src
    v.onended=null;
    v.onerror=null;
    
    vf.classList.add('hiding');
    vf.classList.remove('active');
    restoreMusicAfterVideo();
    setTimeout(()=>{
        v.pause();
        v.removeAttribute('src');
        v.load();
        videoPlaying=false;
        videoClosing=false;
        if(currentVideoCallback){
            const cb=currentVideoCallback;
            currentVideoCallback=null;
            cb();
        }
    },600);
}

function startWithVideo(){
    startMusic();
    go('s1');
}

// ========== AI CHAT FUNCTIONS ==========
const MARIO_SYSTEM_ES="Eres el Maestro Mario Flores Corona, instructor de HVAC/Refrigeracion/Electricidad con 25+ aÃ±os de experiencia. Tu escuela es ACVOLT Tech School en San Bernardino, California. Tu frase: Si no mides, estÃ¡s adivinando. Responde en 2-3 oraciones MAX. SÃ© personal y motivador. Usa frases como Ã³rale, vamos con todo, asÃ­ se hace. NO uses markdown ni emojis.";
const MARIO_SYSTEM_EN="You are Maestro Mario Flores Corona, HVAC/Refrigeration/Electrical instructor with 25+ years of experience. Your school is ACVOLT Tech School in San Bernardino, California. Your motto: If you don't measure, you're guessing. Answer in 2-3 sentences MAX. Be personal and motivating. Use phrases like let's go, you got this, that's how it's done. Do NOT use markdown or emojis.";
function getMarioSystem(){return D.lang==='en'?MARIO_SYSTEM_EN:MARIO_SYSTEM_ES;}

async function getAIResponse(msg){
    try{
        const r=await fetch(SUPABASE_URL+'/tutor-ia-chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                messages:[{role:'user',content:msg}],
                system:getMarioSystem(),
                max_tokens:150
            })
        });
        if(!r.ok)throw new Error('Chat API error');
        const d=await r.json();
        return d.content&&d.content[0]?d.content[0].text:(D.lang==='es'?'Â¡Ã“rale '+(D.name||gn('tÃ©cnico','tÃ©cnica'))+'! Hubo un problema, intenta de nuevo.':'Hey '+(D.name||'technician')+'! There was a problem, try again.');
    }catch(e){
        console.error('AI Chat Error:',e);
        return D.lang==='es'?'Â¡Ã“rale! Problema de conexiÃ³n. Intenta de nuevo.':'Connection problem. Please try again.';
    }
}

let speechAbort=null;

// ========== SPEECH TEXT PREPROCESSOR ==========
// Converts symbols and abbreviations to spoken Spanish words
function prepareForSpeech(text){
    if(!text)return text;
    let t=text;
    // Use English speech conversions if language is English
    if(D.lang==='en'){
        t=t.replace(/(\d+)\s*Â°F/g,'$1 degrees Fahrenheit');
        t=t.replace(/(\d+)\s*Â°C/g,'$1 degrees Celsius');
        t=t.replace(/(\d+)\s*Â°/g,'$1 degrees');
        t=t.replace(/R-(\d+)([A-Za-z]*)/g,function(m,num,suffix){
            if(!suffix)return 'refrigerant R '+num;
            return 'refrigerant R '+num+' '+suffix;
        });
        t=t.replace(/(\d+)\s*psi/gi,'$1 P S I');
        t=t.replace(/(\d+)\s*kW\b/g,'$1 kilowatts');
        t=t.replace(/(\d+)\s*HP\b/gi,'$1 horsepower');
        t=t.replace(/BTU\/h/gi,'B T U per hour');
        t=t.replace(/BTU/gi,'B T U');
        t=t.replace(/(\d+)\s*V\b(?!olt)/g,'$1 volts');
        t=t.replace(/(\d+)\s*W\b(?!att)/g,'$1 watts');
        t=t.replace(/(\d+)\s*Î©/g,'$1 ohms');
        t=t.replace(/(\d+)\s*A\b(?![\w])/g,'$1 amps');
        t=t.replace(/CFM/g,'C F M');
        t=t.replace(/TXV/g,'thermostatic expansion valve');
        t=t.replace(/EPR/g,'evaporator pressure regulator');
        t=t.replace(/GWP/g,'global warming potential');
        t=t.replace(/ODP/g,'ozone depletion potential');
        t=t.replace(/\s*Ã—\s*/g,' times ');
        t=t.replace(/\s*Ã·\s*/g,' divided by ');
        t=t.replace(/\s*=\s*/g,' equals ');
        t=t.replace(/\s*\+\s*/g,' plus ');
        t=t.replace(/\s*âˆ’\s*/g,' minus ');
        t=t.replace(/âˆš/g,'square root of ');
        t=t.replace(/Â²/g,' squared');
        t=t.replace(/\//g,' over ');
        t=t.replace(/HVAC/g,'H V A C');
        t=t.replace(/NEC/g,'National Electrical Code');
        t=t.replace(/NFPA/g,'N F P A');
        t=t.replace(/OSHA/g,'O S H A');
        t=t.replace(/EPA/g,'E P A');
        t=t.replace(/LOTO/g,'lockout tagout');
        t=t.replace(/AC\b/g,'air conditioning');
        t=t.replace(/GFCI/g,'G F C I');
        t=t.replace(/AFCI/g,'A F C I');
        t=t.replace(/VFD/g,'variable frequency drive');
        t=t.replace(/POE/g,'polyolester oil');
        t=t.replace(/PAG/g,'P A G oil');
        t=t.replace(/CW\b/g,'clockwise');
        t=t.replace(/CCW\b/g,'counter clockwise');
        t=t.replace(/UV\b/g,'ultraviolet');
        t=t.replace(/&/g,' and ');
        t=t.replace(/%/g,' percent');
        t=t.replace(/#/g,'number ');
        t=t.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu,'');
        t=t.replace(/\s{2,}/g,' ').trim();
        return t;
    }
    // === FIRST: Refrigerant names (before unit conversions to avoid R-404A â†’ "404 amperios") ===
    t=t.replace(/R-(\d+)([A-Za-z]*)/g,function(m,num,suffix){
        if(!suffix)return 'refrigerante R '+num;
        // Spell out suffix to avoid conflicts: Aâ†’"a", Bâ†’"be", Câ†’"ce"
        const spelled=suffix.split('').map(c=>({A:'a',B:'be',C:'ce',D:'de'}[c.toUpperCase()]||c)).join(' ');
        return 'refrigerante R '+num+' '+spelled;
    });
    // Temperature symbols
    t=t.replace(/(\d+)\s*Â°F/g,'$1 grados Fahrenheit');
    t=t.replace(/(\d+)\s*Â°C/g,'$1 grados Celsius');
    t=t.replace(/(\d+)\s*Â°/g,'$1 grados');
    // Pressure (before generic units)
    t=t.replace(/(\d+)\s*psi/gi,'$1 P S I');
    t=t.replace(/(\d+)\s*PSI/g,'$1 P S I');
    t=t.replace(/(\d+)\s*kPa/gi,'$1 kilopascales');
    // Multi-char units first
    t=t.replace(/(\d+)\s*kW\b/g,'$1 kilowatts');
    t=t.replace(/(\d+)\s*HP\b/gi,'$1 caballos de fuerza');
    t=t.replace(/BTU\/h/gi,'B T U por hora');
    t=t.replace(/BTU/gi,'B T U');
    // Electrical units (single char - must come AFTER multi-char and refrigerant names)
    t=t.replace(/(\d+)\s*V\b(?!olt)/g,'$1 voltios');
    t=t.replace(/(\d+)\s*W\b(?!att)/g,'$1 watts');
    t=t.replace(/(\d+)\s*Î©/g,'$1 ohms');
    // Amps: only match standalone A after number, not inside words
    t=t.replace(/(\d+)\s*A\b(?![\w])/g,'$1 amperios');
    // Refrigeration abbreviations
    t=t.replace(/CFM/g,'C F M');
    t=t.replace(/TXV/g,'vÃ¡lvula de expansiÃ³n termostÃ¡tica');
    t=t.replace(/EPR/g,'regulador de presiÃ³n del evaporador');
    t=t.replace(/GWP/g,'potencial de calentamiento global');
    t=t.replace(/ODP/g,'potencial de destrucciÃ³n de ozono');
    // Refrigerant names
    t=t.replace(/R-(\d+[A-Za-z]*)/g,'refrigerante R $1');
    // Math operators
    t=t.replace(/\s*Ã—\s*/g,' multiplicado por ');
    t=t.replace(/\s*Ã·\s*/g,' dividido entre ');
    t=t.replace(/\s*=\s*/g,' igual a ');
    t=t.replace(/\s*\+\s*/g,' mÃ¡s ');
    t=t.replace(/\s*âˆ’\s*/g,' menos ');
    t=t.replace(/\s*-\s+/g,' menos ');
    t=t.replace(/âˆš/g,'raÃ­z cuadrada de ');
    t=t.replace(/Â²/g,' al cuadrado');
    t=t.replace(/\//g,' entre ');
    // Common abbreviations
    t=t.replace(/HVAC/g,'H V A C');
    t=t.replace(/NEC/g,'CÃ³digo ElÃ©ctrico Nacional');
    t=t.replace(/NFPA/g,'N F P A');
    t=t.replace(/OSHA/g,'O S H A');
    t=t.replace(/EPA/g,'E P A');
    t=t.replace(/LOTO/g,'bloqueo y etiquetado');
    t=t.replace(/AC\b/g,'aire acondicionado');
    t=t.replace(/GFCI/g,'G F C I');
    t=t.replace(/AFCI/g,'A F C I');
    t=t.replace(/VFD/g,'variador de frecuencia');
    t=t.replace(/POE/g,'aceite poliolÃ©ster');
    t=t.replace(/PAG/g,'aceite P A G');
    t=t.replace(/CW\b/g,'en sentido de las manecillas del reloj');
    t=t.replace(/CCW\b/g,'en contra de las manecillas del reloj');
    t=t.replace(/UV\b/g,'ultravioleta');
    // Other symbols
    t=t.replace(/&/g,' y ');
    t=t.replace(/%/g,' por ciento');
    t=t.replace(/#/g,'nÃºmero ');
    // Clean up emojis for speech
    t=t.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu,'');
    // Clean double spaces
    t=t.replace(/\s{2,}/g,' ').trim();
    return t;
}

async function speakText(text){
    // Cancel any ongoing speech
    if(speechAbort)speechAbort.cancelled=true;
    const thisAbort={cancelled:false};
    speechAbort=thisAbort;
    
    try{
        isSpeaking=true;
        lowerMusicForSpeech();
        document.getElementById('speakingIndicator').classList.add('active');
        
        // Preprocess text for natural speech
        const spokenText=prepareForSpeech(text);
        
        // Split into chunks at sentence boundaries
        const chunks=splitTextChunks(spokenText,500);
        
        // Pre-fetch first chunk
        let nextBlob=await fetchVoiceChunk(chunks[0]);
        if(thisAbort.cancelled)return cleanupSpeech();
        
        for(let i=0;i<chunks.length;i++){
            if(thisAbort.cancelled)return cleanupSpeech();
            
            const currentBlob=nextBlob;
            
            // If API returned null, use browser voice fallback
            if(!currentBlob){
                // Try browser speech for this chunk
                if(window.speechSynthesis){
                    await speakWithBrowser(chunks[i]);
                }
                if(i+1<chunks.length)nextBlob=await fetchVoiceChunk(chunks[i+1]);
                continue;
            }
            
            // Start pre-fetching NEXT chunk while current plays
            const fetchNext=(i+1<chunks.length)?fetchVoiceChunk(chunks[i+1]):Promise.resolve(null);
            
            // Play current chunk
            const audioUrl=URL.createObjectURL(currentBlob);
            const audio=document.getElementById('aiAudio');
            audio.src=audioUrl;
            
            await new Promise(resolve=>{
                audio.onended=()=>{URL.revokeObjectURL(audioUrl);resolve();};
                audio.onerror=()=>{URL.revokeObjectURL(audioUrl);resolve();};
                audio.play().catch(()=>resolve());
            });
            
            if(thisAbort.cancelled)return cleanupSpeech();
            
            // Next chunk should already be fetched
            nextBlob=await fetchNext;
        }
        
        cleanupSpeech();
    }catch(e){
        console.error('Voice Error:',e);
        cleanupSpeech();
    }
}

async function fetchVoiceChunk(text){
    try{
        const r=await fetch(SUPABASE_URL+'/tutor-ia-voice',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                text:text.trim(),
                lang:D.lang||'es',
                voice:D.lang==='en'?'echo':'nova'
            })
        });
        if(!r.ok)return null;
        return await r.blob();
    }catch(e){return null;}
}

// ========== BROWSER VOICE FALLBACK ==========
// If API voice fails, use browser's SpeechSynthesis with proper voice
let browserVoicesLoaded=false;
let preferredVoiceES=null;
let preferredVoiceEN=null;

function loadBrowserVoices(){
    if(browserVoicesLoaded)return;
    const voices=window.speechSynthesis?window.speechSynthesis.getVoices():[];
    if(voices.length===0)return;
    browserVoicesLoaded=true;
    
    // Spanish voice priority: Mexican > Latin American > Spain > any Spanish
    const esVoices=voices.filter(v=>v.lang.startsWith('es'));
    const mxVoice=esVoices.find(v=>v.lang==='es-MX'||v.name.toLowerCase().includes('mexico')||v.name.toLowerCase().includes('mexican'));
    const latamVoice=esVoices.find(v=>v.lang==='es-US'||v.lang==='es-419'||v.name.toLowerCase().includes('latin'));
    const maleES=esVoices.find(v=>v.name.toLowerCase().includes('jorge')||v.name.toLowerCase().includes('carlos')||v.name.toLowerCase().includes('diego')||v.name.toLowerCase().includes('andrÃ©s'));
    preferredVoiceES=mxVoice||latamVoice||maleES||esVoices[0]||null;
    
    // English voice priority: US male
    const enVoices=voices.filter(v=>v.lang.startsWith('en'));
    const usVoice=enVoices.find(v=>v.lang==='en-US');
    const maleEN=enVoices.find(v=>v.name.toLowerCase().includes('daniel')||v.name.toLowerCase().includes('alex')||v.name.toLowerCase().includes('david'));
    preferredVoiceEN=maleEN||usVoice||enVoices[0]||null;
    
    console.log('Browser voices loaded. ES:',preferredVoiceES?.name,'EN:',preferredVoiceEN?.name);
}

// Load voices (some browsers need event listener)
if(window.speechSynthesis){
    loadBrowserVoices();
    window.speechSynthesis.onvoiceschanged=loadBrowserVoices;
}

function speakWithBrowser(text){
    return new Promise((resolve)=>{
        if(!window.speechSynthesis){resolve();return;}
        loadBrowserVoices();
        const utter=new SpeechSynthesisUtterance(text);
        utter.lang=D.lang==='es'?'es-MX':'en-US';
        utter.rate=0.95;
        utter.pitch=1.0;
        const voice=D.lang==='es'?preferredVoiceES:preferredVoiceEN;
        if(voice)utter.voice=voice;
        utter.onend=resolve;
        utter.onerror=resolve;
        window.speechSynthesis.speak(utter);
    });
}

function cleanupSpeech(){
    isSpeaking=false;
    document.getElementById('speakingIndicator').classList.remove('active');
    restoreMusicAfterSpeech();
}

function stopSpeech(){
    if(speechAbort)speechAbort.cancelled=true;
    const audio=document.getElementById('aiAudio');
    audio.pause();
    audio.removeAttribute('src');
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    cleanupSpeech();
}

function splitTextChunks(text,maxLen){
    if(text.length<=maxLen)return[text];
    const chunks=[];
    let remaining=text;
    while(remaining.length>0){
        if(remaining.length<=maxLen){chunks.push(remaining);break;}
        let splitAt=-1;
        for(let i=Math.min(maxLen,remaining.length)-1;i>=maxLen*0.4;i--){
            if('.!?'.includes(remaining[i])){splitAt=i+1;break;}
        }
        if(splitAt===-1){
            for(let i=Math.min(maxLen,remaining.length)-1;i>=maxLen*0.4;i--){
                if(',;:'.includes(remaining[i])){splitAt=i+1;break;}
            }
        }
        if(splitAt===-1){
            for(let i=Math.min(maxLen,remaining.length)-1;i>=maxLen*0.4;i--){
                if(remaining[i]===' '){splitAt=i+1;break;}
            }
        }
        if(splitAt===-1)splitAt=maxLen;
        chunks.push(remaining.substring(0,splitAt));
        remaining=remaining.substring(splitAt);
    }
    return chunks;
}

function openAIChat(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    document.getElementById('aiModal').classList.add('active');
}

function closeAIChat(){
    document.getElementById('aiModal').classList.remove('active');
    const audio=document.getElementById('aiAudio');
    audio.pause();
    isSpeaking=false;
    document.getElementById('speakingIndicator').classList.remove('active');
}

async function sendAIMessage(){
    const input=document.getElementById('aiInput');
    const msgs=document.getElementById('aiMessages');
    const sendBtn=document.getElementById('sendBtn');
    const txt=input.value.trim();
    if(!txt||isSpeaking)return;
    
    // Desbloquear audio en el click
    unlockAudio();
    
    // Disable input while processing
    input.disabled=true;
    sendBtn.disabled=true;
    
    // Show user message
    msgs.innerHTML+='<div class="ai-msg user">'+txt+'</div>';
    input.value='';
    
    // Show typing indicator
    msgs.innerHTML+='<div class="ai-msg mario" id="typing"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
    msgs.scrollTop=msgs.scrollHeight;
    
    // Get AI text response
    const response=await getAIResponse(txt);
    
    // Track characters used
    if(window.trackAIChars) window.trackAIChars(txt + response);
    
    // Remove typing indicator and show response
    const typing=document.getElementById('typing');
    if(typing)typing.remove();
    msgs.innerHTML+='<div class="ai-msg mario">'+response+'</div>';
    msgs.scrollTop=msgs.scrollHeight;
    
    // Re-enable input
    input.disabled=false;
    sendBtn.disabled=false;
    input.focus();
    
    // Speak the response
    await speakText(response);
}

// ========== CONFETTI ==========
function cft(){
    const c=document.getElementById('conf');
    c.innerHTML='';
    const cols=['#ff6b2b','#00d4ff','#f1c40f','#2ecc71','#e74c3c','#9b59b6'];
    for(let i=0;i<25;i++){
        const p=document.createElement('div');
        p.className='cf';
        p.style.left=Math.random()*100+'%';
        p.style.background=cols[Math.floor(Math.random()*cols.length)];
        p.style.animationDelay=Math.random()*1.5+'s';
        p.style.animationDuration=(2+Math.random()*1.5)+'s';
        p.style.width=(6+Math.random()*6)+'px';
        p.style.height=p.style.width;
        p.style.borderRadius=Math.random()>.5?'50%':'2px';
        c.appendChild(p);
    }
    setTimeout(()=>c.innerHTML='',3500);
}

// ========== TRANSLATIONS ==========
const T={
es:{step_1:'Paso 1 de 5',step_2:'Paso 2 de 5',step_3:'Paso 3 de 5',step_4:'Paso 4 de 5',step_5:'Paso 5 de 5',welcome_speech:'Â¡Bienvenido! Soy el Maestro Mario y voy a ser tu guÃ­a. Â¿CÃ³mo te llamas?',name_ph:'Escribe tu nombre aquÃ­...',continue:'Continuar â†’',level_speech:'Â¡Mucho gusto, {name}! Â¿En quÃ© nivel tÃ©cnico te encuentras?',spec_speech:'Â¡Excelente, {name}! Â¿En quÃ© Ã¡reas te sientes mÃ¡s fuerte?',multi_hint:'Selecciona una o mÃ¡s opciones',school_speech:'Â¡Vas muy bien, {name}! Â¿DÃ³nde estÃ¡s estudiando?',goals_speech:'Â¡Ãšltima pregunta, {name}! Â¿QuÃ© quieres lograr?',route_speech:'Â¡Perfecto, {name}! He creado tu ruta personalizada. Â¡Vamos con todo!',start_btn:'ðŸš€ Â¡Empezar a Aprender!',lv1:'Estudiante',lv1d:'Estoy aprendiendo lo bÃ¡sico',lv2:'Ayudante',lv2d:'Ya ando en el campo con un tÃ©cnico',lv3:'TÃ©cnico',lv3d:'Ya trabajo solo pero quiero mejorar',lv4:'Avanzado',lv4d:'Quiero dominar el oficio',lv5:'Maestro',lv5d:'Quiero ser lÃ­der / abrir mi empresa',sp_e:'Electricidad',sp_ed:'Circuitos, controles, cableado',sp_a:'Aire Acondicionado',sp_ad:'Splits, centrales, mini splits',sp_r:'RefrigeraciÃ³n',sp_rd:'CÃ¡maras frÃ­as, refrigeradores comerciales',sp_h:'CalefacciÃ³n',sp_hd:'Furnaces, bombas de calor',sp_x:'Estoy empezando en todo',sp_xd:'Quiero aprender de todo',sc_ac:'ACVOLT Tech School',sc_acd:'Estudiante actual de ACVOLT',sc_ot:'Otra escuela',sc_otd:'Estoy en otra instituciÃ³n',sc_sf:'Aprendo por mi cuenta',sc_sfd:'YouTube, libros, campo',sc_dn:'Ya terminÃ© mis estudios',sc_dnd:'Tengo certificaciÃ³n/diploma',gl_c:'Pasar mis certificaciones',gl_cd:'EPA, NATE, OSHA, NCCER',gl_d:'Mejorar mis diagnÃ³sticos',gl_dd:'Ser mÃ¡s preciso en el campo',gl_b:'Abrir mi propio negocio',gl_bd:'De tÃ©cnico a empresario',gl_m:'Ganar mÃ¡s dinero',gl_md:'Subir mi valor como tÃ©cnico',r_elec:'Fundamentos ElÃ©ctricos',r_elecd:'Circuitos, Ley de Ohm, diagramas',r_ac:'Aire Acondicionado',r_acd:'Presiones, carga de refrigerante',r_ref:'RefrigeraciÃ³n Comercial',r_refd:'CÃ¡maras frÃ­as, controles, defrost',r_heat:'CalefacciÃ³n',r_heatd:'Furnaces, bombas de calor, gas',r_cert:'PreparaciÃ³n para Certificaciones',r_certd:'EPA 608 â€¢ NATE â€¢ OSHA â€¢ NCCER',r_biz:'De TÃ©cnico a Empresario',r_bizd:'Licencias, estimados, clientes'},
en:{step_1:'Step 1 of 5',step_2:'Step 2 of 5',step_3:'Step 3 of 5',step_4:'Step 4 of 5',step_5:'Step 5 of 5',welcome_speech:"Welcome technician! I'm Maestro Mario and I'll be your guide. What's your name?",name_ph:'Type your name here...',continue:'Continue â†’',level_speech:"Nice to meet you, {name}! What's your technical level?",spec_speech:'Excellent, {name}! What areas are you strongest in?',multi_hint:'Select one or more options',school_speech:'Great progress, {name}! Where are you studying?',goals_speech:'Last question, {name}! What do you want to achieve?',route_speech:"Perfect, {name}! I've created your personalized path. Let's go!",start_btn:'ðŸš€ Start Learning!',lv1:'Student',lv1d:"I'm learning the basics",lv2:'Helper',lv2d:"I'm in the field with a technician",lv3:'Technician',lv3d:'I work solo but want to improve',lv4:'Advanced',lv4d:'I want to master the trade',lv5:'Master',lv5d:'I want to lead / start my business',sp_e:'Electrical',sp_ed:'Circuits, controls, wiring',sp_a:'Air Conditioning',sp_ad:'Splits, central, mini splits',sp_r:'Refrigeration',sp_rd:'Walk-in coolers, commercial',sp_h:'Heating',sp_hd:'Furnaces, heat pumps',sp_x:'Starting in everything',sp_xd:'I want to learn it all',sc_ac:'ACVOLT Tech School',sc_acd:'Current ACVOLT student',sc_ot:'Another school',sc_otd:"I'm at another institution",sc_sf:'Self-taught',sc_sfd:'YouTube, books, field',sc_dn:'Completed studies',sc_dnd:'I have certification/diploma',gl_c:'Pass certifications',gl_cd:'EPA, NATE, OSHA, NCCER',gl_d:'Improve diagnostics',gl_dd:'Be more precise in the field',gl_b:'Start my business',gl_bd:'From tech to owner',gl_m:'Earn more money',gl_md:'Increase my value',r_elec:'Electrical Fundamentals',r_elecd:"Circuits, Ohm's law, diagrams",r_ac:'Air Conditioning',r_acd:'Pressure diagnostics, charging',r_ref:'Commercial Refrigeration',r_refd:'Walk-in coolers, controls, defrost',r_heat:'Heating Systems',r_heatd:'Furnaces, heat pumps, gas',r_cert:'Certification Prep',r_certd:'EPA 608 â€¢ NATE â€¢ OSHA â€¢ NCCER',r_biz:'Tech to Business Owner',r_bizd:'Licensing, estimates, clients'}
};

const t=k=>(T[D.lang][k]||k).replace('{name}',D.name);
const u=()=>{document.querySelectorAll('[data-t]').forEach(e=>e.textContent=t(e.getAttribute('data-t')));document.querySelectorAll('[data-tp]').forEach(e=>e.placeholder=t(e.getAttribute('data-tp')));};
const go=id=>{document.querySelectorAll('.s').forEach(s=>s.classList.remove('on'));document.getElementById(id).classList.add('on');window.scrollTo(0,0);};
const rx=(id,c)=>{const e=document.getElementById(id);if(e){e.classList.add(c);setTimeout(()=>e.classList.remove(c),1500);}};

function setLang(l){D.lang=l;unlockAudio();u();updateLanguageUI();showVideo('bienvenida',()=>{go('s2');document.getElementById('nm').placeholder=t('name_ph');speakText(t('welcome_speech'));});}
function sName(){D.name=document.getElementById('nm').value.trim();D.gender=detectGender(D.name);u();bLvl();go('s3');rx('a3','nod');speakText(t('level_speech'));document.getElementById('profileBtn').classList.add('active');}
function pLvl(e,v){document.querySelectorAll('#lo .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.level=v;document.getElementById('b3').disabled=false;rx('a3','nod');}
function sLvl(){u();bSpc();go('s4');speakText(t('spec_speech'));}
function tSpc(e,k){if(k==='all'){document.querySelectorAll('#so .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.specs=['all'];}else{document.querySelector('#so .oc:last-child').classList.remove('sel');D.specs=D.specs.filter(s=>s!=='all');e.classList.toggle('sel');if(e.classList.contains('sel'))D.specs.push(k);else D.specs=D.specs.filter(s=>s!==k);}document.getElementById('b4').disabled=D.specs.length===0;rx('a4','nod');}
function sSpc(){u();bSch();go('s5');speakText(t('school_speech'));}
function pSch(e,v){document.querySelectorAll('#sco .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.school=v;document.getElementById('b5').disabled=false;rx('a5','nod');}
function sSch(){u();bGol();go('s6');speakText(t('goals_speech'));}
function tGol(e,k){e.classList.toggle('sel');if(e.classList.contains('sel'))D.goals.push(k);else D.goals=D.goals.filter(g=>g!==k);document.getElementById('b6').disabled=D.goals.length===0;rx('a6','nod');}
function sGol(){u();bRt();go('s7');cft();rx('a7','cel');speakText(t('route_speech'));}

function bLvl(){document.getElementById('lo').innerHTML=[{k:1,i:'ðŸ“š',t:'lv1',d:'lv1d'},{k:2,i:'ðŸ”§',t:'lv2',d:'lv2d'},{k:3,i:'âš™ï¸',t:'lv3',d:'lv3d'},{k:4,i:'ðŸŽ¯',t:'lv4',d:'lv4d'},{k:5,i:'ðŸ‘‘',t:'lv5',d:'lv5d'}].map(x=>'<div class="oc" onclick="pLvl(this,'+x.k+')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div></div>').join('');}
function bSpc(){document.getElementById('so').innerHTML=[{k:'electrical',i:'âš¡',t:'sp_e',d:'sp_ed'},{k:'ac',i:'â„ï¸',t:'sp_a',d:'sp_ad'},{k:'refrigeration',i:'ðŸ§Š',t:'sp_r',d:'sp_rd'},{k:'heating',i:'ðŸ”¥',t:'sp_h',d:'sp_hd'},{k:'all',i:'ðŸŒŸ',t:'sp_x',d:'sp_xd'}].map(x=>'<div class="oc" onclick="tSpc(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div><div class="ck"></div></div>').join('');}
function bSch(){document.getElementById('sco').innerHTML=[{k:'acvolt',i:'ðŸŽ“',t:'sc_ac',d:'sc_acd'},{k:'other',i:'ðŸ«',t:'sc_ot',d:'sc_otd'},{k:'self',i:'ðŸ’ª',t:'sc_sf',d:'sc_sfd'},{k:'done',i:'âœ…',t:'sc_dn',d:'sc_dnd'}].map(x=>'<div class="oc" onclick="pSch(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div></div>').join('');}
function bGol(){document.getElementById('go2').innerHTML=[{k:'certs',i:'ðŸ“‹',t:'gl_c',d:'gl_cd'},{k:'diag',i:'ðŸ”',t:'gl_d',d:'gl_dd'},{k:'biz',i:'ðŸ¢',t:'gl_b',d:'gl_bd'},{k:'money',i:'ðŸ’°',t:'gl_m',d:'gl_md'}].map(x=>'<div class="oc" onclick="tGol(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div><div class="ck"></div></div>').join('');}
function bRt(){var r=[];if(D.specs.includes('all')||D.specs.includes('electrical'))r.push({i:'âš¡',t:'r_elec',d:'r_elecd'});if(D.specs.includes('all')||D.specs.includes('ac'))r.push({i:'â„ï¸',t:'r_ac',d:'r_acd'});if(D.specs.includes('all')||D.specs.includes('refrigeration'))r.push({i:'ðŸ§Š',t:'r_ref',d:'r_refd'});if(D.specs.includes('all')||D.specs.includes('heating'))r.push({i:'ðŸ”¥',t:'r_heat',d:'r_heatd'});if(D.goals.includes('certs'))r.push({i:'ðŸ“‹',t:'r_cert',d:'r_certd'});if(D.goals.includes('biz'))r.push({i:'ðŸ¢',t:'r_biz',d:'r_bizd'});document.getElementById('rl').innerHTML=r.map((x,i)=>'<div class="rt"><div class="rn">'+(i+1)+'</div><div><div class="rtt">'+x.i+' '+t(x.t)+'</div><div class="rd">'+t(x.d)+'</div></div></div>'+(i<r.length-1?'<div class="rl"></div>':'')).join('');}

function startApp(){
    enterStudyMode();
    updateHub();
    go('s-hub');
    speakText(D.lang==='es'?'Â¡'+D.name+'! Bienvenid'+gn('o','a')+' a tu centro de entrenamiento. Elige quÃ© quieres hacer: tomar un quiz, repasar lo que fallaste, o ver videos.':'Welcome '+D.name+'! Choose what you want to do: take a quiz, study what you missed, or watch videos.');
}

// ========== QUIZ TRANSLATION HELPER ==========
// Returns the correct language version of a question field
function tq(q,field){
    if(D.lang==='en'&&q[field+'_en'])return q[field+'_en'];
    return q[field];
}

const QUIZ_LIST=[
    {id:'intro',icon:'ðŸ†•',title:'Intro HVACR',title_en:'Intro to HVACR',count:50,data:typeof QUIZ_INTRO!=='undefined'?QUIZ_INTRO:[],color:'#3498db'},
    {id:'principiante',icon:'ðŸ“š',title:'Principiante HVAC',title_en:'HVAC Beginner',count:50,data:typeof QUIZ_PRINCIPIANTE!=='undefined'?QUIZ_PRINCIPIANTE:[],color:'#00d4ff'},
    {id:'intro_elec',icon:'ðŸ”Œ',title:'Intro Electricidad',title_en:'Intro Electricity',count:100,data:typeof QUIZ_INTRO_ELECTRICIDAD!=='undefined'?QUIZ_INTRO_ELECTRICIDAD:[],color:'#e74c3c'},
    {id:'intro_refri',icon:'ðŸ§Š',title:'Intro RefrigeraciÃ³n',title_en:'Intro Refrigeration',count:100,data:typeof QUIZ_INTRO_REFRIGERACION!=='undefined'?QUIZ_INTRO_REFRIGERACION:[],color:'#1abc9c'},
    {id:'electricidad',icon:'âš¡',title:'Electricidad Avanzada',title_en:'Advanced Electrical',count:117,data:typeof QUIZ_ELECTRICIDAD!=='undefined'?QUIZ_ELECTRICIDAD:[],color:'#ffd700'},
    {id:'refrigeracion',icon:'â„ï¸',title:'RefrigeraciÃ³n Completa',title_en:'Complete Refrigeration',count:200,data:typeof QUIZ_REFRIGERACION!=='undefined'?QUIZ_REFRIGERACION:[],color:'#00e5ff'},
    {id:'study_elec',icon:'âš¡',title:'Estudio Electricidad Avanzada',title_en:'Advanced Electricity Study',count:100,data:typeof QUIZ_STUDY_ELECTRICIDAD!=='undefined'?QUIZ_STUDY_ELECTRICIDAD:[],color:'#9b59b6'},
    {id:'study_refri',icon:'ðŸŒ¡ï¸',title:'Estudio RefrigeraciÃ³n Avanzada',title_en:'Advanced Refrigeration Study',count:100,data:typeof QUIZ_STUDY_REFRIGERACION!=='undefined'?QUIZ_STUDY_REFRIGERACION:[],color:'#e67e22'},
    {id:'elec_comercial',icon:'ðŸ¢',title:'Electricidad Comercial',title_en:'Commercial Electrical',count:278,data:typeof QUIZ_ELECTRICIDAD_COMERCIAL_P2!=='undefined'?QUIZ_ELECTRICIDAD_COMERCIAL_P2:[],color:'#f39c12'},
    {id:'ac_principiante',icon:'â„ï¸',title:'AC Principiante',title_en:'AC Beginner',count:200,data:typeof quizACPrincipiante!=='undefined'?quizACPrincipiante:[],color:'#2ecc71'},
    {id:'heating_intro',icon:'ðŸ”¥',title:'Heating Intro',title_en:'Heating Intro',count:100,data:typeof QUIZ_HEATING_INTRO!=='undefined'?QUIZ_HEATING_INTRO:[],color:'#e74c3c'},
    {id:'wh_intro',icon:'ðŸ’§',title:'Water Heaters Intro',title_en:'Water Heaters Intro',count:100,data:typeof QUIZ_WH_INTRO!=='undefined'?QUIZ_WH_INTRO:[],color:'#3498db'},
    {id:'acca_intro',icon:'ðŸ“',title:'ACCA Manuales Intro',title_en:'ACCA Manuals Intro',count:100,data:typeof QUIZ_ACCA_INTRO!=='undefined'?QUIZ_ACCA_INTRO:[],color:'#9b59b6'},
    {id:'ventas_intro',icon:'ðŸ’¼',title:'Plan de Ventas Intro',title_en:'Sales Plan Intro',count:121,data:typeof QUIZ_VENTAS_INTRO!=='undefined'?QUIZ_VENTAS_INTRO:[],color:'#e67e22'},
    {id:'escuela_intro',icon:'ðŸŽ“',title:'Escuela / Director Intro',title_en:'School / Director Intro',count:105,data:typeof QUIZ_ESCUELA_INTRO!=='undefined'?QUIZ_ESCUELA_INTRO:[],color:'#2c3e50'}
];

const QUIZ_SECTIONS=[
    {num:1,icon:'â„ï¸',title:'Aire Acondicionado',title_en:'Air Conditioning',color:'#00d4ff',
     levels:[{id:'ac_principiante',level:'Intro',level_en:'Intro',dot:'#2ecc71'},{id:'intro_refri',level:'Principiante',level_en:'Beginner',dot:'#f1c40f'}]},
    {num:2,icon:'âš¡',title:'Electricidad',title_en:'Electrical',color:'#ffd700',
     levels:[{id:'intro_elec',level:'Intro',level_en:'Intro',dot:'#2ecc71'},{id:'electricidad',level:'Avanzada',level_en:'Advanced',dot:'#f1c40f'},{id:'study_elec',level:'Estudio Avanzado',level_en:'Advanced Study',dot:'#e67e22'},{id:'elec_comercial',level:'Comercial',level_en:'Commercial',dot:'#e74c3c'}]},
    {num:3,icon:'ðŸ§Š',title:'RefrigeraciÃ³n',title_en:'Refrigeration',color:'#1abc9c',
     levels:[{id:'intro_refri',level:'Intro',level_en:'Intro',dot:'#2ecc71'},{id:'refrigeracion',level:'Completa',level_en:'Complete',dot:'#f1c40f'},{id:'study_refri',level:'Estudio Avanzado',level_en:'Advanced Study',dot:'#e74c3c'}]},
    {num:4,icon:'ðŸ”¥',title:'Heating',title_en:'Heating',color:'#e74c3c',
     levels:[{id:'heating_intro',level:'Intro',level_en:'Intro',dot:'#2ecc71'}]},
    {num:5,icon:'ðŸ’§',title:'Water Heaters',title_en:'Water Heaters',color:'#3498db',
     levels:[{id:'wh_intro',level:'Intro',level_en:'Intro',dot:'#2ecc71'}]},
    {num:6,icon:'ðŸ“',title:'ACCA Manuales',title_en:'ACCA Manuals',color:'#9b59b6',
     levels:[{id:'acca_intro',level:'Intro',level_en:'Intro',dot:'#2ecc71'}]},
    {num:7,icon:'ðŸ—ï¸',title:'Estructura de CompaÃ±Ã­a',title_en:'Company Structure',color:'#95a5a6',levels:[]},
    {num:8,icon:'ðŸ’¼',title:'Plan de Venta',title_en:'Sales Plan',color:'#e67e22',
     levels:[{id:'ventas_intro',level:'Intro',level_en:'Intro',dot:'#2ecc71'}]},
    {num:9,icon:'ðŸŽ“',title:'Escuela / Director',title_en:'School / Director',color:'#2c3e50',levels:[{id:'escuela_intro',level:'Intro',level_en:'Intro',dot:'#2ecc71'}]},
    {num:10,icon:'ðŸª',title:'Franquiciar',title_en:'Franchising',color:'#95a5a6',levels:[]},
    {num:11,icon:'ðŸ·ï¸',title:'Vender la Empresa',title_en:'Selling the Business',color:'#95a5a6',levels:[]},
    {num:12,icon:'âš–ï¸',title:'Leyes Laborales',title_en:'Labor Laws',color:'#95a5a6',levels:[]},
    {num:13,icon:'ðŸ“£',title:'Marketing',title_en:'Marketing',color:'#95a5a6',levels:[]},
    {num:14,icon:'ðŸ¢',title:'Manejo de Empresa',title_en:'Business Management',color:'#95a5a6',levels:[]}
];
const QUIZ_SECTION_GENERAL={icon:'ðŸ†•',title:'General HVACR',title_en:'General HVACR',color:'#3498db',
    levels:[{id:'intro',level:'Intro HVACR',level_en:'Intro HVACR',dot:'#2ecc71'},{id:'principiante',level:'Principiante',level_en:'Beginner',dot:'#f1c40f'}]};

function renderQuizSelector(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    const el=document.getElementById('quizSelList');
    const scores=JSON.parse(localStorage.getItem('maestro_quiz_scores')||'{}');
    const es=D.lang==='es';
    let html='';

    // Total progress bar
    let totalQ=0,totalDone=0;
    QUIZ_LIST.forEach(q=>{if(scores[q.id])totalDone++;totalQ++;});
    html+='<div style="background:var(--card);border-radius:12px;padding:14px 16px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:13px;font-weight:700;color:var(--electric)">'+(es?'ðŸ“Š Progreso Total':'ðŸ“Š Total Progress')+'</span><span style="font-size:12px;color:var(--muted)">'+totalDone+'/'+totalQ+(es?' quizzes completados':' quizzes completed')+'</span></div><div class="pb" style="margin:0"><div class="pbf" style="width:'+(totalQ?Math.round(totalDone/totalQ*100):0)+'%;background:var(--electric)"></div></div></div>';

    // Render each section
    QUIZ_SECTIONS.forEach(sec=>{
        const locked=sec.levels.length===0;
        const secLevels=sec.levels.map(lv=>{
            const q=QUIZ_LIST.find(x=>x.id===lv.id);
            return q?{...lv,count:q.count,score:scores[lv.id]}:{...lv,count:0,score:null};
        });
        const secTotal=secLevels.reduce((s,l)=>s+l.count,0);
        const secDone=secLevels.filter(l=>l.score).length;
        const secId='qsec_'+sec.num;

        html+='<div class="qs-section'+(locked?' locked':'')+'" id="'+secId+'">';
        html+='<div class="qs-section-head" onclick="'+(locked?'':'toggleQSection(\''+secId+'\')')+'">';
        html+='<div class="qs-section-icon" style="background:'+sec.color+'15;color:'+sec.color+'">'+sec.icon+'</div>';
        html+='<div class="qs-section-info">';
        html+='<div class="qs-section-title" style="color:'+(locked?'var(--muted)':sec.color)+'">'+(es?sec.title:sec.title_en)+'</div>';
        html+='<div class="qs-section-meta">';
        if(locked){
            html+='<span>ðŸ”’ '+(es?'PrÃ³ximamente':'Coming soon')+'</span>';
        } else {
            html+='<span>ðŸ“ '+secTotal+(es?' preguntas':' questions')+'</span>';
            html+='<span>ðŸ“Š '+secLevels.length+(es?' niveles':' levels')+'</span>';
            if(secDone>0) html+='<span style="color:#4caf50">âœ… '+secDone+'/'+secLevels.length+'</span>';
        }
        html+='</div></div>';
        if(locked){
            html+='<span class="qs-lock-badge">ðŸ”’</span>';
        } else {
            html+='<span class="qs-section-arrow">â–¼</span>';
        }
        html+='</div>';

        if(!locked){
            html+='<div class="qs-section-body"><div class="qs-section-levels">';
            secLevels.forEach(lv=>{
                const badge=lv.score?'<span class="qs-level-badge done">âœ… '+lv.score+'%</span><span class="qs-level-stars">'+getStarsHTML(lv.score)+'</span>':'<span class="qs-level-badge new">'+(es?'Nuevo':'New')+'</span>';
                html+='<div class="qs-level" onclick="selectQuiz(\''+lv.id+'\')">';
                html+='<div class="qs-level-dot" style="background:'+lv.dot+'"></div>';
                html+='<div class="qs-level-info"><div class="qs-level-name">'+(es?lv.level:lv.level_en)+'</div>';
                html+='<div class="qs-level-count">'+lv.count+(es?' preguntas':' questions')+'</div></div>';
                html+=badge+'</div>';
            });
            html+='</div></div>';
        }
        html+='</div>';
    });

    // General HVACR section at bottom
    const gen=QUIZ_SECTION_GENERAL;
    const genLevels=gen.levels.map(lv=>{
        const q=QUIZ_LIST.find(x=>x.id===lv.id);
        return q?{...lv,count:q.count,score:scores[lv.id]}:{...lv,count:0,score:null};
    });
    const genTotal=genLevels.reduce((s,l)=>s+l.count,0);
    html+='<div class="qs-section" id="qsec_gen">';
    html+='<div class="qs-section-head" onclick="toggleQSection(\'qsec_gen\')">';
    html+='<div class="qs-section-icon" style="background:'+gen.color+'15;color:'+gen.color+'">'+gen.icon+'</div>';
    html+='<div class="qs-section-info"><div class="qs-section-title" style="color:'+gen.color+'">'+(es?gen.title:gen.title_en)+'</div>';
    html+='<div class="qs-section-meta"><span>ðŸ“ '+genTotal+(es?' preguntas':' questions')+'</span></div></div>';
    html+='<span class="qs-section-arrow">â–¼</span></div>';
    html+='<div class="qs-section-body"><div class="qs-section-levels">';
    genLevels.forEach(lv=>{
        const badge=lv.score?'<span class="qs-level-badge done">âœ… '+lv.score+'%</span><span class="qs-level-stars">'+getStarsHTML(lv.score)+'</span>':'<span class="qs-level-badge new">'+(es?'Nuevo':'New')+'</span>';
        html+='<div class="qs-level" onclick="selectQuiz(\''+lv.id+'\')">';
        html+='<div class="qs-level-dot" style="background:'+lv.dot+'"></div>';
        html+='<div class="qs-level-info"><div class="qs-level-name">'+(es?lv.level:lv.level_en)+'</div>';
        html+='<div class="qs-level-count">'+lv.count+(es?' preguntas':' questions')+'</div></div>';
        html+=badge+'</div>';
    });
    html+='</div></div></div>';

    el.innerHTML=html;
}

function toggleQSection(id){
    const el=document.getElementById(id);
    if(el) el.classList.toggle('open');
}

function getStarsHTML(pct){
    const filled=pct>=90?5:pct>=80?4:pct>=70?3:pct>=50?2:1;
    return Array(5).fill(0).map((_,i)=>i<filled?'â­':'â˜†').join('');
}

let currentQuizId='principiante';

function selectQuiz(id){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    currentQuizId=id;
    const q=QUIZ_LIST.find(x=>x.id===id);
    startQuiz(id);
    const intro=D.lang==='es'?'Â¡Vamos con '+q.title+', '+D.name+'! '+q.count+' preguntas bien capciositas. Demuestra lo que sabes.':'Let\'s go with '+q.title+', '+D.name+'! '+q.count+' tricky questions.';
    speakText(intro);
}

// ========== QUIZ SYSTEM ==========
// ========================================================
// QUIZ HEATING INTRO â€” 100 Preguntas (Final Optimizado)
// 4 AIs: Claude + Gemini + ChatGPT + DeepSeek
// Maestro Mario V2 - ACVOLT Tech School
// ========================================================
// ========================================================
// QUIZ WATER HEATERS INTRO â€” 100 Preguntas (Final)
// 4 AIs: Claude(23) + ChatGPT(18) + DeepSeek(30) + Gemini(29)
// ========================================================
// ========================================================
// ACCA MANUALES INTRO â€” 100 Preguntas (Final)
// 4 AIs: Claude(25) + ChatGPT(25) + DeepSeek(25) + Gemini(25)
// CategorÃ­as: Manual J + Manual N + VentilaciÃ³n ASHRAE
// ========================================================
// ========================================================
// PLAN DE VENTAS HVAC â€” 120 Preguntas (Final)
// 4 AIs: Claude(30) + ChatGPT(30) + DeepSeek(30) + Gemini(30)
// 8 CategorÃ­as de Ventas
// ========================================================
let quizData=[];
let quizIdx=0;
let quizRight=0;
let quizWrong=0;
let quizAnswered=false;
let quizAnswers=[];

function shuffleArray(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
    return a;
}

function startQuiz(id){
    const qId=id||currentQuizId||'principiante';
    currentQuizId=qId;
    if(qId==='intro')quizData=shuffleArray(QUIZ_INTRO);
    else if(qId==='electricidad')quizData=shuffleArray(QUIZ_ELECTRICIDAD);
    else if(qId==='refrigeracion')quizData=shuffleArray(QUIZ_REFRIGERACION);
    else if(qId==='intro_elec')quizData=shuffleArray(QUIZ_INTRO_ELECTRICIDAD);
    else if(qId==='intro_refri')quizData=shuffleArray(QUIZ_INTRO_REFRIGERACION);
    else if(qId==='study_elec')quizData=shuffleArray(QUIZ_STUDY_ELECTRICIDAD);
    else if(qId==='study_refri')quizData=shuffleArray(QUIZ_STUDY_REFRIGERACION);
    else if(qId==='elec_comercial')quizData=shuffleArray(QUIZ_ELECTRICIDAD_COMERCIAL_P2);
    else if(qId==='ac_principiante')quizData=shuffleArray(quizACPrincipiante);
    else if(qId==='heating_intro')quizData=shuffleArray(QUIZ_HEATING_INTRO);
    else if(qId==='wh_intro')quizData=shuffleArray(QUIZ_WH_INTRO);
    else if(qId==='acca_intro')quizData=shuffleArray(QUIZ_ACCA_INTRO);
    else if(qId==='ventas_intro')quizData=shuffleArray(QUIZ_VENTAS_INTRO);
    else if(qId==='escuela_intro')quizData=shuffleArray(QUIZ_ESCUELA_INTRO);
    else quizData=shuffleArray(QUIZ_PRINCIPIANTE);
    quizIdx=0;quizRight=0;quizWrong=0;quizStreak=0;
    quizAnswers=new Array(quizData.length).fill(-1);
    document.getElementById('qRight').textContent='0';
    document.getElementById('qWrong').textContent='0';
    go('s8');
    showQuestion();
}

function retryQuiz(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    // Only retry the questions the user got WRONG (not the entire quiz)
    const failedQuestions=[];
    for(let i=0;i<quizData.length;i++){
        if(quizAnswers[i]>=0 && quizAnswers[i]!==quizData[i].c){
            failedQuestions.push(quizData[i]);
        }
    }
    if(failedQuestions.length===0){
        // Perfect score - just restart full quiz
        startQuiz(currentQuizId);
        return;
    }
    // Start quiz with ONLY failed questions
    quizData=shuffleArray(failedQuestions);
    quizIdx=0;quizRight=0;quizWrong=0;quizStreak=0;
    quizAnswers=new Array(quizData.length).fill(-1);
    document.getElementById('qRight').textContent='0';
    document.getElementById('qWrong').textContent='0';
    go('s8');
    showQuestion();
    const q=QUIZ_LIST.find(x=>x.id===currentQuizId);
    speakText(D.lang==='es'?'Â¡Vamos a repasar las '+failedQuestions.length+' que fallaste, '+D.name+'! Â¡TÃº puedes, '+gn('campeÃ³n','campeona')+'!':'Let\'s review the '+failedQuestions.length+' you missed, '+D.name+'! You got this!');
}

// ========== FORMULA DETECTION SYSTEM ==========
const FORMULA_PATTERNS=[
    {
        id:'ohm_r',
        keywords:['resistencia segÃºn ohm','resistencia segÃºn Ohm','cuÃ¡l es la resistencia','ohms','ley de ohm','R = V'],
        title:'âš¡ Ley de Ohm â€” Resistencia',
        formula:'R = V Ã· I',
        vars:'R = Resistencia (Î©) | V = Voltaje (V) | I = Corriente (A)',
        hint:'Â¡Usa la Ley de Ohm! Divide el voltaje entre la corriente.',
        showWheel:true
    },
    {
        id:'ohm_v',
        keywords:['voltaje.*ohm','V = I','voltaje usando ohm','calcular el voltaje'],
        title:'âš¡ Ley de Ohm â€” Voltaje',
        formula:'V = I Ã— R',
        vars:'V = Voltaje (V) | I = Corriente (A) | R = Resistencia (Î©)',
        hint:'Â¡La Ley de Ohm te da el voltaje! Multiplica corriente por resistencia.',
        showWheel:true
    },
    {
        id:'ohm_i',
        keywords:['corriente.*ohm','I = V','amperios.*ohm','calcular la corriente','cuÃ¡ntos amperios'],
        title:'âš¡ Ley de Ohm â€” Corriente',
        formula:'I = V Ã· R',
        vars:'I = Corriente (A) | V = Voltaje (V) | R = Resistencia (Î©)',
        hint:'Â¡La Ley de Ohm! Divide el voltaje entre la resistencia para sacar amperios.',
        showWheel:true
    },
    {
        id:'watt_i',
        keywords:['amperios consume','cuÃ¡ntos amperios','corriente total','1500W','watts.*amperios','I = P','I = W'],
        title:'âš¡ Ley de Watt â€” Corriente',
        formula:'I = W Ã· V',
        vars:'I = Corriente (A) | W = Potencia (Watts) | V = Voltaje (V)',
        hint:'Â¡Para sacar amperios desde watts, usa I = W Ã· V!',
        showWheel:true
    },
    {
        id:'watt_p',
        keywords:['potencia total','watts total','cuÃ¡ntos watts','P = V','W = V'],
        title:'âš¡ Ley de Watt â€” Potencia',
        formula:'W = V Ã— I',
        vars:'W = Potencia (Watts) | V = Voltaje (V) | I = Corriente (A)',
        hint:'Â¡La potencia es voltaje por corriente! W = V Ã— I.',
        showWheel:true
    },
    {
        id:'vdrop',
        keywords:['caÃ­da de voltaje','porcentaje de caÃ­da','voltage drop','Vd ='],
        title:'ðŸ“‰ CaÃ­da de Voltaje',
        formula:'Vd = 2 Ã— K Ã— I Ã— D Ã· CM',
        vars:'K = Resistividad | I = Corriente | D = Distancia | CM = Circular Mils',
        hint:'Â¡Recuerda la fÃ³rmula de caÃ­da de voltaje! El 2 es por ida y vuelta.',
        showWheel:false
    },
    {
        id:'superheat',
        keywords:['superheat','superheat se mide','temperatura de succiÃ³n'],
        title:'ðŸŒ¡ï¸ Superheat',
        formula:'SH = T.lÃ­nea succiÃ³n âˆ’ T.saturaciÃ³n',
        vars:'SH = Superheat | T.lÃ­nea = Temp real | T.sat = SegÃºn tabla P-T',
        hint:'Â¡Para medir superheat necesitas dos cosas: la temperatura real y la de la tabla!',
        showWheel:false
    },
    {
        id:'subcooling',
        keywords:['subcooling','subcooling se mide','temp.*lÃ­quido'],
        title:'ðŸŒ¡ï¸ Subcooling',
        formula:'SC = T.saturaciÃ³n âˆ’ T.lÃ­nea lÃ­quido',
        vars:'SC = Subcooling | T.sat = SegÃºn tabla P-T | T.lÃ­nea = Temp real',
        hint:'Â¡Subcooling es lo opuesto al superheat! La temp de saturaciÃ³n MENOS la real.',
        showWheel:false
    },
    {
        id:'delta_t',
        keywords:['delta T','supply.*return','return.*supply','temperatura del supply'],
        title:'ðŸŒ¡ï¸ Delta T',
        formula:'Î”T = T.return âˆ’ T.supply',
        vars:'Normal: 15-20Â°F | Return = aire que entra | Supply = aire que sale',
        hint:'Â¡Delta T es la diferencia entre el aire que entra y el que sale!',
        showWheel:false
    },
    {
        id:'desbalance',
        keywords:['desbalance de voltaje','desbalance.*trifÃ¡sico','porcentaje.*desbalance'],
        title:'âš–ï¸ Desbalance de Voltaje',
        formula:'% = (Mayor desviaciÃ³n Ã· Promedio) Ã— 100',
        vars:'MÃ¡ximo aceptable: 2% segÃºn NEMA',
        hint:'Â¡Saca el promedio de los tres voltajes, y ve cuÃ¡nto se desvÃ­a el peor!',
        showWheel:false
    },
    {
        id:'breaker_motor',
        keywords:['breaker.*motor','NEC 430','250%','FLA.*breaker'],
        title:'ðŸ“– NEC 430.52 â€” Breaker de Motor',
        formula:'Breaker mÃ¡x = FLA Ã— 250%',
        vars:'FLA = Full Load Amps | Sube al siguiente tamaÃ±o estÃ¡ndar',
        hint:'Â¡Para motores, el breaker puede ser hasta 250% del FLA!',
        showWheel:false
    }
];

function detectFormula(q){
    const text=(tq(q,'q')+' '+tq(q,'e')).toLowerCase();
    for(const f of FORMULA_PATTERNS){
        for(const kw of f.keywords){
            try{
                if(new RegExp(kw,'i').test(text))return f;
            }catch(e){
                if(text.includes(kw.toLowerCase()))return f;
            }
        }
    }
    return null;
}

function showFormulaHelper(q){
    const formula=detectFormula(q);
    const helper=document.getElementById('qFormula');
    const wheel=document.getElementById('qPowerWheel');
    
    if(!formula){
        helper.classList.remove('show');
        return;
    }
    
    helper.classList.add('show');
    document.getElementById('qFormToggleText').textContent='ðŸ“ '+(D.lang==='es'?formula.hint:(formula.hint_en||formula.hint));
    document.getElementById('qFormTitle').textContent=formula.title;
    document.getElementById('qFormText').innerHTML=
        '<span class="formula-big">'+formula.formula+'</span>'+
        '<span class="formula-vars">'+formula.vars+'</span>';
    
    if(formula.showWheel){
        wheel.classList.add('show');
    }else{
        wheel.classList.remove('show');
    }
}

function toggleFormulaDetail(){
    const detail=document.getElementById('qFormDetail');
    const toggle=document.getElementById('qFormToggle');
    if(detail.style.display==='none'){
        detail.style.display='block';
        toggle.classList.add('open');
    }else{
        detail.style.display='none';
        toggle.classList.remove('open');
    }
}

function getFormulaHintBubble(q){
    const formula=detectFormula(q);
    if(!formula)return null;
    
    const hints_es=[
        'Â¡'+D.name+'! Para esta pregunta ocupa usar una fÃ³rmula. Â¿Necesitas ayuda? Â¡Toca la pista! ðŸ“',
        'Â¡Ojo, '+D.name+'! Esta pregunta requiere cÃ¡lculo. Te dejÃ© la fÃ³rmula abajo. Â¡TÃº puedes!',
        D.name+', recuerda que para resolver esta pregunta debes usar una fÃ³rmula. Â¡AhÃ­ te la dejÃ©!',
        'Â¡'+D.name+'! Esta es de cÃ¡lculo. No te asustes â€” te puse la herramienta abajo. Â¡Dale!',
        'Hey '+D.name+', esta necesita matemÃ¡ticas. Pero tranquilo, ahÃ­ abajo tienes todo lo que necesitas.',
    ];
    const hints_en=[
        D.name+'! This one needs a formula. Need help? Tap the hint! ðŸ“',
        'Watch out, '+D.name+'! This requires calculation. I left the formula below!',
        D.name+', remember you need a formula for this one. I got you covered below!',
    ];
    const list=D.lang==='es'?hints_es:hints_en;
    return list[Math.floor(Math.random()*list.length)];
}

// ========== MOTIVATIONAL QUOTES SYSTEM ==========
const MOTIVATION_QUOTES=[
    // 48 Laws of Power - Robert Greene
    {es:'"Nunca brilles mÃ¡s que tu maestro... hasta que lo superes."',en:'"Never outshine your master... until you surpass them."',author:'â€” 48 Laws of Power'},
    {es:'"Los que mÃ¡s saben, mÃ¡s practican en silencio."',en:'"Those who know most, practice in silence."',author:'â€” 48 Laws of Power'},
    {es:'"Domina el arte de la paciencia â€” todo maestro fue primero estudiante."',en:'"Master the art of patience â€” every master was first a student."',author:'â€” 48 Laws of Power'},
    {es:'"El Ã©xito no viene de lo que haces de vez en cuando, sino de lo que haces consistentemente."',en:'"Success doesn\'t come from what you do occasionally, but from what you do consistently."',author:'â€” 48 Laws of Power'},
    {es:'"Planea hasta el final: el tÃ©cnico que anticipa, domina."',en:'"Plan all the way to the end: the tech who anticipates, dominates."',author:'â€” 48 Laws of Power'},
    {es:'"Gana a travÃ©s de tus acciones, nunca a travÃ©s de argumentos."',en:'"Win through your actions, never through arguments."',author:'â€” 48 Laws of Power'},
    {es:'"La reputaciÃ³n es la piedra angular del poder â€” cuida tu trabajo."',en:'"Reputation is the cornerstone of power â€” take care of your work."',author:'â€” 48 Laws of Power'},
    // Art of War - Sun Tzu
    {es:'"El guerrero que se prepara, no le teme a la batalla."',en:'"The warrior who prepares does not fear the battle."',author:'â€” Sun Tzu'},
    {es:'"Conoce tu oficio y conoce tus herramientas, y en 100 diagnÃ³sticos no fallarÃ¡s."',en:'"Know your trade and know your tools, and in 100 diagnostics you will not fail."',author:'â€” Sun Tzu'},
    {es:'"La victoria pertenece al que se prepara mÃ¡s."',en:'"Victory belongs to the most prepared."',author:'â€” Sun Tzu'},
    {es:'"Un tÃ©cnico preparado no necesita suerte."',en:'"A prepared technician doesn\'t need luck."',author:'â€” Sun Tzu'},
    {es:'"El mejor diagnÃ³stico se hace antes de abrir la unidad."',en:'"The best diagnostic is done before opening the unit."',author:'â€” Sun Tzu'},
    // Napoleon Hill
    {es:'"Todo lo que la mente puede concebir y creer, lo puede lograr."',en:'"Whatever the mind can conceive and believe, it can achieve."',author:'â€” Napoleon Hill'},
    {es:'"El punto de partida de todo logro es el deseo."',en:'"The starting point of all achievement is desire."',author:'â€” Napoleon Hill'},
    {es:'"La paciencia, la persistencia y el sudor hacen una combinaciÃ³n imbatible."',en:'"Patience, persistence, and perspiration make an unbeatable combination."',author:'â€” Napoleon Hill'},
    {es:'"No esperes. El momento perfecto nunca llegarÃ¡. Empieza ahora."',en:'"Don\'t wait. The perfect moment will never come. Start now."',author:'â€” Napoleon Hill'},
    // Stephen Covey
    {es:'"Comienza con el fin en mente â€” Â¿quieres ser dueÃ±o o empleado?"',en:'"Begin with the end in mind â€” do you want to be an owner or an employee?"',author:'â€” Stephen Covey'},
    {es:'"Afila la sierra: cada hora que estudias vale mÃ¡s que 10 horas de trabajo sin preparaciÃ³n."',en:'"Sharpen the saw: every hour you study is worth more than 10 hours of unprepared work."',author:'â€” Stephen Covey'},
    {es:'"Primero lo primero: domina las bases y todo lo demÃ¡s caerÃ¡ en su lugar."',en:'"First things first: master the basics and everything else falls into place."',author:'â€” Stephen Covey'},
    // Kiyosaki
    {es:'"Los pobres trabajan por dinero. Los ricos hacen que el dinero trabaje para ellos."',en:'"The poor work for money. The rich make money work for them."',author:'â€” Robert Kiyosaki'},
    {es:'"Tu conocimiento es tu activo mÃ¡s valioso â€” invierte en Ã©l."',en:'"Your knowledge is your most valuable asset â€” invest in it."',author:'â€” Robert Kiyosaki'},
    // Maestro Mario
    {es:'"Si no mides, estÃ¡s adivinando." Â¡Nunca adivines, mide!',en:'"If you don\'t measure, you\'re guessing." Never guess, measure!',author:'â€” Maestro Mario'},
    {es:'"El tÃ©cnico que estudia hoy, cobra mÃ¡s maÃ±ana."',en:'"The technician who studies today earns more tomorrow."',author:'â€” Maestro Mario'},
    {es:'"Cada pregunta que fallas es una lecciÃ³n que ganas."',en:'"Every question you miss is a lesson you gain."',author:'â€” Maestro Mario'},
    {es:'"No hay tÃ©cnico malo, hay tÃ©cnico que no practica."',en:'"There\'s no bad technician, only one who doesn\'t practice."',author:'â€” Maestro Mario'},
    {es:'"Tu herramienta mÃ¡s poderosa es tu conocimiento, no tu llave."',en:'"Your most powerful tool is your knowledge, not your wrench."',author:'â€” Maestro Mario'},
    {es:'"Un tÃ©cnico sin certificaciÃ³n es como un doctor sin tÃ­tulo."',en:'"A technician without certification is like a doctor without a degree."',author:'â€” Maestro Mario'},
    {es:'"El que sabe diagnosticar, nunca se queda sin trabajo."',en:'"The one who knows how to diagnose never runs out of work."',author:'â€” Maestro Mario'},
    {es:'"Hoy estudias, maÃ±ana cobras. AsÃ­ de simple."',en:'"Study today, earn more tomorrow. Simple as that."',author:'â€” Maestro Mario'},
    {es:'"La diferencia entre un tÃ©cnico de $20/hr y uno de $50/hr es lo que sabe, no lo que hace."',en:'"The difference between a $20/hr and a $50/hr tech is what they know, not what they do."',author:'â€” Maestro Mario'},
    {es:'"Cada circuito que entiendes, cada fÃ³rmula que dominas, te acerca a tu libertad."',en:'"Every circuit you understand, every formula you master, brings you closer to freedom."',author:'â€” Maestro Mario'},
    {es:'"Los mejores tÃ©cnicos nunca dejan de aprender."',en:'"The best technicians never stop learning."',author:'â€” Maestro Mario'},
    {es:'"Tu competencia no estudia â€” tÃº sÃ­. Por eso vas a ganar."',en:'"Your competition isn\'t studying â€” you are. That\'s why you\'ll win."',author:'â€” Maestro Mario'},
    // Kobe Bryant
    {es:'"El trabajo duro supera al talento cuando el talento no trabaja duro."',en:'"Hard work beats talent when talent doesn\'t work hard."',author:'â€” Kobe Bryant'},
    {es:'"Yo no le tengo miedo al fracaso. Le tengo miedo a no intentarlo."',en:'"I don\'t fear failure. I fear not trying."',author:'â€” Kobe Bryant'},
    // Other
    {es:'"El Ã©xito es la suma de pequeÃ±os esfuerzos repetidos dÃ­a tras dÃ­a."',en:'"Success is the sum of small efforts repeated day after day."',author:'â€” Robert Collier'},
    {es:'"Disciplina es hacer lo que necesitas hacer, aunque no tengas ganas."',en:'"Discipline is doing what you need to do, even when you don\'t feel like it."',author:'â€” Anonymous'},
    {es:'"El experto en algo fue una vez un principiante."',en:'"The expert in anything was once a beginner."',author:'â€” Helen Hayes'},
    {es:'"No te compares con otros. CompÃ¡rate con quien eras ayer."',en:'"Don\'t compare yourself to others. Compare yourself to who you were yesterday."',author:'â€” Jordan Peterson'},
    {es:'"La consistencia es mÃ¡s importante que la perfecciÃ³n."',en:'"Consistency is more important than perfection."',author:'â€” Anonymous'},
];

let lastQuoteIdx=-1;

function showMotivation(qIdx){
    const bar=document.getElementById('qMotive');
    // Show motivation every 3 questions
    if(qIdx%3===0){
        let idx=Math.floor(Math.random()*MOTIVATION_QUOTES.length);
        while(idx===lastQuoteIdx&&MOTIVATION_QUOTES.length>1)idx=Math.floor(Math.random()*MOTIVATION_QUOTES.length);
        lastQuoteIdx=idx;
        const quote=MOTIVATION_QUOTES[idx];
        document.getElementById('qMotiveText').textContent=D.lang==='es'?quote.es:quote.en;
        document.getElementById('qMotiveAuthor').textContent=quote.author;
        bar.classList.add('show');
    }else{
        bar.classList.remove('show');
    }
}

function showQuestion(){
    if(quizIdx>=quizData.length){showResult();return;}
    const q=quizData[quizIdx];
    const alreadyAnswered=quizAnswers[quizIdx]>=0;
    quizAnswered=alreadyAnswered;
    const pct=Math.round((quizIdx/quizData.length)*100);
    document.getElementById('qBar').style.width=pct+'%';
    document.getElementById('qNum').textContent=(D.lang==='es'?'Pregunta ':'Question ')+(quizIdx+1)+' / '+quizData.length;
    document.getElementById('qPrev').textContent=D.lang==='es'?'â† Anterior':'â† Previous';
    document.getElementById('qCat').textContent=q.cat;
    
    // Show formula helper if question needs it
    showFormulaHelper(q);
    
    // Show motivational quote
    showMotivation(quizIdx);
    
    // Reset formula detail toggle
    const formDetail=document.getElementById('qFormDetail');
    if(formDetail)formDetail.style.display='none';
    const formToggle=document.getElementById('qFormToggle');
    if(formToggle)formToggle.classList.remove('open');
    
    // Back button
    const prevBtn=document.getElementById('qPrev');
    if(quizIdx>0){prevBtn.classList.add('show');}else{prevBtn.classList.remove('show');}
    
    if(alreadyAnswered){
        // Revisiting a question already answered
        const userAnswer=quizAnswers[quizIdx];
        const correct=userAnswer===q.c;
        document.getElementById('qBubble').textContent=correct?(D.lang==='es'?'âœ… Ya contestaste bien esta pregunta.':'âœ… You already got this right.'):(D.lang==='es'?'âŒ AquÃ­ fallaste. La correcta es la '+['A','B','C','D'][q.c]+'.':'âŒ You missed this one. Correct: '+['A','B','C','D'][q.c]+'.');
        document.getElementById('qText').textContent=tq(q,'q');
        const letters=['A','B','C','D'];
        document.getElementById('qOpts').innerHTML=tq(q,'o').map((o,i)=>{
            let cls='quiz-opt disabled';
            if(i===q.c)cls+=' correct';
            if(i===userAnswer&&!correct)cls+=' wrong';
            return '<div class="'+cls+'"><div class="quiz-letter">'+letters[i]+'</div><div>'+o+'</div></div>';
        }).join('');
        document.getElementById('qExplain').innerHTML=correct?('<b>'+(D.lang==='es'?'ExplicaciÃ³n:':'Explanation:')+'</b> '+tq(q,'e')):('<b style="color:#ff6b2b">'+(D.lang==='es'?'ðŸ“– Con peras y manzanas:':'ðŸ“– Simply put:')+'</b><br>'+tq(q,'a')+'<br><br><b>'+(D.lang==='es'?'TÃ©cnico:':'Technical:')+'</b> '+tq(q,'e'));
        document.getElementById('qExplain').classList.add('show');
        const nextBtn=document.getElementById('qNext');
        nextBtn.textContent=(quizIdx<quizData.length-1)?(D.lang==='es'?'Siguiente â†’':'Next â†’'):(D.lang==='es'?'Ver Resultado ðŸ†':'See Result ðŸ†');
        nextBtn.classList.add('show');
    }else{
        // New unanswered question
        const formulaHint=getFormulaHintBubble(q);
        if(formulaHint){
            document.getElementById('qBubble').textContent=formulaHint;
        }else{
            document.getElementById('qBubble').textContent=quizIdx===0?(D.lang==='es'?'Â¡Dale, tÃº puedes!':'You got this!'):(D.lang==='es'?'Â¿QuÃ© piensas, '+D.name+'?':'What do you think, '+D.name+'?');
        }
        document.getElementById('qText').textContent=tq(q,'q');
        document.getElementById('qExplain').classList.remove('show');
        document.getElementById('qNext').classList.remove('show');
        const letters=['A','B','C','D'];
        document.getElementById('qOpts').innerHTML=tq(q,'o').map((o,i)=>'<div class="quiz-opt" onclick="answerQuiz('+i+',this)"><div class="quiz-letter">'+letters[i]+'</div><div>'+o+'</div></div>').join('');
    }
    window.scrollTo(0,0);
}

let quizStreak=0;

const CHEERS_ES=[
    ['Â¡Correcto!','Â¡Bien hecho!','Â¡AsÃ­ se hace!','Â¡Muy bien, '+'{name}'+'!','Â¡Buena elecciÃ³n!','Â¡Exacto!','Â¡Le atinaste!'],
    ['Â¡Chaka, '+'{name}'+'!','Â¡Excelente!','Â¡Wow, quÃ© bÃ¡rbaro!','Â¡PerrÃ­simo!','Â¡Bravo, '+'{name}'+'!','Â¡Me sorprendes!','Â¡Ã“rale, asÃ­ mero!'],
    ['Â¡Ufff quÃ© bÃ¡rbaro, '+'{name}'+'!','Â¡Espectacular!','Â¡EstÃ¡s que ardes!','Â¡QuÃ© mÃ¡quina eres!','Â¡Nadie te para!','Â¡Crack total!'],
    ['ðŸ”¥ Â¡ESTÃS IMPARABLE, '+'{name}'+'! ðŸ”¥','âš¡ Â¡WOW, NO TE PARA NADIE! âš¡','ðŸ’ª Â¡PERRÃSIMO, ERES UNA BESTIA! ðŸ’ª','ðŸ† Â¡VAS CON TODO, CAMPEÃ“N! ðŸ†','ðŸŒŸ Â¡ME SORPRENDES, QUÃ‰ NIVEL! ðŸŒŸ','ðŸ’¥ Â¡CHAKA! Â¡ERES IMPARABLE! ðŸ’¥']
];
const CHEERS_EN=[
    ['Correct!','Well done!','Nice job!','Good pick, '+'{name}'+'!','That\'s right!','Nailed it!','Spot on!'],
    ['Perfect!','Excellent!','Brilliant!','Amazing!','Great work, '+'{name}'+'!','Killing it!','Impressive!'],
    ['Spectacular!','You\'re on fire!','Incredible, '+'{name}'+'!','Crushing it!','Nobody stops you!','Total beast mode!'],
    ['ðŸ”¥ UNSTOPPABLE, '+'{name}'+'! ðŸ”¥','âš¡ NOBODY STOPS YOU! âš¡','ðŸ’ª YOU ARE A BEAST! ðŸ’ª','ðŸ† ALL THE WAY, CHAMP! ðŸ†','ðŸŒŸ WHAT A LEVEL! ðŸŒŸ','ðŸ’¥ INCREDIBLE RUN! ðŸ’¥']
];
const MISS_ES=[
    'Â¡No te preocupes, {name}! Todos fallamos al principio. AsÃ­ se aprende, echÃ¡ndole ganas.',
    'Â¡Ey {name}, tranquilo! Los mejores tÃ©cnicos tambiÃ©n empezaron equivocÃ¡ndose. Â¡TÃº puedes!',
    'Â¡{name}, ya eres {ganador} solo por intentarlo! No te desanimes, vamos {campeon}.',
    'Â¡Ã“rale {name}, casi le atinas! Eres una estrella en entrenamiento. Mira la explicaciÃ³n.',
    'Â¡{name}, no pasa nada! Hasta Mario se equivocaba al principio. Lo importante es aprender.',
    'Â¡Ãnimo {name}! Cada error te acerca mÃ¡s a ser un crack del HVAC. Â¡TÃº puedes con esto!',
    'Â¡Hey {name}! Esta estaba difÃ­cil. Pero tÃº eres {chingon}, vas a dominar este tema.',
    'Â¡{name}, respira! Los grandes se hacen a base de prÃ¡ctica. Mira la explicaciÃ³n y vas a ver quÃ© fÃ¡cil es.'
];
const MISS_EN=[
    'Don\'t worry {name}! Everyone struggles at first. That\'s how you learn!',
    'Hey {name}, take it easy! The best techs started by making mistakes too. You got this!',
    '{name}, you\'re already a winner just for trying! Don\'t give up, champ.',
    'Almost {name}! You\'re a star in training. Check out the explanation.',
    '{name}, no big deal! Even Mario made mistakes starting out. What matters is learning.',
    'Keep going {name}! Every mistake brings you closer to being an HVAC pro!',
    'Hey {name}! That was a tough one. But you\'re awesome, you\'ll master this.',
    '{name}, take a breath! Greatness comes from practice. Check the explanation and you\'ll get it.'
];

function pickCheer(streak){
    const cheers=D.lang==='es'?CHEERS_ES:CHEERS_EN;
    let tier=0;
    if(streak>=8)tier=3;
    else if(streak>=5)tier=2;
    else if(streak>=3)tier=1;
    const list=cheers[tier];
    return list[Math.floor(Math.random()*list.length)].replace('{name}',D.name);
}

function pickMiss(){
    const list=D.lang==='es'?MISS_ES:MISS_EN;
    let msg=list[Math.floor(Math.random()*list.length)].replace(/\{name\}/g,D.name);
    msg=msg.replace(/\{campeon\}/g,gn('campeÃ³n','campeona')).replace(/\{ganador\}/g,gn('ganador','ganadora')).replace(/\{chingon\}/g,gn('chingÃ³n','chingona'));
    const letter=' '+(D.lang==='es'?'La correcta es la ':'Correct answer is ')+['A','B','C','D'][quizData[quizIdx].c]+'.';
    return msg+letter;
}

function celebrate(streak){
    const el=document.getElementById('s8');
    // Vibrate phone
    if(navigator.vibrate){
        if(streak>=5)navigator.vibrate([100,50,100,50,200]);
        else navigator.vibrate(80);
    }
    // Screen shake
    if(streak>=5){
        el.classList.add('big-shake');
        setTimeout(()=>el.classList.remove('big-shake'),600);
    }else if(streak>=2){
        el.classList.add('shake');
        setTimeout(()=>el.classList.remove('shake'),400);
    }
    // Lightning flash at 5+ streak
    if(streak>=5){
        const flash=document.createElement('div');
        flash.className='lightning-flash';
        document.body.appendChild(flash);
        setTimeout(()=>flash.remove(),400);
    }
    // Fire emojis at 3+ streak (reduced for performance)
    if(streak>=3){
        const emojis=streak>=8?['ðŸ”¥','âš¡','ðŸ’¥','ðŸŒŸ']:streak>=5?['ðŸ”¥','âš¡','ðŸ’¥']:['ðŸ”¥','âœ¨'];
        const count=streak>=8?6:streak>=5?4:2;
        for(let i=0;i<count;i++){
            setTimeout(()=>{
                const fire=document.createElement('div');
                fire.className='fire-emoji';
                fire.textContent=emojis[Math.floor(Math.random()*emojis.length)];
                fire.style.left=Math.random()*80+10+'%';
                fire.style.bottom='10%';
                document.body.appendChild(fire);
                setTimeout(()=>fire.remove(),1200);
            },i*150);
        }
    }
    // Streak badge at 5+ 
    if(streak>=5){
        const badge=document.createElement('div');
        badge.className='streak-badge';
        badge.textContent=streak>=10?'ðŸ† '+streak+'x COMBO! ðŸ†':streak>=8?'âš¡ '+streak+'x RACHA! âš¡':'ðŸ”¥ '+streak+'x STREAK! ðŸ”¥';
        document.body.appendChild(badge);
        setTimeout(()=>badge.remove(),1500);
    }
    // Confetti at 5+
    if(streak>=5)cft();
}

function answerQuiz(idx,el){
    if(quizAnswered)return;
    quizAnswered=true;
    quizAnswers[quizIdx]=idx;
    const q=quizData[quizIdx];
    const correct=idx===q.c;
    const opts=document.querySelectorAll('.quiz-opt');
    
    opts.forEach((o,i)=>{
        if(i===q.c)o.classList.add('correct');
        if(i===idx&&!correct)o.classList.add('wrong');
        if(i!==q.c&&i!==idx)o.classList.add('disabled');
    });
    
    if(correct){
        quizRight++;
        quizStreak++;
        if(quizStreak>bestStreak)bestStreak=quizStreak;
        document.getElementById('qRight').textContent=quizRight;
        let cheer=pickCheer(quizStreak);
        // === MILESTONE MESSAGES based on progress ===
        const progressPct=Math.round(((quizIdx+1)/quizData.length)*100);
        if(progressPct>=90&&progressPct<95){
            cheer=D.lang==='es'?'ðŸŽ¯ Â¡ConcentraciÃ³n total, '+D.name+'! Â¡Ya lo tienes, '+gn('campeÃ³n','campeona')+'!':'ðŸŽ¯ Total focus, '+D.name+'! You almost got it, champ!';
        }else if(progressPct>=70&&progressPct<75){
            cheer=D.lang==='es'?'ðŸ‘‘ Â¡Ya puedes saborear la victoria, '+D.name+'! Â¡No aflojes!':'ðŸ‘‘ You can taste victory, '+D.name+'! Don\'t let up!';
        }else if(progressPct>=48&&progressPct<52){
            cheer=D.lang==='es'?'ðŸ… Â¡Ya casi llegas a la mitad! Â¡Esa medalla se acerca, '+D.name+'!':'ðŸ… Almost halfway there! That medal is getting closer, '+D.name+'!';
        }
        document.getElementById('qBubble').textContent=cheer;
        celebrate(quizStreak);
        document.getElementById('qExplain').innerHTML='<b>'+(D.lang==='es'?'ExplicaciÃ³n:':'Explanation:')+'</b> '+tq(q,'e');
        speakText(cheer+' '+tq(q,'e'));
        // Track correct in study tracker (reduce fail count)
        trackAnswer(q,true);
    }else{
        quizWrong++;
        quizStreak=0;
        document.getElementById('qWrong').textContent=quizWrong;
        const motivation=pickMiss();
        const bubble=document.getElementById('qBubble');
        bubble.textContent=motivation;
        // After 4 seconds, update bubble with the simple analogy
        setTimeout(()=>{
            bubble.innerHTML='<span style="color:#ff6b2b">ðŸ“–</span> '+tq(q,'a');
        },4000);
        // Show deep explanation with analogy
        let explain='<b style="color:#ff6b2b">'+(D.lang==='es'?'ðŸ“– Te lo explico con peras y manzanas:':'ðŸ“– Let me break it down simply:')+'</b><br>'+tq(q,'a')+'<br><br><b>'+(D.lang==='es'?'ExplicaciÃ³n tÃ©cnica:':'Technical explanation:')+'</b> '+tq(q,'e');
        document.getElementById('qExplain').innerHTML=explain;
        // Mario speaks EVERYTHING: motivation + analogy + technical explanation
        speakText(motivation+' '+(D.lang==='es'?'Te lo explico fÃ¡cil: ':'Let me explain simply: ')+tq(q,'a')+' '+(D.lang==='es'?'En tÃ©rminos tÃ©cnicos: ':'Technically speaking: ')+tq(q,'e'));
        // Track wrong in study tracker
        trackAnswer(q,false);
    }
    
    document.getElementById('qExplain').classList.add('show');
    document.getElementById('qNext').textContent=(quizIdx<quizData.length-1)?(D.lang==='es'?'Siguiente â†’':'Next â†’'):(D.lang==='es'?'Ver Resultado ðŸ†':'See Result ðŸ†');
    document.getElementById('qNext').classList.add('show');
}

function nextQuestion(){
    stopSpeech();
    quizIdx++;
    showQuestion();
}

function prevQuestion(){
    stopSpeech();
    if(quizIdx>0){quizIdx--;showQuestion();}
}

function showResult(){
    go('s9');
    const pct=Math.round((quizRight/quizData.length)*100);
    document.getElementById('rScore').textContent=pct+'%';
    document.getElementById('rLabel').textContent=quizRight+' / '+quizData.length+(D.lang==='es'?' correctas':' correct');
    
    // Award XP: 10 per correct, bonus for streaks
    const xpEarned=quizRight*10+(bestStreak>=10?50:bestStreak>=5?25:0);
    profile.xp+=xpEarned;
    profile.totalCorrect+=quizRight;
    profile.totalAnswered+=quizData.length;
    profile.quizzesTaken++;
    if(bestStreak>profile.bestStreak)profile.bestStreak=bestStreak;
    
    // Level up check
    while(profile.xp>=profile.xpNeeded){
        profile.xp-=profile.xpNeeded;
        profile.level++;
        profile.xpNeeded=Math.floor(profile.xpNeeded*1.4);
    }
    
    let medal,msg,stars;
    const medalEarned=document.getElementById('rMedalEarned');
    medalEarned.style.display='none';
    
    if(pct===100){
        medal='ðŸ†';stars=5;
        msg=D.lang==='es'?'Â¡Â¡PERFECTO, '+D.name+'!! 100% sin fallar. Â¡Eres leyenda! Te ganaste tu medalla de Bronce ðŸ¥‰':'PERFECT, '+D.name+'!! 100% flawless. You earned your Bronze Medal ðŸ¥‰';
        if(!profile.medals.includes('bronze_principiante')){
            profile.medals.push('bronze_principiante');
            medalEarned.style.display='block';
            document.getElementById('rNewMedal').textContent='ðŸ¥‰';
            document.getElementById('rMedalName').textContent=D.lang==='es'?'Â¡MEDALLA DE BRONCE DESBLOQUEADA!\nPrincipiante Perfecto':'BRONZE MEDAL UNLOCKED!\nPerfect Beginner';
        }
    }else if(pct>=90){
        medal='ðŸ†';stars=5;
        msg=D.lang==='es'?'Â¡IncreÃ­ble, '+D.name+'! Casi perfecto. El Maestro Mario estÃ¡ orgulloso. Â¡Intenta el 100% para tu medalla!':'Incredible, '+D.name+'! Almost perfect. Try for 100% to earn your medal!';
    }else if(pct>=80){
        medal='ðŸ¥‡';stars=4;
        msg=D.lang==='es'?'Â¡Excelente, '+D.name+'! Tienes muy buena base. Repasa lo que fallaste y ve por el 100%.':'Excellent, '+D.name+'! Great foundation. Review mistakes and go for 100%!';
    }else if(pct>=70){
        medal='ðŸ¥ˆ';stars=3;
        msg=D.lang==='es'?'Â¡Bien, '+D.name+'! Vas por buen camino. No te rindas, cada error es una lecciÃ³n.':'Good job, '+D.name+'! On the right track. Every mistake is a lesson.';
    }else if(pct>=60){
        medal='ðŸ¥‰';stars=2;
        msg=D.lang==='es'?'Â¡No te desanimes, '+D.name+'! Ya eres ganador por intentarlo. Repasa y vuelve mÃ¡s fuerte.':'Don\'t get discouraged, '+D.name+'! You\'re a winner for trying. Review and come back stronger.';
    }else{
        medal='ðŸ’ª';stars=1;
        msg=D.lang==='es'?'Â¡'+D.name+', vamos '+gn('campeÃ³n','campeona')+'! Todos fallamos al principio. TÃº puedes, eres una estrella. Â¡Estudia y regresa con todo!':D.name+', let\'s go champ! Everyone struggles at first. You\'re a star. Study and come back strong!';
    }
    
    document.getElementById('rMedal').textContent=medal;
    document.getElementById('rMsg').textContent=msg;
    
    const starEls=document.querySelectorAll('#rStars span');
    starEls.forEach((s,i)=>{s.classList.remove('lit');});
    starEls.forEach((s,i)=>{
        setTimeout(()=>{if(i<stars)s.classList.add('lit');},i*300);
    });
    
    saveProfile();
    
    // Save best quiz score
    const scores=JSON.parse(localStorage.getItem('maestro_quiz_scores')||'{}');
    if(!scores[currentQuizId]||pct>scores[currentQuizId])scores[currentQuizId]=pct;
    localStorage.setItem('maestro_quiz_scores',JSON.stringify(scores));
    
    // === SYNC TO SUPABASE ===
    syncV2Profile();
    syncV2QuizAttempt(currentQuizId, quizData.length, quizRight, quizWrong, pct, null);
    
    // Electricity-specific medal
    if(currentQuizId==='electricidad'&&pct===100&&!profile.medals.includes('bronze_electricidad')){
        profile.medals.push('bronze_electricidad');
        medalEarned.style.display='block';
        document.getElementById('rNewMedal').textContent='âš¡';
        document.getElementById('rMedalName').textContent='Â¡MEDALLA ELÃ‰CTRICA DESBLOQUEADA!\nMaestro de Electricidad';
        saveProfile();
    }
    // Refrigeration medal
    if(currentQuizId==='refrigeracion'&&pct===100&&!profile.medals.includes('bronze_refrigeracion')){
        profile.medals.push('bronze_refrigeracion');
        medalEarned.style.display='block';
        document.getElementById('rNewMedal').textContent='â„ï¸';
        document.getElementById('rMedalName').textContent='Â¡MEDALLA DE REFRIGERACIÃ“N DESBLOQUEADA!\nMaestro de RefrigeraciÃ³n';
        saveProfile();
    }
    
    // Enhanced celebration based on score
    if(pct>=90){
        // EPIC celebration - confetti + video + fanfare
        cft();
        setTimeout(()=>cft(),800);
        setTimeout(()=>cft(),1600);
        showVideo('medalla',()=>{});
    }else if(pct>=70){
        cft();
        setTimeout(()=>cft(),1000);
    }else{
        cft();
    }
    speakText(msg);
    
    // Update retry button to show failed count
    const failedCount=quizData.length-quizRight;
    const retryBtn=document.querySelector('#s9 .bt[onclick="retryQuiz()"]');
    if(retryBtn){
        if(failedCount>0&&pct<100){
            retryBtn.textContent=D.lang==='es'?'ðŸ”„ Repasar las '+failedCount+' que fallÃ©':'ðŸ”„ Review the '+failedCount+' I missed';
            retryBtn.style.display='block';
        }else{
            retryBtn.textContent=D.lang==='es'?'ðŸ”„ Â¡Perfecto! Intentar de Nuevo':'ðŸ”„ Perfect! Try Again';
        }
    }
    
    // Show study zone redirect if score < 100%
    const studyRedirect=document.getElementById('rStudyRedirect');
    const wrongCount=getStudyQuestions().length;
    if(pct<100&&wrongCount>0){
        studyRedirect.style.display='block';
        document.getElementById('rStudyDesc').textContent=D.lang==='es'?
            'Tienes '+wrongCount+' preguntas que necesitas reforzar. Ve a la Zona de Repaso para dominarlas.':
            'You have '+wrongCount+' questions to review. Go to the Review Zone to master them.';
    // Update redirect button text
    const redirectTitle=document.querySelector('#rStudyRedirect .study-redirect-title');
    if(redirectTitle)redirectTitle.textContent=D.lang==='es'?'Â¡El Maestro Mario te recomienda repasar!':'Maestro Mario recommends you review!';
    }else{
        studyRedirect.style.display='none';
    }
}

// ========== PROFILE & MEDAL SYSTEM ==========
const MEDALS_DEF=[
    {id:'bronze_principiante',icon:'ðŸ¥‰',name:'Bronce Principiante',name_en:'Bronze Beginner',desc:'100% en quiz principiante',desc_en:'100% on beginner quiz'},
    {id:'silver_principiante',icon:'ðŸ¥ˆ',name:'Plata Principiante',name_en:'Silver Beginner',desc:'100% dos veces seguidas',desc_en:'100% twice in a row'},
    {id:'gold_principiante',icon:'ðŸ¥‡',name:'Oro Principiante',name_en:'Gold Beginner',desc:'100% tres veces seguidas',desc_en:'100% three times in a row'},
    {id:'bronze_electricidad',icon:'âš¡',name:'Maestro ElÃ©ctrico',name_en:'Electrical Master',desc:'100% en quiz de electricidad',desc_en:'100% on electrical quiz'},
    {id:'bronze_refrigeracion',icon:'â„ï¸',name:'Maestro RefrigeraciÃ³n',name_en:'Refrigeration Master',desc:'100% en quiz de refrigeraciÃ³n',desc_en:'100% on refrigeration quiz'},
    {id:'streak_5',icon:'ðŸ”¥',name:'En Llamas',name_en:'On Fire',desc:'Racha de 5 correctas',desc_en:'Streak of 5 correct'},
    {id:'streak_10',icon:'âš¡',name:'Imparable',name_en:'Unstoppable',desc:'Racha de 10 correctas',desc_en:'Streak of 10 correct'},
    {id:'streak_20',icon:'ðŸ’¥',name:'Leyenda',name_en:'Legend',desc:'Racha de 20 correctas',desc_en:'Streak of 20 correct'},
    {id:'quiz_5',icon:'ðŸ“',name:'Estudiante',name_en:'Student',desc:'Completar 5 quizzes',desc_en:'Complete 5 quizzes'},
    {id:'quiz_15',icon:'ðŸ“š',name:'Estudioso',name_en:'Scholar',desc:'Completar 15 quizzes',desc_en:'Complete 15 quizzes'},
    {id:'correct_100',icon:'ðŸ’¯',name:'CenturiÃ³n',name_en:'Centurion',desc:'100 respuestas correctas',desc_en:'100 correct answers'},
    {id:'correct_500',icon:'ðŸŒŸ',name:'Maestro en Entrenamiento',name_en:'Master in Training',desc:'500 respuestas correctas',desc_en:'500 correct answers'},
    {id:'level_5',icon:'â­',name:'Nivel 5',name_en:'Level 5',desc:'Alcanzar nivel 5',desc_en:'Reach level 5'},
    {id:'level_10',icon:'ðŸ‘‘',name:'Nivel 10',name_en:'Level 10',desc:'Alcanzar nivel 10',desc_en:'Reach level 10'}
];

const LEVEL_TITLES_ES={
    1:'Aprendiz Novato',2:'Aprendiz',3:'Ayudante',4:'TÃ©cnico Jr.',5:'TÃ©cnico',
    6:'TÃ©cnico Senior',7:'Especialista',8:'Experto',9:'Maestro',10:'Gran Maestro',};
const LEVEL_TITLES_EN={
    1:'Rookie Apprentice',2:'Apprentice',3:'Helper',4:'Jr. Technician',5:'Technician',
    6:'Senior Technician',7:'Specialist',8:'Expert',9:'Master',10:'Grand Master',};
function getLevelTitle(lvl){return D.lang==='es'?(LEVEL_TITLES_ES[lvl]||'Leyenda'):(LEVEL_TITLES_EN[lvl]||'Legend');}
const LEVEL_TITLES={
    1:'Aprendiz Novato',2:'Aprendiz',3:'Ayudante',4:'TÃ©cnico Jr.',5:'TÃ©cnico',
    6:'TÃ©cnico Senior',7:'Especialista',8:'Experto',9:'Maestro',10:'Gran Maestro',
    11:'Leyenda HVAC',12:'Maestro Supremo',15:'Dios del HVAC'
};

let profile={level:1,xp:0,xpNeeded:100,totalCorrect:0,totalAnswered:0,quizzesTaken:0,bestStreak:0,medals:[],perfectStreakCount:0,avatar:'novato'};
let bestStreak=0;

const AVATARS=[
    // === STARTER (always available) ===
    {id:'novato',icon:'ðŸ‘¤',name:'Novato',cat:'starter',unlock:'always'},
    {id:'aprendiz',icon:'ðŸ§‘â€ðŸ”§',name:'Aprendiz',cat:'starter',unlock:'always'},
    {id:'casco',icon:'ðŸ‘·',name:'Casco Duro',cat:'starter',unlock:'always'},
    {id:'tools',icon:'ðŸ”§',name:'Herramientas',cat:'starter',unlock:'always'},
    
    // === ELECTRICIDAD (unlock with electricity mastery) ===
    {id:'voltimetro',icon:'âš¡',name:'VoltÃ­metro',cat:'electric',unlock:'quiz',quizId:'electricidad',minPct:50,desc:'50% en Electricidad'},
    {id:'multimetro',icon:'ðŸ”¬',name:'MultÃ­metro',cat:'electric',unlock:'quiz',quizId:'electricidad',minPct:70,desc:'70% en Electricidad'},
    {id:'megger',icon:'ðŸ’¡',name:'Megger Pro',cat:'electric',unlock:'quiz',quizId:'electricidad',minPct:90,desc:'90% en Electricidad'},
    {id:'maestro_elec',icon:'ðŸ—²',name:'Maestro ElÃ©ctrico',cat:'electric',unlock:'quiz',quizId:'electricidad',minPct:100,desc:'100% en Electricidad'},
    
    // === REFRIGERACIÃ“N (unlock with refrigeration mastery) ===
    {id:'manifold',icon:'ðŸ§Š',name:'Manifold Gauges',cat:'refrig',unlock:'quiz',quizId:'refrigeracion',minPct:50,desc:'50% en RefrigeraciÃ³n'},
    {id:'txv',icon:'â„ï¸',name:'VÃ¡lvula TXV',cat:'refrig',unlock:'quiz',quizId:'refrigeracion',minPct:70,desc:'70% en RefrigeraciÃ³n'},
    {id:'recovery',icon:'ðŸ”µ',name:'Recovery Machine',cat:'refrig',unlock:'quiz',quizId:'refrigeracion',minPct:90,desc:'90% en RefrigeraciÃ³n'},
    {id:'maestro_ref',icon:'â˜ƒï¸',name:'Maestro Refrig.',cat:'refrig',unlock:'quiz',quizId:'refrigeracion',minPct:100,desc:'100% en RefrigeraciÃ³n'},
    
    // === AIRE ACONDICIONADO (unlock with AC mastery) ===
    {id:'anemometer',icon:'ðŸŒ€',name:'AnemÃ³metro',cat:'ac',unlock:'quiz',quizId:'ac_residencial',minPct:50,desc:'50% en AC Resid.'},
    {id:'thermostat',icon:'ðŸŒ¡ï¸',name:'Termostato',cat:'ac',unlock:'quiz',quizId:'ac_residencial',minPct:70,desc:'70% en AC Resid.'},
    {id:'minisplit',icon:'ðŸ§Š',name:'Mini Split Pro',cat:'ac',unlock:'quiz',quizId:'ac_comercial',minPct:70,desc:'70% en AC Comerc.'},
    {id:'maestro_ac',icon:'ðŸ”ï¸',name:'Maestro AC',cat:'ac',unlock:'quiz',quizId:'ac_residencial',minPct:100,desc:'100% en AC'},
    
    // === POR NIVEL (unlock with level progression) ===
    {id:'pinzas',icon:'ðŸ”©',name:'Pinzas',cat:'level',unlock:'level',minLevel:2,desc:'Nivel 2'},
    {id:'desarmador',icon:'ðŸª›',name:'Desarmador',cat:'level',unlock:'level',minLevel:3,desc:'Nivel 3'},
    {id:'drill',icon:'ðŸ”¨',name:'Taladro',cat:'level',unlock:'level',minLevel:5,desc:'Nivel 5'},
    {id:'soldadura',icon:'ðŸ”¥',name:'Soplete',cat:'level',unlock:'level',minLevel:7,desc:'Nivel 7'},
    {id:'experto',icon:'â­',name:'Experto',cat:'level',unlock:'level',minLevel:10,desc:'Nivel 10'},
    {id:'birrete',icon:'ðŸŽ“',name:'Graduado',cat:'level',unlock:'level',minLevel:12,desc:'Nivel 12'},
    {id:'corona',icon:'ðŸ‘‘',name:'Rey del HVAC',cat:'level',unlock:'level',minLevel:15,desc:'Nivel 15'},
    
    // === POR LOGROS (unlock with stats) ===
    {id:'racha5',icon:'ðŸ”¥',name:'En Llamas',cat:'achieve',unlock:'streak',minStreak:5,desc:'Racha de 5'},
    {id:'racha10',icon:'ðŸ’¥',name:'Imparable',cat:'achieve',unlock:'streak',minStreak:10,desc:'Racha de 10'},
    {id:'cent',icon:'ðŸ’¯',name:'Centenario',cat:'achieve',unlock:'correct',minCorrect:100,desc:'100 correctas'},
    {id:'quinientos',icon:'ðŸŒŸ',name:'500 Club',cat:'achieve',unlock:'correct',minCorrect:500,desc:'500 correctas'},
    {id:'triple',icon:'ðŸ†',name:'Triple Amenaza',cat:'achieve',unlock:'triple',desc:'Dominar Elec+Refrig+AC'},
    {id:'leyenda',icon:'ðŸ’Ž',name:'Leyenda HVAC',cat:'achieve',unlock:'correct',minCorrect:1000,desc:'1000 correctas'}
];

function isAvatarUnlocked(av){
    if(av.unlock==='always')return true;
    const scores=JSON.parse(localStorage.getItem('maestro_quiz_scores')||'{}');
    
    if(av.unlock==='quiz'){
        const score=scores[av.quizId]||0;
        return score>=av.minPct;
    }
    if(av.unlock==='level'){
        return profile.level>=av.minLevel;
    }
    if(av.unlock==='streak'){
        return profile.bestStreak>=av.minStreak;
    }
    if(av.unlock==='correct'){
        return profile.totalCorrect>=av.minCorrect;
    }
    if(av.unlock==='triple'){
        // Must have â‰¥80% in electricidad AND refrigeracion AND ac_residencial
        return (scores['electricidad']||0)>=80 && (scores['refrigeracion']||0)>=80 && (scores['ac_residencial']||0)>=80;
    }
    return false;
}

function toggleAvatarPicker(){
    const picker=document.getElementById('avatarPicker');
    picker.classList.toggle('open');
    if(picker.classList.contains('open')){
        renderAvatarGrid();
    }
}

function renderAvatarGrid(){
    const grid=document.getElementById('avatarGrid');
    
    const sections=[
        {key:'starter',title:'ðŸ”§ Disponibles',avatars:AVATARS.filter(a=>a.cat==='starter')},
        {key:'electric',title:'âš¡ Electricidad',avatars:AVATARS.filter(a=>a.cat==='electric')},
        {key:'refrig',title:'â„ï¸ RefrigeraciÃ³n',avatars:AVATARS.filter(a=>a.cat==='refrig')},
        {key:'ac',title:'ðŸŒ€ Aire Acondicionado',avatars:AVATARS.filter(a=>a.cat==='ac')},
        {key:'level',title:'ðŸ“ˆ Por Nivel',avatars:AVATARS.filter(a=>a.cat==='level')},
        {key:'achieve',title:'ðŸ† Logros',avatars:AVATARS.filter(a=>a.cat==='achieve')}
    ];
    
    let html='';
    sections.forEach(sec=>{
        const unlockedCount=sec.avatars.filter(a=>isAvatarUnlocked(a)).length;
        html+='<div class="avatar-section">';
        html+='<div class="avatar-section-title">'+sec.title+' <span style="color:var(--electric);font-size:10px">('+unlockedCount+'/'+sec.avatars.length+')</span></div>';
        html+='<div class="avatar-grid">';
        sec.avatars.forEach(av=>{
            const unlocked=isAvatarUnlocked(av);
            const selected=profile.avatar===av.id;
            const cls='avatar-option'+(selected?' selected':'')+(unlocked?'':' locked');
            if(unlocked){
                html+='<div class="'+cls+'" onclick="selectAvatar(\''+av.id+'\')">';
                html+='<div class="av-icon">'+av.icon+'</div>';
                html+='<div class="av-name">'+av.name+'</div>';
                html+='</div>';
            }else{
                html+='<div class="'+cls+'" onclick="showAvatarLockMsg(\''+av.desc.replace(/'/g,"\\'")+'\')" title="'+av.desc+'">';
                html+='<div class="av-icon">ðŸ”’</div>';
                html+='<div class="av-name">'+av.name+'</div>';
                html+='<div class="av-lock">'+av.desc+'</div>';
                html+='</div>';
            }
        });
        html+='</div></div>';
    });
    
    grid.innerHTML=html;
}

function showAvatarLockMsg(desc){
    const bubble=document.getElementById('studyBubble')||document.getElementById('hubBubble');
    // Simple alert for now
    const msg=D.lang==='es'?'ðŸ”’ Para desbloquear este avatar necesitas: '+desc:'ðŸ”’ To unlock this avatar you need: '+desc;
    alert(msg);
}

function selectAvatar(avatarId){
    const av=AVATARS.find(a=>a.id===avatarId);
    if(!av||!isAvatarUnlocked(av))return;
    profile.avatar=avatarId;
    saveProfile();
    const icon=av.icon;
    document.getElementById('profAvatar').innerHTML=icon+'<div class="prof-avatar-edit">âœï¸</div>';
    document.getElementById('profileBtn').textContent=icon;
    document.getElementById('avatarPicker').classList.remove('open');
    renderAvatarGrid();
}

function getAvatarIcon(avatarId){
    const av=AVATARS.find(a=>a.id===avatarId);
    return av?av.icon:'ðŸ‘¤';
}

function getTitle(lvl){
    let title='Aprendiz';
    for(let l of Object.keys(LEVEL_TITLES).map(Number).sort((a,b)=>b-a)){
        if(lvl>=l){title=LEVEL_TITLES[l];break;}
    }
    return title;
}

function checkAutoMedals(){
    if(bestStreak>=5&&!profile.medals.includes('streak_5'))profile.medals.push('streak_5');
    if(bestStreak>=10&&!profile.medals.includes('streak_10'))profile.medals.push('streak_10');
    if(bestStreak>=20&&!profile.medals.includes('streak_20'))profile.medals.push('streak_20');
    if(profile.quizzesTaken>=5&&!profile.medals.includes('quiz_5'))profile.medals.push('quiz_5');
    if(profile.quizzesTaken>=15&&!profile.medals.includes('quiz_15'))profile.medals.push('quiz_15');
    if(profile.totalCorrect>=100&&!profile.medals.includes('correct_100'))profile.medals.push('correct_100');
    if(profile.totalCorrect>=500&&!profile.medals.includes('correct_500'))profile.medals.push('correct_500');
    if(profile.level>=5&&!profile.medals.includes('level_5'))profile.medals.push('level_5');
    if(profile.level>=10&&!profile.medals.includes('level_10'))profile.medals.push('level_10');
}

function saveProfile(){
    checkAutoMedals();
    try{localStorage.setItem('maestro_profile',JSON.stringify(profile));}catch(e){}
}

function loadProfile(){
    try{
        const saved=localStorage.getItem('maestro_profile');
        if(saved){
            const p=JSON.parse(saved);
            Object.assign(profile,p);
            // Migrate old emoji avatars to new ID system
            if(profile.avatar&&!AVATARS.find(a=>a.id===profile.avatar)){
                // Old system used emojis, map to closest new ID
                const emojiMap={'ðŸ‘¤':'novato','ðŸ§‘â€ðŸ”§':'aprendiz','ðŸ‘·':'casco','ðŸ”§':'tools','âš¡':'voltimetro','ðŸ”¥':'racha5','â„ï¸':'txv','ðŸ§Š':'manifold','ðŸŒŸ':'quinientos','ðŸ’Ž':'leyenda','ðŸ†':'triple','ðŸ‘‘':'corona','âš™ï¸':'desarmador','ðŸŒ€':'anemometer','ðŸ’ª':'drill'};
                profile.avatar=emojiMap[profile.avatar]||'novato';
                saveProfile();
            }
            document.getElementById('profileBtn').classList.add('active');
            document.getElementById('profileBtn').textContent=getAvatarIcon(profile.avatar);
            if(D.name)D.gender=detectGender(D.name);
        }
    }catch(e){}
}

function renderProfile(){
    const icon=getAvatarIcon(profile.avatar);
    document.getElementById('profAvatar').innerHTML=icon+'<div class="prof-avatar-edit">âœï¸</div>';
    document.getElementById('profileBtn').textContent=icon;
    document.getElementById('profName').textContent=D.name||gn('TÃ©cnico','TÃ©cnica');
    document.getElementById('profTitle').textContent=getTitle(profile.level);
    document.getElementById('profLevel').textContent=profile.level;
    const xpPct=Math.round((profile.xp/profile.xpNeeded)*100);
    document.getElementById('profXpBar').style.width=xpPct+'%';
    document.getElementById('profXpTxt').textContent=profile.xp+' / '+profile.xpNeeded+' XP';
    document.getElementById('profPts').textContent=profile.totalCorrect*10;
    const acc=profile.totalAnswered>0?Math.round((profile.totalCorrect/profile.totalAnswered)*100):0;
    document.getElementById('profAcc').textContent=acc+'%';
    document.getElementById('profStrk').textContent=profile.bestStreak;
    
    // Medals grid
    document.getElementById('medalsGrid').innerHTML=MEDALS_DEF.map(m=>{
        const earned=profile.medals.includes(m.id);
        const mName=D.lang==='es'?m.name:(m.name_en||m.name);
        const mDesc=D.lang==='es'?m.desc:(m.desc_en||m.desc);
        return '<div class="medal-slot'+(earned?' earned':'')+'"><div class="medal-icon">'+(earned?m.icon:'ðŸ”’')+'</div><div class="medal-name">'+mName+'</div><div style="font-size:10px;color:var(--muted);margin-top:2px">'+mDesc+'</div></div>';
    }).join('');

    // Load cross-app progress from Supabase
    loadCrossAppProgress().then(function(data){
      if(!data) return;
      var section = document.getElementById('crossAppSection');
      section.style.display = 'block';
      document.getElementById('crossV2Quizzes').textContent = data.v2_quizzes || 0;
      document.getElementById('crossV1Quizzes').textContent = data.v1_quizzes || 0;
      document.getElementById('crossTotalQuizzes').textContent = data.total_quizzes || 0;
      document.getElementById('crossAvgScore').textContent = (data.overall_avg_score || 0) + '%';
      document.getElementById('crossCerts').textContent = data.total_certificates || 0;
      
      if(D.lang==='en'){
        document.getElementById('crossAppTitle').textContent = 'Total Progress';
        document.getElementById('crossTotalLabel').textContent = 'Total Quizzes';
        document.getElementById('crossAvgLabel').textContent = 'Average';
        document.getElementById('crossCertsLabel').textContent = 'Certificates';
      }
    }).catch(function(){});
}

// Load profile on start
loadProfile();

// Close music panel on outside click
document.addEventListener('click',e=>{
    const panel=document.getElementById('musicPanel');
    const btn=document.getElementById('musicBtn');
    const setBtn=document.querySelector('.music-settings');
    if(musicPanelOpen&&!panel.contains(e.target)&&e.target!==btn&&e.target!==setBtn){
        musicPanelOpen=false;
        panel.classList.remove('open');
    }
});

document.getElementById('nm').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim().length>=2)sName();});

// ========== 3-ZONE SYSTEM ==========

// === WRONG ANSWER TRACKER ===
// Stores: { "questionHash": { q, cat, fails, lastFail, masteredAt, quizId } }
function getTracker(){
    try{return JSON.parse(localStorage.getItem('maestro_study_tracker')||'{}');}catch(e){return{};}
}
function saveTracker(t){
    try{localStorage.setItem('maestro_study_tracker',JSON.stringify(t));}catch(e){}
}

function questionHash(q){
    // Simple hash from question text
    return q.q.substring(0,60).replace(/[^a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃ±]/g,'').toLowerCase();
}

function trackAnswer(q,correct){
    const tracker=getTracker();
    const hash=questionHash(q);
    if(!tracker[hash]){
        tracker[hash]={q:q.q,cat:q.cat,fails:0,correct:0,lastFail:null,masteredAt:null,quizId:currentQuizId,
            // Store full question for study mode
            fullQ:{cat:q.cat,q:q.q,o:[...q.o],c:q.c,e:q.e,a:q.a}
        };
    }
    if(correct){
        tracker[hash].correct++;
        // If they get it right 2 times after failing, mark as mastered
        if(tracker[hash].fails>0&&tracker[hash].correct>=2){
            tracker[hash].masteredAt=Date.now();
        }
    }else{
        tracker[hash].fails++;
        tracker[hash].lastFail=Date.now();
        tracker[hash].masteredAt=null; // Reset mastery if they fail again
        tracker[hash].correct=0; // Reset correct streak
    }
    saveTracker(tracker);
}

function getStudyQuestions(catFilter){
    const tracker=getTracker();
    const questions=[];
    for(const hash in tracker){
        const t=tracker[hash];
        // Include if: failed at least 1 time AND not mastered yet
        if(t.fails>=1&&!t.masteredAt&&t.fullQ){
            if(!catFilter||t.cat===catFilter){
                questions.push({...t.fullQ,_hash:hash,_fails:t.fails});
            }
        }
    }
    // Sort by most fails first
    questions.sort((a,b)=>b._fails-a._fails);
    return questions;
}

function getStudyCategories(){
    const questions=getStudyQuestions();
    const cats={};
    questions.forEach(q=>{
        if(!cats[q.cat])cats[q.cat]={count:0,icon:q.cat.split(' ')[0]};
        cats[q.cat].count++;
    });
    return cats;
}

// === HUB FUNCTIONS ===
function updateLanguageUI(){
    const es=D.lang==='es';
    // Helper to set text by ID
    function tx(id,esT,enT){const el=document.getElementById(id);if(el)el.textContent=es?esT:enT;}
    function txH(id,esT,enT){const el=document.getElementById(id);if(el)el.innerHTML=es?esT:enT;}
    
    // === HUB ZONES ===
    tx('hubQuizName','Quiz Zone','Quiz Zone');
    tx('hubQuizDesc',es?'Toma quizzes y demuestra lo que sabes':'Take quizzes and show what you know','Take quizzes and show what you know');
    tx('hubQuizBadge',es?'Â¡Vamos!':'Let\'s go!','Let\'s go!');
    tx('hubRepasoName',es?'Zona de Repaso':'Review Zone','Review Zone');
    tx('hubRepasoDesc',es?'Repasa solo las preguntas que fallaste en los quizzes':'Review only the questions you missed in quizzes','Review only the questions you missed in quizzes');
    tx('hubEstudioName',es?'Zona de Estudio':'Study Zone','Study Zone');
    tx('hubEstudioDesc',es?'Todas las preguntas con explicaciones detalladas, fÃ³rmulas y ejemplos de campo':'All questions with detailed explanations, formulas and field examples','All questions with detailed explanations, formulas and field examples');
    tx('hubVideoName','Video Zone','Video Zone');
    tx('hubVideoDesc',es?'Videos de Maestro Mario para aprender visualmente':'Maestro Mario videos to learn visually','Maestro Mario videos to learn visually');
    tx('hubProfileBtn',es?'ðŸ‘¤ Mi Perfil':'ðŸ‘¤ My Profile','ðŸ‘¤ My Profile');
    tx('hubRutaBtn',es?'â† Mi Ruta':'â† My Path','â† My Path');
    
    // === SECTION TITLES ===
    tx('repasoTitle',es?'ðŸ”„ ZONA DE REPASO':'ðŸ”„ REVIEW ZONE','ðŸ”„ REVIEW ZONE');
    tx('estudioTitle',es?'ðŸ“– ZONA DE ESTUDIO':'ðŸ“– STUDY ZONE','ðŸ“– STUDY ZONE');
    
    // === QUIZ SELECTOR ===
    tx('quizSelBubble',es?'Â¿QuÃ© quiz quieres tomar hoy?':'Which quiz do you want to take today?','Which quiz do you want to take today?');
    
    // === STUDY ZONE ===
    const sb=document.getElementById('studyBubble');
    if(sb&&!sb.textContent)sb.textContent=es?'AquÃ­ repasamos lo que necesitas reforzar.':'Here we review what you need to strengthen.';
    
    // === LIBRARY ===
    tx('floatLibBtn',es?'ðŸ“– Zona de Estudio':'ðŸ“– Study Zone','ðŸ“– Study Zone');
    const lb=document.getElementById('libraryBubble');
    if(lb&&(!lb.textContent||lb.textContent.includes('estudiar')||lb.textContent.includes('study')))
        lb.textContent=es?'AquÃ­ puedes estudiar TODAS las preguntas con explicaciones detalladas y ejemplos de campo.':'Here you can study ALL questions with detailed explanations and field examples.';
    
    // === VIDEO ZONE ===
    tx('videoBubble',es?'Videos del Maestro Mario para que aprendas viendo.':'Maestro Mario videos to learn by watching.','Maestro Mario videos to learn by watching.');
    
    // === AI CHAT ===
    tx('aiChatStatus',es?'ðŸŸ¢ Disponible para ayudarte':'ðŸŸ¢ Available to help you','ðŸŸ¢ Available to help you');
    tx('aiChatWelcome',es?'Â¡Ã“rale '+(D.name||gn('tÃ©cnico','tÃ©cnica'))+'! Soy el Maestro Mario con inteligencia artificial. Â¿En quÃ© te puedo ayudar? PregÃºntame lo que quieras sobre HVAC, refrigeraciÃ³n, o electricidad. ðŸ”§':'Hey '+(D.name||'technician')+'! I\'m Maestro Mario with AI. How can I help? Ask me anything about HVAC, refrigeration, or electrical. ðŸ”§','');
    tx('aiChatTyping',es?'Maestro Mario estÃ¡ hablando...':'Maestro Mario is typing...','Maestro Mario is typing...');
    
    // === AVATAR & MUSIC ===
    tx('avatarPickerTitle',es?'ðŸ”§ Elige tu Avatar':'ðŸ”§ Choose your Avatar','ðŸ”§ Choose your Avatar');
    tx('avatarPickerSub',es?'Desbloquea avatares dominando quizzes y subiendo de nivel':'Unlock avatars by mastering quizzes and leveling up','Unlock avatars by mastering quizzes and leveling up');
    tx('musicPanelTitle',es?'ðŸŽ¶ Elige tu mÃºsica':'ðŸŽ¶ Choose your music','ðŸŽ¶ Choose your music');
    
    // === FORMULA HINT DEFAULT ===
    const ft=document.getElementById('qFormToggleText');
    if(ft&&!ft.textContent)ft.textContent=es?'Mario te da una pista â€” tÃ³came':'Mario gives you a hint â€” tap me';
    
    // === QUIZ NAV BUTTONS (defaults) ===
    const qp=document.getElementById('qPrev');if(qp&&!qp.textContent)qp.textContent=es?'â† Anterior':'â† Previous';
    const qn=document.getElementById('qNext');if(qn&&!qn.textContent)qn.textContent=es?'Siguiente â†’':'Next â†’';
    const sp=document.getElementById('sqPrev');if(sp&&!sp.textContent)sp.textContent=es?'â† Anterior':'â† Previous';
    const sn=document.getElementById('sqNext');if(sn&&!sn.textContent)sn.textContent=es?'Siguiente â†’':'Next â†’';
    
    // === RESULT PAGE ===
    tx('retryBtn',es?'ðŸ”„ Intentar de Nuevo':'ðŸ”„ Try Again','ðŸ”„ Try Again');
    tx('otherQuizBtn',es?'ðŸ“ Otro Quiz':'ðŸ“ Another Quiz','ðŸ“ Another Quiz');
    tx('viewProfileBtn',es?'ðŸ‘¤ Ver Mi Perfil':'ðŸ‘¤ View My Profile','ðŸ‘¤ View My Profile');
    tx('studyRedirectTitle',es?'Â¡El Maestro Mario te recomienda repasar!':'Maestro Mario recommends you review!','Maestro Mario recommends you review!');
    
    // === STUDY RESULT ===
    tx('studyRetryBtn',es?'ðŸ”„ Repasar de Nuevo':'ðŸ”„ Review Again','ðŸ”„ Review Again');
    tx('studyZoneRepasoBtn',es?'ðŸ”„ Zona de Repaso':'ðŸ”„ Review Zone','ðŸ”„ Review Zone');
    
    // === VIDEO ===
    tx('videoLabel',es?'ðŸ”´ EN VIVO':'ðŸ”´ LIVE','ðŸ”´ LIVE');
    
    // === NEWBIE ZONE ===
    tx('hubNewbieName',es?'Soy Nuevo en HVAC':'I\'m New to HVAC','I\'m New to HVAC');
    tx('hubNewbieDesc',es?'IntroducciÃ³n a HVACR: la industria, herramientas, terminologÃ­a, salarios y cÃ³mo empezar tu carrera':'Intro to HVACR: the industry, tools, terminology, salary, and how to start your career','Intro to HVACR: the industry, tools, terminology, salary, and how to start your career');
    tx('hubNewbieBadge',es?'Nivel 1':'Level 1','Level 1');
    tx('hubNewbieStat',es?'ðŸŽ“ 8 temas + 50 preguntas':'ðŸŽ“ 8 topics + 50 questions','ðŸŽ“ 8 topics + 50 questions');
    
    // === PROFILE PAGE ===
    tx('profLevelLabel',es?'NIVEL':'LEVEL','LEVEL');
    tx('profPtsLabel',es?'Puntos':'Points','Points');
    tx('profAccLabel',es?'PrecisiÃ³n':'Accuracy','Accuracy');
    tx('profStrkLabel',es?'Mejor Racha':'Best Streak','Best Streak');
    tx('profMedalsTitle',es?'ðŸ… Medallas':'ðŸ… Medals','ðŸ… Medals');
    tx('profQuizBtn',es?'ðŸ“ Tomar un Quiz':'ðŸ“ Take a Quiz','ðŸ“ Take a Quiz');
    tx('profMusicBtn',es?'ðŸŽ¶ Cambiar MÃºsica':'ðŸŽ¶ Change Music','ðŸŽ¶ Change Music');
    tx('exitAppBtn',es?'ðŸšª Salir del App':'ðŸšª Exit App','ðŸšª Exit App');
    tx('avatarPickerTitle',es?'ðŸ”§ Elige tu Avatar':'ðŸ”§ Choose your Avatar','ðŸ”§ Choose your Avatar');
    tx('avatarPickerSub',es?'Desbloquea avatares dominando quizzes y subiendo de nivel':'Unlock avatars by mastering quizzes and leveling up','Unlock avatars by mastering quizzes and leveling up');
    
    // === ALL "Volver al Hub" BUTTONS ===
    document.querySelectorAll('[data-lang="volver-hub"]').forEach(b=>{b.textContent=es?'â† Volver al Hub':'â† Back to Hub';});
    
    // === LANG-REPASO-BTN ===
    document.querySelectorAll('.lang-repaso-btn').forEach(b=>{b.textContent=es?'ðŸ”„ Ir a Zona de Repaso â†’':'ðŸ”„ Go to Review Zone â†’';});
}

function updateHub(){
    updateLanguageUI();
    // Quiz zone stats
    const totalQuizzes=QUIZ_LIST.length;
    const totalQs=QUIZ_LIST.reduce((s,q)=>s+q.count,0);
    document.getElementById('hubQuizCount').textContent='ðŸ“‹ '+totalQuizzes+' quizzes';
    document.getElementById('hubQuizTotal').textContent='ðŸ“Š '+totalQs+(D.lang==='es'?' preguntas':' questions');
    
    // Study zone stats
    const studyQs=getStudyQuestions();
    document.getElementById('hubStudyCount').textContent='ðŸ”„ '+studyQs.length+(D.lang==='es'?' por repasar':' to review');
    const studyBadge=document.getElementById('hubStudyBadge');
    if(studyQs.length>0){
        studyBadge.style.display='block';
        studyBadge.textContent=studyQs.length>=10?'ðŸ”¥ '+studyQs.length:studyQs.length>=5?'âš ï¸ '+studyQs.length:(D.lang==='es'?'ðŸ“– Repasa':'ðŸ“– Review');
    }else{
        studyBadge.style.display='none';
    }
    
    // Hub bubble message
    const bubble=document.getElementById('hubBubble');
    if(studyQs.length>=10){
        bubble.textContent=D.lang==='es'?'Â¡'+D.name+'! Tienes '+studyQs.length+' preguntas por repasar. Â¡Ve a la Zona de Repaso!':''+D.name+'! You have '+studyQs.length+' questions to review. Hit the Review Zone!';
    }else if(studyQs.length>0){
        bubble.textContent=D.lang==='es'?'Â¿QuÃ© quieres hacer hoy, '+D.name+'? Tienes '+studyQs.length+' preguntas pendientes de repaso.':'What do you want to do, '+D.name+'? You have '+studyQs.length+' questions to review.';
    }else{
        bubble.textContent=D.lang==='es'?'Â¡'+D.name+'! Â¿Listo para aprender? Elige tu zona.':''+D.name+'! Ready to learn? Pick your zone.';
    }
    
    // Library zone stats
    updateHubLibraryCount();
}

function goQuizZone(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    renderQuizSelector();
    go('s7b');
    speakText(D.lang==='es'?'Â¡Vamos con los quizzes, '+D.name+'! Elige cuÃ¡l quieres tomar.':'Let\'s do quizzes, '+D.name+'! Pick which one you want.');
}

function goStudyZone(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    renderStudyZone();
    go('s-study');
    const count=getStudyQuestions().length;
    if(count>0){
        speakText(D.lang==='es'?'Zona de estudio, '+D.name+'. Tienes '+count+' preguntas para repasar. Â¡Vamos a dominarlas!':'Study zone, '+D.name+'. You have '+count+' questions to review. Let\'s master them!');
    }else{
        speakText(D.lang==='es'?'Â¡'+D.name+', tu zona de estudio estÃ¡ limpia! Ve a tomar quizzes para practicar.':''+D.name+', your study zone is clean! Go take quizzes to practice.');
    }
}

function goVideoZone(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    renderVideoZone();
    go('s-videos');
    speakText(D.lang==='es'?'Zona de videos. Pronto tendrÃ¡s videos del Maestro Mario aquÃ­.':'Video zone. Maestro Mario videos coming soon.');
}

function goNewbieZone(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    go('s-newbie');
    renderNewbieZone();
    speakText(D.lang==='en'?'Welcome! Let me show you the basics of HVAC. This is where your journey begins!':'Â¡Bienvenido! DÃ©jame enseÃ±arte lo bÃ¡sico de HVAC. Â¡AquÃ­ empieza tu camino!');
}

function startIntroQuiz(){
    selectQuiz('intro');
}

function renderNewbieZone(){
    const en=D.lang==='en';
    document.getElementById('newbieTitle').textContent=en?'ðŸ†• I\'M NEW TO HVAC':'ðŸ†• SOY NUEVO EN HVAC';
    document.getElementById('newbieBubble').textContent=en?'Welcome to the HVAC world! Here\'s everything you need to know to get started.':'Â¡Bienvenido al mundo HVAC! AquÃ­ te explico todo lo que necesitas saber para empezar.';
    document.getElementById('newbieQuizBtn').textContent=en?'ðŸ“ Take Intro HVACR Quiz (50 questions)':'ðŸ“ Tomar Quiz Intro HVACR (50 preguntas)';
    const topics=en?[
        {icon:'â„ï¸',title:'What is HVAC?',text:'HVAC stands for <b>Heating, Ventilation, and Air Conditioning</b>. It\'s the system that keeps buildings comfortable â€” warm in winter, cool in summer, and with clean air year-round. As an HVAC technician, you\'ll install, maintain, and repair these systems.'},
        {icon:'ðŸ”§',title:'Basic Tools You Need',text:'Every tech needs: <b>Multimeter</b> (measures voltage, amps, ohms), <b>Manifold gauges</b> (measures refrigerant pressure), <b>Thermometer</b>, <b>Screwdrivers & wrenches</b>, <b>Vacuum pump</b> (removes moisture from systems), and <b>Refrigerant scale</b>.'},
        {icon:'âš¡',title:'Basic Electrical',text:'<b>Voltage (V)</b> = pressure that pushes electricity. <b>Current (A)</b> = flow of electrons. <b>Resistance (Î©)</b> = opposition to flow. <b>Ohm\'s Law: V = I Ã— R</b>. You\'ll use this EVERY day. Example: 240V Ã· 20A = 12Î©.'},
        {icon:'ðŸ§Š',title:'How Refrigeration Works',text:'Refrigeration moves heat from inside to outside using 4 components: <b>Compressor</b> (pumps refrigerant), <b>Condenser</b> (releases heat outside), <b>Metering device</b> (drops pressure), <b>Evaporator</b> (absorbs heat inside). The refrigerant cycles continuously.'},
        {icon:'ðŸŒ¡ï¸',title:'Key Measurements',text:'<b>Superheat</b> = how much the gas is heated above boiling point (suction line). <b>Subcooling</b> = how much the liquid is cooled below condensing point (liquid line). These tell you if the system has the right refrigerant charge.'},
        {icon:'ðŸ“œ',title:'Certifications You Need',text:'<b>EPA 608</b> â€” Required by law to handle refrigerants. <b>OSHA 10/30</b> â€” Safety training. <b>NATE</b> â€” Industry certification. <b>NCCER</b> â€” Construction certification. Start with EPA 608, it\'s mandatory!'},
        {icon:'ðŸ›¡ï¸',title:'Safety First!',text:'Always: <b>Lock out / Tag out (LOTO)</b> before working on equipment. Wear <b>PPE</b> (safety glasses, gloves, steel-toe boots). Never work on live circuits unless testing. Remember: <b>If you don\'t measure, you\'re guessing!</b>'},
        {icon:'ðŸ’°',title:'Career Path & Salary',text:'HVAC is one of the best trades! <b>Entry:</b> $18-25/hr. <b>Experienced:</b> $30-45/hr. <b>Business owner:</b> $100K-300K+/year. Start as a helper, get certified, gain field experience, then start your own company!'}
    ]:[
        {icon:'â„ï¸',title:'Â¿QuÃ© es HVAC?',text:'HVAC significa <b>Heating, Ventilation, and Air Conditioning</b> (CalefacciÃ³n, VentilaciÃ³n y Aire Acondicionado). Es el sistema que mantiene los edificios cÃ³modos. Como tÃ©cnico HVAC, instalarÃ¡s, darÃ¡s mantenimiento y repararÃ¡s estos sistemas.'},
        {icon:'ðŸ”§',title:'Herramientas BÃ¡sicas',text:'Todo tÃ©cnico necesita: <b>MultÃ­metro</b> (mide voltaje, amperaje, ohms), <b>Manifold gauges</b> (mide presiÃ³n de refrigerante), <b>TermÃ³metro</b>, <b>Desarmadores y llaves</b>, <b>Bomba de vacÃ­o</b>, y <b>BÃ¡scula de refrigerante</b>.'},
        {icon:'âš¡',title:'Electricidad BÃ¡sica',text:'<b>Voltaje (V)</b> = la presiÃ³n que empuja la electricidad. <b>Corriente (A)</b> = el flujo de electrones. <b>Resistencia (Î©)</b> = oposiciÃ³n al flujo. <b>Ley de Ohm: V = I Ã— R</b>. Esto lo usarÃ¡s TODOS los dÃ­as. Ejemplo: 240V Ã· 20A = 12Î©.'},
        {icon:'ðŸ§Š',title:'CÃ³mo Funciona la RefrigeraciÃ³n',text:'La refrigeraciÃ³n mueve calor de adentro hacia afuera con 4 componentes: <b>Compresor</b> (bombea refrigerante), <b>Condensador</b> (libera calor afuera), <b>Dispositivo de mediciÃ³n</b> (baja presiÃ³n), <b>Evaporador</b> (absorbe calor adentro).'},
        {icon:'ðŸŒ¡ï¸',title:'Mediciones Clave',text:'<b>Superheat</b> = cuÃ¡nto se calienta el gas arriba de su punto de ebulliciÃ³n (lÃ­nea de succiÃ³n). <b>Subcooling</b> = cuÃ¡nto se enfrÃ­a el lÃ­quido abajo de su punto de condensaciÃ³n (lÃ­nea de lÃ­quido). Te dicen si el sistema tiene la carga correcta.'},
        {icon:'ðŸ“œ',title:'Certificaciones Necesarias',text:'<b>EPA 608</b> â€” Requerida por ley para manejar refrigerantes. <b>OSHA 10/30</b> â€” Seguridad. <b>NATE</b> â€” CertificaciÃ³n de la industria. <b>NCCER</b> â€” CertificaciÃ³n de construcciÃ³n. Â¡Empieza con EPA 608, es obligatoria!'},
        {icon:'ðŸ›¡ï¸',title:'Â¡Seguridad Primero!',text:'Siempre: <b>Lock out / Tag out (LOTO)</b> antes de trabajar en equipos. Usa <b>EPP</b> (gafas, guantes, botas con punta de acero). Nunca trabajes en circuitos energizados. Recuerda: <b>Â¡Si no mides, estÃ¡s adivinando!</b>'},
        {icon:'ðŸ’°',title:'Carrera y Salario',text:'Â¡HVAC es uno de los mejores oficios! <b>Entrada:</b> $18-25/hr. <b>Experimentado:</b> $30-45/hr. <b>DueÃ±o de negocio:</b> $100K-300K+/aÃ±o. Empieza como ayudante, saca certificaciones, gana experiencia, Â¡y abre tu empresa!'}
    ];
    let html='';
    topics.forEach(t=>{
        html+='<div style="background:var(--card);border-radius:16px;padding:18px;border:1px solid rgba(255,255,255,0.06)">';
        html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">';
        html+='<span style="font-size:28px">'+t.icon+'</span>';
        html+='<span style="font-size:16px;font-weight:700;color:#3498db;font-family:Fredoka,sans-serif">'+t.title+'</span>';
        html+='</div>';
        html+='<div style="font-size:13px;line-height:1.7;color:var(--txt)">'+t.text+'</div>';
        html+='</div>';
    });
    document.getElementById('newbieContent').innerHTML=html;
}

// === STUDY ZONE RENDER ===
function renderStudyZone(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    const container=document.getElementById('studyContent');
    const questions=getStudyQuestions();
    const cats=getStudyCategories();
    const bubble=document.getElementById('studyBubble');
    
    if(questions.length===0){
        bubble.textContent=D.lang==='es'?'Â¡Felicidades '+D.name+'! No tienes preguntas pendientes. Ve a tomar quizzes.':'Congrats '+D.name+'! No pending questions. Go take quizzes.';
        container.innerHTML='<div class="study-empty">'+
            '<div class="study-empty-icon">ðŸŽ‰</div>'+
            '<div class="study-empty-title">'+(D.lang==='es'?'Â¡Todo limpio!':'All clean!')+'</div>'+
            '<div class="study-empty-desc">'+(D.lang==='es'?'No tienes preguntas por repasar. Â¡Sigue tomando quizzes para seguir aprendiendo!':'No questions to review. Keep taking quizzes to keep learning!')+'</div>'+
            '</div>'+
            '<button class="bt" onclick="goQuizZone()" style="margin-top:16px">'+(D.lang==='es'?'ðŸ“ Ir a Quiz Zone':'ðŸ“ Go to Quiz Zone')+'</button>';
        return;
    }
    
    bubble.textContent=D.lang==='es'?D.name+', tienes '+questions.length+' preguntas que necesitas reforzar. Â¡TÃº puedes!':D.name+', you have '+questions.length+' questions to strengthen. You got this!';
    
    let html='<div class="study-alert">ðŸ“š '+(D.lang==='es'?'Tienes <b>'+questions.length+' preguntas</b> que fallaste en los quizzes. RepÃ¡salas aquÃ­ hasta dominarlas.':'You have <b>'+questions.length+' questions</b> you missed in quizzes. Review them here until you master them.')+'</div>';
    
    // Show "Review All" button
    html+='<button class="bt" onclick="startStudyQuiz(\'all\')" style="margin-bottom:16px">ðŸ”¥ '+(D.lang==='es'?'Repasar Todas ('+questions.length+')':'Review All ('+questions.length+')')+'</button>';
    
    // Show by category
    for(const cat in cats){
        html+='<div class="study-topic" onclick="startStudyQuiz(\''+cat.replace(/'/g,"\\'")+'\')">';
        html+='<div class="study-topic-icon">'+cats[cat].icon+'</div>';
        html+='<div class="study-topic-info">';
        html+='<div class="study-topic-name">'+cat+'</div>';
        html+='<div class="study-topic-count">'+cats[cat].count+(D.lang==='es'?' preguntas por repasar':' questions to review')+'</div>';
        html+='</div></div>';
    }
    
    // Show mastered count
    const tracker=getTracker();
    const mastered=Object.values(tracker).filter(t=>t.masteredAt).length;
    if(mastered>0){
        html+='<div style="text-align:center;margin-top:20px;font-size:13px;color:var(--electric)">âœ… '+(D.lang==='es'?mastered+' preguntas dominadas':mastered+' questions mastered')+'</div>';
    }
    
    container.innerHTML=html;
}

// === STUDY QUIZ MODE ===
let studyData=[];
let studyIdx=0;
let studyRight=0;
let studyWrong=0;
let studyAnswered=false;
let studyAnswers=[];
let lastStudyCat='all';

function startStudyQuiz(catFilter){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    lastStudyCat=catFilter;
    const questions=catFilter==='all'?getStudyQuestions():getStudyQuestions(catFilter);
    if(questions.length===0){
        goStudyZone();
        return;
    }
    studyData=shuffleArray(questions);
    studyIdx=0;studyRight=0;studyWrong=0;
    studyAnswers=new Array(studyData.length).fill(-1);
    document.getElementById('sqRight').textContent='0';
    document.getElementById('sqWrong').textContent='0';
    go('s-study-quiz');
    showStudyQuestion();
}

function showStudyQuestion(){
    if(studyIdx>=studyData.length){showStudyResult();return;}
    const q=studyData[studyIdx];
    const alreadyAnswered=studyAnswers[studyIdx]>=0;
    studyAnswered=alreadyAnswered;
    const pct=Math.round((studyIdx/studyData.length)*100);
    document.getElementById('sqBar').style.width=pct+'%';
    document.getElementById('sqNum').textContent='ðŸ“š '+(D.lang==='es'?'Repaso ':'Review ')+(studyIdx+1)+' / '+studyData.length;
    document.getElementById('sqCat').textContent=q.cat;
    
    const prevBtn=document.getElementById('sqPrev');
    if(studyIdx>0){prevBtn.classList.add('show');}else{prevBtn.classList.remove('show');}
    
    if(alreadyAnswered){
        const userAnswer=studyAnswers[studyIdx];
        const correct=userAnswer===q.c;
        document.getElementById('sqBubble').textContent=correct?'âœ… Â¡Bien! Ya la dominas.':'âŒ Sigue intentando. La correcta es la '+['A','B','C','D'][q.c]+'.';
        document.getElementById('sqText').textContent=tq(q,'q');
        const letters=['A','B','C','D'];
        document.getElementById('sqOpts').innerHTML=tq(q,'o').map((o,i)=>{
            let cls='quiz-opt disabled';
            if(i===q.c)cls+=' correct';
            if(i===userAnswer&&!correct)cls+=' wrong';
            return '<div class="'+cls+'"><div class="quiz-letter">'+letters[i]+'</div><div>'+o+'</div></div>';
        }).join('');
        document.getElementById('sqExplain').innerHTML='<b style="color:#ff6b2b">ðŸ“–</b> '+tq(q,'a')+'<br><br><b>'+(D.lang==='es'?'TÃ©cnico:':'Technical:')+'</b> '+tq(q,'e');
        document.getElementById('sqExplain').classList.add('show');
        const nextBtn=document.getElementById('sqNext');
        nextBtn.textContent=(studyIdx<studyData.length-1)?'Siguiente â†’':'Ver Resultado ðŸ†';
        nextBtn.classList.add('show');
    }else{
        document.getElementById('sqBubble').textContent=D.lang==='es'?'Esta la fallaste antes. Â¡PiÃ©nsale bien, '+D.name+'!':'You missed this before. Think carefully, '+D.name+'!';
        document.getElementById('sqText').textContent=tq(q,'q');
        document.getElementById('sqExplain').classList.remove('show');
        document.getElementById('sqNext').classList.remove('show');
        const letters=['A','B','C','D'];
        document.getElementById('sqOpts').innerHTML=tq(q,'o').map((o,i)=>'<div class="quiz-opt" onclick="answerStudy('+i+',this)"><div class="quiz-letter">'+letters[i]+'</div><div>'+o+'</div></div>').join('');
    }
    window.scrollTo(0,0);
}

function answerStudy(idx,el){
    if(studyAnswered)return;
    studyAnswered=true;
    studyAnswers[studyIdx]=idx;
    const q=studyData[studyIdx];
    const correct=idx===q.c;
    const opts=document.querySelectorAll('#s-study-quiz .quiz-opt');
    
    opts.forEach((o,i)=>{
        if(i===q.c)o.classList.add('correct');
        if(i===idx&&!correct)o.classList.add('wrong');
        if(i!==q.c&&i!==idx)o.classList.add('disabled');
    });
    
    // Track in study tracker
    trackAnswer(q,correct);
    
    if(correct){
        studyRight++;
        document.getElementById('sqRight').textContent=studyRight;
        document.getElementById('sqBubble').textContent=D.lang==='es'?'âœ… Â¡Muy bien, '+D.name+'! Â¡Ya le estÃ¡s agarrando!':'âœ… Great job, '+D.name+'! You\'re getting it!';
        document.getElementById('sqExplain').innerHTML='<b>'+(D.lang==='es'?'ExplicaciÃ³n:':'Explanation:')+'</b> '+tq(q,'e');
        celebrate(1);
        speakText(D.lang==='es'?'Â¡Correcto! Ya le agarraste. '+tq(q,'e'):'Correct! You got it. '+tq(q,'e'));
    }else{
        studyWrong++;
        document.getElementById('sqWrong').textContent=studyWrong;
        document.getElementById('sqBubble').textContent=D.lang==='es'?'âŒ AÃºn no, '+D.name+'. La correcta es la '+['A','B','C','D'][q.c]+'. Lee bien la explicaciÃ³n.':'âŒ Not yet, '+D.name+'. Correct: '+['A','B','C','D'][q.c]+'. Read the explanation.';
        document.getElementById('sqExplain').innerHTML='<b style="color:#ff6b2b">'+(D.lang==='es'?'ðŸ“– Con peras y manzanas:':'ðŸ“– Simply put:')+'</b><br>'+tq(q,'a')+'<br><br><b>'+(D.lang==='es'?'TÃ©cnico:':'Technical:')+'</b> '+tq(q,'e');
        speakText(D.lang==='es'?'AÃºn no, pero no te rindas. Te lo explico: ':' Not yet, but don\'t give up. Let me explain: '+tq(q,'a')+' '+tq(q,'e'));
    }
    
    document.getElementById('sqExplain').classList.add('show');
    document.getElementById('sqNext').textContent=(studyIdx<studyData.length-1)?'Siguiente â†’':'Ver Resultado ðŸ†';
    document.getElementById('sqNext').classList.add('show');
}

function studyNext(){
    stopSpeech();
    studyIdx++;
    showStudyQuestion();
}

function studyPrev(){
    stopSpeech();
    if(studyIdx>0){studyIdx--;showStudyQuestion();}
}

function showStudyResult(){
    go('s-study-result');
    const pct=studyData.length>0?Math.round((studyRight/studyData.length)*100):0;
    document.getElementById('srScore').textContent=pct+'%';
    document.getElementById('srLabel').textContent=studyRight+' / '+studyData.length+(D.lang==='es'?' correctas en repaso':' correct in review');
    
    let medal,msg;
    if(pct>=90){
        medal='ðŸ†';
        msg=D.lang==='es'?'Â¡IncreÃ­ble, '+D.name+'! Â¡Ya dominas estas preguntas! Las que sacaste bien se van de tu zona de estudio.':'Amazing, '+D.name+'! You\'ve mastered these! Correct ones leave your study zone.';
    }else if(pct>=70){
        medal='ðŸ¥‡';
        msg=D.lang==='es'?'Â¡Muy bien, '+D.name+'! Vas mejorando. Sigue repasando las que fallaste.':'Great job, '+D.name+'! You\'re improving. Keep reviewing the ones you missed.';
    }else if(pct>=50){
        medal='ðŸ¥ˆ';
        msg=D.lang==='es'?'Â¡Vas progresando, '+D.name+'! Repasa las explicaciones y vuelve a intentar.':'Making progress, '+D.name+'! Review explanations and try again.';
    }else{
        medal='ðŸ’ª';
        msg=D.lang==='es'?'Â¡No te rindas, '+D.name+'! La prÃ¡ctica hace al maestro. Lee las explicaciones con calma.':'Don\'t give up, '+D.name+'! Practice makes perfect. Read explanations carefully.';
    }
    
    document.getElementById('srMedal').textContent=medal;
    document.getElementById('srMsg').textContent=msg;
    
    // Award XP for study
    const xpEarned=studyRight*5;
    profile.xp+=xpEarned;
    while(profile.xp>=profile.xpNeeded){
        profile.xp-=profile.xpNeeded;
        profile.level++;
        profile.xpNeeded=Math.floor(profile.xpNeeded*1.4);
    }
    saveProfile();
    
    cft();
    speakText(msg);
}

// === VIDEO ZONE ===
const VIDEO_TOPICS=[
    {cat:'âš¡ Electricidad',cat_en:'âš¡ Electrical',videos:[
        {title:'Ley de Ohm Explicada',desc:'Voltaje, corriente y resistencia con ejemplos reales',icon:'âš¡',dur:'PrÃ³ximamente'},
        {title:'CÃ³mo Usar el MultÃ­metro',desc:'Medir voltaje, amperaje, resistencia y continuidad',icon:'ðŸ”¬',dur:'PrÃ³ximamente'},
        {title:'Circuitos Serie vs Paralelo',desc:'Diferencias y cÃ³mo diagnosticar cada uno',icon:'ðŸ”Œ',dur:'PrÃ³ximamente'},
        {title:'GFCI y AFCI Explicados',desc:'Protecciones elÃ©ctricas y cuÃ¡ndo se requieren',icon:'ðŸ›¡ï¸',dur:'PrÃ³ximamente'}
    ]},
    {cat:'â„ï¸ Aire Acondicionado',cat_en:'â„ï¸ Air Conditioning',videos:[
        {title:'Ciclo de RefrigeraciÃ³n',desc:'Los 4 componentes y cÃ³mo funciona el sistema',icon:'ðŸ”„',dur:'PrÃ³ximamente'},
        {title:'Superheat y Subcooling',desc:'QuÃ© son, cÃ³mo medirlos y valores normales',icon:'ðŸŒ¡ï¸',dur:'PrÃ³ximamente'},
        {title:'DiagnÃ³stico con Manifold',desc:'Leer presiones y diagnosticar problemas',icon:'ðŸ“Š',dur:'PrÃ³ximamente'},
        {title:'Mantenimiento Preventivo',desc:'Checklist completo para servicio de AC',icon:'ðŸ”§',dur:'PrÃ³ximamente'}
    ]},
    {cat:'ðŸ§Š RefrigeraciÃ³n',cat_en:'ðŸ§Š Refrigeration',videos:[
        {title:'Walk-in Coolers 101',desc:'Componentes y troubleshooting bÃ¡sico',icon:'ðŸ§Š',dur:'PrÃ³ximamente'},
        {title:'VÃ¡lvula TXV',desc:'CÃ³mo funciona y cÃ³mo diagnosticar problemas',icon:'âš™ï¸',dur:'PrÃ³ximamente'},
        {title:'EPA 608 Prep',desc:'Todo lo que necesitas para pasar el examen',icon:'ðŸ“‹',dur:'PrÃ³ximamente'}
    ]},
    {cat:'ðŸ›¡ï¸ Seguridad',cat_en:'ðŸ›¡ï¸ Safety',videos:[
        {title:'Lockout/Tagout (LOTO)',desc:'Procedimiento correcto paso a paso',icon:'ðŸ”’',dur:'PrÃ³ximamente'},
        {title:'PPE para HVAC',desc:'Equipo de protecciÃ³n personal obligatorio',icon:'ðŸ¥½',dur:'PrÃ³ximamente'}
    ]}
];

function renderVideoZone(){
    const container=document.getElementById('videoContent');
    let html='';
    
    VIDEO_TOPICS.forEach(topic=>{
        html+='<div class="video-section-title">'+topic.cat+'</div>';
        topic.videos.forEach(v=>{
            html+='<div class="video-card" onclick="alert(\''+(D.lang==='es'?'PrÃ³ximamente â€” estamos grabando los videos del Maestro Mario':'Coming soon â€” we are recording Maestro Mario videos')+'\')">';
            html+='<div class="video-card-thumb">'+v.icon+'</div>';
            html+='<div class="video-card-info">';
            html+='<div class="video-card-title">'+v.title+'</div>';
            html+='<div class="video-card-desc">'+v.desc+'</div>';
            html+='<div class="video-card-dur">ðŸŽ¬ '+v.dur+'</div>';
            html+='</div></div>';
        });
    });
    
    container.innerHTML=html;
}

// ========== ZONA DE ESTUDIO (STUDY LIBRARY) ==========
function goStudyLibrary(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    renderStudyLibrary();
    go('s-library');
    speakText(D.lang==='es'?'Bienvenido a la Zona de Estudio, '+D.name+'. AquÃ­ puedes estudiar todas las preguntas con explicaciones detalladas.':'Welcome to the Study Library, '+D.name+'. Study all questions with detailed explanations here.');
}

function getAllQuizQuestions(){
    const all=[];
    if(typeof QUIZ_INTRO!=='undefined')all.push(...QUIZ_INTRO.map(q=>({...q,_source:'intro'})));
    if(typeof QUIZ_PRINCIPIANTE!=='undefined')all.push(...QUIZ_PRINCIPIANTE.map(q=>({...q,_source:'principiante'})));
    if(typeof QUIZ_ELECTRICIDAD!=='undefined')all.push(...QUIZ_ELECTRICIDAD.map(q=>({...q,_source:'electricidad'})));
    if(typeof QUIZ_REFRIGERACION!=='undefined')all.push(...QUIZ_REFRIGERACION.map(q=>({...q,_source:'refrigeracion'})));
    if(typeof QUIZ_INTRO_ELECTRICIDAD!=='undefined')all.push(...QUIZ_INTRO_ELECTRICIDAD.map(q=>({...q,_source:'intro_elec'})));
    if(typeof QUIZ_INTRO_REFRIGERACION!=='undefined')all.push(...QUIZ_INTRO_REFRIGERACION.map(q=>({...q,_source:'intro_refri'})));
    if(typeof QUIZ_STUDY_ELECTRICIDAD!=='undefined')all.push(...QUIZ_STUDY_ELECTRICIDAD.map(q=>({...q,_source:'study_elec'})));
    if(typeof QUIZ_STUDY_REFRIGERACION!=='undefined')all.push(...QUIZ_STUDY_REFRIGERACION.map(q=>({...q,_source:'study_refri'})));
    if(typeof QUIZ_ELECTRICIDAD_COMERCIAL_P2!=='undefined')all.push(...QUIZ_ELECTRICIDAD_COMERCIAL_P2.map(q=>({...q,_source:'elec_comercial'})));
    return all;
}

function getLibraryCategories(){
    const all=getAllQuizQuestions();
    const cats={};
    all.forEach(q=>{
        if(!cats[q.cat])cats[q.cat]={count:0,icon:q.cat.split(' ')[0],questions:[]};
        cats[q.cat].count++;
        cats[q.cat].questions.push(q);
    });
    return cats;
}

function renderStudyLibrary(){
    if(!window.checkAIPremium || !window.checkAIPremium()) return;
    const container=document.getElementById('libraryContent');
    const cats=getLibraryCategories();
    const allQ=getAllQuizQuestions();
    const bubble=document.getElementById('libraryBubble');
    bubble.textContent=D.lang==='es'?
        D.name+', aquÃ­ tienes '+allQ.length+' preguntas organizadas por tema. Estudia con calma, cada una tiene explicaciÃ³n completa y ejemplos de campo.':
        D.name+', here are '+allQ.length+' questions organized by topic. Study at your pace, each has full explanations and field examples.';
    
    let html='<div style="text-align:center;margin-bottom:16px;font-size:14px;color:var(--electric);font-weight:700">ðŸ“– '+allQ.length+(D.lang==='es'?' preguntas disponibles en ':' questions available in ')+Object.keys(cats).length+(D.lang==='es'?' temas':' topics')+'</div>';
    
    const sortedCats=Object.keys(cats).sort((a,b)=>cats[b].count-cats[a].count);
    
    for(const cat of sortedCats){
        const c=cats[cat];
        html+='<div class="quiz-sel-card" onclick="showLibraryCategory(\''+cat.replace(/'/g,"\\'")+'\')" style="border-color:rgba(46,204,113,0.15);margin-bottom:10px">';
        html+='<div class="qs-icon" style="background:rgba(46,204,113,0.1);font-size:32px">'+c.icon+'</div>';
        html+='<div class="qs-info"><div class="qs-title" style="color:#2ecc71">'+cat+'</div>';
        html+='<div class="qs-count" style="color:var(--muted)">ðŸ“– '+c.count+(D.lang==='es'?' preguntas con explicaciÃ³n':' questions with explanation')+'</div>';
        html+='</div></div>';
    }
    
    container.innerHTML=html;
}

function detectFormulas(text){
    // Detect formula patterns in question or explanation text
    const formulas=[];
    const patterns=[
        {rx:/R\s*=\s*V\s*[Ã·\/]\s*I/i,f:'R = V Ã· I',name:'Ley de Ohm (Resistencia)',ex:'Si V=240V y I=20A â†’ R = 240Ã·20 = 12Î©'},
        {rx:/V\s*=\s*I\s*[Ã—x\*]\s*R/i,f:'V = I Ã— R',name:'Ley de Ohm (Voltaje)',ex:'Si I=10A y R=12Î© â†’ V = 10Ã—12 = 120V'},
        {rx:/I\s*=\s*V\s*[Ã·\/]\s*R/i,f:'I = V Ã· R',name:'Ley de Ohm (Corriente)',ex:'Si V=240V y R=20Î© â†’ I = 240Ã·20 = 12A'},
        {rx:/P\s*=\s*V\s*[Ã—x\*]\s*I|[Ww]att/i,f:'P = V Ã— I',name:'Ley de Watt (Potencia)',ex:'Si V=120V y I=10A â†’ P = 120Ã—10 = 1,200W'},
        {rx:/superheat/i,f:'Superheat = T lÃ­nea succiÃ³n âˆ’ T saturaciÃ³n (segÃºn presiÃ³n)',name:'Superheat',ex:'Si presiÃ³n=70psi (40Â°F sat.) y T lÃ­nea=50Â°F â†’ SH = 50âˆ’40 = 10Â°F'},
        {rx:/subcooling/i,f:'Subcooling = T saturaciÃ³n (segÃºn presiÃ³n) âˆ’ T lÃ­nea lÃ­quido',name:'Subcooling',ex:'Si presiÃ³n=280psi (120Â°F sat.) y T lÃ­nea=110Â°F â†’ SC = 120âˆ’110 = 10Â°F'},
        {rx:/[Oo]hm|resistencia.*voltaje|voltaje.*corriente/i,f:'V = I Ã— R  |  I = V Ã· R  |  R = V Ã· I',name:'Ley de Ohm',ex:'Con 2 valores conocidos, siempre puedes calcular el tercero'},
        {rx:/BTU|capacidad.*enfriamiento|tonelada/i,f:'1 Ton = 12,000 BTU/h  |  CFM = BTU Ã· (1.08 Ã— Î”T)',name:'Capacidad de Enfriamiento',ex:'3 Ton = 36,000 BTU/h. Para Î”T=20Â°F â†’ CFM = 36000Ã·(1.08Ã—20) = 1,667 CFM'},
        {rx:/[Aa]mperaje|amperios|overload/i,f:'I = P Ã· V  |  P = V Ã— I  |  I = V Ã· R',name:'CÃ¡lculo de Corriente',ex:'Motor de 1HP(746W) a 240V â†’ I = 746Ã·240 = 3.1A'},
    ];
    const combined=text;
    patterns.forEach(p=>{
        if(p.rx.test(combined))formulas.push(p);
    });
    return formulas;
}

function showLibraryCategory(catName){
    const cats=getLibraryCategories();
    const cat=cats[catName];
    if(!cat)return;
    
    document.getElementById('libDetailTitle').textContent=catName;
    const container=document.getElementById('libDetailContent');
    
    let html='<div style="text-align:center;margin-bottom:14px;font-size:13px;color:var(--muted)">'+cat.count+(D.lang==='es'?' preguntas â€” toca cada una para estudiar a fondo':' questions â€” tap each to study in depth')+'</div>';
    cat.questions.forEach((q,i)=>{
        const letters=['A','B','C','D'];
        html+='<div style="background:var(--card);border:1.5px solid rgba(46,204,113,0.15);border-radius:16px;padding:18px;margin-bottom:14px">';
        html+='<div style="font-size:11px;color:var(--electric);font-weight:700;margin-bottom:6px;letter-spacing:1px">ðŸ“– '+(D.lang==='es'?'PREGUNTA':'QUESTION')+' '+(i+1)+(D.lang==='es'?' DE ':' OF ')+cat.count+'</div>';
        html+='<div style="font-size:15px;font-weight:700;line-height:1.5;margin-bottom:12px">'+q.q+'</div>';
        
        // Options - all shown with correct highlighted
        tq(q,'o').forEach((opt,j)=>{
            const isCorrect=j===q.c;
            const bg=isCorrect?'rgba(46,204,113,0.15)':'rgba(255,255,255,0.03)';
            const border=isCorrect?'rgba(46,204,113,0.4)':'rgba(255,255,255,0.06)';
            const color=isCorrect?'#2ecc71':'var(--txt)';
            html+='<div style="background:'+bg+';border:1.5px solid '+border+';border-radius:12px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:10px;font-size:14px">';
            html+='<span style="width:28px;height:28px;border-radius:8px;background:'+(isCorrect?'#2ecc71':'rgba(255,255,255,0.08)')+';display:flex;align-items:center;justify-content:center;font-family:Fredoka;font-size:14px;font-weight:700;color:'+(isCorrect?'white':'var(--txt)')+';flex-shrink:0">'+letters[j]+'</span>';
            html+='<span style="color:'+color+';font-weight:'+(isCorrect?'700':'400')+'">'+opt+(isCorrect?' âœ…':'')+'</span></div>';
        });
        
        // === TECHNICAL EXPLANATION (primary, bigger) ===
        html+='<div style="background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:16px;margin-top:14px">';
        html+='<div style="font-size:14px;font-weight:700;color:var(--electric);margin-bottom:8px">ðŸ“˜ '+(D.lang==='es'?'ExplicaciÃ³n TÃ©cnica Detallada':'Detailed Technical Explanation')+'</div>';
        html+='<div style="font-size:14px;line-height:1.7;color:var(--txt)">'+tq(q,'e')+'</div>';
        
        // === WHY CORRECT ANSWER (detailed reasoning) ===
        html+='<div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,212,255,0.15)">';
        html+='<div style="font-size:12px;font-weight:700;color:#2ecc71;margin-bottom:4px">âœ… '+(D.lang==='es'?'Â¿Por quÃ© la respuesta '+letters[q.c]+' es correcta?':'Why is answer '+letters[q.c]+' correct?')+'</div>';
        html+='<div style="font-size:13px;line-height:1.6;color:var(--muted)">'+(D.lang==='es'?'La opciÃ³n correcta es':'The correct answer is')+' <b style="color:#2ecc71">'+tq(q,'o')[q.c]+'</b>. '+tq(q,'e')+'</div>';
        html+='</div>';
        
        // === WHY OTHERS ARE WRONG ===
        let wrongExplain='';
        q.o.forEach((opt,j)=>{
            if(j!==q.c) wrongExplain+='<span style="color:#e74c3c">'+letters[j]+')</span> '+opt+(D.lang==='es'?' â€” Incorrecto. ':' â€” Incorrect. ');
        });
        html+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(0,212,255,0.1)">';
        html+='<div style="font-size:12px;font-weight:700;color:#e74c3c;margin-bottom:4px">âŒ '+(D.lang==='es'?'Â¿Por quÃ© las otras estÃ¡n mal?':'Why are the others wrong?')+'</div>';
        html+='<div style="font-size:12px;line-height:1.6;color:var(--muted)">'+wrongExplain+'</div>';
        html+='</div>';
        html+='</div>';
        
        // === FORMULA BREAKDOWN (if applicable) ===
        const formulas=detectFormulas(tq(q,'q')+' '+tq(q,'e'));
        if(formulas.length>0){
            html+='<div style="background:rgba(241,196,15,0.08);border:1px solid rgba(241,196,15,0.25);border-radius:12px;padding:16px;margin-top:8px">';
            html+='<div style="font-size:14px;font-weight:700;color:var(--gold);margin-bottom:10px">ðŸ“ '+(D.lang==='es'?'FÃ³rmulas Aplicables':'Applicable Formulas')+'</div>';
            formulas.forEach(f=>{
                html+='<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:12px;margin-bottom:8px">';
                html+='<div style="font-family:Fredoka;font-size:16px;color:var(--gold);font-weight:700;text-align:center;margin-bottom:6px">'+f.f+'</div>';
                html+='<div style="font-size:12px;color:var(--electric);font-weight:600;margin-bottom:4px">'+f.name+'</div>';
                html+='<div style="font-size:12px;color:var(--muted);line-height:1.5">ðŸ“Š '+(D.lang==='es'?'Ejemplo':'Example')+': '+f.ex+'</div>';
                html+='</div>';
            });
            html+='</div>';
        }
        
        // === FIELD TIP (analogy - secondary, collapsible feel) ===
        if(tq(q,'a')){
            html+='<div style="background:rgba(255,107,43,0.06);border:1px solid rgba(255,107,43,0.15);border-radius:12px;padding:14px;margin-top:8px">';
            html+='<div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:6px">ðŸ’¡ '+(D.lang==='es'?'Tip de Campo (AnalogÃ­a):':'Field Tip (Analogy):')+'</div>';
            html+='<div style="font-size:13px;line-height:1.6;color:var(--muted)">'+tq(q,'a')+'</div>';
            html+='</div>';
        }
        
        html+='</div>';
    });
    
    container.innerHTML=html;
    go('s-library-detail');
    window.scrollTo(0,0);
}

function updateHubLibraryCount(){
    const el=document.getElementById('hubLibraryCount');
    if(el){
        const all=getAllQuizQuestions();
        const cats=getLibraryCategories();
        el.textContent='ðŸ“– '+all.length+(D.lang==='es'?' preguntas en ':' questions in ')+Object.keys(cats).length+(D.lang==='es'?' temas':' topics');
    }
}

</script>
<!-- HOME BUTTON -->
<button class="home-fab" onclick="window.location.href='https://acvolttech.github.io/maestroac-app/'" title="MenÃº Principal">ðŸ </button>

<!-- AI CHARACTER COUNTER -->
<div class="ai-chars-banner" id="aiCharsBanner">ðŸ¤– <span id="aiCharsCount">50,000</span> / 50,000</div>

<!-- AI PAYWALL MODAL -->
<div class="paywall-overlay" id="paywallModal">
  <div class="paywall-card" style="max-width:440px;padding:18px 16px">
    <!-- Mario avatar -->
    <div style="display:flex;justify-content:center;margin-bottom:8px">
      <div style="width:60px;height:60px;border-radius:50%;overflow:hidden;border:2px solid var(--accent);box-shadow:0 0 15px rgba(255,107,43,0.3)">
        <img src="mario.jpg" alt="Maestro Mario" style="width:100%;height:100%;object-fit:cover">
      </div>
    </div>
    
    <!-- Mario's personal message -->
    <div class="pw-title" style="font-size:17px" id="pwTitle">Â¡Hey, tÃ©cnico!</div>
    <div style="background:var(--card2);border-radius:12px;padding:12px;margin:8px 0;text-align:left;font-size:13px;line-height:1.6;color:var(--txt);border-left:3px solid var(--accent)">
      <span id="pwMarioMsg">Esta es una herramienta poderosa que te puede cambiar la carrera. ðŸš€ Con AI Premium desbloqueas mÃ¡s de 10,000 preguntas, videos personalizados, y yo te guÃ­o con inteligencia artificial. PregÃºntame lo que necesites del campo â€” diagnÃ³sticos, cÃ³digos, herramientas. Recibes 50,000 caracteres de AI por mes, como tener un mentor 24/7.</span>
    </div>

    <!-- Benefits -->
    <div class="pw-features" style="margin:10px 0" id="pwFeatures">
      <div class="pw-feature"><span>ðŸ“š</span> 10,000+ preguntas de prÃ¡ctica con explicaciones detalladas</div>
      <div class="pw-feature"><span>ðŸ¤–</span> Chat con Mario AI â€” hazme preguntas de campo y te busco la respuesta</div>
      <div class="pw-feature"><span>ðŸ—£ï¸</span> Mi voz te guÃ­a mientras estudias</div>
      <div class="pw-feature"><span>ðŸŽ¥</span> Videos personalizados con enlaces directos a cada tema</div>
      <div class="pw-feature"><span>ðŸ’¬</span> 50,000 caracteres de AI por mes â€” como tener un mentor 24/7</div>
      <div class="pw-feature"><span>ðŸ“Š</span> Todo lo que aprendas aquÃ­ cuenta en Maestro ACVOLT</div>
      <div class="pw-feature"><span>ðŸ”§</span> PregÃºntame lo que sea del campo â€” diagnÃ³stico, cÃ³digos, herramientas</div>
      <div class="pw-feature"><span>ðŸ”„</span> Las DOS apps conectadas â€” un solo progreso</div>
    </div>

    <!-- Community message -->
    <div id="pwCommunity" style="background:rgba(0,212,255,0.08);border-radius:10px;padding:10px 12px;margin:8px 0;text-align:center;font-size:12px;line-height:1.5;color:var(--electric);border:1px solid rgba(0,212,255,0.15)">
      ðŸ’™ Al suscribirte ayudas a <b>ACVOLT Tech School</b> a seguir mejorando las apps, crear mÃ¡s contenido y ofrecer mejores recursos para toda la comunidad de tÃ©cnicos HVAC.
    </div>

    <div class="pw-price" style="margin-top:10px">$49 USD</div>
    <div class="pw-period" id="pwPeriod">por mes Â· cancela cuando quieras</div>
    <button class="pw-btn" onclick="startStripeCheckout()" id="pwBtn">ðŸ’³ Quiero Suscribirme</button>
    <button class="pw-close" onclick="closePaywall()" id="pwClose">Ahora no, gracias</button>
  </div>
</div>

<!-- AI PREMIUM SYSTEM + V1 USER DETECTION -->
<script>
(function(){
  var CHAR_LIMIT = 50000;
  var STRIPE_PAYMENT_LINK = 'https://buy.stripe.com/bJecN54zJ8Bic2X6If3sI0h';

  function getPremiumData(){
    try {
      var d = JSON.parse(localStorage.getItem('maestroac_ai_premium') || 'null');
      if(!d) d = { active: false, chars_used: 0, month: new Date().getMonth(), year: new Date().getFullYear() };
      var now = new Date();
      if(d.month !== now.getMonth() || d.year !== now.getFullYear()){
        d.chars_used = 0; d.month = now.getMonth(); d.year = now.getFullYear();
        savePremiumData(d);
      }
      return d;
    } catch(e){ return { active: false, chars_used: 0, month: new Date().getMonth(), year: new Date().getFullYear() }; }
  }

  function savePremiumData(d){
    try { localStorage.setItem('maestroac_ai_premium', JSON.stringify(d)); } catch(e){}
  }

  function getCharsRemaining(){
    var d = getPremiumData();
    return Math.max(0, CHAR_LIMIT - d.chars_used);
  }

  function useChars(count){
    var d = getPremiumData();
    d.chars_used += count;
    savePremiumData(d);
    updateCharsUI();
    checkCharWarnings(d);
  }

  function updateCharsUI(){
    var remaining = getCharsRemaining();
    var el = document.getElementById('aiCharsCount');
    var banner = document.getElementById('aiCharsBanner');
    if(el) el.textContent = remaining.toLocaleString();
    if(banner){
      var d = getPremiumData();
      if(d.active) banner.classList.add('show');
      else banner.classList.remove('show');
    }
  }

  function checkCharWarnings(d){
    var remaining = CHAR_LIMIT - d.chars_used;
    var pct = remaining / CHAR_LIMIT;
    var nombre = (typeof D !== 'undefined' && D.name) ? D.name : 'tÃ©cnico';
    if(remaining <= 0){
      var nextMonth = new Date(); nextMonth.setMonth(nextMonth.getMonth()+1); nextMonth.setDate(1);
      setTimeout(function(){ alert('ðŸ”’ Se acabaron tus caracteres AI este mes, '+nombre+'. Quizzes y explicaciones escritas siguen gratis. Se renuevan el '+nextMonth.toLocaleDateString('es-MX')+'.'); },500);
    } else if(pct <= 0.2 && pct > 0){
      setTimeout(function(){ alert('âš ï¸ Te quedan pocos caracteres AI ('+remaining.toLocaleString()+'), '+nombre+'. GuÃ¡rdalos para las mÃ¡s difÃ­ciles.'); },500);
    }
  }

  window.checkAIPremium = function(){
    var d = getPremiumData();
    if(!d.active){
      // Personalize Mario's message
      var nombre = (typeof D !== 'undefined' && D.name) ? D.name.split(' ')[0] : ((typeof D !== 'undefined' && D.lang === 'en') ? 'technician' : 'tÃ©cnico');
      var isEn = (typeof D !== 'undefined' && D.lang === 'en');
      var titleEl = document.getElementById('pwTitle');
      var msgEl = document.getElementById('pwMarioMsg');
      if(titleEl) titleEl.textContent = isEn ? 'Hey, ' + nombre + '! ðŸ‘‹' : 'Â¡Hey, ' + nombre + '! ðŸ‘‹';
      if(msgEl) msgEl.innerHTML = isEn
        ? 'I can see you want to keep growing â€” that says a lot about you. ðŸ’ª This is a powerful tool, <b>' + nombre + '</b>. With A.C.VOLT Premium you unlock over <b>10,000 questions</b>, personalized videos, and I personally guide you with artificial intelligence. Ask me anything about the field â€” diagnostics, codes, tools â€” I\'ll find the answer. You get <b>50,000 AI characters per month</b>, like having a mentor with you 24/7. And everything you learn here <b>counts in Maestro A.C.VOLT</b> too â€” both apps work together to take you further.'
        : 'Veo que quieres seguir avanzando â€” eso me dice mucho de ti. ðŸ’ª Esta herramienta es poderosa, <b>' + nombre + '</b>. Con ACVOLT Premium desbloqueas mÃ¡s de <b>10,000 preguntas</b>, videos personalizados, y yo personalmente te guÃ­o con inteligencia artificial. PregÃºntame lo que quieras del campo â€” diagnÃ³sticos, cÃ³digos, herramientas â€” yo te busco la respuesta. Recibes <b>50,000 caracteres de AI por mes</b>, es como tener un mentor contigo 24/7. Y todo lo que aprendas aquÃ­ <b>cuenta en Maestro ACVOLT</b> tambiÃ©n â€” las dos apps trabajan juntas para que llegues mÃ¡s lejos.';
      document.getElementById('paywallModal').classList.add('active');
      // Swap all text to English if needed
      if(isEn){
        var feat = document.getElementById('pwFeatures');
        if(feat) feat.innerHTML = '<div class="pw-feature"><span>ðŸ“š</span> 10,000+ practice questions with detailed explanations</div><div class="pw-feature"><span>ðŸ¤–</span> Chat with Mario AI â€” ask me field questions and I\'ll find the answer</div><div class="pw-feature"><span>ðŸ—£ï¸</span> My voice guides you while you study</div><div class="pw-feature"><span>ðŸŽ¥</span> personalized videos with direct links to each topic</div><div class="pw-feature"><span>ðŸ’¬</span> 50,000 AI characters per month â€” like having a mentor 24/7</div><div class="pw-feature"><span>ðŸ“Š</span> Everything you learn here counts in Maestro ACVOLT</div><div class="pw-feature"><span>ðŸ”§</span> Ask me anything â€” diagnostics, codes, tools</div><div class="pw-feature"><span>ðŸ”„</span> BOTH apps connected â€” one single progress</div>';
        var comm = document.getElementById('pwCommunity');
        if(comm) comm.innerHTML = 'ðŸ’™ By subscribing you help <b>ACVOLT Tech School</b> keep improving the apps, create more content, and offer better resources for the entire HVAC technician community.';
        var period = document.getElementById('pwPeriod');
        if(period) period.textContent = 'per month Â· cancel anytime';
        var btn = document.getElementById('pwBtn');
        if(btn) btn.innerHTML = 'ðŸ’³ Subscribe Now';
        var close = document.getElementById('pwClose');
        if(close) close.textContent = 'Not now, thanks';
      }
      // Mario speaks the message - bilingual
      var speech = isEn 
        ? 'Hey, ' + nombre + '! I can see you want to keep growing, and that says a lot about you. This is a powerful tool. With A.C.volt Premium you unlock over 10 thousand questions, personalized videos, and I personally guide you with artificial intelligence. Ask me anything about the field, diagnostics, codes, tools, I will find the answer for you. You get 50 thousand A.I. characters per month, it is like having a mentor with you 24 7. And everything you learn here counts in Maestro A.C.volt too. By subscribing you help A.C.volt Tech School keep improving the apps for the entire HVAC technician community.'
        : 'Hey, ' + nombre + '! Veo que quieres seguir avanzando, eso me dice mucho de ti. Esta herramienta es poderosa. Con A.C.volt Premium desbloqueas mÃ¡s de 10 mil preguntas, videos personalizados, y yo personalmente te guÃ­o con inteligencia artificial. PregÃºntame lo que quieras del campo, diagnÃ³sticos, cÃ³digos, herramientas, yo te busco la respuesta. Recibes 50 mil caracteres de A.I. por mes, es como tener un mentor contigo las 24 horas. Y todo lo que aprendas aquÃ­ cuenta en Maestro A.C.volt tambiÃ©n. Al suscribirte ayudas a A.C.volt Tech School a seguir mejorando las apps para toda la comunidad de tÃ©cnicos.';
      if(typeof speakText === 'function') speakText(speech);
      return false;
    }
    if(getCharsRemaining() <= 0){
      var nombre = (typeof D !== 'undefined' && D.name) ? D.name : 'tÃ©cnico';
      alert('ðŸ”’ Se acabaron tus caracteres AI este mes, '+nombre+'. Se renuevan el prÃ³ximo mes.');
      return false;
    }
    return true;
  };

  window.trackAIChars = function(text){
    if(text) useChars(text.length);
  };

  window.closePaywall = function(){
    document.getElementById('paywallModal').classList.remove('active');
    if(window.speechSynthesis) window.speechSynthesis.cancel();
  };

  window.startStripeCheckout = function(){
    window.location.href = STRIPE_PAYMENT_LINK;
  };

  function checkStripeReturn(){
    var params = new URLSearchParams(window.location.search);
    if(params.get('premium') === 'success'){
      var d = getPremiumData();
      d.active = true;
      d.activated_at = new Date().toISOString();
      savePremiumData(d);
      window.history.replaceState({}, '', window.location.pathname);
      var nombre = (typeof D !== 'undefined' && D.name) ? D.name : 'tÃ©cnico';
      setTimeout(function(){
        alert('ðŸŽ‰ Â¡Bienvenido a AI Premium, '+nombre+'! Tienes 50,000 caracteres de AI este mes. ðŸ§ ');
      }, 500);
    }
  }

  // V1 USER DETECTION
  function detectV1User(){
    try {
      var tecnico = localStorage.getItem('tecnico_user');
      if(!tecnico) return;
      var data = JSON.parse(tecnico);
      var nombre = data.nombre || data.name || '';
      if(!nombre) return;
      if(typeof D !== 'undefined' && !D.name){
        D.name = nombre;
        D.lang = 'es';
        D.level = 3;
        D.specs = ['all'];
        D.school = data.escuela || 'acvolt';
        D.goals = ['certs','diag'];
        D.gender = (typeof detectGender === 'function') ? detectGender(nombre) : 'm';
        setTimeout(function(){
          if(typeof u === 'function') u();
          if(typeof updateLanguageUI === 'function') updateLanguageUI();
          if(typeof enterStudyMode === 'function') enterStudyMode();
          if(typeof updateHub === 'function') updateHub();
          if(typeof go === 'function') go('s-hub');
          if(typeof speakText === 'function'){
            speakText('Â¡Hola '+nombre.split(' ')[0]+'! Te reconozco de Maestro ACVOLT. Â¡Bienvenido a Maestro Mario AI!');
          }
        }, 800);
      }
    } catch(e){ console.log('V1 detection:', e); }
  }

  updateCharsUI();
  checkStripeReturn();
  setTimeout(detectV1User, 1500);
})();
</script>

<!-- NOTIFICATION & REMINDER SYSTEM -->
<div id="welcomeBackOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(10,22,40,0.97);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--card);border:1px solid rgba(0,212,255,0.2);border-radius:20px;max-width:400px;width:100%;padding:24px 20px;text-align:center;animation:pwSlide 0.4s ease">
    <div style="width:70px;height:70px;border-radius:50%;overflow:hidden;border:2px solid var(--accent);margin:0 auto 12px;box-shadow:0 0 20px rgba(255,107,43,0.3)">
      <img src="mario.jpg" alt="Mario" style="width:100%;height:100%;object-fit:cover">
    </div>
    <div id="wbTitle" style="font-family:'Fredoka',sans-serif;font-size:20px;font-weight:700;color:var(--txt);margin-bottom:8px">Â¡Hey, tÃ©cnico!</div>
    <div id="wbMessage" style="background:var(--card2);border-radius:12px;padding:14px;text-align:left;font-size:14px;line-height:1.7;color:var(--txt);border-left:3px solid var(--accent);margin-bottom:16px"></div>
    <div id="wbProgress" style="font-size:13px;color:var(--electric);margin-bottom:16px"></div>
    <button onclick="closeWelcomeBack()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),#e84500);color:#fff;font-size:16px;font-weight:700;cursor:pointer;font-family:'Fredoka',sans-serif" id="wbBtn">ðŸš€ Â¡Vamos a estudiar!</button>
  </div>
</div>

<script>
(function(){
  var INACTIVITY_HOURS = 4;
  var CHECK_INTERVAL_MS = 60000; // check every minute
  var STORAGE_KEY = 'maestro_last_activity';
  var NOTIF_KEY = 'maestro_notif_sent';
  var APP_NAME = 'v2';
  var SUPABASE_ACTIVITY_URL = 'https://htklsowiyjwsjnacnvnr.supabase.co/rest/v1/rpc/update_user_activity';
  var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0a2xzb3dpeWp3c2puYWNudm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjIwMjQsImV4cCI6MjA4NjAzODAyNH0.6A3F7MI4YJEMo98b4Zfzao9p_hMh2T0ha0dRJ4SUhv0';
  var lastSyncTime = 0;
  var SYNC_INTERVAL = 300000; // sync to Supabase every 5 minutes max

  // ===== SUPABASE ACTIVITY SYNC =====
  function syncActivityToSupabase(){
    var now = Date.now();
    if(now - lastSyncTime < SYNC_INTERVAL) return; // throttle
    lastSyncTime = now;

    try {
      var nombre = 'tÃ©cnico';
      var email = null;
      var telefono = null;
      var lang = 'es';
      var quizCount = 0;
      var bestScore = null;
      var premium = false;

      try { nombre = D.name || 'tÃ©cnico'; } catch(e){}
      try { lang = D.lang || 'es'; } catch(e){}
      try { email = D.email || null; } catch(e){}
      try { telefono = D.telefono || D.phone || null; } catch(e){}
      try {
        var scores = JSON.parse(localStorage.getItem('maestro_quiz_scores')||'{}');
        quizCount = Object.keys(scores).length;
        var vals = Object.values(scores);
        bestScore = vals.length ? Math.max.apply(null, vals) : null;
      } catch(e){}
      try { premium = !!JSON.parse(localStorage.getItem('ai_premium_data')||'{}').active; } catch(e){}

      // Only sync if we have an email
      if(!email) {
        // Try to get from tecnico_user
        try { 
          var tu = JSON.parse(localStorage.getItem('tecnico_user')||'{}');
          email = tu.email || null;
          if(!nombre || nombre === 'tÃ©cnico') nombre = tu.nombre || nombre;
          telefono = telefono || tu.telefono || null;
        } catch(e){}
      }

      if(!email) return; // can't sync without email

      fetch(SUPABASE_ACTIVITY_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
        },
        body: JSON.stringify({
          p_nombre: nombre,
          p_email: email,
          p_telefono: telefono,
          p_lang: lang,
          p_app: APP_NAME,
          p_quiz_score: bestScore,
          p_quizzes: quizCount,
          p_premium: premium
        })
      }).catch(function(e){ console.log('Activity sync error:', e); });
    } catch(e){ console.log('Sync prep error:', e); }
  }

  // ===== ACTIVITY TRACKING =====
  function updateActivity(){
    var now = Date.now();
    localStorage.setItem(STORAGE_KEY, now.toString());
    localStorage.removeItem(NOTIF_KEY); // reset notification flag on activity
    syncActivityToSupabase(); // sync to Supabase (throttled)
  }

  function getLastActivity(){
    var t = localStorage.getItem(STORAGE_KEY);
    return t ? parseInt(t) : Date.now();
  }

  function getInactiveHours(){
    return (Date.now() - getLastActivity()) / (1000 * 60 * 60);
  }

  // Track user activity
  var activityEvents = ['click','keydown','scroll','touchstart'];
  activityEvents.forEach(function(ev){
    document.addEventListener(ev, updateActivity, {passive:true});
  });
  updateActivity(); // mark activity on load

  // ===== BROWSER NOTIFICATIONS =====
  function requestNotifPermission(){
    if('Notification' in window && Notification.permission === 'default'){
      // Ask after 30 seconds of using app
      setTimeout(function(){
        Notification.requestPermission();
      }, 30000);
    }
  }

  function sendBrowserNotification(title, body){
    if('Notification' in window && Notification.permission === 'granted'){
      try {
        var n = new Notification(title, {
          body: body,
          icon: 'mario.jpg',
          badge: 'mario.jpg',
          tag: 'maestro-reminder',
          renotify: true
        });
        n.onclick = function(){ window.focus(); n.close(); };
      } catch(e){ console.log('Notif error:', e); }
    }
  }

  // ===== INACTIVITY CHECKER (runs while tab is open/background) =====
  function checkInactivity(){
    var hours = getInactiveHours();
    var alreadySent = localStorage.getItem(NOTIF_KEY);
    
    if(hours >= INACTIVITY_HOURS && !alreadySent){
      localStorage.setItem(NOTIF_KEY, 'true');
      
      var nombre = 'tÃ©cnico';
      try { nombre = D.name ? D.name.split(' ')[0] : 'tÃ©cnico'; } catch(e){}
      var isEn = false;
      try { isEn = D.lang === 'en'; } catch(e){}

      // Send browser notification if tab is in background
      if(document.hidden){
        var notifTitle = isEn ? 'Hey ' + nombre + '! ðŸ“š' : 'Â¡Hey ' + nombre + '! ðŸ“š';
        var notifBody = isEn 
          ? 'You haven\'t studied in ' + Math.floor(hours) + ' hours. Maestro Mario is waiting for you!'
          : 'Llevas ' + Math.floor(hours) + ' horas sin estudiar. Â¡El Maestro Mario te espera!';
        sendBrowserNotification(notifTitle, notifBody);
      }
    }
  }

  setInterval(checkInactivity, CHECK_INTERVAL_MS);

  // ===== WELCOME BACK SCREEN =====
  function showWelcomeBack(){
    var hours = getInactiveHours();
    if(hours < INACTIVITY_HOURS) return;

    var nombre = 'tÃ©cnico';
    var isEn = false;
    var quizCount = 0;
    var bestScore = 0;
    
    try { nombre = D.name ? D.name.split(' ')[0] : 'tÃ©cnico'; } catch(e){}
    try { isEn = D.lang === 'en'; } catch(e){}
    try { 
      var scores = JSON.parse(localStorage.getItem('maestro_quiz_scores')||'{}');
      quizCount = Object.keys(scores).length;
      var vals = Object.values(scores);
      bestScore = vals.length ? Math.max.apply(null, vals) : 0;
    } catch(e){}

    var hoursAway = Math.floor(hours);
    var daysAway = Math.floor(hours / 24);
    var timeText = '';
    
    if(isEn){
      timeText = daysAway >= 1 ? daysAway + ' day' + (daysAway>1?'s':'') : hoursAway + ' hour' + (hoursAway>1?'s':'');
    } else {
      timeText = daysAway >= 1 ? daysAway + ' dÃ­a' + (daysAway>1?'s':'') : hoursAway + ' hora' + (hoursAway>1?'s':'');
    }

    // Pick motivational message based on context
    var messages_es = [
      'Â¡' + nombre + ', te extraÃ±aba! Llevas ' + timeText + ' sin estudiar. Recuerda: la consistencia es mÃ¡s importante que la perfecciÃ³n. Cada dÃ­a que estudias es un dÃ­a mÃ¡s cerca de tu meta. Â¡Vamos con todo!',
      'Â¡' + nombre + '! Ya pasaron ' + timeText + '. Un tÃ©cnico que no practica se oxida como un contacto sin mantenimiento. Â¡Vamos a repasar y mantener ese conocimiento afilado!',
      'Â¡Ã“rale, ' + nombre + '! ' + timeText + ' sin estudiar es mucho tiempo. Los mejores tÃ©cnicos practican todos los dÃ­as. Â¡Yo sÃ© que tÃº puedes, vamos a darle!',
      'Â¡' + nombre + ', bienvenido de vuelta! ' + timeText + ' lejos es bastante. Pero lo bueno es que regresaste â€” eso dice mucho de ti. Â¡Ahora sÃ­, a darle con todo!'
    ];
    var messages_en = [
      nombre + ', I missed you! It\'s been ' + timeText + ' since you last studied. Remember: consistency beats perfection. Every day you study is a day closer to your goal. Let\'s go!',
      nombre + '! ' + timeText + ' have passed. A technician who doesn\'t practice gets rusty like an unmaintained contact. Let\'s review and keep that knowledge sharp!',
      'Hey ' + nombre + '! ' + timeText + ' without studying is too long. The best techs practice every day. I know you can do it, let\'s get to work!',
      nombre + ', welcome back! ' + timeText + ' away is a lot. But the good thing is you came back â€” that says a lot about you. Now let\'s hit it hard!'
    ];

    var msgs = isEn ? messages_en : messages_es;
    var msg = msgs[Math.floor(Math.random() * msgs.length)];

    // Progress info
    var progressHtml = '';
    if(quizCount > 0){
      progressHtml = isEn 
        ? 'ðŸ“Š You\'ve completed <b>' + quizCount + ' quiz' + (quizCount>1?'zes':'') + '</b> with a best score of <b>' + bestScore + '%</b>. Keep it up!'
        : 'ðŸ“Š Has completado <b>' + quizCount + ' quiz' + (quizCount>1?'zes':'') + '</b> con tu mejor score de <b>' + bestScore + '%</b>. Â¡Sigue asÃ­!';
    } else {
      progressHtml = isEn
        ? 'ðŸ“ You haven\'t taken any quizzes yet. Today is a great day to start!'
        : 'ðŸ“ AÃºn no has tomado ningÃºn quiz. Â¡Hoy es un gran dÃ­a para empezar!';
    }

    document.getElementById('wbTitle').textContent = isEn ? 'Welcome back, ' + nombre + '! ðŸ‘‹' : 'Â¡Bienvenido de vuelta, ' + nombre + '! ðŸ‘‹';
    document.getElementById('wbMessage').innerHTML = msg;
    document.getElementById('wbProgress').innerHTML = progressHtml;
    document.getElementById('wbBtn').textContent = isEn ? 'ðŸš€ Let\'s study!' : 'ðŸš€ Â¡Vamos a estudiar!';
    
    var overlay = document.getElementById('welcomeBackOverlay');
    overlay.style.display = 'flex';

    // Mario speaks
    if(typeof speakText === 'function') speakText(msg);
  }

  window.closeWelcomeBack = function(){
    document.getElementById('welcomeBackOverlay').style.display = 'none';
    if(window.speechSynthesis) window.speechSynthesis.cancel();
    updateActivity();
  };

  // ===== REGISTER SERVICE WORKER FOR BACKGROUND NOTIFICATIONS =====
  if('serviceWorker' in navigator){
    // Create inline service worker
    var swCode = 'self.addEventListener("push",function(e){var d=e.data?e.data.json():{};self.registration.showNotification(d.title||"Maestro Mario",{body:d.body||"Es hora de estudiar!",icon:"mario.jpg",tag:"maestro-reminder"});});';
    var swBlob = new Blob([swCode], {type:'application/javascript'});
    var swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(function(){});
  }

  // ===== INIT =====
  requestNotifPermission();
  
  // Show welcome back after a short delay (let app load first)
  setTimeout(function(){
    showWelcomeBack();
  }, 2000);

})();
</script>

</body>
</html>
