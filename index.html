<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maestro Mario - HVAC Training App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--accent:#ff6b2b;--electric:#00d4ff;--gold:#f1c40f;--dark:#0a1628;--card:#111d33;--card2:#162440;--txt:#e8f0ff;--muted:#7a93b8;--r:16px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Nunito',sans-serif;background:var(--dark);color:var(--txt);min-height:100vh;min-height:100dvh;overflow-x:hidden}
        .bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
        .bg .o{position:absolute;border-radius:50%;filter:blur(90px);opacity:.12;animation:d 22s ease-in-out infinite}
        .bg .o:nth-child(1){width:420px;height:420px;background:var(--accent);top:-120px;left:-120px}
        .bg .o:nth-child(2){width:360px;height:360px;background:var(--electric);bottom:-100px;right:-100px;animation-delay:-8s}
        .bg .o:nth-child(3){width:280px;height:280px;background:#6366f1;top:40%;left:40%;animation-delay:-15s}
        @keyframes d{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-30px) scale(1.08)}66%{transform:translate(-20px,20px) scale(.92)}}
        .gr{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,212,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.025) 1px,transparent 1px);background-size:44px 44px}
        .app{position:relative;z-index:1;max-width:460px;margin:0 auto;min-height:100vh;min-height:100dvh;padding:16px 18px;display:flex;flex-direction:column}
        .s{display:none;flex-direction:column;align-items:center;flex:1;animation:si .55s cubic-bezier(.16,1,.3,1)}
        .s.on{display:flex}
        @keyframes si{from{opacity:0;transform:translateY(36px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
        
        /* VIDEO FLOTANTE DESDE LA DERECHA */
        .video-float{position:fixed;bottom:120px;right:-320px;z-index:900;width:280px;transition:right 0.5s cubic-bezier(.16,1,.3,1);pointer-events:none}
        .video-float.active{right:16px;pointer-events:auto}
        .video-float.hiding{right:-320px}
        .video-float-inner{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 10px 40px rgba(255,107,43,0.5),0 0 0 3px var(--accent);background:#000}
        .video-float video{width:100%;display:block;border-radius:17px}
        .video-float-label{position:absolute;top:10px;left:10px;background:rgba(255,107,43,0.9);color:white;font-family:'Fredoka',sans-serif;font-size:11px;font-weight:700;padding:4px 10px;border-radius:12px;display:flex;align-items:center;gap:6px}
        .video-float-label::before{content:'';width:8px;height:8px;border-radius:50%;background:white;animation:blink 1s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .video-float-close{position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,0.6);border:none;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .video-float-close:hover{background:var(--accent)}
        .video-float-glow{position:absolute;inset:-3px;border-radius:23px;background:conic-gradient(var(--accent),var(--electric),var(--gold),var(--accent));z-index:-1;animation:sp 3s linear infinite}
        
        /* BOTON DE MUSICA */
        .music-btn{position:fixed;top:16px;right:16px;z-index:500;width:50px;height:50px;border-radius:50%;background:var(--card);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(255,107,43,0.3)}
        .music-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(255,107,43,0.5)}
        .music-btn .icon{font-size:22px}
        .music-btn.muted{border-color:var(--muted);opacity:0.6}
        .music-btn.muted .icon{opacity:0.5}
        
        /* MODAL AI CHAT */
        .ai-modal{position:fixed;inset:0;z-index:600;background:rgba(10,22,40,0.95);display:flex;align-items:flex-end;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s}
        .ai-modal.active{opacity:1;visibility:visible}
        .ai-chat{width:100%;max-width:460px;height:75vh;background:var(--card);border-radius:24px 24px 0 0;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.4s cubic-bezier(.16,1,.3,1)}
        .ai-modal.active .ai-chat{transform:translateY(0)}
        .ai-chat-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:12px}
        .ai-chat-avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid var(--accent)}
        .ai-chat-avatar img{width:100%;height:100%;object-fit:cover}
        .ai-chat-title{flex:1}
        .ai-chat-title h3{font-family:'Fredoka',sans-serif;font-size:17px;color:var(--txt)}
        .ai-chat-title span{font-size:12px;color:var(--electric)}
        .ai-chat-close{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:var(--txt);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .ai-chat-close:hover{background:var(--accent)}
        .ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
        .ai-msg{max-width:85%;padding:14px 18px;border-radius:18px;font-size:15px;line-height:1.5}
        .ai-msg.mario{background:linear-gradient(135deg,rgba(255,107,43,0.2),rgba(0,212,255,0.1));border:1px solid rgba(255,107,43,0.3);align-self:flex-start;border-bottom-left-radius:4px}
        .ai-msg.user{background:var(--card2);align-self:flex-end;border-bottom-right-radius:4px}
        .ai-chat-input{padding:16px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px}
        .ai-chat-input input{flex:1;padding:14px 18px;border-radius:25px;border:2px solid rgba(255,255,255,0.1);background:var(--dark);color:var(--txt);font-size:15px;outline:none}
        .ai-chat-input input:focus{border-color:var(--accent)}
        .ai-chat-input button{width:50px;height:50px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:22px;cursor:pointer}
        
        /* CONFETTI */
        .cw{position:fixed;inset:0;pointer-events:none;z-index:100}.cf{position:absolute;top:-16px;animation:cff 2.8s ease-out forwards}
        @keyframes cff{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
        
        /* AVATAR - CLICKEABLE PARA ABRIR AI */
        .aw{position:relative;margin:16px auto 12px;cursor:pointer;transition:transform 0.3s}
        .aw:hover{transform:scale(1.05)}
        .aw.lg{width:190px;height:190px}.aw.md{width:140px;height:140px}.aw.sm{width:120px;height:120px}
        .ar{position:absolute;inset:-6px;border-radius:50%;background:conic-gradient(var(--accent),var(--electric),var(--accent));animation:sp 4s linear infinite}
        @keyframes sp{to{transform:rotate(360deg)}}
        .ag{position:absolute;inset:-20px;border-radius:50%;background:radial-gradient(circle,var(--accent) 0%,transparent 70%);opacity:.25;animation:pu 3s ease-in-out infinite}
        @keyframes pu{0%,100%{transform:scale(1);opacity:.25}50%{transform:scale(1.12);opacity:.4}}
        .ai{position:relative;width:100%;height:100%;border-radius:50%;overflow:hidden;border:4px solid var(--dark);animation:fl 4.5s ease-in-out infinite}
        .ai img{width:100%;height:100%;object-fit:cover}
        @keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .aw.nod .ai{animation:nd .5s ease-in-out 2}
        @keyframes nd{0%,100%{transform:rotate(0)}30%{transform:rotate(5deg)}70%{transform:rotate(-3deg)}}
        .aw.cel .ai{animation:ce .6s ease-in-out 2}
        @keyframes ce{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-18px) scale(1.06)}}
        
        /* INDICADOR DE AI EN AVATAR */
        .aw::after{content:'Toca para preguntar';position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);background:var(--accent);color:white;font-family:'Fredoka',sans-serif;font-size:11px;padding:4px 12px;border-radius:12px;white-space:nowrap;opacity:0;transition:opacity 0.3s}
        .aw:hover::after{opacity:1}
        
        /* BURBUJA */
        .bb{background:var(--card);border:1.5px solid rgba(0,212,255,.15);border-radius:var(--r);padding:18px 22px;margin:0 6px 20px;position:relative;box-shadow:0 6px 28px rgba(0,0,0,.25);text-align:center;font-size:16.5px;line-height:1.55;font-weight:600;min-height:60px}
        .bb::before{content:'';position:absolute;top:-10px;left:50%;transform:translateX(-50%);border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid rgba(0,212,255,.15)}
        .bb::after{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid var(--card)}
        
        /* OTROS */
        .lo{text-align:center;padding:4px 0}.lo-t{font-family:'Fredoka',sans-serif;font-size:26px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.lo-s{font-size:12px;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:2px}
        .pb{width:100%;height:5px;background:rgba(255,255,255,.06);border-radius:3px;margin:12px 0 6px;overflow:hidden}.pbf{height:100%;background:linear-gradient(90deg,var(--accent),var(--electric));border-radius:3px;transition:width .6s}
        .ps{font-size:12px;color:var(--muted);margin-bottom:12px;text-align:center}.ps b{color:var(--accent)}
        .os{width:100%;display:flex;flex-direction:column;gap:10px}
        .oc{background:var(--card);border:2px solid rgba(255,255,255,.06);border-radius:var(--r);padding:16px 18px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:14px}
        .oc:hover{border-color:rgba(255,107,43,.4);background:var(--card2);transform:translateY(-1px)}
        .oc.sel{border-color:var(--accent);background:linear-gradient(135deg,rgba(255,107,43,.12),rgba(0,212,255,.06))}
        .oi{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;transition:all .25s}
        .oc.sel .oi{background:var(--accent);transform:scale(1.08)}
        .ot{font-family:'Fredoka',sans-serif;font-size:15px;font-weight:600}.od{font-size:12.5px;color:var(--muted);margin-top:1px}
        .ck{width:22px;height:22px;border-radius:7px;border:2px solid rgba(255,255,255,.12);margin-left:auto;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:white}
        .oc.sel .ck{background:var(--accent);border-color:var(--accent)}.oc.sel .ck::after{content:'âœ“'}
        .mh{font-size:12.5px;color:var(--muted);text-align:center;margin-bottom:8px}
        .fl{display:flex;gap:18px;justify-content:center;margin-top:16px}
        .fc{width:135px;height:155px;background:var(--card);border:2.5px solid rgba(255,255,255,.06);border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer;transition:all .3s}
        .fc:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 10px 28px rgba(255,107,43,.18)}
        .fe{font-size:42px;line-height:1}.fn{font-family:'Fredoka',sans-serif;font-size:17px;font-weight:600}
        .bt{width:100%;padding:16px;border:none;border-radius:var(--r);background:linear-gradient(135deg,var(--accent),#e84500);color:white;font-family:'Fredoka',sans-serif;font-size:17px;font-weight:700;cursor:pointer;margin-top:20px;transition:all .25s;box-shadow:0 4px 18px rgba(255,107,43,.25)}
        .bt:hover{transform:translateY(-2px);box-shadow:0 7px 24px rgba(255,107,43,.35)}.bt:disabled{opacity:.35;cursor:not-allowed;transform:none}
        .ip{width:100%;padding:16px 18px;border:2px solid rgba(255,255,255,.06);border-radius:var(--r);background:var(--card);color:var(--txt);font-size:16px;font-weight:600;outline:none}.ip:focus{border-color:var(--accent)}.ip::placeholder{color:var(--muted)}
        .sp{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;text-align:center}
        .sp-t{font-family:'Fredoka',sans-serif;font-size:40px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--electric));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.15}
        .sp-s{font-size:17px;color:var(--muted);max-width:280px}
        .badge{display:inline-flex;align-items:center;gap:7px;background:rgba(255,107,43,.1);border:1px solid rgba(255,107,43,.25);border-radius:28px;padding:5px 14px;font-family:'Fredoka',sans-serif;font-size:13px;color:var(--accent)}
        .rt{background:var(--card);border:1.5px solid rgba(0,212,255,.12);border-radius:var(--r);padding:16px 18px;margin-bottom:10px;display:flex;align-items:center;gap:14px;animation:ri .5s ease-out backwards}
        @keyframes ri{from{opacity:0;transform:translateX(-24px)}to{opacity:1;transform:translateX(0)}}
        .rn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--electric));display:flex;align-items:center;justify-content:center;font-family:'Fredoka',sans-serif;font-weight:700;font-size:16px;flex-shrink:0}
        .rtt{font-family:'Fredoka',sans-serif;font-size:14.5px;font-weight:600}.rd{font-size:12px;color:var(--muted)}
        .rl{width:2px;height:16px;background:linear-gradient(var(--accent),var(--electric));margin-left:35px;border-radius:2px}
        .typing{display:inline-flex;gap:4px;align-items:center;padding:4px 0}
        .typing .dot{width:8px;height:8px;border-radius:50%;background:var(--electric);animation:tblink 1.4s infinite both}
        .typing .dot:nth-child(2){animation-delay:.2s}.typing .dot:nth-child(3){animation-delay:.4s}
        @keyframes tblink{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
    </style>
</head>
<body>
<div class="bg"><div class="o"></div><div class="o"></div><div class="o"></div></div>
<div class="gr"></div>

<!-- BOTON MUSICA -->
<div class="music-btn muted" id="musicBtn" onclick="toggleMusic()">
    <span class="icon">ðŸŽµ</span>
</div>

<!-- VIDEO FLOTANTE DESDE LA DERECHA -->
<div class="video-float" id="videoFloat">
    <div class="video-float-glow"></div>
    <div class="video-float-inner">
        <div class="video-float-label">EN VIVO</div>
        <button class="video-float-close" onclick="closeVideo()">âœ•</button>
        <video id="marioVideo" playsinline webkit-playsinline></video>
    </div>
</div>

<!-- MODAL AI CHAT -->
<div class="ai-modal" id="aiModal">
    <div class="ai-chat">
        <div class="ai-chat-header">
            <div class="ai-chat-avatar"><img src="mario.jpg" alt="Mario"></div>
            <div class="ai-chat-title"><h3>Maestro Mario AI</h3><span>ðŸŸ¢ Disponible para ayudarte</span></div>
            <button class="ai-chat-close" onclick="closeAIChat()">âœ•</button>
        </div>
        <div class="ai-chat-messages" id="aiMessages">
            <div class="ai-msg mario">Â¡Ã“rale tÃ©cnico! Soy el Maestro Mario con inteligencia artificial. Â¿En quÃ© te puedo ayudar? PregÃºntame lo que quieras sobre HVAC, refrigeraciÃ³n, o electricidad. ðŸ”§</div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiInput" placeholder="Escribe tu pregunta..." onkeydown="if(event.key==='Enter')sendAIMessage()">
            <button onclick="sendAIMessage()">âž¤</button>
        </div>
    </div>
</div>

<!-- AUDIO MUSICA DE FONDO -->
<audio id="bgMusic" loop preload="auto">
    <source src="musica.mp3" type="audio/mpeg">
</audio>

<div class="app">
<!-- PANTALLA INICIO -->
<div class="s on" id="s0"><div class="sp">
    <div class="aw lg" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="Maestro Mario"></div></div>
    <div><div class="sp-t">MAESTRO<br>MARIO</div><div class="badge">âš¡ NIVEL 33</div></div>
    <div class="sp-s">Si no mides, estÃ¡s adivinando</div>
    <button class="bt" onclick="startWithVideo()" style="max-width:260px">Comenzar / Start</button>
</div></div>

<!-- IDIOMA -->
<div class="s" id="s1">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div><div class="lo-s">HVAC â€¢ ELECTRICAL â€¢ TRAINING</div></div>
    <div class="aw md" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb">Â¡Hola! Choose your language<br>Elige tu idioma</div>
    <div class="fl"><div class="fc" onclick="setLang('es')"><span class="fe">ðŸ‡²ðŸ‡½</span><span class="fn">EspaÃ±ol</span></div><div class="fc" onclick="setLang('en')"><span class="fe">ðŸ‡ºðŸ‡¸</span><span class="fn">English</span></div></div>
</div>

<!-- NOMBRE -->
<div class="s" id="s2">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:20%"></div></div><div class="ps"><b data-t="step_1"></b></div>
    <div class="aw md" id="a2" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb" id="bb2"><span data-t="welcome_speech"></span></div>
    <div style="width:100%"><input class="ip" id="nm" data-tp="name_ph" oninput="document.getElementById('b2').disabled=this.value.trim().length<2"><button class="bt" id="b2" disabled onclick="sName()" data-t="continue"></button></div>
</div>

<!-- NIVEL -->
<div class="s" id="s3">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:40%"></div></div><div class="ps"><b data-t="step_2"></b></div>
    <div class="aw sm" id="a3" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb" id="bb3"><span data-t="level_speech"></span></div>
    <div class="os" id="lo"></div>
    <button class="bt" id="b3" disabled onclick="sLvl()" data-t="continue"></button>
</div>

<!-- ESPECIALIDADES -->
<div class="s" id="s4">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:60%"></div></div><div class="ps"><b data-t="step_3"></b></div>
    <div class="aw sm" id="a4" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb" id="bb4"><span data-t="spec_speech"></span></div>
    <p class="mh" data-t="multi_hint"></p>
    <div class="os" id="so"></div>
    <button class="bt" id="b4" disabled onclick="sSpc()" data-t="continue"></button>
</div>

<!-- ESCUELA -->
<div class="s" id="s5">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:80%"></div></div><div class="ps"><b data-t="step_4"></b></div>
    <div class="aw sm" id="a5" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb" id="bb5"><span data-t="school_speech"></span></div>
    <div class="os" id="sco"></div>
    <button class="bt" id="b5" disabled onclick="sSch()" data-t="continue"></button>
</div>

<!-- METAS -->
<div class="s" id="s6">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:90%"></div></div><div class="ps"><b data-t="step_5"></b></div>
    <div class="aw sm" id="a6" onclick="openAIChat()"><div class="ag"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb" id="bb6"><span data-t="goals_speech"></span></div>
    <p class="mh" data-t="multi_hint"></p>
    <div class="os" id="go2"></div>
    <button class="bt" id="b6" disabled onclick="sGol()" data-t="continue"></button>
</div>

<!-- RUTA FINAL -->
<div class="s" id="s7">
    <div class="lo"><div class="lo-t">MAESTRO MARIO</div></div>
    <div class="pb"><div class="pbf" style="width:100%"></div></div>
    <div class="aw md" id="a7" onclick="openAIChat()"><div class="ag" style="background:radial-gradient(circle,var(--gold) 0%,transparent 70%)"></div><div class="ar"></div><div class="ai"><img src="mario.jpg" alt="M"></div></div>
    <div class="bb" id="bb7"><span data-t="route_speech"></span></div>
    <div id="rl" style="width:100%"></div>
    <button class="bt" onclick="startApp()" data-t="start_btn"></button>
</div>
</div>
<div class="cw" id="conf"></div>

<script>
const D={lang:'es',name:'',level:null,specs:[],school:null,goals:[]};
let videoPlaying=false;
let musicPlaying=false;
let currentVideoCallback=null;

const VIDEOS={
    bienvenida:'bienvenida.mp4',
    correcto:'correcto.mp4.mp4',
    incorrecto:'incorrecto.mp4.mp4',
    medalla:'medalla.mp4.mp4'
};

const bgMusic=document.getElementById('bgMusic');
bgMusic.volume=0.3;

function toggleMusic(){
    const btn=document.getElementById('musicBtn');
    if(musicPlaying){
        bgMusic.pause();
        btn.classList.add('muted');
        musicPlaying=false;
    }else{
        bgMusic.play().catch(e=>console.log('Music blocked'));
        btn.classList.remove('muted');
        musicPlaying=true;
    }
}

function showVideo(type,cb){
    if(videoPlaying)return;
    videoPlaying=true;
    currentVideoCallback=cb;
    const vf=document.getElementById('videoFloat');
    const v=document.getElementById('marioVideo');
    v.src=VIDEOS[type]||VIDEOS.bienvenida;
    v.load();
    vf.classList.add('active');
    vf.classList.remove('hiding');
    v.play().catch(e=>{console.log('Video error:',e);closeVideo();});
    v.onended=function(){closeVideo();};
    v.onerror=function(){closeVideo();};
}

function closeVideo(){
    const vf=document.getElementById('videoFloat');
    const v=document.getElementById('marioVideo');
    vf.classList.add('hiding');
    vf.classList.remove('active');
    setTimeout(()=>{
        v.pause();
        v.src='';
        videoPlaying=false;
        if(currentVideoCallback){
            currentVideoCallback();
            currentVideoCallback=null;
        }
    },500);
}

function startWithVideo(){
    showVideo('bienvenida',()=>{
        go('s1');
    });
}

// AI CHAT - Solo se abre cuando tocan el cÃ­rculo grande
const MARIO_SYSTEM="Eres el Maestro Mario Flores Corona, instructor de HVAC/Refrigeracion/Electricidad con 25+ aÃ±os. Tu escuela es ACVOLT Tech School. Tu frase: Si no mides, estÃ¡s adivinando. Responde en 2-3 oraciones MAX. Usa frases como Ã³rale, vamos con todo. NO uses markdown.";

async function askMarioAI(msg){
    try{
        const r=await fetch('https://htklsowiyjwsjnacnvnr.supabase.co/functions/v1/tutor-ia-chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:200,system:MARIO_SYSTEM,messages:[{role:'user',content:msg}]})
        });
        const d=await r.json();
        return d.content&&d.content[0]?d.content[0].text:'Â¡Ã“rale! Problema tÃ©cnico, intenta de nuevo.';
    }catch(e){return 'Â¡Ã“rale! Problema de conexiÃ³n.';}
}

function openAIChat(){
    document.getElementById('aiModal').classList.add('active');
}

function closeAIChat(){
    document.getElementById('aiModal').classList.remove('active');
}

async function sendAIMessage(){
    const input=document.getElementById('aiInput');
    const msgs=document.getElementById('aiMessages');
    const txt=input.value.trim();
    if(!txt)return;
    msgs.innerHTML+='<div class="ai-msg user">'+txt+'</div>';
    input.value='';
    msgs.innerHTML+='<div class="ai-msg mario" id="typing"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
    msgs.scrollTop=msgs.scrollHeight;
    const resp=await askMarioAI(txt);
    const typing=document.getElementById('typing');
    if(typing)typing.remove();
    msgs.innerHTML+='<div class="ai-msg mario">'+resp+'</div>';
    msgs.scrollTop=msgs.scrollHeight;
}

// CONFETTI
function cft(){
    const c=document.getElementById('conf');
    const cols=['#ff6b2b','#00d4ff','#f1c40f','#2ecc71','#e74c3c','#9b59b6'];
    for(let i=0;i<55;i++){
        const p=document.createElement('div');
        p.className='cf';
        p.style.left=Math.random()*100+'%';
        p.style.background=cols[Math.floor(Math.random()*cols.length)];
        p.style.animationDelay=Math.random()*1.8+'s';
        p.style.animationDuration=(2+Math.random()*2)+'s';
        p.style.width=(6+Math.random()*7)+'px';
        p.style.height=p.style.width;
        p.style.borderRadius=Math.random()>.5?'50%':'2px';
        c.appendChild(p);
    }
    setTimeout(()=>c.innerHTML='',4500);
}

// TRANSLATIONS
const T={
es:{step_1:'Paso 1 de 5',step_2:'Paso 2 de 5',step_3:'Paso 3 de 5',step_4:'Paso 4 de 5',step_5:'Paso 5 de 5',welcome_speech:'Â¡Bienvenido tÃ©cnico! Soy el Maestro Mario y voy a ser tu guÃ­a. Â¿CÃ³mo te llamas?',name_ph:'Escribe tu nombre aquÃ­...',continue:'Continuar â†’',level_speech:'Â¡Mucho gusto, {name}! Â¿En quÃ© nivel tÃ©cnico te encuentras?',spec_speech:'Â¡Excelente, {name}! Â¿En quÃ© Ã¡reas te sientes mÃ¡s fuerte?',multi_hint:'Selecciona una o mÃ¡s opciones',school_speech:'Â¡Vas muy bien, {name}! Â¿DÃ³nde estÃ¡s estudiando?',goals_speech:'Â¡Ãšltima pregunta, {name}! Â¿QuÃ© quieres lograr?',route_speech:'Â¡Perfecto, {name}! He creado tu ruta personalizada. Â¡Vamos con todo!',start_btn:'ðŸš€ Â¡Empezar a Aprender!',lv1:'Estudiante',lv1d:'Estoy aprendiendo lo bÃ¡sico',lv2:'Ayudante',lv2d:'Ya ando en el campo con un tÃ©cnico',lv3:'TÃ©cnico',lv3d:'Ya trabajo solo pero quiero mejorar',lv4:'Avanzado',lv4d:'Quiero dominar el oficio',lv5:'Maestro',lv5d:'Quiero ser lÃ­der / abrir mi empresa',sp_e:'Electricidad',sp_ed:'Circuitos, controles, cableado',sp_a:'Aire Acondicionado',sp_ad:'Splits, centrales, mini splits',sp_r:'RefrigeraciÃ³n',sp_rd:'CÃ¡maras frÃ­as, refrigeradores comerciales',sp_h:'CalefacciÃ³n',sp_hd:'Furnaces, bombas de calor',sp_x:'Estoy empezando en todo',sp_xd:'Quiero aprender de todo',sc_ac:'ACVOLT Tech School',sc_acd:'Estudiante actual de ACVOLT',sc_ot:'Otra escuela',sc_otd:'Estoy en otra instituciÃ³n',sc_sf:'Aprendo por mi cuenta',sc_sfd:'YouTube, libros, campo',sc_dn:'Ya terminÃ© mis estudios',sc_dnd:'Tengo certificaciÃ³n/diploma',gl_c:'Pasar mis certificaciones',gl_cd:'EPA, NATE, OSHA, NCCER',gl_d:'Mejorar mis diagnÃ³sticos',gl_dd:'Ser mÃ¡s preciso en el campo',gl_b:'Abrir mi propio negocio',gl_bd:'De tÃ©cnico a empresario',gl_m:'Ganar mÃ¡s dinero',gl_md:'Subir mi valor como tÃ©cnico',r_elec:'Fundamentos ElÃ©ctricos',r_elecd:'Circuitos, Ley de Ohm, diagramas',r_ac:'Aire Acondicionado',r_acd:'Presiones, carga de refrigerante',r_ref:'RefrigeraciÃ³n Comercial',r_refd:'CÃ¡maras frÃ­as, controles, defrost',r_heat:'CalefacciÃ³n',r_heatd:'Furnaces, bombas de calor, gas',r_cert:'PreparaciÃ³n para Certificaciones',r_certd:'EPA 608 â€¢ NATE â€¢ OSHA â€¢ NCCER',r_biz:'De TÃ©cnico a Empresario',r_bizd:'Licencias, estimados, clientes'},
en:{step_1:'Step 1 of 5',step_2:'Step 2 of 5',step_3:'Step 3 of 5',step_4:'Step 4 of 5',step_5:'Step 5 of 5',welcome_speech:"Welcome technician! I'm Maestro Mario and I'll be your guide. What's your name?",name_ph:'Type your name here...',continue:'Continue â†’',level_speech:"Nice to meet you, {name}! What's your technical level?",spec_speech:'Excellent, {name}! What areas are you strongest in?',multi_hint:'Select one or more options',school_speech:'Great progress, {name}! Where are you studying?',goals_speech:'Last question, {name}! What do you want to achieve?',route_speech:"Perfect, {name}! I've created your personalized path. Let's go!",start_btn:'ðŸš€ Start Learning!',lv1:'Student',lv1d:"I'm learning the basics",lv2:'Helper',lv2d:"I'm in the field with a technician",lv3:'Technician',lv3d:'I work solo but want to improve',lv4:'Advanced',lv4d:'I want to master the trade',lv5:'Master',lv5d:'I want to lead / start my business',sp_e:'Electrical',sp_ed:'Circuits, controls, wiring',sp_a:'Air Conditioning',sp_ad:'Splits, central, mini splits',sp_r:'Refrigeration',sp_rd:'Walk-in coolers, commercial',sp_h:'Heating',sp_hd:'Furnaces, heat pumps',sp_x:'Starting in everything',sp_xd:'I want to learn it all',sc_ac:'ACVOLT Tech School',sc_acd:'Current ACVOLT student',sc_ot:'Another school',sc_otd:"I'm at another institution",sc_sf:'Self-taught',sc_sfd:'YouTube, books, field',sc_dn:'Completed studies',sc_dnd:'I have certification/diploma',gl_c:'Pass certifications',gl_cd:'EPA, NATE, OSHA, NCCER',gl_d:'Improve diagnostics',gl_dd:'Be more precise in the field',gl_b:'Start my business',gl_bd:'From tech to owner',gl_m:'Earn more money',gl_md:'Increase my value',r_elec:'Electrical Fundamentals',r_elecd:"Circuits, Ohm's law, diagrams",r_ac:'Air Conditioning',r_acd:'Pressure diagnostics, charging',r_ref:'Commercial Refrigeration',r_refd:'Walk-in coolers, controls, defrost',r_heat:'Heating Systems',r_heatd:'Furnaces, heat pumps, gas',r_cert:'Certification Prep',r_certd:'EPA 608 â€¢ NATE â€¢ OSHA â€¢ NCCER',r_biz:'Tech to Business Owner',r_bizd:'Licensing, estimates, clients'}
};

const t=k=>(T[D.lang][k]||k).replace('{name}',D.name);
const u=()=>{document.querySelectorAll('[data-t]').forEach(e=>e.textContent=t(e.getAttribute('data-t')));document.querySelectorAll('[data-tp]').forEach(e=>e.placeholder=t(e.getAttribute('data-tp')));};
const go=id=>{document.querySelectorAll('.s').forEach(s=>s.classList.remove('on'));document.getElementById(id).classList.add('on');window.scrollTo(0,0);};
const rx=(id,c)=>{const e=document.getElementById(id);if(e){e.classList.add(c);setTimeout(()=>e.classList.remove(c),1500);}};

function setLang(l){D.lang=l;u();go('s2');document.getElementById('nm').placeholder=t('name_ph');}
function sName(){D.name=document.getElementById('nm').value.trim();u();bLvl();go('s3');rx('a3','nod');}
function pLvl(e,v){document.querySelectorAll('#lo .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.level=v;document.getElementById('b3').disabled=false;rx('a3','nod');}
function sLvl(){u();bSpc();go('s4');}
function tSpc(e,k){if(k==='all'){document.querySelectorAll('#so .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.specs=['all'];}else{document.querySelector('#so .oc:last-child').classList.remove('sel');D.specs=D.specs.filter(s=>s!=='all');e.classList.toggle('sel');if(e.classList.contains('sel'))D.specs.push(k);else D.specs=D.specs.filter(s=>s!==k);}document.getElementById('b4').disabled=D.specs.length===0;rx('a4','nod');}
function sSpc(){u();bSch();go('s5');}
function pSch(e,v){document.querySelectorAll('#sco .oc').forEach(o=>o.classList.remove('sel'));e.classList.add('sel');D.school=v;document.getElementById('b5').disabled=false;rx('a5','nod');}
function sSch(){u();bGol();go('s6');}
function tGol(e,k){e.classList.toggle('sel');if(e.classList.contains('sel'))D.goals.push(k);else D.goals=D.goals.filter(g=>g!==k);document.getElementById('b6').disabled=D.goals.length===0;rx('a6','nod');}
function sGol(){u();bRt();go('s7');cft();rx('a7','cel');}

function bLvl(){document.getElementById('lo').innerHTML=[{k:1,i:'ðŸ“š',t:'lv1',d:'lv1d'},{k:2,i:'ðŸ”§',t:'lv2',d:'lv2d'},{k:3,i:'âš™ï¸',t:'lv3',d:'lv3d'},{k:4,i:'ðŸŽ¯',t:'lv4',d:'lv4d'},{k:5,i:'ðŸ‘‘',t:'lv5',d:'lv5d'}].map(x=>'<div class="oc" onclick="pLvl(this,'+x.k+')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div></div>').join('');}
function bSpc(){document.getElementById('so').innerHTML=[{k:'electrical',i:'âš¡',t:'sp_e',d:'sp_ed'},{k:'ac',i:'â„ï¸',t:'sp_a',d:'sp_ad'},{k:'refrigeration',i:'ðŸ§Š',t:'sp_r',d:'sp_rd'},{k:'heating',i:'ðŸ”¥',t:'sp_h',d:'sp_hd'},{k:'all',i:'ðŸŒŸ',t:'sp_x',d:'sp_xd'}].map(x=>'<div class="oc" onclick="tSpc(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div><div class="ck"></div></div>').join('');}
function bSch(){document.getElementById('sco').innerHTML=[{k:'acvolt',i:'ðŸŽ“',t:'sc_ac',d:'sc_acd'},{k:'other',i:'ðŸ«',t:'sc_ot',d:'sc_otd'},{k:'self',i:'ðŸ’ª',t:'sc_sf',d:'sc_sfd'},{k:'done',i:'âœ…',t:'sc_dn',d:'sc_dnd'}].map(x=>'<div class="oc" onclick="pSch(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div></div>').join('');}
function bGol(){document.getElementById('go2').innerHTML=[{k:'certs',i:'ðŸ“‹',t:'gl_c',d:'gl_cd'},{k:'diag',i:'ðŸ”',t:'gl_d',d:'gl_dd'},{k:'biz',i:'ðŸ¢',t:'gl_b',d:'gl_bd'},{k:'money',i:'ðŸ’°',t:'gl_m',d:'gl_md'}].map(x=>'<div class="oc" onclick="tGol(this,\''+x.k+'\')"><div class="oi">'+x.i+'</div><div><div class="ot">'+t(x.t)+'</div><div class="od">'+t(x.d)+'</div></div><div class="ck"></div></div>').join('');}
function bRt(){var r=[];if(D.specs.includes('all')||D.specs.includes('electrical'))r.push({i:'âš¡',t:'r_elec',d:'r_elecd'});if(D.specs.includes('all')||D.specs.includes('ac'))r.push({i:'â„ï¸',t:'r_ac',d:'r_acd'});if(D.specs.includes('all')||D.specs.includes('refrigeration'))r.push({i:'ðŸ§Š',t:'r_ref',d:'r_refd'});if(D.specs.includes('all')||D.specs.includes('heating'))r.push({i:'ðŸ”¥',t:'r_heat',d:'r_heatd'});if(D.goals.includes('certs'))r.push({i:'ðŸ“‹',t:'r_cert',d:'r_certd'});if(D.goals.includes('biz'))r.push({i:'ðŸ¢',t:'r_biz',d:'r_bizd'});document.getElementById('rl').innerHTML=r.map((x,i)=>'<div class="rt"><div class="rn">'+(i+1)+'</div><div><div class="rtt">'+x.i+' '+t(x.t)+'</div><div class="rd">'+t(x.d)+'</div></div></div>'+(i<r.length-1?'<div class="rl"></div>':'')).join('');}

function startApp(){alert(D.lang==='es'?'Â¡'+D.name+', tu ruta estÃ¡ lista! PrÃ³ximamente: Quiz y Medallas ðŸ…':D.name+', your path is ready! Coming: Quiz & Medals ðŸ…');console.log('Profile:',JSON.stringify(D,null,2));}
document.getElementById('nm').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim().length>=2)sName();});
</script>
</body>
</html>
